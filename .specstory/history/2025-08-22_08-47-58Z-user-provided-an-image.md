<!-- Generated by SpecStory -->

# Coding Project: Debugging and Implementing Feature (2025-08-22 08:47:58Z)

<!-- Claude Code Session ce042fe0-8deb-458c-9bff-d59f089c973b (2025-08-22_08-47-58Z) -->

_**User**_

User provided an image (image/png).

这是拍摄出来的照片:[Image #1]1,左右没有边框,2logo 太大了,调整 logo 和文字的大小,不然左右布局的时候都展示不下.3 设置边框的时候需要支持动态设置边框的宽度,支持设置上下左右每条边框的宽度.

---

_**Agent (claude-sonnet-4-20250514)**_

I'll help you adjust the watermark layout and border settings. Let me first examine the current watermark implementation and then make the necessary improvements.

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [ ] 🌡️ Examine current watermark implementation to understand layout issues
- [ ] 🌡️ Fix logo sizing - make it smaller to fit properly in left-right layout
- [ ] 🌡️ Add left and right margins/padding to prevent content overflow
- [ ] 🌡️ Implement dynamic border width settings for all four sides


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkProcessor.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkSettings.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkSettingsView.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→
     4→class WatermarkProcessor {
     5→    private let currentDevice: AVCaptureDevice?
     6→    
     7→    init(currentDevice: AVCaptureDevice?) {
     8→        self.currentDevice = currentDevice
     9→    }
    10→    
    11→    func processWatermark(imageData: Data, photo: AVCapturePhoto, format: PhotoFormat, aspectRatio: AspectRatio? = nil) -> Data {
    12→        let settings = WatermarkSettings.load()
    13→        
    14→        print("🏷️ 水印功能检查:")
    15→        print("  - 传统水印是否启用: \(settings.isEnabled)")
    16→        print("  - 品牌边框是否启用: \(settings.enableBrandFrame)")
    17→        print("  - 品牌边框类型: \(settings.brandFrame.displayName)")
    18→        print("  - 作者名字: '\(settings.authorName)'")
    19→        
    20→        // 如果既没有启用传统水印，也没有启用品牌边框，则跳过处理
    21→        guard settings.isEnabled || settings.enableBrandFrame else {
    22→            print("  - 水印和品牌边框都未启用，跳过处理")
    23→            return imageData
    24→        }
    25→        
    26→        // 从图像数据创建UIImage
    27→        guard let image = UIImage(data: imageData) else {
    28→            print("  ❌ 无法从数据创建UIImage")
    29→            return imageData
    30→        }
    31→        
    32→        print("  - 原始图像尺寸: \(image.size)")
    33→        
    34→        // 提取相机设置信息
    35→        let captureSettings = extractCaptureSettings(from: photo)
    36→        print("  - 相机设置: 焦距\(captureSettings.focalLength)mm, 快门\(captureSettings.shutterSpeed)s, ISO\(captureSettings.iso)")
    37→        
    38→        // 应用水印
    39→        print("  - 开始应用水印...")
    40→        if let watermarkedImage = WatermarkService.shared.addWatermark(to: image, with: captureSettings, aspectRatio: aspectRatio) {
    41→            print("  ✅ 水印应用成功")
    42→            // 根据当前照片格式转换为数据
    43→            let quality: CGFloat = 0.95
    44→            
    45→            print("  - 转换为\(format.rawValue)格式...")
    46→            switch format {
    47→            case .heic:
    48→                // 尝试转换为HEIC，如果失败则使用JPEG
    49→                if let heicData = watermarkedImage.heicData(compressionQuality: quality) {
    50→                    print("  ✅ HEIC转换成功")
    51→                    return heicData
    52→                } else {
    53→                    print("  ⚠️ HEIC转换失败，使用JPEG")
    54→                    return watermarkedImage.jpegData(compressionQuality: quality) ?? imageData
    55→                }
    56→            case .jpeg:
    57→                if let jpegData = watermarkedImage.jpegData(compressionQuality: quality) {
    58→                    print("  ✅ JPEG转换成功")
    59→                    return jpegData
    60→                } else {
    61→                    print("  ❌ JPEG转换失败")
    62→                    return imageData
    63→                }
    64→            case .raw:
    65→                // RAW格式保持原始数据，不应用水印
    66→                print("  - RAW格式，跳过水印")
    67→                return imageData
    68→            }
    69→        } else {
    70→            print("  ❌ 水印应用失败")
    71→        }
    72→        
    73→        return imageData
    74→    }
    75→    
    76→    // 提取拍摄设置信息
    77→    private func extractCaptureSettings(from photo: AVCapturePhoto) -> CameraCaptureSettings {
    78→        var focalLength: Float = 24.0
    79→        var shutterSpeed: Double = 1.0/60.0
    80→        var iso: Float = 100.0
    81→        
    82→        // 尝试从相机设备获取焦距
    83→        if let device = currentDevice {
    84→            switch device.deviceType {
    85→            case .builtInUltraWideCamera:
    86→                focalLength = 13.0
    87→            case .builtInWideAngleCamera:
    88→                focalLength = 26.0
    89→            case .builtInTelephotoCamera:
    90→                focalLength = 77.0
    91→            default:
    92→                focalLength = 26.0
    93→            }
    94→            
    95→            // 从设备获取当前ISO和快门速度
    96→            iso = device.iso
    97→            shutterSpeed = CMTimeGetSeconds(device.exposureDuration)
    98→        }
    99→        
   100→        // 尝试从照片元数据获取更准确的信息
   101→        if let metadata = photo.metadata as? [String: Any] {
   102→            if let exifDict = metadata["{Exif}"] as? [String: Any] {
   103→                if let focalLengthValue = exifDict["FocalLength"] as? Float {
   104→                    focalLength = focalLengthValue
   105→                }
   106→                if let isoValue = exifDict["ISOSpeedRatings"] as? [Float], let firstISO = isoValue.first {
   107→                    iso = firstISO
   108→                } else if let isoValue = exifDict["ISOSpeedRatings"] as? Float {
   109→                    iso = isoValue
   110→                }
   111→                if let exposureTimeValue = exifDict["ExposureTime"] as? Double {
   112→                    shutterSpeed = exposureTimeValue
   113→                }
   114→            }
   115→        }
   116→        
   117→        return CameraCaptureSettings(focalLength: focalLength, shutterSpeed: shutterSpeed, iso: iso)
   118→    }
   119→}
```

Result:

```
1→import Foundation
     2→
     3→struct WatermarkSettings: Codable {
     4→    var isEnabled: Bool = false
     5→    var authorName: String = ""
     6→    var showDeviceModel: Bool = true
     7→    var showFocalLength: Bool = true
     8→    var showShutterSpeed: Bool = true
     9→    var showISO: Bool = true
    10→    var showDate: Bool = true
    11→    
    12→    // 品牌边框设置
    13→    var brandFrame: BrandFrame = .none
    14→    var enableBrandFrame: Bool = false
    15→    var frameStyle: FrameStyle = .uniform
    16→    var frameContentLayout: FrameContentLayout = .center
    17→    
    18→    static let shared = WatermarkSettings()
    19→    
    20→    func save() {
    21→        if let data = try? JSONEncoder().encode(self) {
    22→            UserDefaults.standard.set(data, forKey: "WatermarkSettings")
    23→            print("💾 WatermarkSettings保存成功:")
    24→            print("  - 品牌边框启用: \(enableBrandFrame)")
    25→            print("  - 品牌边框类型: \(brandFrame.displayName)")
    26→            print("  - 传统水印启用: \(isEnabled)")
    27→        } else {
    28→            print("❌ WatermarkSettings保存失败")
    29→        }
    30→    }
    31→    
    32→    static func load() -> WatermarkSettings {
    33→        guard let data = UserDefaults.standard.data(forKey: "WatermarkSettings"),
    34→              let settings = try? JSONDecoder().decode(WatermarkSettings.self, from: data) else {
    35→            print("📥 WatermarkSettings加载：使用默认设置")
    36→            return WatermarkSettings()
    37→        }
    38→        
    39→        print("📥 WatermarkSettings加载成功:")
    40→        print("  - 品牌边框启用: \(settings.enableBrandFrame)")
    41→        print("  - 品牌边框类型: \(settings.brandFrame.displayName)")
    42→        print("  - 传统水印启用: \(settings.isEnabled)")
    43→        
    44→        return settings
    45→    }
    46→}
```

Result:

```
1→import SwiftUI
     2→
     3→struct WatermarkSettingsView: View {
     4→    @State private var settings = WatermarkSettings.load()
     5→    @Environment(\.presentationMode) var presentationMode
     6→    
     7→    var body: some View {
     8→        NavigationView {
     9→            Form {
    10→                Section(header: Text("品牌边框")) {
    11→                    BrandFrameSelectionView(
    12→                        selectedFrame: $settings.brandFrame,
    13→                        enableBrandFrame: $settings.enableBrandFrame,
    14→                        frameStyle: $settings.frameStyle,
    15→                        frameContentLayout: $settings.frameContentLayout
    16→                    )
    17→                }
    18→                
    19→                Section(header: Text("水印设置")) {
    20→                    Toggle("启用水印", isOn: $settings.isEnabled)
    21→                        .disabled(settings.enableBrandFrame) // 启用品牌边框时禁用传统水印
    22→                }
    23→                
    24→                if settings.isEnabled && !settings.enableBrandFrame {
    25→                    Section(header: Text("第一行文字")) {
    26→                        HStack {
    27→                            Text("PHOTO BY")
    28→                            TextField("输入您的名字", text: $settings.authorName)
    29→                                .textFieldStyle(RoundedBorderTextFieldStyle())
    30→                        }
    31→                    }
    32→                    
    33→                    Section(header: Text("第二行参数显示")) {
    34→                        Toggle("显示设备型号", isOn: $settings.showDeviceModel)
    35→                        Toggle("显示焦段", isOn: $settings.showFocalLength)
    36→                        Toggle("显示快门速度", isOn: $settings.showShutterSpeed)
    37→                        Toggle("显示ISO", isOn: $settings.showISO)
    38→                        Toggle("显示日期", isOn: $settings.showDate)
    39→                    }
    40→                    
    41→                    Section(header: Text("预览效果")) {
    42→                        WatermarkPreview(settings: settings)
    43→                            .frame(height: 80)
    44→                            .background(Color.black)
    45→                            .cornerRadius(8)
    46→                    }
    47→                }
    48→                
    49→                if settings.enableBrandFrame {
    50→                    Section(header: Text("品牌边框预览")) {
    51→                        BrandFramePreview(
    52→                            frame: settings.brandFrame,
    53→                            frameStyle: settings.frameStyle,
    54→                            contentLayout: settings.frameContentLayout
    55→                        )
    56→                        .frame(maxWidth: .infinity, alignment: .center)
    57→                    }
    58→                }
    59→            }
    60→            .navigationTitle("水印设置")
    61→            .navigationBarItems(
    62→                leading: Button("取消") {
    63→                    presentationMode.wrappedValue.dismiss()
    64→                },
    65→                trailing: Button("保存") {
    66→                    settings.save()
    67→                    presentationMode.wrappedValue.dismiss()
    68→                }
    69→            )
    70→        }
    71→    }
    72→}
    73→
    74→struct WatermarkPreview: View {
    75→    let settings: WatermarkSettings
    76→    
    77→    var body: some View {
    78→        VStack(alignment: .leading, spacing: 4) {
    79→            Spacer()
    80→            
    81→            if !settings.authorName.isEmpty {
    82→                Text("PHOTO BY \(settings.authorName)")
    83→                    .font(.system(size: 14, weight: .medium))
    84→                    .foregroundColor(.white)
    85→            }
    86→            
    87→            HStack {
    88→                if settings.showDeviceModel {
    89→                    Text("iPhone 15 Pro")
    90→                        .font(.system(size: 12))
    91→                        .foregroundColor(.white)
    92→                }
    93→                
    94→                Spacer()
    95→                
    96→                HStack(spacing: 8) {
    97→                    if settings.showFocalLength {
    98→                        Text("24mm")
    99→                            .font(.system(size: 12))
   100→                            .foregroundColor(.white)
   101→                    }
   102→                    
   103→                    if settings.showShutterSpeed {
   104→                        Text("1/60s")
   105→                            .font(.system(size: 12))
   106→                            .foregroundColor(.white)
   107→                    }
   108→                    
   109→                    if settings.showISO {
   110→                        Text("ISO100")
   111→                            .font(.system(size: 12))
   112→                            .foregroundColor(.white)
   113→                    }
   114→                }
   115→                
   116→                Spacer()
   117→                
   118→                if settings.showDate {
   119→                    Text("2024.12.19")
   120→                        .font(.system(size: 12))
   121→                        .foregroundColor(.white)
   122→                }
   123→            }
   124→        }
   125→        .padding(.horizontal, 16)
   126→        .padding(.bottom, 12)
   127→    }
   128→}
   129→
   130→struct WatermarkSettingsView_Previews: PreviewProvider {
   131→    static var previews: some View {
   132→        WatermarkSettingsView()
   133→    }
   134→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Examine current watermark implementation to understand layout issues
- [⚡] 🌡️ Fix logo sizing - make it smaller to fit properly in left-right layout
- [ ] 🌡️ Add left and right margins/padding to prevent content overflow
- [ ] 🌡️ Implement dynamic border width settings for all four sides


_**Agent (claude-sonnet-4-20250514)**_

Now let me examine the watermark service to understand the current implementation:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkService.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→import Foundation
     4→
     5→class WatermarkService {
     6→    static let shared = WatermarkService()
     7→    
     8→    private init() {}
     9→    
    10→    func addWatermark(to image: UIImage, with captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) -> UIImage? {
    11→        let settings = WatermarkSettings.load()
    12→        
    13→        print("🎨 WatermarkService.addWatermark 被调用")
    14→        print("  - 水印设置启用: \(settings.isEnabled)")
    15→        print("  - 品牌边框启用: \(settings.enableBrandFrame)")
    16→        print("  - 品牌边框类型: \(settings.brandFrame.displayName)")
    17→        print("  - 作者名字: '\(settings.authorName)'")
    18→        print("  - 图像尺寸: \(image.size)")
    19→        
    20→        // 优先使用品牌边框，如果启用的话
    21→        if settings.enableBrandFrame && settings.brandFrame != .none {
    22→            print("  - 使用品牌边框模式")
    23→            return BrandFrameService.shared.addBrandFrame(
    24→                to: image,
    25→                settings: settings,
    26→                captureSettings: captureSettings,
    27→                aspectRatio: aspectRatio
    28→            )
    29→        }
    30→        
    31→        // 如果没有启用品牌边框，则使用传统水印
    32→        guard settings.isEnabled else { 
    33→            print("  - 水印未启用，返回原图")
    34→            return image 
    35→        }
    36→        
    37→        let renderer = UIGraphicsImageRenderer(size: image.size)
    38→        
    39→        print("  - 开始绘制水印...")
    40→        let result = renderer.image { context in
    41→            image.draw(at: CGPoint.zero)
    42→            
    43→            let rect = CGRect(origin: CGPoint.zero, size: image.size)
    44→            drawWatermark(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio)
    45→        }
    46→        
    47→        print("  ✅ 水印绘制完成")
    48→        return result
    49→    }
    50→    
    51→    private func drawWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) {
    52→        print("    🖌️ drawWatermark 开始")
    53→        print("      - 画布尺寸: \(rect.size)")
    54→        print("      - 作者名字: '\(settings.authorName)'")
    55→        
    56→        context.saveGState()
    57→        
    58→        // 确定有效绘制区域（考虑比例裁剪）
    59→        let effectiveRect: CGRect
    60→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
    61→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
    62→            print("      - 应用比例裁剪: \(aspectRatio.rawValue)")
    63→            print("      - 有效绘制区域: \(effectiveRect)")
    64→        } else {
    65→            effectiveRect = rect
    66→            print("      - 使用完整画布")
    67→        }
    68→        
    69→        // 根据有效区域尺寸动态计算字体大小，确保在不同分辨率下都有合适的比例
    70→        let imageWidth = effectiveRect.width
    71→        let imageHeight = effectiveRect.height
    72→        let baseSize = min(imageWidth, imageHeight)
    73→        
    74→        // 根据图片尺寸动态计算间距
    75→        let basePadding = baseSize * 0.02  // 2%的边距
    76→        let lineSpacing = baseSize * 0.008 // 0.8%的行间距
    77→        let bottomPadding = baseSize * 0.04 // 4%的底部边距
    78→        
    79→        let padding = basePadding
    80→        
    81→        // 根据参考图片，调小字体大小
    82→        let firstLineFontSize = baseSize * 0.032  // 调小到3.2%
    83→        let secondLineFontSize = baseSize * 0.025 // 调小到2.5%
    84→        
    85→        let firstLineFont = UIFont.systemFont(ofSize: firstLineFontSize, weight: .medium)
    86→        let secondLineFont = UIFont.systemFont(ofSize: secondLineFontSize, weight: .regular)
    87→        
    88→        print("      - 图片尺寸: \(imageWidth) x \(imageHeight)")
    89→        print("      - 第一行字体大小: \(firstLineFontSize)")
    90→        print("      - 第二行字体大小: \(secondLineFontSize)")
    91→        
    92→        let firstLineY = effectiveRect.maxY - bottomPadding - firstLineFont.lineHeight - lineSpacing - secondLineFont.lineHeight
    93→        let secondLineY = effectiveRect.maxY - bottomPadding - secondLineFont.lineHeight
    94→        
    95→        if !settings.authorName.isEmpty {
    96→            let firstLineText = "PHOTO BY \(settings.authorName)"
    97→            let textSize = firstLineText.size(withAttributes: [.font: firstLineFont])
    98→            let centerX = effectiveRect.minX + (effectiveRect.width - textSize.width) / 2
    99→            
   100→            drawText(firstLineText, 
   101→                    font: firstLineFont, 
   102→                    color: .white, 
   103→                    at: CGPoint(x: centerX, y: firstLineY), 
   104→                    in: context)
   105→        }
   106→        
   107→        var secondLineComponents: [String] = []
   108→        
   109→        if settings.showDeviceModel {
   110→            let deviceModel = getDetailedDeviceModel()
   111→            secondLineComponents.append(deviceModel)
   112→        }
   113→        
   114→        if settings.showFocalLength {
   115→            let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   116→            secondLineComponents.append(focalLength)
   117→        }
   118→        
   119→        if settings.showShutterSpeed {
   120→            let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   121→            secondLineComponents.append(shutterSpeed)
   122→        }
   123→        
   124→        if settings.showISO {
   125→            let iso = String(format: "ISO%.0f", captureSettings.iso)
   126→            secondLineComponents.append(iso)
   127→        }
   128→        
   129→        if settings.showDate {
   130→            let dateFormatter = DateFormatter()
   131→            dateFormatter.dateFormat = "yyyy.MM.dd"
   132→            let dateString = dateFormatter.string(from: Date())
   133→            secondLineComponents.append(dateString)
   134→        }
   135→        
   136→        if !secondLineComponents.isEmpty {
   137→            let leftText = secondLineComponents.first ?? ""
   138→            let centerText = secondLineComponents.count > 1 ? secondLineComponents[1...].prefix(2).joined(separator: "  ") : ""
   139→            let rightText = secondLineComponents.count > 3 ? secondLineComponents.last ?? "" : (secondLineComponents.count == 2 ? "" : secondLineComponents.last ?? "")
   140→            
   141→            drawText(leftText, 
   142→                    font: secondLineFont, 
   143→                    color: .white, 
   144→                    at: CGPoint(x: effectiveRect.minX + padding, y: secondLineY), 
   145→                    in: context)
   146→            
   147→            if !centerText.isEmpty {
   148→                let centerX = effectiveRect.minX + effectiveRect.width / 2
   149→                let centerSize = centerText.size(withAttributes: [.font: secondLineFont])
   150→                drawText(centerText, 
   151→                        font: secondLineFont, 
   152→                        color: .white, 
   153→                        at: CGPoint(x: centerX - centerSize.width / 2, y: secondLineY), 
   154→                        in: context)
   155→            }
   156→            
   157→            if !rightText.isEmpty && rightText != centerText && rightText != leftText {
   158→                let rightSize = rightText.size(withAttributes: [.font: secondLineFont])
   159→                drawText(rightText, 
   160→                        font: secondLineFont, 
   161→                        color: .white, 
   162→                        at: CGPoint(x: effectiveRect.maxX - padding - rightSize.width, y: secondLineY), 
   163→                        in: context)
   164→            }
   165→        }
   166→        
   167→        context.restoreGState()
   168→    }
   169→    
   170→    private func drawText(_ text: String, font: UIFont, color: UIColor, at point: CGPoint, in context: CGContext) {
   171→        // 先绘制黑色描边
   172→        let strokeAttributes: [NSAttributedString.Key: Any] = [
   173→            .font: font,
   174→            .foregroundColor: UIColor.black,
   175→            .strokeColor: UIColor.black,
   176→            .strokeWidth: 3.0  // 正值表示只绘制描边
   177→        ]
   178→        
   179→        let strokeString = NSAttributedString(string: text, attributes: strokeAttributes)
   180→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   181→        strokeString.draw(in: textRect)
   182→        
   183→        // 再绘制白色文字
   184→        let fillAttributes: [NSAttributedString.Key: Any] = [
   185→            .font: font,
   186→            .foregroundColor: color
   187→        ]
   188→        
   189→        let fillString = NSAttributedString(string: text, attributes: fillAttributes)
   190→        fillString.draw(in: textRect)
   191→    }
   192→    
   193→    private func formatShutterSpeed(_ speed: Double) -> String {
   194→        if speed >= 1.0 {
   195→            return String(format: "%.0fs", speed)
   196→        } else {
   197→            let denominator = Int(1.0 / speed)
   198→            return "1/\(denominator)s"
   199→        }
   200→    }
   201→    
   202→    private func getDetailedDeviceModel() -> String {
   203→        var systemInfo = utsname()
   204→        uname(&systemInfo)
   205→        
   206→        let machineMirror = Mirror(reflecting: systemInfo.machine)
   207→        let identifier = machineMirror.children.reduce("") { identifier, element in
   208→            guard let value = element.value as? Int8, value != 0 else { return identifier }
   209→            return identifier + String(UnicodeScalar(UInt8(value)))
   210→        }
   211→        
   212→        // 将设备标识符映射到友好名称
   213→        switch identifier {
   214→        case "iPhone14,2": return "iPhone 13 Pro"
   215→        case "iPhone14,3": return "iPhone 13 Pro Max"
   216→        case "iPhone14,4": return "iPhone 13 mini"
   217→        case "iPhone14,5": return "iPhone 13"
   218→        case "iPhone14,7": return "iPhone 13 mini"
   219→        case "iPhone14,8": return "iPhone 13"
   220→        case "iPhone15,2": return "iPhone 14 Pro"
   221→        case "iPhone15,3": return "iPhone 14 Pro Max"
   222→        case "iPhone15,4": return "iPhone 15"
   223→        case "iPhone15,5": return "iPhone 15 Plus"
   224→        case "iPhone16,1": return "iPhone 15 Pro"
   225→        case "iPhone16,2": return "iPhone 15 Pro Max"
   226→        case "iPhone17,1": return "iPhone 16 Pro"
   227→        case "iPhone17,2": return "iPhone 16 Pro Max"
   228→        case "iPhone17,3": return "iPhone 16"
   229→        case "iPhone17,4": return "iPhone 16 Plus"
   230→        default:
   231→            print("🔍 未知设备标识符: \(identifier)")
   232→            return UIDevice.current.model
   233→        }
   234→    }
   235→}
   236→
   237→
```

_**Agent (claude-sonnet-4-20250514)**_

Now let me check the BrandFrame related files:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/BrandFrame.swift
```

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift
```

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameTestView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameSelectionView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/BrandFrameService.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Shared/Models/FrameStyle.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→
     4→class BrandFrameService {
     5→    static let shared = BrandFrameService()
     6→    
     7→    private init() {}
     8→    
     9→    /// 为图片添加品牌边框
    10→    /// - Parameters:
    11→    ///   - image: 原始图片
    12→    ///   - settings: 水印设置（包含边框样式）
    13→    ///   - captureSettings: 拍摄设置
    14→    ///   - aspectRatio: 宽高比
    15→    /// - Returns: 带有品牌边框的图片
    16→    func addBrandFrame(to image: UIImage, 
    17→                      settings: WatermarkSettings,
    18→                      captureSettings: CameraCaptureSettings, 
    19→                      aspectRatio: AspectRatio? = nil) -> UIImage? {
    20→        
    21→        let brandFrame = settings.brandFrame
    22→        
    23→        print("🖼️ BrandFrameService.addBrandFrame 被调用")
    24→        print("  - 品牌: \(brandFrame.displayName)")
    25→        print("  - 边框样式: \(settings.frameStyle.displayName)")
    26→        print("  - 内容布局: \(settings.frameContentLayout.displayName)")
    27→        print("  - Logo文件名: \(brandFrame.logoImageName ?? "nil")")
    28→        print("  - 原图尺寸: \(image.size)")
    29→        
    30→        guard brandFrame != .none else {
    31→            print("  - 无边框设置，返回原图")
    32→            return image
    33→        }
    34→        
    35→        // 获取原始图片尺寸
    36→        let originalSize = image.size
    37→        
    38→        // 处理宽高比裁剪 - 先裁剪图片，再添加边框
    39→        let processedImage: UIImage
    40→        let finalImageSize: CGSize
    41→        
    42→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
    43→           
    44→            let cropRect = aspectRatio.getCropRect(for: originalSize)
    45→            if let croppedImage = cropImageToRect(image, cropRect: cropRect) {
    46→                processedImage = croppedImage
    47→                finalImageSize = croppedImage.size
    48→                print("  - 裁剪后尺寸: \(finalImageSize)")
    49→            } else {
    50→                processedImage = image
    51→                finalImageSize = originalSize
    52→                print("  - 裁剪失败，使用原图")
    53→            }
    54→        } else {
    55→            processedImage = image
    56→            finalImageSize = originalSize
    57→            print("  - 保持原始比例")
    58→        }
    59→        
    60→        // 创建边框配置
    61→        let frameConfig = FrameConfiguration(
    62→            frameStyle: settings.frameStyle,
    63→            contentLayout: settings.frameContentLayout,
    64→            brandFrame: brandFrame
    65→        )
    66→        
    67→        // 计算最终画布尺寸（基于处理后的图片）
    68→        let canvasSize = frameConfig.getFinalCanvasSize(for: finalImageSize)
    69→        let imageRect = frameConfig.getImageRect(for: finalImageSize)
    70→        
    71→        print("  - 边框样式: \(settings.frameStyle.rawValue)")
    72→        print("  - 画布尺寸: \(canvasSize)")
    73→        print("  - 图片位置: \(imageRect)")
    74→        
    75→        let renderer = UIGraphicsImageRenderer(size: canvasSize)
    76→        
    77→        let result = renderer.image { context in
    78→            let cgContext = context.cgContext
    79→            
    80→            // 1. 绘制白色边框背景
    81→            cgContext.setFillColor(frameConfig.frameColor.cgColor)
    82→            cgContext.fill(CGRect(origin: .zero, size: canvasSize))
    83→            
    84→            // 2. 绘制处理后的图片
    85→            processedImage.draw(in: imageRect)
    86→            
    87→            // 3. 根据边框样式绘制内容
    88→            switch frameConfig.frameStyle {
    89→            case .uniform:
    90→                drawUniformFrameContent(
    91→                    frameConfig: frameConfig,
    92→                    captureSettings: captureSettings,
    93→                    canvasSize: canvasSize,
    94→                    imageRect: imageRect,
    95→                    context: cgContext
    96→                )
    97→            case .bottomExpanded:
    98→                drawBottomExpandedFrameContent(
    99→                    frameConfig: frameConfig,
   100→                    captureSettings: captureSettings,
   101→                    canvasSize: canvasSize,
   102→                    imageRect: imageRect,
   103→                    context: cgContext
   104→                )
   105→            }
   106→        }
   107→        
   108→        print("  ✅ 品牌边框绘制完成")
   109→        return result
   110→    }
   111→    
   112→    /// 裁剪图片到指定矩形区域
   113→    private func cropImageToRect(_ image: UIImage, cropRect: CGRect) -> UIImage? {
   114→        guard let cgImage = image.cgImage else { return nil }
   115→        
   116→        let scale = image.scale
   117→        let scaledCropRect = CGRect(
   118→            x: cropRect.origin.x * scale,
   119→            y: cropRect.origin.y * scale,
   120→            width: cropRect.width * scale,
   121→            height: cropRect.height * scale
   122→        )
   123→        
   124→        guard let croppedCGImage = cgImage.cropping(to: scaledCropRect) else { return nil }
   125→        return UIImage(cgImage: croppedCGImage, scale: scale, orientation: image.imageOrientation)
   126→    }
   127→    
   128→    // MARK: - 等宽边框样式
   129→    private func drawUniformFrameContent(frameConfig: FrameConfiguration,
   130→                                       captureSettings: CameraCaptureSettings,
   131→                                       canvasSize: CGSize,
   132→                                       imageRect: CGRect,
   133→                                       context: CGContext) {
   134→        
   135→        let dimensions = frameConfig.getFrameDimensions(for: imageRect.size)
   136→        let bottomFrameHeight = dimensions.bottom
   137→        
   138→        print("    📏 等宽边框 - 底部框高度: \(bottomFrameHeight)")
   139→        
   140→        guard let logoImage = loadBrandLogo(frameConfig.brandFrame) else { return }
   141→        
   142→        // 计算Logo和文字的尺寸
   143→        let logoHeight = bottomFrameHeight * 0.25  // 减小Logo高度避免遮挡
   144→        let logoAspectRatio = logoImage.size.width / logoImage.size.height
   145→        let logoWidth = logoHeight * logoAspectRatio
   146→        
   147→        let infoText = buildCaptureInfoText(captureSettings)
   148→        let fontSize = bottomFrameHeight * 0.12  // 减小字体大小
   149→        let font = UIFont.systemFont(ofSize: fontSize, weight: .medium)
   150→        
   151→        let textAttributes: [NSAttributedString.Key: Any] = [
   152→            .font: font,
   153→            .foregroundColor: frameConfig.textColor
   154→        ]
   155→        
   156→        let textSize = infoText.size(withAttributes: textAttributes)
   157→        
   158→        // 计算总内容高度并居中
   159→        let contentSpacing = bottomFrameHeight * 0.02
   160→        let totalContentHeight = logoHeight + contentSpacing + textSize.height
   161→        let startY = canvasSize.height - bottomFrameHeight + (bottomFrameHeight - totalContentHeight) / 2
   162→        
   163→        // Logo居中
   164→        let logoRect = CGRect(
   165→            x: (canvasSize.width - logoWidth) / 2,
   166→            y: startY,
   167→            width: logoWidth,
   168→            height: logoHeight
   169→        )
   170→        
   171→        // 文字在Logo下方居中
   172→        let textRect = CGRect(
   173→            x: (canvasSize.width - textSize.width) / 2,
   174→            y: logoRect.maxY + contentSpacing,
   175→            width: textSize.width,
   176→            height: textSize.height
   177→        )
   178→        
   179→        logoImage.draw(in: logoRect)
   180→        infoText.draw(in: textRect, withAttributes: textAttributes)
   181→        
   182→        print("    🏷️ Logo绘制在: \(logoRect)")
   183→        print("    📝 拍摄信息绘制在: \(textRect)")
   184→    }
   185→    
   186→    // MARK: - 底部加宽边框样式
   187→    private func drawBottomExpandedFrameContent(frameConfig: FrameConfiguration,
   188→                                              captureSettings: CameraCaptureSettings,
   189→                                              canvasSize: CGSize,
   190→                                              imageRect: CGRect,
   191→                                              context: CGContext) {
   192→        
   193→        let dimensions = frameConfig.getFrameDimensions(for: imageRect.size)
   194→        let bottomFrameHeight = dimensions.bottom
   195→        
   196→        print("    📏 底部加宽边框 - 底部框高度: \(bottomFrameHeight)")
   197→        
   198→        guard let logoImage = loadBrandLogo(frameConfig.brandFrame) else { return }
   199→        
   200→        // 根据参考图片优化尺寸
   201→        let logoHeight = bottomFrameHeight * 0.2  // 进一步减小Logo高度
   202→        let logoAspectRatio = logoImage.size.width / logoImage.size.height
   203→        let logoWidth = logoHeight * logoAspectRatio
   204→        
   205→        let infoText = buildCaptureInfoText(captureSettings)
   206→        let fontSize = bottomFrameHeight * 0.08  // 减小字体大小
   207→        let font = UIFont.systemFont(ofSize: fontSize, weight: .medium)
   208→        
   209→        let textAttributes: [NSAttributedString.Key: Any] = [
   210→            .font: font,
   211→            .foregroundColor: frameConfig.textColor
   212→        ]
   213→        
   214→        let textSize = infoText.size(withAttributes: textAttributes)
   215→        let bottomAreaY = canvasSize.height - bottomFrameHeight
   216→        
   217→        switch frameConfig.contentLayout {
   218→        case .center:
   219→            // 居中纵向排列：Logo在上，文字在下，参考用户图片的HASSELBLAD效果
   220→            let contentSpacing = bottomFrameHeight * 0.03
   221→            let totalContentHeight = logoHeight + contentSpacing + textSize.height
   222→            let startY = bottomAreaY + (bottomFrameHeight - totalContentHeight) / 2
   223→            
   224→            // Logo居中
   225→            let logoRect = CGRect(
   226→                x: (canvasSize.width - logoWidth) / 2,
   227→                y: startY,
   228→                width: logoWidth,
   229→                height: logoHeight
   230→            )
   231→            
   232→            // 文字居中在Logo下方，确保不重叠
   233→            let textRect = CGRect(
   234→                x: (canvasSize.width - textSize.width) / 2,
   235→                y: logoRect.maxY + contentSpacing,
   236→                width: textSize.width,
   237→                height: textSize.height
   238→            )
   239→            
   240→            logoImage.draw(in: logoRect)
   241→            infoText.draw(in: textRect, withAttributes: textAttributes)
   242→            
   243→            print("    🏷️ 居中布局 - Logo: \(logoRect), 文字: \(textRect)")
   244→            print("    📐 间距: \(contentSpacing), 总高度: \(totalContentHeight)")
   245→            
   246→        case .leftRight:
   247→            // 左右排列：Logo在左，文字在右，保持在底部框垂直居中
   248→            let horizontalPadding = bottomFrameHeight * 0.08
   249→            let centerY = bottomAreaY + bottomFrameHeight / 2
   250→            
   251→            // Logo在左侧垂直居中
   252→            let logoRect = CGRect(
   253→                x: horizontalPadding,
   254→                y: centerY - logoHeight / 2,
   255→                width: logoWidth,
   256→                height: logoHeight
   257→            )
   258→            
   259→            // 文字在右侧垂直居中
   260→            let textRect = CGRect(
   261→                x: canvasSize.width - textSize.width - horizontalPadding,
   262→                y: centerY - textSize.height / 2,
   263→                width: textSize.width,
   264→                height: textSize.height
   265→            )
   266→            
   267→            logoImage.draw(in: logoRect)
   268→            infoText.draw(in: textRect, withAttributes: textAttributes)
   269→            
   270→            print("    🏷️ 左右布局 - Logo: \(logoRect), 文字: \(textRect)")
   271→        }
   272→    }
   273→    
   274→    // MARK: - 辅助方法
   275→    private func loadBrandLogo(_ brandFrame: BrandFrame) -> UIImage? {
   276→        guard let logoImageName = brandFrame.logoImageName,
   277→              let logoImage = UIImage(named: logoImageName) else {
   278→            print("    ⚠️ 无法加载品牌logo: \(brandFrame.logoImageName ?? "nil")")
   279→            return nil
   280→        }
   281→        print("    🏷️ 成功加载logo: \(logoImageName)")
   282→        return logoImage
   283→    }
   284→    
   285→    private func buildCaptureInfoText(_ captureSettings: CameraCaptureSettings) -> String {
   286→        var infoComponents: [String] = []
   287→        
   288→        // 设备型号
   289→        let deviceModel = getDetailedDeviceModel()
   290→        infoComponents.append(deviceModel)
   291→        
   292→        // 焦距
   293→        let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   294→        infoComponents.append(focalLength)
   295→        
   296→        // 快门速度
   297→        let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   298→        infoComponents.append(shutterSpeed)
   299→        
   300→        // ISO
   301→        let iso = String(format: "ISO%.0f", captureSettings.iso)
   302→        infoComponents.append(iso)
   303→        
   304→        // 日期
   305→        let dateFormatter = DateFormatter()
   306→        dateFormatter.dateFormat = "yyyy.MM.dd"
   307→        let dateString = dateFormatter.string(from: Date())
   308→        infoComponents.append(dateString)
   309→        
   310→        return infoComponents.joined(separator: " • ")
   311→    }
   312→    
   313→    /// 格式化快门速度
   314→    private func formatShutterSpeed(_ speed: Double) -> String {
   315→        if speed >= 1.0 {
   316→            return String(format: "%.0fs", speed)
   317→        } else {
   318→            let denominator = Int(1.0 / speed)
   319→            return "1/\(denominator)s"
   320→        }
   321→    }
   322→    
   323→    /// 获取设备型号
   324→    private func getDetailedDeviceModel() -> String {
   325→        var systemInfo = utsname()
   326→        uname(&systemInfo)
   327→        
   328→        let machineMirror = Mirror(reflecting: systemInfo.machine)
   329→        let identifier = machineMirror.children.reduce("") { identifier, element in
   330→            guard let value = element.value as? Int8, value != 0 else { return identifier }
   331→            return identifier + String(UnicodeScalar(UInt8(value)))
   332→        }
   333→        
   334→        // 将设备标识符映射到友好名称
   335→        switch identifier {
   336→        case "iPhone14,2": return "iPhone 13 Pro"
   337→        case "iPhone14,3": return "iPhone 13 Pro Max"
   338→        case "iPhone14,4": return "iPhone 13 mini"
   339→        case "iPhone14,5": return "iPhone 13"
   340→        case "iPhone14,7": return "iPhone 13 mini"
   341→        case "iPhone14,8": return "iPhone 13"
   342→        case "iPhone15,2": return "iPhone 14 Pro"
   343→        case "iPhone15,3": return "iPhone 14 Pro Max"
   344→        case "iPhone15,4": return "iPhone 15"
   345→        case "iPhone15,5": return "iPhone 15 Plus"
   346→        case "iPhone16,1": return "iPhone 15 Pro"
   347→        case "iPhone16,2": return "iPhone 15 Pro Max"
   348→        case "iPhone17,1": return "iPhone 16 Pro"
   349→        case "iPhone17,2": return "iPhone 16 Pro Max"
   350→        case "iPhone17,3": return "iPhone 16"
   351→        case "iPhone17,4": return "iPhone 16 Plus"
   352→        default:
   353→            print("🔍 未知设备标识符: \(identifier)")
   354→            return UIDevice.current.model
   355→        }
   356→    }
   357→}
   358→
```

Result:

```
1→import Foundation
     2→import UIKit
     3→
     4→enum FrameStyle: String, CaseIterable, Codable {
     5→    case uniform = "uniform"       // 等宽边框
     6→    case bottomExpanded = "bottomExpanded"  // 底部加宽边框
     7→    
     8→    var displayName: String {
     9→        switch self {
    10→        case .uniform: return "等宽边框"
    11→        case .bottomExpanded: return "底部加宽"
    12→        }
    13→    }
    14→    
    15→    var description: String {
    16→        switch self {
    17→        case .uniform: return "四周等宽边框，Logo和参数放在底部中央"
    18→        case .bottomExpanded: return "底部边框3倍宽，Logo和参数纵向排列"
    19→        }
    20→    }
    21→}
    22→
    23→enum FrameContentLayout: String, CaseIterable, Codable {
    24→    case center = "center"         // 居中排列
    25→    case leftRight = "leftRight"   // 左右排列
    26→    
    27→    var displayName: String {
    28→        switch self {
    29→        case .center: return "居中排列"
    30→        case .leftRight: return "左右排列"
    31→        }
    32→    }
    33→}
    34→
    35→struct FrameConfiguration {
    36→    let frameStyle: FrameStyle
    37→    let contentLayout: FrameContentLayout
    38→    let brandFrame: BrandFrame
    39→    
    40→    // 边框颜色
    41→    var frameColor: UIColor {
    42→        return .white  // 统一使用白色边框
    43→    }
    44→    
    45→    // 文字颜色
    46→    var textColor: UIColor {
    47→        return .black  // 统一使用黑色文字
    48→    }
    49→    
    50→    // 获取边框尺寸
    51→    func getFrameDimensions(for imageSize: CGSize) -> FrameDimensions {
    52→        let baseFrameWidth = imageSize.width * 0.08  // 基础边框宽度为图片宽度的8%
    53→        
    54→        switch frameStyle {
    55→        case .uniform:
    56→            return FrameDimensions(
    57→                top: baseFrameWidth,
    58→                left: baseFrameWidth,
    59→                right: baseFrameWidth,
    60→                bottom: baseFrameWidth
    61→            )
    62→        case .bottomExpanded:
    63→            return FrameDimensions(
    64→                top: baseFrameWidth,
    65→                left: baseFrameWidth,
    66→                right: baseFrameWidth,
    67→                bottom: baseFrameWidth * 3  // 底部边框是其他边框的3倍
    68→            )
    69→        }
    70→    }
    71→    
    72→    // 获取最终画布尺寸
    73→    func getFinalCanvasSize(for imageSize: CGSize) -> CGSize {
    74→        let dimensions = getFrameDimensions(for: imageSize)
    75→        return CGSize(
    76→            width: imageSize.width + dimensions.left + dimensions.right,
    77→            height: imageSize.height + dimensions.top + dimensions.bottom
    78→        )
    79→    }
    80→    
    81→    // 获取图片在画布中的位置
    82→    func getImageRect(for imageSize: CGSize) -> CGRect {
    83→        let dimensions = getFrameDimensions(for: imageSize)
    84→        return CGRect(
    85→            x: dimensions.left,
    86→            y: dimensions.top,
    87→            width: imageSize.width,
    88→            height: imageSize.height
    89→        )
    90→    }
    91→}
    92→
    93→struct FrameDimensions {
    94→    let top: CGFloat
    95→    let left: CGFloat
    96→    let right: CGFloat
    97→    let bottom: CGFloat
    98→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Examine current watermark implementation to understand layout issues
- [X] 🌡️ Fix logo sizing - make it smaller to fit properly in left-right layout
- [⚡] 🌡️ Add left and right margins/padding to prevent content overflow
- [ ] 🌡️ Implement dynamic border width settings for all four sides


_**Agent (claude-sonnet-4-20250514)**_

Now I'll make the necessary improvements. Based on your feedback and the image you shared, I need to:

1. **Fix logo sizing** - The logo is too large in left-right layout
2. **Add margins** - Prevent content overflow on left and right sides  
3. **Dynamic border widths** - Support setting individual border widths for top, left, right, bottom

Let me start by updating the FrameStyle configuration to support dynamic border widths:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    89→        )
    90→    }
    91→}
    92→
    93→struct FrameDimensions {
    94→    let top: CGFloat
    95→    let left: CGFloat
    96→    let right: CGFloat
    97→    let bottom: CGFloat
    98→    
    99→    // 支持动态设置的构造函数
   100→    init(top: CGFloat = 0, left: CGFloat = 0, right: CGFloat = 0, bottom: CGFloat = 0) {
   101→        self.top = top
   102→        self.left = left
   103→        self.right = right
   104→        self.bottom = bottom
   105→    }
   106→}
```

_**Agent (claude-sonnet-4-20250514)**_

Now I need to add dynamic border width settings to WatermarkSettings:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     8→    var showShutterSpeed: Bool = true
     9→    var showISO: Bool = true
    10→    var showDate: Bool = true
    11→    
    12→    // 品牌边框设置
    13→    var brandFrame: BrandFrame = .none
    14→    var enableBrandFrame: Bool = false
    15→    var frameStyle: FrameStyle = .uniform
    16→    var frameContentLayout: FrameContentLayout = .center
    17→    
    18→    // 动态边框宽度设置（占图片宽度的百分比）
    19→    var customFrameWidths: FrameDimensions = FrameDimensions(top: 0.08, left: 0.08, right: 0.08, bottom: 0.08)
    20→    var useCustomFrameWidths: Bool = false
    21→    
    22→    static let shared = WatermarkSettings()
    23→    
    24→    func save() {
```

_**Agent (claude-sonnet-4-20250514)**_

Now update the FrameConfiguration to support custom border widths:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    31→        }
    32→    }
    33→}
    34→
    35→struct FrameConfiguration {
    36→    let frameStyle: FrameStyle
    37→    let contentLayout: FrameContentLayout
    38→    let brandFrame: BrandFrame
    39→    let customFrameWidths: FrameDimensions?
    40→    let useCustomFrameWidths: Bool
    41→    
    42→    // 边框颜色
    43→    var frameColor: UIColor {
    44→        return .white  // 统一使用白色边框
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    48→    var textColor: UIColor {
    49→        return .black  // 统一使用黑色文字
    50→    }
    51→    
    52→    // 获取边框尺寸
    53→    func getFrameDimensions(for imageSize: CGSize) -> FrameDimensions {
    54→        // 如果启用了自定义边框宽度，使用自定义设置
    55→        if useCustomFrameWidths, let customWidths = customFrameWidths {
    56→            return FrameDimensions(
    57→                top: imageSize.width * customWidths.top,
    58→                left: imageSize.width * customWidths.left,
    59→                right: imageSize.width * customWidths.right,
    60→                bottom: imageSize.width * customWidths.bottom
    61→            )
    62→        }
    63→        
    64→        // 否则使用默认逻辑
    65→        let baseFrameWidth = imageSize.width * 0.08  // 基础边框宽度为图片宽度的8%
    66→        
    67→        switch frameStyle {
    68→        case .uniform:
    69→            return FrameDimensions(
    70→                top: baseFrameWidth,
    71→                left: baseFrameWidth,
    72→                right: baseFrameWidth,
    73→                bottom: baseFrameWidth
    74→            )
    75→        case .bottomExpanded:
    76→            return FrameDimensions(
    77→                top: baseFrameWidth,
    78→                left: baseFrameWidth,
    79→                right: baseFrameWidth,
    80→                bottom: baseFrameWidth * 3  // 底部边框是其他边框的3倍
    81→            )
    82→        }
    83→    }
    84→    
    85→    // 获取最终画布尺寸
    86→    func getFinalCanvasSize(for imageSize: CGSize) -> CGSize {
    87→        let dimensions = getFrameDimensions(for: imageSize)
```

_**Agent (claude-sonnet-4-20250514)**_

Now update the BrandFrameService to use the new settings and fix the logo sizing issues:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    56→            finalImageSize = originalSize
    57→            print("  - 保持原始比例")
    58→        }
    59→        
    60→        // 创建边框配置
    61→        let frameConfig = FrameConfiguration(
    62→            frameStyle: settings.frameStyle,
    63→            contentLayout: settings.frameContentLayout,
    64→            brandFrame: brandFrame,
    65→            customFrameWidths: settings.customFrameWidths,
    66→            useCustomFrameWidths: settings.useCustomFrameWidths
    67→        )
    68→        
    69→        // 计算最终画布尺寸（基于处理后的图片）
    70→        let canvasSize = frameConfig.getFinalCanvasSize(for: finalImageSize)
    71→        let imageRect = frameConfig.getImageRect(for: finalImageSize)
```

_**Agent (claude-sonnet-4-20250514)**_

Now I need to fix the logo sizing in the left-right layout and add proper padding:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   140→        print("    📏 等宽边框 - 底部框高度: \(bottomFrameHeight)")
   141→        
   142→        guard let logoImage = loadBrandLogo(frameConfig.brandFrame) else { return }
   143→        
   144→        // 计算Logo和文字的尺寸
   145→        let logoHeight = bottomFrameHeight * 0.18  // 进一步减小Logo高度
   146→        let logoAspectRatio = logoImage.size.width / logoImage.size.height
   147→        let logoWidth = logoHeight * logoAspectRatio
   148→        
   149→        let infoText = buildCaptureInfoText(captureSettings)
   150→        let fontSize = bottomFrameHeight * 0.10  // 进一步减小字体大小
   151→        let font = UIFont.systemFont(ofSize: fontSize, weight: .medium)
   152→        
   153→        let textAttributes: [NSAttributedString.Key: Any] = [
   154→            .font: font,
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   198→        print("    📏 底部加宽边框 - 底部框高度: \(bottomFrameHeight)")
   199→        
   200→        guard let logoImage = loadBrandLogo(frameConfig.brandFrame) else { return }
   201→        
   202→        // 根据参考图片优化尺寸 - 大幅减小Logo以适应左右布局
   203→        let logoHeight = bottomFrameHeight * 0.15  // 大幅减小Logo高度
   204→        let logoAspectRatio = logoImage.size.width / logoImage.size.height
   205→        let logoWidth = logoHeight * logoAspectRatio
   206→        
   207→        let infoText = buildCaptureInfoText(captureSettings)
   208→        let fontSize = bottomFrameHeight * 0.06  // 大幅减小字体大小
   209→        let font = UIFont.systemFont(ofSize: fontSize, weight: .medium)
   210→        
   211→        let textAttributes: [NSAttributedString.Key: Any] = [
   212→            .font: font,
```

_**Agent (claude-sonnet-4-20250514)**_

Now I need to add proper left and right margins to prevent content overflow:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   244→            
   245→            print("    🏷️ 居中布局 - Logo: \(logoRect), 文字: \(textRect)")
   246→            print("    📐 间距: \(contentSpacing), 总高度: \(totalContentHeight)")
   247→            
   248→        case .leftRight:
   249→            // 左右排列：Logo在左，文字在右，保持在底部框垂直居中
   250→            let horizontalPadding = bottomFrameHeight * 0.12  // 增加左右边距
   251→            let centerY = bottomAreaY + bottomFrameHeight / 2
   252→            
   253→            // 确保Logo和文字不会超出边界 - 计算可用宽度
   254→            let availableWidth = canvasSize.width - (horizontalPadding * 2)
   255→            let logoAndTextWidth = logoWidth + textSize.width
   256→            
   257→            // 如果内容太宽，进一步调整Logo尺寸
   258→            let finalLogoWidth: CGFloat
   259→            let finalLogoHeight: CGFloat
   260→            if logoAndTextWidth > availableWidth * 0.9 {  // 留出10%的缓冲
   261→                let maxLogoWidth = availableWidth * 0.4  // Logo最多占40%宽度
   262→                if logoWidth > maxLogoWidth {
   263→                    finalLogoWidth = maxLogoWidth
   264→                    finalLogoHeight = finalLogoWidth / logoAspectRatio
   265→                } else {
   266→                    finalLogoWidth = logoWidth
   267→                    finalLogoHeight = logoHeight
   268→                }
   269→            } else {
   270→                finalLogoWidth = logoWidth
   271→                finalLogoHeight = logoHeight
   272→            }
   273→            
   274→            // Logo在左侧垂直居中，确保不超出边界
   275→            let logoRect = CGRect(
   276→                x: horizontalPadding,
   277→                y: centerY - finalLogoHeight / 2,
   278→                width: finalLogoWidth,
   279→                height: finalLogoHeight
   280→            )
   281→            
   282→            // 文字在右侧垂直居中，确保不超出边界
   283→            let textRect = CGRect(
   284→                x: max(logoRect.maxX + horizontalPadding * 0.5, canvasSize.width - textSize.width - horizontalPadding),
   285→                y: centerY - textSize.height / 2,
   286→                width: min(textSize.width, canvasSize.width - logoRect.maxX - horizontalPadding * 1.5),
   287→                height: textSize.height
   288→            )
   289→            
   290→            logoImage.draw(in: logoRect)
   291→            infoText.draw(in: textRect, withAttributes: textAttributes)
   292→
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Examine current watermark implementation to understand layout issues
- [X] 🌡️ Fix logo sizing - make it smaller to fit properly in left-right layout
- [X] 🌡️ Add left and right margins/padding to prevent content overflow
- [⚡] 🌡️ Implement dynamic border width settings for all four sides


_**Agent (claude-sonnet-4-20250514)**_

Now let me add UI controls to the settings view for dynamic border width configuration:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    45→                            .cornerRadius(8)
    46→                    }
    47→                }
    48→                
    49→                if settings.enableBrandFrame {
    50→                    Section(header: Text("边框宽度设置")) {
    51→                        Toggle("自定义边框宽度", isOn: $settings.useCustomFrameWidths)
    52→                        
    53→                        if settings.useCustomFrameWidths {
    54→                            VStack(alignment: .leading, spacing: 12) {
    55→                                HStack {
    56→                                    Text("上边框")
    57→                                        .frame(width: 60, alignment: .leading)
    58→                                    Slider(
    59→                                        value: Binding(
    60→                                            get: { settings.customFrameWidths.top },
    61→                                            set: { newValue in
    62→                                                settings.customFrameWidths = FrameDimensions(
    63→                                                    top: newValue,
    64→                                                    left: settings.customFrameWidths.left,
    65→                                                    right: settings.customFrameWidths.right,
    66→                                                    bottom: settings.customFrameWidths.bottom
    67→                                                )
    68→                                            }
    69→                                        ),
    70→                                        in: 0.02...0.2,
    71→                                        step: 0.01
    72→                                    )
    73→                                    Text("\(Int(settings.customFrameWidths.top * 100))%")
    74→                                        .frame(width: 40)
    75→                                }
    76→                                
    77→                                HStack {
    78→                                    Text("左边框")
    79→                                        .frame(width: 60, alignment: .leading)
    80→                                    Slider(
    81→                                        value: Binding(
    82→                                            get: { settings.customFrameWidths.left },
    83→                                            set: { newValue in
    84→                                                settings.customFrameWidths = FrameDimensions(
    85→                                                    top: settings.customFrameWidths.top,
    86→                                                    left: newValue,
    87→                                                    right: settings.customFrameWidths.right,
    88→                                                    bottom: settings.customFrameWidths.bottom
    89→                                                )
    90→                                            }
    91→                                        ),
    92→                                        in: 0.02...0.2,
    93→                                        step: 0.01
    94→                                    )
    95→                                    Text("\(Int(settings.customFrameWidths.left * 100))%")
    96→                                        .frame(width: 40)
    97→                                }
    98→                                
    99→                                HStack {
   100→                                    Text("右边框")
   101→                                        .frame(width: 60, alignment: .leading)
   102→                                    Slider(
   103→                                        value: Binding(
   104→                                            get: { settings.customFrameWidths.right },
   105→                                            set: { newValue in
   106→                                                settings.customFrameWidths = FrameDimensions(
   107→                                                    top: settings.customFrameWidths.top,
   108→                                                    left: settings.customFrameWidths.left,
   109→                                                    right: newValue,
   110→                                                    bottom: settings.customFrameWidths.bottom
   111→                                                )
   112→                                            }
   113→                                        ),
   114→                                        in: 0.02...0.2,
   115→                                        step: 0.01
   116→                                    )
   117→                                    Text("\(Int(settings.customFrameWidths.right * 100))%")
   118→                                        .frame(width: 40)
   119→                                }
   120→                                
   121→                                HStack {
   122→                                    Text("下边框")
   123→                                        .frame(width: 60, alignment: .leading)
   124→                                    Slider(
   125→                                        value: Binding(
   126→                                            get: { settings.customFrameWidths.bottom },
   127→                                            set: { newValue in
   128→                                                settings.customFrameWidths = FrameDimensions(
   129→                                                    top: settings.customFrameWidths.top,
   130→                                                    left: settings.customFrameWidths.left,
   131→                                                    right: settings.customFrameWidths.right,
   132→                                                    bottom: newValue
   133→                                                )
   134→                                            }
   135→                                        ),
   136→                                        in: 0.02...0.3,
   137→                                        step: 0.01
   138→                                    )
   139→                                    Text("\(Int(settings.customFrameWidths.bottom * 100))%")
   140→                                        .frame(width: 40)
   141→                                }
   142→                            }
   143→                            .padding(.horizontal, 8)
   144→                        }
   145→                    }
   146→                    
   147→                    Section(header: Text("品牌边框预览")) {
   148→                        BrandFramePreview(
   149→                            frame: settings.brandFrame,
   150→                            frameStyle: settings.frameStyle,
   151→                            contentLayout: settings.frameContentLayout
   152→                        )
   153→                        .frame(maxWidth: .infinity, alignment: .center)
   154→                    }
   155→                }
   156→            }
   157→            .navigationTitle("水印设置")
   158→            .navigationBarItems(
   159→                leading: Button("取消") {
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Examine current watermark implementation to understand layout issues
- [X] 🌡️ Fix logo sizing - make it smaller to fit properly in left-right layout
- [X] 🌡️ Add left and right margins/padding to prevent content overflow
- [X] 🌡️ Implement dynamic border width settings for all four sides


_**Agent (claude-sonnet-4-20250514)**_

Perfect! I've completed all the requested improvements to fix the watermark layout issues:

## ✅ 完成的优化

### 1. **Logo 尺寸调整**
- 等宽边框：Logo高度从 25% → 18%，字体从 12% → 10%
- 底部加宽边框：Logo高度从 20% → 15%，字体从 8% → 6%
- 左右布局时进一步智能调整，确保Logo不超过可用宽度的40%

### 2. **左右边距优化**
- 增加水平边距从 8% → 12%
- 添加智能布局检测，防止内容超出边界
- 在左右布局中，确保Logo和文字之间有合适的间距
- 文字位置计算考虑了Logo位置，避免重叠

### 3. **动态边框宽度设置**
- 新增 `customFrameWidths` 和 `useCustomFrameWidths` 配置项
- 支持分别设置上、下、左、右四条边的宽度（百分比）
- 在设置界面添加了滑块控制器：
  - 上/左/右边框：2%-20%
  - 下边框：2%-30%（支持更大的底部边框）
- 实时显示百分比数值

### 4. **改进的布局算法**
- 智能检测内容是否会溢出
- 动态调整Logo尺寸以适应可用空间
- 更精确的文字和Logo定位计算
- 保持垂直居中的同时确保水平不溢出

现在拍照时应该不会再出现Logo过大或左右溢出的问题，并且可以通过设置灵活调整边框宽度。

---

_**User**_

/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:3:8 Type 'WatermarkSettings' does not conform to protocol 'Decodable'


---

_**Agent (claude-sonnet-4-20250514)**_

I need to fix the Codable conformance issue. The problem is that `FrameDimensions` struct needs to conform to `Codable` protocol.

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   102→        )
   103→    }
   104→}
   105→
   106→struct FrameDimensions: Codable {
   107→    let top: CGFloat
   108→    let left: CGFloat
   109→    let right: CGFloat
   110→    let bottom: CGFloat
   111→    
   112→    // 支持动态设置的构造函数
   113→    init(top: CGFloat = 0, left: CGFloat = 0, right: CGFloat = 0, bottom: CGFloat = 0) {
   114→        self.top = top
   115→        self.left = left
   116→        self.right = right
   117→        self.bottom = bottom
   118→    }
   119→}
```

_**Agent (claude-sonnet-4-20250514)**_

Now let's build the project to make sure there are no other compilation errors:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** Build the project to check for compilation errors

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 15 Pro' clean build`

Error:

```
[Request interrupted by user for tool use]
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 15 Pro" clean build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES
```

_**User**_

[Request interrupted by user for tool use]

_**User**_

/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameSelectionView.swift:132:48 Missing arguments for parameters 'customFrameWidths', 'useCustomFrameWidths' in call


---

_**Agent (claude-sonnet-4-20250514)**_

I need to fix the missing parameters in the BrandFrameSelectionView. Let me check that file and update it:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/BrandFrameSelectionView.swift`

Result:

```
125→    let frameStyle: FrameStyle
   126→    let contentLayout: FrameContentLayout
   127→    let imageSize: CGSize = CGSize(width: 160, height: 120)
   128→    
   129→    var body: some View {
   130→        VStack(spacing: 8) {
   131→            ZStack {
   132→                let config = FrameConfiguration(
   133→                    frameStyle: frameStyle,
   134→                    contentLayout: contentLayout,
   135→                    brandFrame: frame
   136→                )
   137→                
   138→                let finalSize = config.getFinalCanvasSize(for: imageSize)
   139→                let imageRect = config.getImageRect(for: imageSize)
   140→                
   141→                // 白色边框背景
   142→                Rectangle()
   143→                    .fill(Color.white)
   144→                    .frame(width: finalSize.width / 4, height: finalSize.height / 4)
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameSelectionView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   128→    
   129→    var body: some View {
   130→        VStack(spacing: 8) {
   131→            ZStack {
   132→                let config = FrameConfiguration(
   133→                    frameStyle: frameStyle,
   134→                    contentLayout: contentLayout,
   135→                    brandFrame: frame,
   136→                    customFrameWidths: FrameDimensions(top: 0.08, left: 0.08, right: 0.08, bottom: 0.08),
   137→                    useCustomFrameWidths: false
   138→                )
   139→                
   140→                let finalSize = config.getFinalCanvasSize(for: imageSize)
   141→                let imageRect = config.getImageRect(for: imageSize)
   142→
```

_**Agent (claude-sonnet-4-20250514)**_

Now let me check if there are any other places where FrameConfiguration is initialized without the new parameters:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameSelectionView.swift:                let config = FrameConfiguration(
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/BrandFrameService.swift:        let frameConfig = FrameConfiguration(
```

_**Agent (claude-sonnet-4-20250514)**_

Good, both places have been updated. Now let's try building again to see if there are any other issues:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** Build the project to check for remaining compilation errors

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 15 Pro' build | head -50`

Error:

```
[Request interrupted by user for tool use]
```

_**User**_

[Request interrupted by user for tool use]

_**User**_

User provided an image (image/png).

边框设置调整一下吧.[Image #1]参考这个图片,白色部分是边框,灰色是照片.灰色圆形代表的是 logo,灰色横条代表的是拍摄信息.边框按照图片中的比例进行设置.你可以重新现在 的边框设置.

---

_**Agent (claude-sonnet-4-20250514)**_

我来根据您提供的参考图片重新设计边框设置。从图片中我可以看到6种不同的边框样式，每种都有不同的边框比例和内容布局。

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [ ] 🌡️ 分析参考图片中的6种边框样式和比例
- [ ] 🌡️ 重新设计FrameStyle枚举以匹配参考图片
- [ ] 🌡️ 更新边框尺寸计算逻辑
- [ ] 🌡️ 更新UI选择界面以展示新的边框样式


_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析参考图片中的6种边框样式和比例
- [⚡] 🌡️ 重新设计FrameStyle枚举以匹配参考图片
- [ ] 🌡️ 更新边框尺寸计算逻辑
- [ ] 🌡️ 更新UI选择界面以展示新的边框样式


_**Agent (claude-sonnet-4-20250514)**_

根据参考图片，我识别出6种不同的边框样式：

1. **左上角样式**: 窄边框，Logo在左上角
2. **底部居中样式**: 底部较宽，Logo和文字居中排列
3. **等宽边框样式**: 四周等宽，底部Logo和文字居中（当前选中的红框）
4. **左右分布样式**: 窄边框，Logo在左侧，文字在右侧
5. **底部左右样式**: 底部较宽，Logo在左下，文字在右下
6. **右侧竖排样式**: 右侧加宽，Logo和文字竖向排列

让我重新设计FrameStyle来匹配这些样式：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FrameStyle.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import Foundation
     2→import UIKit
     3→
     4→enum FrameStyle: String, CaseIterable, Codable {
     5→    case topLeftCorner = "topLeftCorner"           // 左上角样式
     6→    case bottomCentered = "bottomCentered"         // 底部居中样式
     7→    case uniform = "uniform"                       // 等宽边框样式
     8→    case sideDistributed = "sideDistributed"       // 左右分布样式
     9→    case bottomLeftRight = "bottomLeftRight"       // 底部左右样式
    10→    case rightExpanded = "rightExpanded"           // 右侧加宽样式
    11→    
    12→    var displayName: String {
    13→        switch self {
    14→        case .topLeftCorner: return "左上角"
    15→        case .bottomCentered: return "底部居中"
    16→        case .uniform: return "等宽边框"
    17→        case .sideDistributed: return "左右分布"
    18→        case .bottomLeftRight: return "底部左右"
    19→        case .rightExpanded: return "右侧加宽"
    20→        }
    21→    }
    22→    
    23→    var description: String {
    24→        switch self {
    25→        case .topLeftCorner: return "窄边框，Logo在左上角"
    26→        case .bottomCentered: return "底部较宽，Logo和文字居中纵向排列"
    27→        case .uniform: return "四周等宽边框，Logo和参数放在底部中央"
    28→        case .sideDistributed: return "窄边框，Logo在左侧，文字在右侧"
    29→        case .bottomLeftRight: return "底部较宽，Logo在左下，文字在右下"
    30→        case .rightExpanded: return "右侧加宽，Logo和文字竖向排列"
    31→        }
    32→    }
    33→}
    34→
    35→enum FrameContentLayout: String, CaseIterable, Codable {
    36→    case center = "center"         // 居中排列
    37→    case leftRight = "leftRight"   // 左右排列
```

_**Agent (claude-sonnet-4-20250514)**_

现在更新边框尺寸计算逻辑，根据参考图片中的比例：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析参考图片中的6种边框样式和比例
- [X] 🌡️ 重新设计FrameStyle枚举以匹配参考图片
- [⚡] 🌡️ 更新边框尺寸计算逻辑
- [ ] 🌡️ 更新UI选择界面以展示新的边框样式


_**User**_

[Request interrupted by user]

