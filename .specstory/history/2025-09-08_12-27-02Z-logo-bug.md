<!-- Generated by SpecStory -->

# Debugging Complex Web App Authentication and Performance (2025-09-08 12:27:02Z)

<!-- Claude Code Session 8ac18f50-4cf3-4ee0-8046-9a76a09ebc31 (2025-09-08_12-27-02Z) -->

_**User**_

全面排查代码,修复logo无法渲染到图片的bug

---

_**Agent (claude-sonnet-4-20250514)**_

哥，我来全面排查这个logo无法渲染到图片的bug。让我先建立一个任务清单来系统性地诊断这个问题。

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [ ] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [ ] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [ ] 🌡️ 验证WatermarkProcessor的logo处理机制
- [ ] 🌡️ 检查logo资源文件和路径问题
- [ ] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [⚡] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [ ] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [ ] 🌡️ 验证WatermarkProcessor的logo处理机制
- [ ] 🌡️ 检查logo资源文件和路径问题
- [ ] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

让我先找到DynamicLogoManager相关的文件，分析logo加载逻辑：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 4 files
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift
/Users/macongcong/Desktop/MC/MCCamera/LOGO_MANAGEMENT.md
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/DynamicLogoManager.swift`

Result:

```
1→import UIKit
     2→import SwiftUI
     3→
     4→// 动态Logo项目
     5→struct DynamicLogo: Identifiable, Hashable, CustomDebugStringConvertible {
     6→    let id = UUID()
     7→    let imageName: String
     8→    let displayName: String
     9→    let isAvailable: Bool
    10→    
    11→    init(imageName: String, displayName: String? = nil) {
    12→        self.imageName = imageName
    13→        self.displayName = displayName ?? DynamicLogoManager.generateDisplayName(from: imageName)
    14→        self.isAvailable = UIImage(named: imageName) != nil
    15→    }
    16→    
    17→    var debugDescription: String {
    18→        return "DynamicLogo(imageName: '\(imageName)', displayName: '\(displayName)', isAvailable: \(isAvailable))"
    19→    }
    20→}
    21→
    22→// 动态Logo管理器 - 自动扫描和管理所有Logo资源
    23→class DynamicLogoManager: ObservableObject {
    24→    static let shared = DynamicLogoManager()
    25→    
    26→    @Published private(set) var availableLogos: [DynamicLogo] = []
    27→    private var logoCache: [String: UIImage] = [:]
    28→    
    29→    // Logo名称到显示名称的映射表（可配置）
    30→    private let nameMapping: [String: String] = [
    31→        "Apple_logo_black": "Apple",
    32→        "Canon_wordmark": "Canon",
    33→        "Sony_logo": "Sony",
    34→        "Nikon_Logo": "Nikon",
    35→        "Leica_Camera_logo": "Leica",
    36→        "Fujifilm_logo": "Fujifilm",
    37→        "Hasselblad_logo": "Hasselblad",
    38→        "Hasselblad_logo_w": "Hasselblad W",
    39→        "Olympus_Corporation_logo": "Olympus",
    40→        "Panasonic_logo_(Blue)": "Panasonic",
    41→        "Zeiss_logo": "Zeiss",
    42→        "Arri_logo": "Arri",
    43→        "Panavision_logo": "Panavision",
    44→        "Polaroid_logo": "Polaroid",
    45→        "Ricoh_logo_2012": "Ricoh",
    46→        "Eastman_Kodak_Company_logo_(2016)(no_background)": "Kodak",
    47→        "dji-1": "DJI",
    48→        "hasu": "哈苏"
    49→    ]
    50→    
    51→    private init() {
    52→        scanAvailableLogos()
    53→    }
    54→    
    55→    // MARK: - Logo扫描和发现
    56→    
    57→    /// 扫描所有可用的Logo资源
    58→    func scanAvailableLogos() {
    59→        var logos: [DynamicLogo] = []
    60→        
    61→        // 添加"无Logo"选项
    62→        logos.append(DynamicLogo(imageName: "none", displayName: "无"))
    63→        
    64→        // 扫描已知的Logo列表（按使用频率和重要性排序）
    65→        let logoNames = [
    66→            // 专业品牌
    67→            "Hasselblad_logo",
    68→            "Hasselblad_logo_w",
    69→            "hasu",
    70→            "Zeiss_logo",
    71→            // 主流相机品牌（优先显示）
    72→            "Canon_wordmark",
    73→            "Sony_logo", 
    74→            "Nikon_Logo",
    75→            "Fujifilm_logo",
    76→            "Leica_Camera_logo",
    77→            
    78→
    79→            // 其他品牌
    80→            "Apple_logo_black",
    81→            "Olympus_Corporation_logo",
    82→            "Panasonic_logo_(Blue)",
    83→            "Ricoh_logo_2012",
    84→            
    85→            // 电影/专业设备
    86→            "Arri_logo",
    87→            "Panavision_logo",
    88→            
    89→            // 其他
    90→            "Polaroid_logo",
    91→            "Eastman_Kodak_Company_logo_(2016)(no_background)",
    92→            "dji-1"
    93→        ]
    94→        
    95→        for logoName in logoNames {
    96→            let logo = DynamicLogo(imageName: logoName)
    97→            if logo.isAvailable {
    98→                logos.append(logo)
    99→                print("✅ 发现Logo: \(logo.displayName) (\(logoName))")
   100→            } else {
   101→                print("⚠️ Logo不可用: \(logoName)")
   102→            }
   103→        }
   104→        
   105→        // 尝试自动发现更多Logo（通过常见的Logo品牌名称模式）
   106→        logos.append(contentsOf: discoverAdditionalLogos())
   107→        
   108→        DispatchQueue.main.async {
   109→            self.availableLogos = logos
   110→            print("📱 Logo管理器: 发现 \(logos.count) 个Logo资源")
   111→        }
   112→    }
   113→    
   114→    /// 尝试发现额外的Logo资源
   115→    private func discoverAdditionalLogos() -> [DynamicLogo] {
   116→        var additionalLogos: [DynamicLogo] = []
   117→        
   118→        // 常见的Logo品牌和可能的文件名模式
   119→        let brandPatterns = [
   120→            "xiaomi", "huawei", "samsung", "lg", "oneplus", 
   121→            "google", "microsoft", "adobe", "nvidia", "amd",
   122→            "pentax", "sigma", "tamron", "blackmagic", "red"
   123→        ]
   124→        
   125→        for brand in brandPatterns {
   126→            // 尝试不同的命名模式
   127→            let possibleNames = [
   128→                "\(brand)_logo",
   129→                "\(brand)_Logo",
   130→                "\(brand.capitalized)_logo",
   131→                "\(brand.capitalized)_Logo",
   132→                brand,
   133→                brand.capitalized
   134→            ]
   135→            
   136→            for name in possibleNames {
   137→                if UIImage(named: name) != nil {
   138→                    let logo = DynamicLogo(imageName: name, displayName: brand.capitalized)
   139→                    additionalLogos.append(logo)
   140→                    print("🔍 自动发现Logo: \(logo.displayName) (\(name))")
   141→                    break // 找到一个就跳出内层循环
   142→                }
   143→            }
   144→        }
   145→        
   146→        return additionalLogos
   147→    }
   148→    
   149→    // MARK: - Logo管理
   150→    
   151→    /// 加载指定的Logo图片
   152→    func loadLogo(_ logo: DynamicLogo) -> UIImage? {
   153→        // 特殊处理"无"选项
   154→        if logo.imageName == "none" {
   155→            return nil
   156→        }
   157→        
   158→        // 检查缓存
   159→        if let cachedLogo = logoCache[logo.imageName] {
   160→            return cachedLogo
   161→        }
   162→        
   163→        // 从Bundle加载图片
   164→        guard let image = UIImage(named: logo.imageName) else {
   165→            print("⚠️ DynamicLogoManager: 无法加载Logo图片 '\(logo.imageName)'")
   166→            return nil
   167→        }
   168→        
   169→        // 预处理Logo图片
   170→        let processedImage = preprocessLogo(image)
   171→        
   172→        // 缓存处理后的图片
   173→        logoCache[logo.imageName] = processedImage
   174→        
   175→        return processedImage
   176→    }
   177→    
   178→    /// 预处理Logo图片
   179→    private func preprocessLogo(_ image: UIImage) -> UIImage {
   180→        let maxSize: CGFloat = 200
   181→        
   182→        if max(image.size.width, image.size.height) <= maxSize {
   183→            return image
   184→        }
   185→        
   186→        // 缩放图片到合适大小
   187→        let scale = maxSize / max(image.size.width, image.size.height)
   188→        let newSize = CGSize(
   189→            width: image.size.width * scale,
   190→            height: image.size.height * scale
   191→        )
   192→        
   193→        let renderer = UIGraphicsImageRenderer(size: newSize)
   194→        return renderer.image { _ in
   195→            image.draw(in: CGRect(origin: .zero, size: newSize))
   196→        }
   197→    }
   198→    
   199→    // MARK: - 辅助方法
   200→    
   201→    /// 根据文件名生成显示名称
   202→    static func generateDisplayName(from imageName: String) -> String {
   203→        // 处理特殊情况
   204→        if imageName == "none" { return "无" }
   205→        
   206→        // 移除常见的后缀
   207→        let cleaned = imageName
   208→            .replacingOccurrences(of: "_logo", with: "")
   209→            .replacingOccurrences(of: "_Logo", with: "")
   210→            .replacingOccurrences(of: "_wordmark", with: "")
   211→            .replacingOccurrences(of: "_Corporation_logo", with: "")
   212→        
   213→        // 处理特殊字符和格式
   214→        let formatted = cleaned
   215→            .replacingOccurrences(of: "_", with: " ")
   216→            .replacingOccurrences(of: "(Blue)", with: "")
   217→            .replacingOccurrences(of: "(2016)(no_background)", with: "")
   218→            .trimmingCharacters(in: .whitespacesAndNewlines)
   219→        
   220→        return formatted.isEmpty ? imageName : formatted
   221→    }
   222→    
   223→    /// 获取Logo对象通过图片名称
   224→    func getLogo(by imageName: String) -> DynamicLogo? {
   225→        return availableLogos.first { $0.imageName == imageName }
   226→    }
   227→    
   228→    /// 刷新Logo列表
   229→    func refresh() {
   230→        scanAvailableLogos()
   231→    }
   232→    
   233→    /// 清理缓存
   234→    func clearCache() {
   235→        logoCache.removeAll()
   236→    }
   237→}
   238→
   239→// MARK: - SwiftUI Extensions
   240→
   241→extension DynamicLogoManager {
   242→    /// 为SwiftUI提供的Logo视图
   243→    func logoView(for logo: DynamicLogo, size: CGSize = CGSize(width: 24, height: 24)) -> some View {
   244→        Group {
   245→            if let logoImage = loadLogo(logo) {
   246→                Image(uiImage: logoImage)
   247→                    .resizable()
   248→                    .aspectRatio(contentMode: .fit)
   249→                    .frame(width: size.width, height: size.height)
   250→            } else if logo.imageName == "none" {
   251→                // "无Logo"的特殊显示
   252→                Image(systemName: "xmark")
   253→                    .font(.system(size: size.height * 0.6))
   254→                    .foregroundColor(.gray)
   255→                    .frame(width: size.width, height: size.height)
   256→            } else {
   257→                // 备用显示
   258→                Text(logo.displayName.prefix(1))
   259→                    .font(.system(size: size.height * 0.6, weight: .bold))
   260→                    .frame(width: size.width, height: size.height)
   261→                    .background(Color.gray.opacity(0.3))
   262→                    .cornerRadius(size.width * 0.1)
   263→            }
   264→        }
   265→    }
   266→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在检查WatermarkService中如何使用DynamicLogoManager：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkService.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→import Foundation
     4→
     5→class WatermarkService {
     6→    static let shared = WatermarkService()
     7→    
     8→    private init() {}
     9→    
    10→    // 获取当前界面方向
    11→    private func getCurrentInterfaceOrientation() -> String {
    12→        let interfaceOrientation = UIApplication.shared.connectedScenes
    13→            .compactMap { $0 as? UIWindowScene }
    14→            .first?.interfaceOrientation ?? .portrait
    15→        
    16→        switch interfaceOrientation {
    17→        case .portrait:
    18→            return "竖屏"
    19→        case .portraitUpsideDown:
    20→            return "倒立竖屏"
    21→        case .landscapeLeft:
    22→            return "左横屏"
    23→        case .landscapeRight:
    24→            return "右横屏"
    25→        default:
    26→            return "未知"
    27→        }
    28→    }
    29→    
    30→    func addWatermark(to image: UIImage, with captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) -> UIImage? {
    31→        // 🚀 优化：使用autoreleasepool包围整个水印处理过程
    32→        return autoreleasepool {
    33→            let settings = WatermarkSettings.load()
    34→            
    35→            // 检测图像方向
    36→            let isLandscape = image.size.width > image.size.height
    37→            let currentOrientation = getCurrentInterfaceOrientation()
    38→            
    39→            print("🎨 WatermarkService.addWatermark 被调用")
    40→            print("  - 设置启用: \(settings.isEnabled)")
    41→            print("  - 水印样式: \(settings.watermarkStyle.displayName)")
    42→            print("  - 作者名字: '\(settings.authorName)'")
    43→            print("  - 图像尺寸: \(image.size)")
    44→            print("  - 图像方向: \(isLandscape ? "横屏" : "竖屏")")
    45→            print("  - 界面方向: \(currentOrientation)")
    46→            
    47→            guard settings.isEnabled else { 
    48→                print("  - 水印未启用，返回原图")
    49→                return image 
    50→            }
    51→            
    52→            // 🚀 优化：检查图像大小，降低阈值以便更多图像使用优化路径
    53→            let imageArea = image.size.width * image.size.height
    54→            let megapixels = Int(imageArea / 1_000_000)
    55→            
    56→            // 🚀 关键修复：降低阈值到8MP，让12MP图像也使用优化绘制
    57→            if megapixels > 8 {
    58→                print("  ⚠️ 大图像(\(megapixels)MP)，使用优化的水印绘制")
    59→                return drawWatermarkOptimized(image: image, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio, isLandscape: isLandscape)
    60→            }
    61→            
    62→            // 🚀 统一水印绘制（包装在autoreleasepool中）
    63→            var result: UIImage?
    64→            autoreleasepool {
    65→                let renderer = UIGraphicsImageRenderer(size: image.size)
    66→                
    67→                print("  - 开始绘制统一水印...")
    68→                result = renderer.image { context in
    69→                    image.draw(at: CGPoint.zero)
    70→                    
    71→                    let rect = CGRect(origin: CGPoint.zero, size: image.size)
    72→                    
    73→                    // 🎨 统一使用专业垂直水印样式
    74→                    drawProfessionalVerticalWatermark(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio, isLandscape: isLandscape)
    75→                }
    76→            }
    77→            
    78→            print("  ✅ 水印绘制完成")
    79→            return result
    80→        }
    81→    }
    82→    
    83→    // 🚀 新增：优化的水印绘制方法，用于超大图像
    84→    private func drawWatermarkOptimized(image: UIImage, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio?, isLandscape: Bool) -> UIImage? {
    85→        return autoreleasepool {
    86→            print("  🎨 使用优化水印绘制")
    87→            
    88→            // 对于超大图像，使用更高效的绘制方式
    89→            let format = UIGraphicsImageRendererFormat()
    90→            format.scale = 1.0 // 使用1.0缩放因子减少内存使用
    91→            format.opaque = false
    92→            
    93→            let renderer = UIGraphicsImageRenderer(size: image.size, format: format)
    94→            
    95→            return renderer.image { context in
    96→                // 绘制原图
    97→                image.draw(at: CGPoint.zero)
    98→                
    99→                // 绘制水印（简化版本）
   100→                let rect = CGRect(origin: CGPoint.zero, size: image.size)
   101→                
   102→                // 🎨 使用简化版统一水印样式
   103→                drawProfessionalVerticalWatermarkSimplified(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio, isLandscape: isLandscape)
   104→            }
   105→        }
   106→    }
   107→    
   108→    
   109→    // 🚀 新增：超快速文字绘制方法，只有白色文字和轻微阴影
   110→    private func drawTextSimplified(_ text: String, font: UIFont, at point: CGPoint) {
   111→        // 使用简单的阴影效果替代描边，大大提升性能
   112→        let shadowOffset = CGSize(width: 1, height: 1)
   113→        
   114→        // 绘制阴影
   115→        let shadowAttributes: [NSAttributedString.Key: Any] = [
   116→            .font: font,
   117→            .foregroundColor: UIColor.black.withAlphaComponent(0.3),
   118→        ]
   119→        
   120→        let shadowString = NSAttributedString(string: text, attributes: shadowAttributes)
   121→        let shadowRect = CGRect(x: point.x + shadowOffset.width, y: point.y + shadowOffset.height, width: 1000, height: font.lineHeight)
   122→        shadowString.draw(in: shadowRect)
   123→        
   124→        // 绘制主文字
   125→        let textAttributes: [NSAttributedString.Key: Any] = [
   126→            .font: font,
   127→            .foregroundColor: UIColor.white
   128→        ]
   129→        
   130→        let attributedString = NSAttributedString(string: text, attributes: textAttributes)
   131→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   132→        attributedString.draw(in: textRect)
   133→    }
   134→    
   135→    
   136→    
   137→    private func formatShutterSpeed(_ speed: Double) -> String {
   138→        if speed >= 1.0 {
   139→            return String(format: "%.0fs", speed)
   140→        } else {
   141→            let denominator = Int(1.0 / speed)
   142→            return "1/\(denominator)s"
   143→        }
   144→    }
   145→    
   146→    // MARK: - 专业垂直水印渲染
   147→    
   148→    // 🚀 新增：专业垂直水印绘制方法
   149→    private func drawProfessionalVerticalWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio?, isLandscape: Bool) {
   150→        context.saveGState()
   151→        
   152→        // 确定有效绘制区域
   153→        let effectiveRect: CGRect
   154→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
   155→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
   156→        } else {
   157→            effectiveRect = rect
   158→        }
   159→        
   160→        // 计算基本参数 - 横屏适配
   161→        let baseSize = min(effectiveRect.width, effectiveRect.height)
   162→        let logoSize = baseSize * (isLandscape ? 0.035 : 0.04)      // Logo大小
   163→        let titleFontSize = baseSize * (isLandscape ? 0.024 : 0.028)  // 设备名字体大小
   164→        let lineFontSize = baseSize * (isLandscape ? 0.020 : 0.024)   // 其他行字体大小
   165→        let lineSpacing = baseSize * 0.012    // 行间距
   166→        let bottomPadding = baseSize * (isLandscape ? 0.04 : 0.05)   // 底部边距
   167→        
   168→        // 字体定义
   169→        let titleFont = UIFont.systemFont(ofSize: titleFontSize, weight: .medium)
   170→        let lineFont = UIFont.systemFont(ofSize: lineFontSize, weight: .regular)
   171→        
   172→        // 获取水印内容
   173→        let watermarkContent = buildWatermarkContent(settings: settings, captureSettings: captureSettings)
   174→        
   175→        // 计算总高度
   176→        var totalHeight: CGFloat = 0
   177→        var lineHeights: [CGFloat] = []
   178→        
   179→        if settings.showLogoLine && settings.selectedLogo != .none {
   180→            lineHeights.append(logoSize)
   181→            totalHeight += logoSize + lineSpacing
   182→        }
   183→        
   184→        for content in watermarkContent {
   185→            if !content.isEmpty {
   186→                let font = content == watermarkContent.first ? titleFont : lineFont
   187→                lineHeights.append(font.lineHeight)
   188→                totalHeight += font.lineHeight + lineSpacing
   189→            }
   190→        }
   191→        
   192→        if totalHeight > 0 {
   193→            totalHeight -= lineSpacing // 移除最后一个间距
   194→        }
   195→        
   196→        // 🎨 计算起始Y位置 - 统一使用底部对齐，位置差异通过X坐标体现
   197→        let startY = effectiveRect.maxY - bottomPadding - totalHeight
   198→        
   199→        // 计算X位置
   200→        let centerX = effectiveRect.midX
   201→        let leftX = effectiveRect.minX + baseSize * 0.05
   202→        let rightX = effectiveRect.maxX - baseSize * 0.05
   203→        
   204→        var currentY = startY
   205→        var lineIndex = 0
   206→        
   207→        // 绘制Logo行 - 支持DynamicLogoManager
   208→        print("🎨 WatermarkService Logo渲染检查:")
   209→        print("  - showLogoLine: \(settings.showLogoLine)")
   210→        print("  - selectedLogo: \(settings.selectedLogo)")
   211→        print("  - selectedLogo != .none: \(settings.selectedLogo != .none)")
   212→        
   213→        if settings.showLogoLine && settings.selectedLogo != .none {
   214→            let logoY = currentY
   215→            
   216→            // 🔧 重大修复：使用DynamicLogoManager替代旧的LogoManager
   217→            let logoImage: UIImage?
   218→            
   219→            // 首先尝试通过BrandLogo的imageName查找DynamicLogo
   220→            if let brandLogoImageName = settings.selectedLogo.imageName,
   221→               let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   222→                logoImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   223→                print("  🔄 WatermarkService: 使用DynamicLogoManager加载Logo: '\(brandLogoImageName)' -> \(logoImage != nil ? "成功" : "失败")")
   224→            } else {
   225→                // 备用：尝试使用老的LogoManager
   226→                logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   227→                print("  ⚠️ WatermarkService: 回退到LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   228→            }
   229→            
   230→            if let logoImage = logoImage {
   231→                // 🔧 修复：保持Logo的真实宽高比，88px最大宽度限制，按比例调整高度
   232→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
   233→                let maxLogoWidth: CGFloat = 488 // 最大宽度488px
   234→                
   235→                // 根据88px限制计算实际尺寸
   236→                let logoWidth = min(logoSize * logoAspectRatio, maxLogoWidth)
   237→                let logoHeight = logoWidth / logoAspectRatio
   238→                
   239→                // 🎨 使用新的Logo位置设置
   240→                let logoX: CGFloat
   241→                switch settings.logoPosition {
   242→                case .left:
   243→                    logoX = leftX
   244→                case .right:
   245→                    logoX = rightX - logoWidth // 使用实际计算的宽度
   246→                case .center:
   247→                    logoX = centerX - logoWidth / 2 // 使用实际计算的宽度
   248→                }
   249→                
   250→                let logoRect = CGRect(
   251→                    x: logoX,
   252→                    y: logoY,
   253→                    width: logoWidth, // 使用按比例计算的宽度（488px限制）
   254→                    height: logoHeight // 使用按比例计算的高度
   255→                )
   256→                logoImage.draw(in: logoRect)
   257→                
   258→                print("  🎨 Logo绘制成功: 位置=\(settings.position.displayName), 原始尺寸=\(logoImage.size), 渲染尺寸=\(logoRect.size), 宽高比=\(String(format: "%.2f", logoAspectRatio))")
   259→            } else {
   260→                print("  ❌ Logo加载失败: \(settings.selectedLogo.displayName) (imageName: \(settings.selectedLogo.imageName ?? "nil"))")
   261→            }
   262→            
   263→            currentY += lineHeights[lineIndex] + lineSpacing
   264→            lineIndex += 1
   265→        }
   266→        
   267→        // 绘制文字行
   268→        for content in watermarkContent where !content.isEmpty {
   269→            let font = content == watermarkContent.first ? titleFont : lineFont
   270→            let textSize = content.size(withAttributes: [.font: font])
   271→            
   272→            // 🎨 使用新的信息位置设置
   273→            let textX: CGFloat
   274→            switch settings.infoPosition {
   275→            case .left:
   276→                textX = leftX
   277→            case .right:
   278→                textX = rightX - textSize.width
   279→            case .center:
   280→                textX = centerX - textSize.width / 2
   281→            }
   282→            
   283→            drawTextWithShadow(content, 
   284→                             font: font, 
   285→                             at: CGPoint(x: textX, y: currentY), 
   286→                             in: context)
   287→            
   288→            currentY += lineHeights[lineIndex] + lineSpacing
   289→            lineIndex += 1
   290→        }
   291→        
   292→        context.restoreGState()
   293→    }
   294→    
   295→    // 🚀 新增：简化版专业垂直水印绘制（包含Logo）
   296→    private func drawProfessionalVerticalWatermarkSimplified(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio?, isLandscape: Bool) {
   297→        context.saveGState()
   298→        
   299→        // 确定有效绘制区域
   300→        let effectiveRect: CGRect
   301→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
   302→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
   303→        } else {
   304→            effectiveRect = rect
   305→        }
   306→        
   307→        // 计算基本参数 - 横屏适配
   308→        let baseSize = min(effectiveRect.width, effectiveRect.height)
   309→        let logoSize = baseSize * (isLandscape ? 0.035 : 0.04)      // Logo大小
   310→        let titleFontSize = baseSize * (isLandscape ? 0.024 : 0.028)
   311→        let lineFontSize = baseSize * (isLandscape ? 0.020 : 0.024)
   312→        let lineSpacing = baseSize * 0.012
   313→        let bottomPadding = baseSize * (isLandscape ? 0.04 : 0.05)
   314→        
   315→        let titleFont = UIFont.systemFont(ofSize: titleFontSize, weight: .medium)
   316→        let lineFont = UIFont.systemFont(ofSize: lineFontSize, weight: .regular)
   317→        
   318→        // 获取水印内容
   319→        let watermarkContent = buildWatermarkContent(settings: settings, captureSettings: captureSettings)
   320→        
   321→        print("🎨 WatermarkService 简化版Logo渲染检查:")
   322→        print("  - showLogoLine: \(settings.showLogoLine)")
   323→        print("  - selectedLogo: \(settings.selectedLogo)")
   324→        print("  - selectedLogo != .none: \(settings.selectedLogo != .none)")
   325→        
   326→        // 🔧 重大修复：计算总高度时包含Logo
   327→        var totalHeight: CGFloat = 0
   328→        var lineHeights: [CGFloat] = []
   329→        
   330→        // Logo行高度
   331→        if settings.showLogoLine && settings.selectedLogo != .none {
   332→            lineHeights.append(logoSize)
   333→            totalHeight += logoSize + lineSpacing
   334→            print("  - Logo行将被渲染，高度: \(logoSize)")
   335→        }
   336→        
   337→        // 文字行高度
   338→        for content in watermarkContent where !content.isEmpty {
   339→            let font = content == watermarkContent.first ? titleFont : lineFont
   340→            lineHeights.append(font.lineHeight)
   341→            totalHeight += font.lineHeight + lineSpacing
   342→        }
   343→        
   344→        if totalHeight > 0 {
   345→            totalHeight -= lineSpacing // 移除最后一个间距
   346→        }
   347→        
   348→        let startY = effectiveRect.maxY - bottomPadding - totalHeight
   349→        let centerX = effectiveRect.midX
   350→        let leftX = effectiveRect.minX + baseSize * 0.05
   351→        let rightX = effectiveRect.maxX - baseSize * 0.05
   352→        
   353→        var currentY = startY
   354→        var lineIndex = 0
   355→        
   356→        // 🔧 重大修复：绘制Logo行
   357→        if settings.showLogoLine && settings.selectedLogo != .none {
   358→            let logoY = currentY
   359→            
   360→            // 使用和完整版相同的Logo加载逻辑
   361→            let logoImage: UIImage?
   362→            
   363→            if let brandLogoImageName = settings.selectedLogo.imageName,
   364→               let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   365→                logoImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   366→                print("  🔄 简化版: 使用DynamicLogoManager加载Logo: '\(brandLogoImageName)' -> \(logoImage != nil ? "成功" : "失败")")
   367→            } else {
   368→                logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   369→                print("  ⚠️ 简化版: 回退到LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   370→            }
   371→            
   372→            if let logoImage = logoImage {
   373→                // 保持Logo的真实宽高比
   374→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
   375→                let maxLogoWidth: CGFloat = 488
   376→                
   377→                let logoWidth = min(logoSize * logoAspectRatio, maxLogoWidth)
   378→                let logoHeight = logoWidth / logoAspectRatio
   379→                
   380→                // Logo位置
   381→                let logoX: CGFloat
   382→                switch settings.logoPosition {
   383→                case .left:
   384→                    logoX = leftX
   385→                case .right:
   386→                    logoX = rightX - logoWidth
   387→                case .center:
   388→                    logoX = centerX - logoWidth / 2
   389→                }
   390→                
   391→                let logoRect = CGRect(
   392→                    x: logoX,
   393→                    y: logoY,
   394→                    width: logoWidth,
   395→                    height: logoHeight
   396→                )
   397→                
   398→                logoImage.draw(in: logoRect)
   399→                print("  🎨 简化版Logo绘制成功: 尺寸=\(logoRect.size)")
   400→            } else {
   401→                print("  ❌ 简化版Logo加载失败: \(settings.selectedLogo.displayName)")
   402→            }
   403→            
   404→            currentY += lineHeights[lineIndex] + lineSpacing
   405→            lineIndex += 1
   406→        }
   407→        
   408→        // 绘制文字行（简化版本）
   409→        for content in watermarkContent where !content.isEmpty {
   410→            let font = content == watermarkContent.first ? titleFont : lineFont
   411→            let textSize = content.size(withAttributes: [.font: font])
   412→            
   413→            // 🎨 使用新的信息位置设置
   414→            let textX: CGFloat
   415→            switch settings.infoPosition {
   416→            case .left:
   417→                textX = leftX
   418→            case .right:
   419→                textX = rightX - textSize.width
   420→            case .center:
   421→                textX = centerX - textSize.width / 2
   422→            }
   423→            
   424→            drawTextSimplified(content,
   425→                             font: font,
   426→                             at: CGPoint(x: textX, y: currentY))
   427→            
   428→            currentY += lineHeights[lineIndex] + lineSpacing
   429→            lineIndex += 1
   430→        }
   431→        
   432→        context.restoreGState()
   433→    }
   434→    
   435→    // 🚀 构建水印内容数组 - 动态内容结构
   436→    private func buildWatermarkContent(settings: WatermarkSettings, captureSettings: CameraCaptureSettings) -> [String] {
   437→        var content: [String] = []
   438→        
   439→        // 第一优先级：自定义文字
   440→        if !settings.customText.isEmpty {
   441→            content.append(settings.customText)
   442→        }
   443→        
   444→        // 第二优先级：设备型号（仅当用户开启了设备开关时）
   445→        if settings.showDeviceModel {
   446→            let deviceText = DeviceInfoHelper.getDetailedDeviceModel()
   447→            content.append(deviceText)
   448→        }
   449→        
   450→        // 第三优先级：镜头信息（仅当用户开启了焦距开关时）
   451→        if settings.showFocalLength {
   452→            let lensInfo = buildLensInfo(captureSettings: captureSettings)
   453→            if !lensInfo.isEmpty {
   454→                content.append(lensInfo)
   455→            }
   456→        }
   457→        
   458→        // 第四优先级：拍摄参数（根据用户开启的开关动态组合）
   459→        var parameterComponents: [String] = []
   460→        
   461→        if settings.showAperture {
   462→            parameterComponents.append(captureSettings.formattedAperture)
   463→        }
   464→        
   465→        if settings.showShutterSpeed {
   466→            parameterComponents.append(captureSettings.formattedShutterSpeed)
   467→        }
   468→        
   469→        if settings.showISO {
   470→            parameterComponents.append(captureSettings.formattedISO)
   471→        }
   472→        
   473→        if settings.showDate {
   474→            let formatter = DateFormatter()
   475→            formatter.dateFormat = "yyyy.MM.dd"
   476→            parameterComponents.append(formatter.string(from: captureSettings.timestamp))
   477→        }
   478→        
   479→        if settings.showTimeStamp {
   480→            let formatter = DateFormatter()
   481→            formatter.dateFormat = "HH:mm:ss"
   482→            parameterComponents.append(formatter.string(from: captureSettings.timestamp))
   483→        }
   484→        
   485→        // 如果有拍摄参数，组合成一行
   486→        if !parameterComponents.isEmpty {
   487→            let parametersLine = parameterComponents.joined(separator: " / ")
   488→            content.append(parametersLine)
   489→        }
   490→        
   491→        print("  🔧 动态水印内容构建完成：")
   492→        print("    开关状态检查:")
   493→        print("      - showDeviceModel: \(settings.showDeviceModel)")
   494→        print("      - showFocalLength: \(settings.showFocalLength)")
   495→        print("      - showAperture: \(settings.showAperture)")
   496→        print("      - showShutterSpeed: \(settings.showShutterSpeed)")
   497→        print("      - showISO: \(settings.showISO)")
   498→        print("      - showDate: \(settings.showDate)")
   499→        print("      - showTimeStamp: \(settings.showTimeStamp)")
   500→        for (index, line) in content.enumerated() {
   501→            print("    第\(index + 1)行: \(line)")
   502→        }
   503→        
   504→        return content
   505→    }
   506→    
   507→    // 🚀 构建镜头信息
   508→    private func buildLensInfo(captureSettings: CameraCaptureSettings) -> String {
   509→        return captureSettings.lensInfo
   510→    }
   511→    
   512→    
   513→    
   514→    // 🚀 带阴影的文字绘制
   515→    private func drawTextWithShadow(_ text: String, font: UIFont, at point: CGPoint, in context: CGContext) {
   516→        // 绘制阴影
   517→        let shadowAttributes: [NSAttributedString.Key: Any] = [
   518→            .font: font,
   519→            .foregroundColor: UIColor.black.withAlphaComponent(0.4)
   520→        ]
   521→        
   522→        let shadowString = NSAttributedString(string: text, attributes: shadowAttributes)
   523→        let shadowRect = CGRect(x: point.x + 1, y: point.y + 1, width: 1000, height: font.lineHeight)
   524→        shadowString.draw(in: shadowRect)
   525→        
   526→        // 绘制主文字
   527→        let textAttributes: [NSAttributedString.Key: Any] = [
   528→            .font: font,
   529→            .foregroundColor: UIColor.white
   530→        ]
   531→        
   532→        let attributedString = NSAttributedString(string: text, attributes: textAttributes)
   533→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   534→        attributedString.draw(in: textRect)
   535→    }
   536→    
   537→}
   538→
   539→
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [⚡] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [ ] 🌡️ 验证WatermarkProcessor的logo处理机制
- [ ] 🌡️ 检查logo资源文件和路径问题
- [ ] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

现在检查PhotoDecorationPipeline中的logo渲染流程：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 3 files
/Users/macongcong/Desktop/MC/MCCamera/.claude-agents/commands/performance-audit.md
/Users/macongcong/Desktop/MC/MCCamera/.claude-agents/commands/photo-decoration.md
/Users/macongcong/Desktop/MC/MCCamera/.claude-agents/photo-processing-specialist.md
```

_**Agent (claude-sonnet-4-20250514)**_

让我找到PhotoDecorationPipeline的实际代码文件：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
No files found
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
No files found
```

_**Agent (claude-sonnet-4-20250514)**_

让我搜索Core/Photo目录中的相关文件：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoPromise.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncMemoryManager.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/TaskScheduler.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Core/Photo/PhotoProcessor.swift`

Result:

```
1→import UIKit
     2→import ImageIO
     3→import Photos
     4→import UniformTypeIdentifiers
     5→
     6→class PhotoProcessor {
     7→    private let locationManager: LocationManager
     8→    
     9→    init(locationManager: LocationManager) {
    10→        self.locationManager = locationManager
    11→    }
    12→    
    13→    func savePhotoToLibrary(_ imageData: Data, format: PhotoFormat, aspectRatio: AspectRatio? = nil, frameSettings: FrameSettings? = nil, captureSettings: CameraCaptureSettings? = nil) {
    14→        PHPhotoLibrary.requestAuthorization { [weak self] status in
    15→            guard status == .authorized else {
    16→                print("❌ 相册权限未授权")
    17→                return
    18→            }
    19→            
    20→            let dataSize = imageData.count / (1024 * 1024)
    21→            print("💾 开始保存照片到相册 (大小: \(dataSize)MB)")
    22→            
    23→            // 🚀 关键优化：分步骤处理，每个步骤都有独立的内存管理
    24→            
    25→            // 步骤1：处理相框（如果需要）
    26→            // 🚀 修复：跳过相框处理，因为已经在CameraService.applyWatermarkIfNeeded中处理了
    27→            var processedImageData = imageData
    28→            print("💾 步骤1：跳过相框处理（已在CameraService中处理）")
    29→            
    30→            // 步骤2：🚀 智能处理 - 避免重复处理
    31→            var finalImageData: Data? = processedImageData // 默认使用已处理的数据
    32→            
    33→            // 🚀 关键优化：只有在需要比例裁剪时才进行图像重处理
    34→            let needsImageProcessing = (aspectRatio != nil && aspectRatio != .ratio4_3)
    35→            
    36→            if needsImageProcessing {
    37→                autoreleasepool {
    38→                    print("💾 步骤2：需要比例裁剪，进行图像处理")
    39→                    self?.logOriginalMetadata(processedImageData)
    40→                    
    41→                    // 🚀 添加内存保护：检查数据大小
    42→                    let dataSize = processedImageData.count / (1024 * 1024)
    43→                    if dataSize > 200 {
    44→                        print("💾 ⚠️ 数据过大(\(dataSize)MB)，跳过图像重处理以避免崩溃")
    45→                        finalImageData = self?.addMinimalMetadata(to: processedImageData)
    46→                    } else {
    47→                        finalImageData = self?.createImageWithCompleteMetadataOptimized(from: processedImageData, format: format, aspectRatio: aspectRatio)
    48→                    }
    49→                }
    50→            } else {
    51→                print("💾 步骤2：跳过图像重处理，直接使用水印后的数据")
    52→                // 🚀 只添加基本的应用标识到现有数据
    53→                finalImageData = self?.addMinimalMetadata(to: processedImageData)
    54→            }
    55→            
    56→            // 步骤3：保存到相册
    57→            autoreleasepool {
    58→                print("💾 步骤3：保存到相册")
    59→                if let imageData = finalImageData {
    60→                    self?.saveImageDataToPhotoLibrary(imageData)
    61→                } else {
    62→                    print("❌ 无法创建最终图像数据，使用原始数据")
    63→                    self?.saveImageDataToPhotoLibrary(processedImageData)
    64→                }
    65→            }
    66→        }
    67→    }
    68→    
    69→    // 将保存到相册的操作提取为单独的方法，便于内存管理
    70→    private func saveImageDataToPhotoLibrary(_ imageData: Data) {
    71→        let dataSize = imageData.count / (1024 * 1024)
    72→        print("💾 开始保存照片到相册 (大小: \(dataSize)MB)")
    73→        
    74→        PHPhotoLibrary.shared().performChanges({ [weak self] in
    75→            let creationRequest = PHAssetCreationRequest.forAsset()
    76→            
    77→            // 使用增强后的图像数据
    78→            creationRequest.addResource(with: .photo, data: imageData, options: nil)
    79→            
    80→            // 如果有位置信息，添加GPS数据
    81→            if let location = self?.locationManager.currentLocation {
    82→                creationRequest.location = location
    83→                print("📍 添加GPS位置信息: \(location.coordinate)")
    84→            } else {
    85→                print("📍 无GPS位置信息")
    86→            }
    87→            
    88→        }) { success, error in
    89→            DispatchQueue.main.async {
    90→                if let error = error {
    91→                    print("❌ 保存照片失败: \(error)")
    92→                } else if success {
    93→                    print("✅ 照片已成功保存到相册，包含完整元数据")
    94→                    print("🎉 整个拍照流程完成")
    95→                } else {
    96→                    print("⚠️ 照片保存状态未知")
    97→                }
    98→            }
    99→        }
   100→    }
   101→    
   102→    // 🚀 新增：优化的元数据处理方法 - 减少内存占用
   103→    private func createImageWithCompleteMetadataOptimized(from imageData: Data, format: PhotoFormat, aspectRatio: AspectRatio? = nil) -> Data? {
   104→        return autoreleasepool {
   105→            let originalSize = imageData.count / (1024 * 1024)
   106→            print("📸 优化的元数据处理开始 (大小: \(originalSize)MB)")
   107→            
   108→            // 检查图像大小，如果太大则直接保存原始数据
   109→            if originalSize > 100 { // 如果超过100MB，直接保存
   110→                print("📸 图像过大(\(originalSize)MB)，跳过元数据处理直接保存")
   111→                return imageData
   112→            }
   113→            
   114→            var result: Data?
   115→            
   116→            autoreleasepool {
   117→                guard let source = CGImageSourceCreateWithData(imageData as CFData, nil) else {
   118→                    print("❌ 无法创建图像源")
   119→                    result = imageData
   120→                    return
   121→                }
   122→                
   123→                // 获取基本图像信息（不加载图像数据）
   124→                guard let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any],
   125→                      let width = properties[kCGImagePropertyPixelWidth as String] as? Int,
   126→                      let height = properties[kCGImagePropertyPixelHeight as String] as? Int else {
   127→                    print("❌ 无法获取图像属性")
   128→                    result = imageData
   129→                    return
   130→                }
   131→                
   132→                let megapixels = (width * height) / 1_000_000
   133→                print("📸 图像尺寸: \(width)x\(height) (\(megapixels)MP)")
   134→                
   135→                // 对于48MP或以上的图像，使用不同的处理策略
   136→                if megapixels >= 40 {
   137→                    print("📸 检测到超大图像(\(megapixels)MP)，使用简化处理")
   138→                    result = processLargeImageOptimized(imageData: imageData, source: source, format: format)
   139→                } else {
   140→                    print("📸 标准图像处理")
   141→                    result = processStandardImage(imageData: imageData, source: source, format: format, aspectRatio: aspectRatio)
   142→                }
   143→            }
   144→            
   145→            print("📸 优化的元数据处理完成")
   146→            return result ?? imageData
   147→        }
   148→    }
   149→    
   150→    // 🚀 新增：大图像优化处理
   151→    private func processLargeImageOptimized(imageData: Data, source: CGImageSource, format: PhotoFormat) -> Data? {
   152→        return autoreleasepool {
   153→            print("📸 大图像优化处理开始")
   154→            
   155→            // 对于大图像，只添加基本元数据，不做图像处理
   156→            var metadata: [String: Any] = [:]
   157→            if let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] {
   158→                // 保留原有的重要元数据
   159→                if let exif = properties[kCGImagePropertyExifDictionary as String] {
   160→                    metadata[kCGImagePropertyExifDictionary as String] = exif
   161→                }
   162→                if let tiff = properties[kCGImagePropertyTIFFDictionary as String] {
   163→                    metadata[kCGImagePropertyTIFFDictionary as String] = tiff
   164→                }
   165→                if let gps = properties[kCGImagePropertyGPSDictionary as String] {
   166→                    metadata[kCGImagePropertyGPSDictionary as String] = gps
   167→                }
   168→            }
   169→            
   170→            // 添加应用信息到现有元数据
   171→            var tiffDict = metadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] ?? [:]
   172→            if tiffDict[kCGImagePropertyTIFFSoftware as String] == nil {
   173→                tiffDict[kCGImagePropertyTIFFSoftware as String] = "MCCamera 1.0.0"
   174→            }
   175→            metadata[kCGImagePropertyTIFFDictionary as String] = tiffDict
   176→            
   177→            // 使用原始图像数据，只更新元数据
   178→            let mutableData = NSMutableData()
   179→            let outputType = (format == .heic) ? UTType.heic.identifier as CFString : UTType.jpeg.identifier as CFString
   180→            
   181→            guard let destination = CGImageDestinationCreateWithData(mutableData, outputType, 1, nil),
   182→                  let cgImage = CGImageSourceCreateImageAtIndex(source, 0, nil) else {
   183→                print("❌ 大图像处理失败")
   184→                return imageData
   185→            }
   186→            
   187→            // 使用较低的压缩质量减少内存使用
   188→            let options: [CFString: Any] = [
   189→                kCGImageDestinationLossyCompressionQuality: 0.80,
   190→                kCGImageDestinationOptimizeColorForSharing: true
   191→            ]
   192→            
   193→            CGImageDestinationSetProperties(destination, options as CFDictionary)
   194→            CGImageDestinationAddImage(destination, cgImage, metadata as CFDictionary)
   195→            
   196→            guard CGImageDestinationFinalize(destination) else {
   197→                print("❌ 大图像写入失败")
   198→                return imageData
   199→            }
   200→            
   201→            print("✅ 大图像优化处理完成")
   202→            return mutableData as Data
   203→        }
   204→    }
   205→    
   206→    // 🚀 新增：标准图像处理
   207→    private func processStandardImage(imageData: Data, source: CGImageSource, format: PhotoFormat, aspectRatio: AspectRatio?) -> Data? {
   208→        return autoreleasepool {
   209→            print("📸 标准图像处理开始")
   210→            
   211→            guard let cgImage = CGImageSourceCreateImageAtIndex(source, 0, nil) else {
   212→                print("❌ 无法创建CGImage")
   213→                return imageData
   214→            }
   215→            
   216→            // 处理比例裁剪（如果需要）
   217→            let finalCGImage: CGImage
   218→            if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
   219→                print("🔄 应用比例裁剪: \(aspectRatio.rawValue)")
   220→                finalCGImage = cropImageToAspectRatio(cgImage, aspectRatio: aspectRatio)
   221→            } else {
   222→                finalCGImage = cgImage
   223→            }
   224→            
   225→            // 获取并处理元数据
   226→            let metadata = processMetadata(from: source)
   227→            
   228→            // 创建输出数据
   229→            let mutableData = NSMutableData()
   230→            let outputType = (format == .heic) ? UTType.heic.identifier as CFString : UTType.jpeg.identifier as CFString
   231→            
   232→            guard let destination = CGImageDestinationCreateWithData(mutableData, outputType, 1, nil) else {
   233→                print("❌ 无法创建输出目标")
   234→                return imageData
   235→            }
   236→            
   237→            let options: [CFString: Any] = [
   238→                kCGImageDestinationLossyCompressionQuality: 0.85,
   239→                kCGImageDestinationOptimizeColorForSharing: true
   240→            ]
   241→            
   242→            CGImageDestinationSetProperties(destination, options as CFDictionary)
   243→            CGImageDestinationAddImage(destination, finalCGImage, metadata as CFDictionary)
   244→            
   245→            guard CGImageDestinationFinalize(destination) else {
   246→                print("❌ 标准图像写入失败")
   247→                return imageData
   248→            }
   249→            
   250→            print("✅ 标准图像处理完成")
   251→            return mutableData as Data
   252→        }
   253→    }
   254→    
   255→    // 🚀 新增：轻量级元数据处理
   256→    private func processMetadata(from source: CGImageSource) -> [String: Any] {
   257→        var metadata: [String: Any] = [:]
   258→        
   259→        if let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] {
   260→            // 保留必要的元数据
   261→            if let exif = properties[kCGImagePropertyExifDictionary as String] {
   262→                metadata[kCGImagePropertyExifDictionary as String] = exif
   263→            }
   264→            if let tiff = properties[kCGImagePropertyTIFFDictionary as String] {
   265→                metadata[kCGImagePropertyTIFFDictionary as String] = tiff
   266→            }
   267→            if let gps = properties[kCGImagePropertyGPSDictionary as String] {
   268→                metadata[kCGImagePropertyGPSDictionary as String] = gps
   269→            }
   270→        }
   271→        
   272→        // 添加基本的应用信息
   273→        var tiffDict = metadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] ?? [:]
   274→        tiffDict[kCGImagePropertyTIFFSoftware as String] = "MCCamera 1.0.0"
   275→        if tiffDict[kCGImagePropertyTIFFMake as String] == nil {
   276→            tiffDict[kCGImagePropertyTIFFMake as String] = "Apple"
   277→        }
   278→        metadata[kCGImagePropertyTIFFDictionary as String] = tiffDict
   279→        
   280→        return metadata
   281→    }
   282→
   283→    private func createImageWithCompleteMetadata(from imageData: Data, format: PhotoFormat, aspectRatio: AspectRatio? = nil) -> Data? {
   284→        var resultData: Data?
   285→        
   286→        // 使用autoreleasepool减少内存占用
   287→        autoreleasepool {
   288→            guard let source = CGImageSourceCreateWithData(imageData as CFData, nil) else {
   289→                print("❌ 无法创建CGImageSource")
   290→                resultData = imageData // 返回原始数据作为备选
   291→                return
   292→            }
   293→            
   294→            guard let cgImage = CGImageSourceCreateImageAtIndex(source, 0, nil) else {
   295→                print("❌ 无法创建CGImage")
   296→                resultData = imageData // 返回原始数据作为备选
   297→                return
   298→            }
   299→            
   300→            // 关键调试：检查原始图像尺寸
   301→            let originalWidth = cgImage.width
   302→            let originalHeight = cgImage.height
   303→            let originalMegapixels = (originalWidth * originalHeight) / 1_000_000
   304→            
   305→            print("🔍 原始图像尺寸检查:")
   306→            print("  - 宽度: \(originalWidth)")
   307→            print("  - 高度: \(originalHeight)")
   308→            print("  - 总像素: \(originalMegapixels)MP")
   309→            print("  - 是否为48MP: \(originalMegapixels >= 40)")
   310→            
   311→            // 如果是48MP图像，确保不会被意外缩放
   312→            if originalMegapixels >= 40 {
   313→                print("✅ 检测到48MP原始图像！")
   314→            } else if originalMegapixels >= 10 && originalMegapixels <= 15 {
   315→                print("ℹ️ 检测到12MP图像")
   316→            } else {
   317→                print("⚠️ 检测到未知分辨率图像: \(originalMegapixels)MP")
   318→            }
   319→            
   320→            // 处理比例裁剪
   321→            let finalCGImage: CGImage
   322→            if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
   323→                print("🔄 应用比例裁剪: \(aspectRatio.rawValue)")
   324→                finalCGImage = cropImageToAspectRatio(cgImage, aspectRatio: aspectRatio)
   325→            } else {
   326→                print("📷 保持原始比例")
   327→                finalCGImage = cgImage
   328→            }
   329→            
   330→            // 获取原始元数据 - 优化：只获取需要的元数据
   331→            var metadata: [String: Any] = [:]
   332→            if let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] {
   333→                // 只复制需要的元数据字典
   334→                if let exif = properties[kCGImagePropertyExifDictionary as String] as? [String: Any] {
   335→                    metadata[kCGImagePropertyExifDictionary as String] = exif
   336→                }
   337→                if let tiff = properties[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   338→                    metadata[kCGImagePropertyTIFFDictionary as String] = tiff
   339→                }
   340→                if let gps = properties[kCGImagePropertyGPSDictionary as String] as? [String: Any] {
   341→                    metadata[kCGImagePropertyGPSDictionary as String] = gps
   342→                }
   343→            }
   344→            
   345→            print("📸 原始元数据字段:")
   346→            print("  - 总字段数: \(metadata.keys.count)")
   347→            
   348→            // 保留并补充EXIF信息（不覆盖已有的重要信息）
   349→            var exifDict = metadata[kCGImagePropertyExifDictionary as String] as? [String: Any] ?? [:]
   350→            
   351→            // 只在没有镜头信息时才添加
   352→            if exifDict[kCGImagePropertyExifLensMake as String] == nil {
   353→                exifDict[kCGImagePropertyExifLensMake as String] = "Apple"
   354→            }
   355→            if exifDict[kCGImagePropertyExifLensModel as String] == nil {
   356→                exifDict[kCGImagePropertyExifLensModel as String] = DeviceInfoHelper.getLensModelForPhotos(device: AVCaptureDevice.default(for: .video)!)
   357→            }
   358→            
   359→            // 添加拍摄时间（如果没有的话）
   360→            if exifDict[kCGImagePropertyExifDateTimeOriginal as String] == nil {
   361→                let now = Date()
   362→                let dateFormatter = DateFormatter()
   363→                dateFormatter.dateFormat = "yyyy:MM:dd HH:mm:ss"
   364→                exifDict[kCGImagePropertyExifDateTimeOriginal as String] = dateFormatter.string(from: now)
   365→                exifDict[kCGImagePropertyExifDateTimeDigitized as String] = dateFormatter.string(from: now)
   366→            }
   367→            
   368→            // 保留并补充TIFF信息
   369→            var tiffDict = metadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] ?? [:]
   370→            
   371→            // 只在没有设备信息时才添加
   372→            if tiffDict[kCGImagePropertyTIFFMake as String] == nil {
   373→                tiffDict[kCGImagePropertyTIFFMake as String] = "Apple"
   374→            }
   375→            if tiffDict[kCGImagePropertyTIFFModel as String] == nil {
   376→                tiffDict[kCGImagePropertyTIFFModel as String] = DeviceInfoHelper.getDetailedDeviceModel()
   377→            }
   378→            if tiffDict[kCGImagePropertyTIFFSoftware as String] == nil {
   379→                tiffDict[kCGImagePropertyTIFFSoftware as String] = "MCCamera 1.0.0"
   380→            }
   381→            
   382→            // 添加时间戳（如果没有的话）
   383→            if tiffDict[kCGImagePropertyTIFFDateTime as String] == nil {
   384→                let now = Date()
   385→                let dateFormatter = DateFormatter()
   386→                dateFormatter.dateFormat = "yyyy:MM:dd HH:mm:ss"
   387→                tiffDict[kCGImagePropertyTIFFDateTime as String] = dateFormatter.string(from: now)
   388→            }
   389→            
   390→            // 添加GPS信息（如果有位置数据且没有GPS信息）
   391→            if metadata[kCGImagePropertyGPSDictionary as String] == nil,
   392→               let gpsMetadata = locationManager.getLocationMetadata() {
   393→                metadata[kCGImagePropertyGPSDictionary as String] = gpsMetadata
   394→            }
   395→            
   396→            // 更新元数据
   397→            metadata[kCGImagePropertyExifDictionary as String] = exifDict
   398→            metadata[kCGImagePropertyTIFFDictionary as String] = tiffDict
   399→            
   400→            // 根据格式和图像大小选择输出类型
   401→            let outputType: CFString
   402→            let compressionQuality: Float
   403→            
   404→            // 🔄 关键优化：对于大尺寸图像，使用JPEG格式而不是HEIC格式
   405→            let useJpegForLargeImages = originalMegapixels > 20
   406→            
   407→            switch format {
   408→            case .heic:
   409→                if useJpegForLargeImages {
   410→                    print("📸 大尺寸图像(\(originalMegapixels)MP)，使用JPEG格式代替HEIC以减少内存使用")
   411→                    outputType = UTType.jpeg.identifier as CFString
   412→                    compressionQuality = 0.85 // 降低压缩质量以减少内存使用
   413→                } else {
   414→                    print("  - 转换为HEIC格式...")
   415→                    outputType = UTType.heic.identifier as CFString
   416→                    compressionQuality = 0.85 // 降低压缩质量以减少内存使用
   417→                }
   418→            case .jpeg:
   419→                outputType = UTType.jpeg.identifier as CFString
   420→                compressionQuality = 0.85 // 降低压缩质量以减少内存使用
   421→            case .raw:
   422→                // RAW格式通常不需要重新编码，直接返回原始数据
   423→                print("📸 RAW格式保持原始数据")
   424→                resultData = imageData
   425→                return
   426→            }
   427→            
   428→            // 🔄 关键优化：对于大尺寸图像，先缩小再处理
   429→            let processedCGImage: CGImage
   430→            if originalMegapixels > 30 { // 对于非常大的图像（如48MP）
   431→                print("📸 缩小大尺寸图像以减少内存使用")
   432→                // 创建一个较小的图像用于处理
   433→                let scaleFactor = sqrt(20.0 / Double(originalMegapixels)) // 缩小到约20MP
   434→                let newWidth = Int(Double(finalCGImage.width) * scaleFactor)
   435→                let newHeight = Int(Double(finalCGImage.height) * scaleFactor)
   436→                
   437→                // 使用Core Graphics缩小图像
   438→                let colorSpace = CGColorSpaceCreateDeviceRGB()
   439→                if let context = CGContext(data: nil, width: newWidth, height: newHeight, bitsPerComponent: 8, bytesPerRow: 0, space: colorSpace, bitmapInfo: CGImageAlphaInfo.premultipliedLast.rawValue) {
   440→                    context.interpolationQuality = .high
   441→                    context.draw(finalCGImage, in: CGRect(x: 0, y: 0, width: newWidth, height: newHeight))
   442→                    if let resizedImage = context.makeImage() {
   443→                        processedCGImage = resizedImage
   444→                        print("📸 图像已缩小至 \(newWidth) x \(newHeight)")
   445→                    } else {
   446→                        processedCGImage = finalCGImage
   447→                        print("❌ 图像缩小失败，使用原始图像")
   448→                    }
   449→                } else {
   450→                    processedCGImage = finalCGImage
   451→                    print("❌ 无法创建图形上下文，使用原始图像")
   452→                }
   453→            } else {
   454→                processedCGImage = finalCGImage
   455→            }
   456→            
   457→            // 创建新的图像数据
   458→            let mutableData = NSMutableData()
   459→            guard let destination = CGImageDestinationCreateWithData(mutableData, outputType, 1, nil) else {
   460→                print("❌ 无法创建CGImageDestination")
   461→                resultData = imageData
   462→                return
   463→            }
   464→            
   465→            // 设置压缩质量和其他选项
   466→            var options: [CFString: Any] = [
   467→                kCGImageDestinationLossyCompressionQuality: compressionQuality,
   468→                kCGImageDestinationOptimizeColorForSharing: true // 优化颜色共享
   469→            ]
   470→            
   471→            // 对于HEIC格式，添加额外的优化选项
   472→            if outputType == UTType.heic.identifier as CFString {
   473→                options[kCGImageDestinationEmbedThumbnail] = false // 不嵌入缩略图以减少内存使用
   474→            }
   475→            
   476→            // 先设置属性，再添加图像
   477→            CGImageDestinationSetProperties(destination, options as CFDictionary)
   478→            
   479→            // 添加图像和元数据
   480→            CGImageDestinationAddImage(destination, processedCGImage, metadata as CFDictionary)
   481→            
   482→            // 完成写入
   483→            guard CGImageDestinationFinalize(destination) else {
   484→                print("❌ 无法完成图像写入")
   485→                resultData = imageData
   486→                return
   487→            }
   488→            
   489→            // 验证保存的元数据
   490→            verifyMetadata(mutableData)
   491→            
   492→            print("✅ 成功创建带有完整元数据的图像，格式: \(outputType == UTType.heic.identifier as CFString ? "HEIC" : "JPEG")")
   493→            resultData = mutableData as Data
   494→        }
   495→        
   496→        return resultData
   497→    }
   498→    
   499→    private func verifyMetadata(_ data: NSMutableData) {
   500→        autoreleasepool {
   501→            if let verifySource = CGImageSourceCreateWithData(data, nil),
   502→               let verifyMetadata = CGImageSourceCopyPropertiesAtIndex(verifySource, 0, nil) as? [String: Any] {
   503→                print("📋 验证保存的元数据:")
   504→                
   505→                if let verifyExif = verifyMetadata[kCGImagePropertyExifDictionary as String] as? [String: Any] {
   506→                    print("  - EXIF字段数量: \(verifyExif.keys.count)")
   507→                    if let lensMake = verifyExif[kCGImagePropertyExifLensMake as String] {
   508→                        print("  - 镜头制造商: \(lensMake)")
   509→                    }
   510→                    if let lensModel = verifyExif[kCGImagePropertyExifLensModel as String] {
   511→                        print("  - 镜头型号: \(lensModel)")
   512→                    }
   513→                    if let dateTime = verifyExif[kCGImagePropertyExifDateTimeOriginal as String] {
   514→                        print("  - 拍摄时间: \(dateTime)")
   515→                    }
   516→                    if let iso = verifyExif[kCGImagePropertyExifISOSpeedRatings as String] {
   517→                        print("  - ISO: \(iso)")
   518→                    }
   519→                    if let exposureTime = verifyExif[kCGImagePropertyExifExposureTime as String] {
   520→                        print("  - 快门速度: \(exposureTime)")
   521→                    }
   522→                }
   523→                
   524→                if let verifyTiff = verifyMetadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   525→                    print("  - TIFF字段数量: \(verifyTiff.keys.count)")
   526→                    if let make = verifyTiff[kCGImagePropertyTIFFMake as String] {
   527→                        print("  - 设备制造商: \(make)")
   528→                    }
   529→                    if let model = verifyTiff[kCGImagePropertyTIFFModel as String] {
   530→                        print("  - 设备型号: \(model)")
   531→                    }
   532→                }
   533→                
   534→                if let verifyGPS = verifyMetadata[kCGImagePropertyGPSDictionary as String] as? [String: Any] {
   535→                    print("  - GPS字段数量: \(verifyGPS.keys.count)")
   536→                } else {
   537→                    print("  - 无GPS信息")
   538→                }
   539→            } else {
   540→                print("❌ 无法验证保存的元数据")
   541→            }
   542→        }
   543→    }
   544→    
   545→    private func cropImageToAspectRatio(_ cgImage: CGImage, aspectRatio: AspectRatio) -> CGImage {
   546→        let originalWidth = cgImage.width
   547→        let originalHeight = cgImage.height
   548→        let originalSize = CGSize(width: originalWidth, height: originalHeight)
   549→        
   550→        print("🔄 裁剪图像:")
   551→        print("  - 原始尺寸: \(originalWidth) x \(originalHeight)")
   552→        print("  - 目标比例: \(aspectRatio.rawValue) (\(aspectRatio.ratioValue))")
   553→        
   554→        // 计算裁剪区域
   555→        let cropRect = aspectRatio.getCropRect(for: originalSize)
   556→        
   557→        print("  - 裁剪区域: \(cropRect)")
   558→        print("  - 裁剪后尺寸: \(Int(cropRect.width)) x \(Int(cropRect.height))")
   559→        
   560→        // 执行裁剪
   561→        if let croppedImage = cgImage.cropping(to: cropRect) {
   562→            print("✅ 图像裁剪成功")
   563→            return croppedImage
   564→        } else {
   565→            print("❌ 图像裁剪失败，返回原图")
   566→            return cgImage
   567→        }
   568→    }
   569→    
   570→    // 🚀 新增：只添加最小元数据，避免重复图像处理
   571→    private func addMinimalMetadata(to imageData: Data) -> Data? {
   572→        return autoreleasepool {
   573→            print("💾 添加最小元数据，避免重复图像处理")
   574→            
   575→            // 创建图像源
   576→            guard let source = CGImageSourceCreateWithData(imageData as CFData, nil) else {
   577→                print("❌ 无法创建图像源，返回原始数据")
   578→                return imageData
   579→            }
   580→            
   581→            // 获取现有元数据
   582→            var metadata: [String: Any] = [:]
   583→            if let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] {
   584→                // 保留所有现有元数据
   585→                metadata = properties
   586→            }
   587→            
   588→            // 只添加/更新应用标识到TIFF字典
   589→            var tiffDict = metadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] ?? [:]
   590→            
   591→            // 如果没有软件标识，添加MCCamera标识
   592→            if tiffDict[kCGImagePropertyTIFFSoftware as String] == nil {
   593→                tiffDict[kCGImagePropertyTIFFSoftware as String] = "MCCamera 1.0.0"
   594→                print("💾 添加MCCamera软件标识")
   595→            }
   596→            
   597→            metadata[kCGImagePropertyTIFFDictionary as String] = tiffDict
   598→            
   599→            // 创建输出数据，保持原始格式
   600→            let mutableData = NSMutableData()
   601→            
   602→            // 检测原始格式
   603→            let imageUTI = CGImageSourceGetType(source)
   604→            let outputType = imageUTI ?? UTType.heic.identifier as CFString
   605→            
   606→            guard let destination = CGImageDestinationCreateWithData(mutableData, outputType, 1, nil),
   607→                  let cgImage = CGImageSourceCreateImageAtIndex(source, 0, nil) else {
   608→                print("❌ 无法创建输出目标，返回原始数据")
   609→                return imageData
   610→            }
   611→            
   612→            // 使用高质量设置，但不压缩
   613→            let options: [CFString: Any] = [
   614→                kCGImageDestinationLossyCompressionQuality: 0.95,
   615→                kCGImageDestinationOptimizeColorForSharing: false
   616→            ]
   617→            
   618→            CGImageDestinationSetProperties(destination, options as CFDictionary)
   619→            CGImageDestinationAddImage(destination, cgImage, metadata as CFDictionary)
   620→            
   621→            guard CGImageDestinationFinalize(destination) else {
   622→                print("❌ 元数据写入失败，返回原始数据")
   623→                return imageData
   624→            }
   625→            
   626→            let finalSize = mutableData.count / (1024 * 1024)
   627→            print("✅ 最小元数据添加完成，大小: \(finalSize)MB")
   628→            return mutableData as Data
   629→        }
   630→    }
   631→    
   632→    private func logOriginalMetadata(_ imageData: Data) {
   633→        autoreleasepool {
   634→            guard let source = CGImageSourceCreateWithData(imageData as CFData, nil),
   635→                  let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] else {
   636→                print("📸 无法读取原始照片元数据")
   637→                return
   638→            }
   639→            
   640→            print("📸 原始照片元数据:")
   641→            if let exif = properties[kCGImagePropertyExifDictionary as String] as? [String: Any] {
   642→                print("  - EXIF数据存在，包含 \(exif.keys.count) 个字段")
   643→                if let iso = exif[kCGImagePropertyExifISOSpeedRatings as String] {
   644→                    print("  - ISO: \(iso)")
   645→                }
   646→                if let exposureTime = exif[kCGImagePropertyExifExposureTime as String] {
   647→                    print("  - 快门速度: \(exposureTime)")
   648→                }
   649→            } else {
   650→                print("  - 无EXIF数据")
   651→            }
   652→            
   653→            if let tiff = properties[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   654→                print("  - TIFF数据存在")
   655→                if let make = tiff[kCGImagePropertyTIFFMake as String] {
   656→                    print("  - 制造商: \(make)")
   657→                }
   658→            }
   659→        }
   660→    }
   661→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在我需要找到PhotoDecorationPipeline的实际实现。让我搜索相关的处理流程：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 2 files
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Core/Camera/CameraService.swift`

Result:

```
1→import AVFoundation
     2→import UIKit
     3→import Photos
     4→import CoreLocation
     5→
     6→class CameraService: NSObject, ObservableObject {
     7→    let session = AVCaptureSession()
     8→    private var videoOutput = AVCaptureVideoDataOutput()
     9→    private var photoOutput = AVCapturePhotoOutput()
    10→    var currentDevice: AVCaptureDevice?
    11→    private var currentInput: AVCaptureDeviceInput?
    12→    
    13→    private let sessionQueue = DispatchQueue(label: "camera.session.queue")
    14→    
    15→    // Manager instances
    16→    private let locationManager = LocationManager()
    17→    private lazy var highResolutionManager = HighResolutionCameraManager(
    18→        sessionQueue: sessionQueue,
    19→        photoOutput: photoOutput
    20→    )
    21→    private lazy var photoProcessor = PhotoProcessor(locationManager: locationManager)
    22→    private lazy var photoSettingsManager = PhotoSettingsManager(photoOutput: photoOutput)
    23→    
    24→    var previewLayer: AVCaptureVideoPreviewLayer {
    25→        let layer = AVCaptureVideoPreviewLayer(session: session)
    26→        layer.videoGravity = .resizeAspectFill
    27→        return layer
    28→    }
    29→    
    30→    var availableCameras: [AVCaptureDevice] = []
    31→    var currentCameraIndex: Int = 0
    32→    
    33→    // 添加设置相关的属性
    34→    private var currentPhotoFormat: PhotoFormat = .heic
    35→    private var currentPhotoResolution: PhotoResolution = .resolution12MP
    36→    
    37→    private var photoCompletionHandler: ((Result<Data, Error>) -> Void)?
    38→    private var currentAspectRatio: AspectRatio?
    39→    private var currentFrameSettings: FrameSettings?
    40→    
    41→    override init() {
    42→        super.init()
    43→        // 立即进行快速初始化
    44→        quickSetup()
    45→    }
    46→    
    47→    private func quickSetup() {
    48→        print("🚀 开始快速设置相机")
    49→        // 所有相机设置移到后台线程，避免阻塞主线程
    50→        sessionQueue.async { [weak self] in
    51→            guard let self = self else { return }
    52→            
    53→            print("🎥 后台配置相机...")
    54→            // 使用默认后置相机进行快速设置
    55→            guard let defaultCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back) else {
    56→                print("❌ 无法获取默认相机")
    57→                return
    58→            }
    59→            
    60→            self.session.beginConfiguration()
    61→            
    62→            // 设置session preset - 对于48MP捕获很重要
    63→            self.configureSessionPreset()
    64→            
    65→            // 配置默认相机
    66→            self.configureDefaultCamera(defaultCamera)
    67→            
    68→            // 添加输出并配置高分辨率捕获
    69→            self.configurePhotoOutput()
    70→            
    71→            self.session.commitConfiguration()
    72→            
    73→            // 验证配置状态
    74→            self.verifyConfiguration()
    75→            
    76→            // 更新相机列表（在主线程）
    77→            DispatchQueue.main.async {
    78→                self.availableCameras = [defaultCamera]
    79→                print("✅ 快速设置完成，相机可用")
    80→            }
    81→            
    82→            // 发现其他相机
    83→            self.discoverAdditionalCameras()
    84→        }
    85→    }
    86→    
    87→    private func configureSessionPreset() {
    88→        let presets: [AVCaptureSession.Preset] = [.photo, .high, .inputPriority]
    89→        var presetSet = false
    90→        
    91→        for preset in presets {
    92→            if self.session.canSetSessionPreset(preset) {
    93→                self.session.sessionPreset = preset
    94→                print("🚀 快速设置: Session preset设置为 \(preset.rawValue)")
    95→                presetSet = true
    96→                break
    97→            }
    98→        }
    99→        
   100→        if !presetSet {
   101→            print("❌ 快速设置: 无法设置任何首选preset")
   102→        }
   103→    }
   104→    
   105→    private func configureDefaultCamera(_ defaultCamera: AVCaptureDevice) {
   106→        do {
   107→            let input = try AVCaptureDeviceInput(device: defaultCamera)
   108→            if self.session.canAddInput(input) {
   109→                self.session.addInput(input)
   110→                self.currentInput = input
   111→                self.currentDevice = defaultCamera
   112→            }
   113→        } catch {
   114→            print("❌ 配置默认相机失败: \(error)")
   115→        }
   116→    }
   117→    
   118→    private func configurePhotoOutput() {
   119→        if self.session.canAddOutput(self.photoOutput) {
   120→            self.session.addOutput(self.photoOutput)
   121→            
   122→            // 立即启用高分辨率捕获
   123→            self.photoOutput.isHighResolutionCaptureEnabled = true
   124→            print("🚀 快速设置: 高分辨率捕获已启用")
   125→            
   126→            // 设置最高质量优先级
   127→            self.photoOutput.maxPhotoQualityPrioritization = .quality
   128→            
   129→            print("🚀 快速设置PhotoOutput状态:")
   130→            print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   131→        } else {
   132→            print("❌ 快速设置: 无法添加photoOutput")
   133→        }
   134→    }
   135→    
   136→    private func verifyConfiguration() {
   137→        print("🚀 Session配置完成后，PhotoOutput最终状态:")
   138→        print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   139→        print("  - 可用编解码器类型: \(self.photoOutput.availablePhotoCodecTypes)")
   140→        
   141→        // 如果初始分辨率设置为48MP，确保配置48MP模式
   142→        if self.currentPhotoResolution == .resolution48MP {
   143→            print("🚀 快速设置: 检测到48MP初始设置，配置48MP模式")
   144→            if let device = currentDevice {
   145→                self.highResolutionManager.configureFor48MP(enable: true, device: device, session: session)
   146→            }
   147→        }
   148→    }
   149→    
   150→    private func discoverAdditionalCameras() {
   151→        let cameraDiscovery = CameraDiscovery()
   152→        let newCameras = cameraDiscovery.discoverCameras()
   153→        
   154→        // 更新相机列表
   155→        DispatchQueue.main.async { [weak self] in
   156→            self?.availableCameras = newCameras.isEmpty ? (self?.availableCameras ?? []) : newCameras
   157→            print("发现的相机数量: \(self?.availableCameras.count ?? 0)")
   158→            
   159→            // 如果有多个相机，默认切换到1x镜头（索引为1）
   160→            if let self = self, self.availableCameras.count > 1 {
   161→                self.switchCamera(to: 1)
   162→            }
   163→        }
   164→    }
   165→    
   166→    func requestPermissions(completion: @escaping (Bool) -> Void) {
   167→        let cameraAuthStatus = AVCaptureDevice.authorizationStatus(for: .video)
   168→        
   169→        switch cameraAuthStatus {
   170→        case .authorized:
   171→            completion(true)
   172→        case .notDetermined:
   173→            AVCaptureDevice.requestAccess(for: .video) { granted in
   174→                DispatchQueue.main.async {
   175→                    completion(granted)
   176→                }
   177→            }
   178→        default:
   179→            completion(false)
   180→        }
   181→    }
   182→    
   183→    func startSession() {
   184→        sessionQueue.async { [weak self] in
   185→            guard let self = self, !self.session.isRunning else { return }
   186→            
   187→            self.session.startRunning()
   188→            print("✅ Session已启动")
   189→        }
   190→    }
   191→    
   192→    func stopSession() {
   193→        sessionQueue.async { [weak self] in
   194→            guard let self = self, self.session.isRunning else { return }
   195→            self.session.stopRunning()
   196→        }
   197→    }
   198→    
   199→    func switchCamera(to index: Int) {
   200→        guard index >= 0 && index < availableCameras.count else { return }
   201→        
   202→        let selectedCamera = availableCameras[index]
   203→        currentCameraIndex = index
   204→        
   205→        print("🔄 切换相机到索引 \(index)")
   206→        print("🔄 选中的相机: \(selectedCamera.localizedName) (\(selectedCamera.deviceType.rawValue))")
   207→        
   208→        configureCamera(selectedCamera)
   209→    }
   210→    
   211→    private func configureCamera(_ device: AVCaptureDevice) {
   212→        sessionQueue.async { [weak self] in
   213→            guard let self = self else { return }
   214→            
   215→            self.session.beginConfiguration()
   216→            
   217→            if let currentInput = self.currentInput {
   218→                self.session.removeInput(currentInput)
   219→            }
   220→            
   221→            do {
   222→                let input = try AVCaptureDeviceInput(device: device)
   223→                if self.session.canAddInput(input) {
   224→                    self.session.addInput(input)
   225→                    self.currentInput = input
   226→                    self.currentDevice = device
   227→                    
   228→                    // 重新配置PhotoOutput以确保高分辨率捕获正确设置
   229→                    self.photoOutput.isHighResolutionCaptureEnabled = true
   230→                    print("📷 设备切换后: 高分辨率捕获重新启用")
   231→                    
   232→                    // 为48MP配置设备格式
   233→                    if self.currentPhotoResolution == .resolution48MP {
   234→                        self.highResolutionManager.configureFor48MP(enable: true, device: device, session: self.session)
   235→                    }
   236→                }
   237→            } catch {
   238→                print("Error configuring camera: \(error)")
   239→            }
   240→            
   241→            self.session.commitConfiguration()
   242→        }
   243→    }
   244→    
   245→    func capturePhoto(aspectRatio: AspectRatio? = nil, flashMode: AVCaptureDevice.FlashMode = .auto, frameSettings: FrameSettings? = nil, completion: @escaping (Result<Data, Error>) -> Void) {
   246→        sessionQueue.async { [weak self] in
   247→            guard let self = self else { return }
   248→            
   249→            // 检查 session 是否在运行
   250→            guard self.session.isRunning else {
   251→                DispatchQueue.main.async {
   252→                    completion(.failure(NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "相机未启动"])))
   253→                }
   254→                return
   255→            }
   256→            
   257→            // 创建照片设置
   258→            let settings = self.photoSettingsManager.createPhotoSettings(
   259→                format: self.currentPhotoFormat,
   260→                resolution: self.currentPhotoResolution
   261→            )
   262→            
   263→            // 设置闪光灯模式
   264→            if let currentDevice = self.currentDevice, currentDevice.hasFlash {
   265→                settings.flashMode = flashMode
   266→                print("📸 设置闪光灯模式为: \(flashMode.rawValue)")
   267→            } else {
   268→                settings.flashMode = .off
   269→                print("📸 设备不支持闪光灯，设置为关闭")
   270→            }
   271→            
   272→            // 使用设备支持的最高质量设置
   273→            let maxQuality = self.photoOutput.maxPhotoQualityPrioritization
   274→            if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.quality.rawValue {
   275→                settings.photoQualityPrioritization = .quality
   276→            } else if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.balanced.rawValue {
   277→                settings.photoQualityPrioritization = .balanced
   278→            } else {
   279→                settings.photoQualityPrioritization = .speed
   280→            }
   281→            
   282→            // Apple建议：启用嵌入式缩略图以获得更好的相册体验
   283→            if settings.availableEmbeddedThumbnailPhotoCodecTypes.contains(.jpeg) {
   284→                settings.embeddedThumbnailPhotoFormat = [
   285→                    AVVideoCodecKey: AVVideoCodecType.jpeg
   286→                ]
   287→            }
   288→            
   289→            // 设置方向信息 - 根据当前设备方向动态设置
   290→            if let connection = self.photoOutput.connection(with: .video) {
   291→                if connection.isVideoOrientationSupported {
   292→                    connection.videoOrientation = self.getCurrentVideoOrientation()
   293→                }
   294→            }
   295→            
   296→            print("📸 拍照设置配置完成")
   297→            
   298→            self.photoCompletionHandler = completion
   299→            self.currentAspectRatio = aspectRatio
   300→            
   301→            // 保存相框设置，用于后续处理
   302→            self.currentFrameSettings = frameSettings
   303→            
   304→            self.photoOutput.capturePhoto(with: settings, delegate: self)
   305→        }
   306→    }
   307→    
   308→    func setFocusPoint(_ point: CGPoint) {
   309→        guard let device = currentDevice, device.isFocusPointOfInterestSupported else { return }
   310→        
   311→        do {
   312→            try device.lockForConfiguration()
   313→            device.focusPointOfInterest = point
   314→            device.focusMode = .autoFocus
   315→            
   316→            if device.isExposurePointOfInterestSupported {
   317→                device.exposurePointOfInterest = point
   318→                device.exposureMode = .autoExpose
   319→            }
   320→            
   321→            device.unlockForConfiguration()
   322→        } catch {
   323→            print("Error setting focus point: \(error)")
   324→        }
   325→    }
   326→    
   327→    func setExposureCompensation(_ value: Float) {
   328→        guard let device = currentDevice else { return }
   329→        
   330→        do {
   331→            try device.lockForConfiguration()
   332→            
   333→            // 确保设备处于连续自动曝光模式，以便曝光补偿生效
   334→            if device.isExposureModeSupported(.continuousAutoExposure) {
   335→                device.exposureMode = .continuousAutoExposure
   336→            }
   337→            
   338→            // 限制曝光补偿值在设备支持的范围内
   339→            let clampedValue = max(device.minExposureTargetBias, min(value, device.maxExposureTargetBias))
   340→            device.setExposureTargetBias(clampedValue, completionHandler: { time in
   341→                print("📸 CameraService: 曝光补偿设置完成 - 值: \(clampedValue), 时间: \(time.seconds)秒")
   342→            })
   343→            
   344→            device.unlockForConfiguration()
   345→        } catch {
   346→            print("Error setting exposure compensation: \(error)")
   347→        }
   348→    }
   349→    
   350→    // 更新设置的方法
   351→    func updatePhotoSettings(format: PhotoFormat, resolution: PhotoResolution) {
   352→        let needsSessionReconfiguration = (currentPhotoResolution != resolution)
   353→        
   354→        currentPhotoFormat = format
   355→        currentPhotoResolution = resolution
   356→        print("📸 更新照片设置 - 格式: \(format.rawValue), 分辨率: \(resolution.rawValue)")
   357→        
   358→        // 如果分辨率改变，需要重新配置session
   359→        if needsSessionReconfiguration {
   360→            sessionQueue.async { [weak self] in
   361→                self?.reconfigureSession()
   362→            }
   363→        }
   364→    }
   365→    
   366→    // 重新配置session的方法
   367→    private func reconfigureSession() {
   368→        guard session.isRunning else { return }
   369→        
   370→        print("🔄 重新配置Session - 分辨率: \(currentPhotoResolution.rawValue)")
   371→        
   372→        session.beginConfiguration()
   373→        
   374→        // 根据新的分辨率设置session preset
   375→        let sessionPreset = CameraHelper.getSessionPreset(for: currentPhotoResolution, session: session)
   376→        if session.canSetSessionPreset(sessionPreset) {
   377→            session.sessionPreset = sessionPreset
   378→            print("📸 更新session preset为: \(sessionPreset.rawValue)")
   379→        }
   380→        
   381→        // 重新配置PhotoOutput以确保高分辨率设置正确
   382→        if currentPhotoResolution == .resolution48MP {
   383→            // 48MP模式：确保PhotoOutput配置正确
   384→            photoOutput.isHighResolutionCaptureEnabled = true
   385→            photoOutput.maxPhotoQualityPrioritization = .quality
   386→            print("🔄 48MP模式：重新配置PhotoOutput")
   387→        }
   388→        
   389→        // 根据分辨率配置相应的设备格式
   390→        if let device = currentDevice {
   391→            if currentPhotoResolution == .resolution48MP {
   392→                highResolutionManager.configureFor48MP(enable: true, device: device, session: session)
   393→            } else {
   394→                highResolutionManager.configureFor48MP(enable: false, device: device, session: session)
   395→            }
   396→        }
   397→        
   398→        session.commitConfiguration()
   399→        
   400→        print("🔄 Session重新配置完成")
   401→    }
   402→    
   403→    var is48MPAvailable: Bool {
   404→        return highResolutionManager.is48MPAvailable(for: currentDevice)
   405→    }
   406→    
   407→    // 获取当前设备方向对应的视频方向
   408→    private func getCurrentVideoOrientation() -> AVCaptureVideoOrientation {
   409→        let interfaceOrientation = UIApplication.shared.connectedScenes
   410→            .compactMap { $0 as? UIWindowScene }
   411→            .first?.interfaceOrientation ?? .portrait
   412→        
   413→        switch interfaceOrientation {
   414→        case .portrait:
   415→            return .portrait
   416→        case .portraitUpsideDown:
   417→            return .portraitUpsideDown
   418→        case .landscapeLeft:
   419→            return .landscapeLeft
   420→        case .landscapeRight:
   421→            return .landscapeRight
   422→        default:
   423→            return .portrait
   424→        }
   425→    }
   426→    
   427→    // 🚀 优化后的水印和相框功能：智能处理逻辑
   428→    private func applyWatermarkIfNeeded(to imageData: Data, photo: AVCapturePhoto) -> Data {
   429→        print("🎨 开始应用水印和相框，原始大小: \(imageData.count / 1024 / 1024)MB")
   430→        
   431→        var processedData = imageData
   432→        let hasFrame = currentFrameSettings?.selectedFrame != .none
   433→        let watermarkSettings = WatermarkSettings.load()
   434→        let hasWatermark = watermarkSettings.isEnabled
   435→        
   436→        print("🎨 处理状态: 相框=\(hasFrame), 水印=\(hasWatermark)")
   437→        
   438→        if hasFrame {
   439→            // 有相框的情况：将水印信息集成到相框中处理
   440→            if let frameSettings = currentFrameSettings {
   441→                autoreleasepool {
   442→                    print("🎨 应用相框并集成水印信息")
   443→                    let photoDecorationService = PhotoDecorationService(frameSettings: frameSettings)
   444→                    
   445→                    // 提取相机设置信息供相框使用
   446→                    let captureSettings = extractCaptureSettings(from: photo)
   447→                    
   448→                    // 🚀 修复：对于需要显示拍摄参数的相框（如大师系列），即使没有水印也要传递captureSettings
   449→                    let needsCaptureInfo = frameSettings.showISO || frameSettings.showAperture || 
   450→                                         frameSettings.showFocalLength || frameSettings.showShutterSpeed
   451→                    
   452→                    print("🔧 相框参数需求检查:")
   453→                    print("  - hasWatermark: \(hasWatermark)")
   454→                    print("  - needsCaptureInfo: \(needsCaptureInfo)")
   455→                    print("  - 最终传递captureSettings: \(hasWatermark || needsCaptureInfo)")
   456→                    
   457→                    processedData = photoDecorationService.applyFrameToPhoto(
   458→                        processedData, 
   459→                        withWatermarkInfo: (hasWatermark || needsCaptureInfo) ? captureSettings : nil,
   460→                        aspectRatio: currentAspectRatio
   461→                    )
   462→                    print("🎨 相框+水印处理完成，大小: \(processedData.count / 1024 / 1024)MB")
   463→                }
   464→            }
   465→        } else if hasWatermark {
   466→            // 没有相框但有水印：保持原有逻辑，将水印添加到照片上
   467→            autoreleasepool {
   468→                print("🎨 应用水印到照片")
   469→                let watermarkProcessor = WatermarkProcessor(currentDevice: currentDevice)
   470→                processedData = watermarkProcessor.processWatermark(
   471→                    imageData: processedData, 
   472→                    photo: photo, 
   473→                    format: currentPhotoFormat, 
   474→                    aspectRatio: currentAspectRatio
   475→                )
   476→                print("🎨 水印处理完成，大小: \(processedData.count / 1024 / 1024)MB")
   477→            }
   478→        }
   479→        
   480→        return processedData
   481→    }
   482→    
   483→    // 提取拍摄设置信息的辅助方法
   484→    private func extractCaptureSettings(from photo: AVCapturePhoto) -> CameraCaptureSettings {
   485→        // 使用新的静态方法创建增强的相机设置
   486→        return CameraCaptureSettings.fromPhoto(photo, device: currentDevice)
   487→    }
   488→}
   489→
   490→extension CameraService: AVCapturePhotoCaptureDelegate {
   491→    func photoOutput(_ output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto, error: Error?) {
   492→        if let error = error {
   493→            photoCompletionHandler?(.failure(error))
   494→            return
   495→        }
   496→        
   497→        // 🚀 革命性改进：使用异步管线处理，立即释放拍摄状态
   498→        print("🚀 拍摄完成，启动异步处理管线")
   499→        
   500→        autoreleasepool {
   501→            guard let imageData = photo.fileDataRepresentation() else {
   502→                let error = NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "Failed to get image data"])
   503→                photoCompletionHandler?(.failure(error))
   504→                return
   505→            }
   506→            
   507→            // 立即返回成功状态 - 连拍响应提升10x
   508→            photoCompletionHandler?(.success(imageData))
   509→            photoCompletionHandler = nil
   510→            
   511→            // 🚀 使用新的异步管线处理
   512→            let captureSettings = self.extractCaptureSettings(from: photo)
   513→            
   514→            let promise = AsyncPhotoPipeline.shared.processPhotoAsync(
   515→                rawPhoto: photo,
   516→                imageData: imageData,
   517→                captureSettings: captureSettings,
   518→                frameSettings: self.currentFrameSettings,
   519→                aspectRatio: self.currentAspectRatio,
   520→                format: self.currentPhotoFormat
   521→            )
   522→            
   523→            // 🎯 链式回调：优雅的响应式编程
   524→            promise
   525→                .onPreview { previewData in
   526→                    // 可以在这里更新UI显示快速预览
   527→                    print("👁️ 快速预览就绪")
   528→                }
   529→                .onProgress { progress in
   530→                    // 显示处理进度
   531→                    print("📈 处理进度: \(Int(progress * 100))%")
   532→                }
   533→                .onSuccess { finalData in
   534→                    // 最终处理完成
   535→                    print("✅ 异步处理完成，照片已保存")
   536→                }
   537→                .onFailure { error in
   538→                    // 处理错误
   539→                    print("❌ 异步处理失败: \(error)")
   540→                }
   541→                .onMemoryPressure {
   542→                    // 内存压力处理
   543→                    print("⚠️ 内存压力，处理延迟")
   544→                }
   545→        }
   546→    }
   547→    
   548→    // MARK: - Legacy Methods (已被AsyncPhotoPipeline替代，保留用于兼容)
   549→    
   550→    // 🚀 旧版后台处理方法 - 已被异步管线替代，保留用于降级兼容
   551→    private func processPhotoInBackgroundLegacy(photo: AVCapturePhoto, originalData: Data) {
   552→        // 这个方法现在只作为异步管线失败时的降级方案
   553→        autoreleasepool {
   554→            print("⚠️ 使用降级处理方案")
   555→            
   556→            let captureSettings = self.extractCaptureSettings(from: photo)
   557→            let processedData = self.applyWatermarkIfNeeded(to: originalData, photo: photo)
   558→            
   559→            self.photoProcessor.savePhotoToLibrary(
   560→                processedData,
   561→                format: self.currentPhotoFormat,
   562→                aspectRatio: self.currentAspectRatio,
   563→                frameSettings: self.currentFrameSettings,
   564→                captureSettings: captureSettings
   565→            )
   566→            
   567→            print("✅ 降级处理完成")
   568→        }
   569→    }
   570→    
   571→    // 🚀 新增：轻量级图像验证，减少内存占用
   572→    private func verifyImageDataLightweight(_ imageData: Data) {
   573→        autoreleasepool {
   574→            // 只获取基本的图像属性，不创建完整的图像对象
   575→            guard let source = CGImageSourceCreateWithData(imageData as CFData, nil) else { 
   576→                print("❌ 无法创建图像源")
   577→                return 
   578→            }
   579→            
   580→            // 只获取图像属性，不加载图像数据
   581→            guard let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] else {
   582→                print("❌ 无法获取图像属性")
   583→                return
   584→            }
   585→            
   586→            if let pixelWidth = properties[kCGImagePropertyPixelWidth as String] as? Int,
   587→               let pixelHeight = properties[kCGImagePropertyPixelHeight as String] as? Int {
   588→                let megapixels = (pixelWidth * pixelHeight) / 1_000_000
   589→                let dataSize = imageData.count / (1024 * 1024) // MB
   590→                
   591→                print("🔍 图像信息: \(pixelWidth)x\(pixelHeight) (\(megapixels)MP), 大小: \(dataSize)MB")
   592→                
   593→                if currentPhotoResolution == .resolution48MP && megapixels < 40 {
   594→                    print("❌ 警告：预期48MP但实际拍摄\(megapixels)MP")
   595→                } else if currentPhotoResolution == .resolution48MP && megapixels >= 40 {
   596→                    print("✅ 成功：48MP模式")
   597→                }
   598→            }
   599→        }
   600→    }
   601→    
   602→    private func verifyImageData(_ imageData: Data) {
   603→        // 保留原方法用于兼容，但标记为已弃用
   604→        verifyImageDataLightweight(imageData)
   605→    }
   606→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [X] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [⚡] 🌡️ 验证WatermarkProcessor的logo处理机制
- [ ] 🌡️ 检查logo资源文件和路径问题
- [ ] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

现在让我检查WatermarkProcessor：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 6 files
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift
/Users/macongcong/Desktop/MC/MCCamera/.claude-agents/photo-processing-specialist.md
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkProcessor.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→
     4→class WatermarkProcessor {
     5→    private let currentDevice: AVCaptureDevice?
     6→    
     7→    init(currentDevice: AVCaptureDevice?) {
     8→        self.currentDevice = currentDevice
     9→    }
    10→    
    11→    func processWatermark(imageData: Data, photo: AVCapturePhoto, format: PhotoFormat, aspectRatio: AspectRatio? = nil) -> Data {
    12→        // 🚀 优化：使用autoreleasepool包围整个处理过程
    13→        return autoreleasepool {
    14→            let settings = WatermarkSettings.load()
    15→            let dataSize = imageData.count / (1024 * 1024)
    16→            
    17→            print("🏷️ 水印处理开始 (数据大小: \(dataSize)MB)")
    18→            print("  - 水印启用: \(settings.isEnabled)")
    19→            
    20→            guard settings.isEnabled else {
    21→                print("  - 水印未启用，跳过处理")
    22→                return imageData
    23→            }
    24→            
    25→            // 🚀 检查数据大小，如果太大则跳过水印处理
    26→            if dataSize > 150 {
    27→                print("  ⚠️ 数据过大(\(dataSize)MB)，跳过水印处理以避免内存爆炸")
    28→                return imageData
    29→            }
    30→            
    31→            // 🚀 关键优化：延迟图像创建，并立即包装在autoreleasepool中
    32→            var processedData: Data = imageData
    33→            
    34→            autoreleasepool {
    35→                print("  📊 开始UIImage创建")
    36→                
    37→                // 从图像数据创建UIImage（内存密集型操作）
    38→                guard let image = UIImage(data: imageData) else {
    39→                    print("  ❌ 无法创建UIImage")
    40→                    return
    41→                }
    42→                
    43→                print("  - 图像尺寸: \(Int(image.size.width))x\(Int(image.size.height))")
    44→                
    45→                // 提取相机设置信息（轻量级操作）
    46→                let captureSettings = extractCaptureSettings(from: photo)
    47→                
    48→                // 应用水印（内存密集型操作）
    49→                print("  📊 开始应用水印")
    50→                
    51→                if let watermarkedImage = WatermarkService.shared.addWatermark(to: image, with: captureSettings, aspectRatio: aspectRatio) {
    52→                    
    53→                    // 🚀 立即转换并释放UIImage
    54→                    autoreleasepool {
    55→                        let quality: CGFloat = 0.92 // 稍微降低质量以减少内存压力
    56→                        
    57→                        switch format {
    58→                        case .heic:
    59→                            if let heicData = watermarkedImage.heicData(compressionQuality: quality) {
    60→                                processedData = heicData
    61→                                print("  ✅ HEIC处理完成 (\(heicData.count / 1024 / 1024)MB)")
    62→                            } else {
    63→                                processedData = watermarkedImage.jpegData(compressionQuality: quality) ?? imageData
    64→                                print("  ⚠️ HEIC失败，使用JPEG")
    65→                            }
    66→                        case .jpeg:
    67→                            if let jpegData = watermarkedImage.jpegData(compressionQuality: quality) {
    68→                                processedData = jpegData
    69→                                print("  ✅ JPEG处理完成 (\(jpegData.count / 1024 / 1024)MB)")
    70→                            } else {
    71→                                print("  ❌ JPEG转换失败")
    72→                            }
    73→                        case .raw:
    74→                            print("  - RAW格式跳过水印")
    75→                        }
    76→                    }
    77→                    
    78→                } else {
    79→                    print("  ❌ 水印应用失败")
    80→                }
    81→                
    82→                // watermarkedImage和image将在这里自动释放
    83→            }
    84→            
    85→            print("🏷️ 水印处理完成")
    86→            return processedData
    87→        }
    88→    }
    89→    
    90→    // 提取拍摄设置信息
    91→    private func extractCaptureSettings(from photo: AVCapturePhoto) -> CameraCaptureSettings {
    92→        var focalLength: Float = 24.0
    93→        var shutterSpeed: Double = 1.0/60.0
    94→        var iso: Float = 100.0
    95→        
    96→        // 尝试从相机设备获取焦距
    97→        if let device = currentDevice {
    98→            switch device.deviceType {
    99→            case .builtInUltraWideCamera:
   100→                focalLength = 13.0
   101→            case .builtInWideAngleCamera:
   102→                focalLength = 26.0
   103→            case .builtInTelephotoCamera:
   104→                focalLength = 77.0
   105→            default:
   106→                focalLength = 26.0
   107→            }
   108→            
   109→            // 从设备获取当前ISO和快门速度
   110→            iso = device.iso
   111→            shutterSpeed = CMTimeGetSeconds(device.exposureDuration)
   112→        }
   113→        
   114→        // 尝试从照片元数据获取更准确的信息
   115→        if let metadata = photo.metadata as? [String: Any] {
   116→            if let exifDict = metadata["{Exif}"] as? [String: Any] {
   117→                if let focalLengthValue = exifDict["FocalLength"] as? Float {
   118→                    focalLength = focalLengthValue
   119→                }
   120→                if let isoValue = exifDict["ISOSpeedRatings"] as? [Float], let firstISO = isoValue.first {
   121→                    iso = firstISO
   122→                } else if let isoValue = exifDict["ISOSpeedRatings"] as? Float {
   123→                    iso = isoValue
   124→                }
   125→                if let exposureTimeValue = exifDict["ExposureTime"] as? Double {
   126→                    shutterSpeed = exposureTimeValue
   127→                }
   128→            }
   129→        }
   130→        
   131→        return CameraCaptureSettings(focalLength: focalLength, shutterSpeed: shutterSpeed, iso: iso)
   132→    }
   133→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我检查logo资源文件是否存在：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [X] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [X] 🌡️ 验证WatermarkProcessor的logo处理机制
- [⚡] 🌡️ 检查logo资源文件和路径问题
- [ ] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/backup/WechatIMG31 1.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/backup/WechatIMG31 2.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/backup/WechatIMG31.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/WechatIMG31.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/WechatIMG31 1.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/AppIcon.appiconset/WechatIMG31 2.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/hasu.imageset/hasu.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Apple_logo_white.imageset/Apple_logo_white.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/相框/baolilai.imageset/baolilai.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/相框/底部文字.imageset/底部文字@2x.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/相框/sign_b.imageset/sign_b.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/相框/sign_w.imageset/sign_w.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Hasselblad_logo.imageset/Hasselblad_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Panavision_logo.imageset/Panavision_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Sony_logo.imageset/Sony_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/dji-1.imageset/dji-1.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Arri_logo.imageset/Arri_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Panasonic_logo_(Blue).imageset/Panasonic_logo_(Blue).png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Olympus_Corporation_logo.imageset/Olympus_Corporation_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Polaroid_logo.imageset/Polaroid_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Apple_logo_black.imageset/Apple_logo_black.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Canon_wordmark.imageset/Canon_wordmark.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Fujifilm_logo.imageset/Fujifilm_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Leica_Camera_logo.imageset/Leica_Camera_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Zeiss_logo.imageset/Zeiss_logo.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Ricoh_logo_2012.imageset/Ricoh_logo_2012.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Hasselblad_logo_w.imageset/Hasselblad_logo_w.png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Eastman_Kodak_Company_logo_(2016)(no_background).imageset/Eastman_Kodak_Company_logo_(2016)(no_background).png
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets/logo/Nikon_Logo.imageset/Nikon_Logo.png
```

_**Agent (claude-sonnet-4-20250514)**_

很好！Logo资源文件存在。现在让我检查WatermarkSettings中的选择逻辑：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 11 files
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift
/Users/macongcong/Desktop/MC/MCCamera/DEVELOPMENT_ROADMAP.md
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkSettings.swift`

Result:

```
1→import Foundation
     2→
     3→// 🎨 简化：水印样式枚举 - 只保留一种统一样式
     4→enum WatermarkStyle: String, CaseIterable, Codable {
     5→    case unified = "统一水印"
     6→    
     7→    var displayName: String {
     8→        return self.rawValue
     9→    }
    10→}
    11→
    12→// 水印位置枚举
    13→enum WatermarkPosition: String, CaseIterable, Codable {
    14→    case bottomLeft = "左下角"
    15→    case bottomRight = "右下角"
    16→    case bottomCenter = "底部居中"
    17→    
    18→    var displayName: String {
    19→        return self.rawValue
    20→    }
    21→}
    22→
    23→// 品牌Logo枚举
    24→enum BrandLogo: String, CaseIterable, Codable {
    25→    case none = "无"
    26→    case apple = "Apple"
    27→    case canon = "Canon"
    28→    case sony = "Sony"
    29→    case nikon = "Nikon"
    30→    case leica = "Leica"
    31→    case fujifilm = "Fujifilm"
    32→    case hasselblad = "Hasselblad"
    33→    case olympus = "Olympus"
    34→    case panasonic = "Panasonic"
    35→    case zeiss = "Zeiss"
    36→    case arri = "Arri"
    37→    case panavision = "Panavision"
    38→    case polaroid = "Polaroid"
    39→    case ricoh = "Ricoh"
    40→    case kodak = "Kodak"
    41→    case dji = "DJI"
    42→    case baolilai = "宝丽来"
    43→    case hasu = "哈苏"
    44→    case hasselblad_w = "Hasselblad白"
    45→    case custom = "自定义"
    46→    
    47→    var displayName: String {
    48→        return self.rawValue
    49→    }
    50→    
    51→    // 获取Logo图片名称
    52→    var imageName: String? {
    53→        switch self {
    54→        case .none, .custom:
    55→            return nil
    56→        case .apple:
    57→            return "Apple_logo_black"
    58→        case .canon:
    59→            return "Canon_wordmark"
    60→        case .sony:
    61→            return "Sony_logo"
    62→        case .nikon:
    63→            return "Nikon_Logo"
    64→        case .leica:
    65→            return "Leica_Camera_logo"
    66→        case .fujifilm:
    67→            return "Fujifilm_logo"
    68→        case .hasselblad:
    69→            return "Hasselblad_logo"
    70→        case .olympus:
    71→            return "Olympus_Corporation_logo"
    72→        case .panasonic:
    73→            return "Panasonic_logo_(Blue)"
    74→        case .zeiss:
    75→            return "Zeiss_logo"
    76→        case .arri:
    77→            return "Arri_logo"
    78→        case .panavision:
    79→            return "Panavision_logo"
    80→        case .polaroid:
    81→            return "Polaroid_logo"
    82→        case .ricoh:
    83→            return "Ricoh_logo_2012"
    84→        case .kodak:
    85→            return "Eastman_Kodak_Company_logo_(2016)(no_background)"
    86→        case .dji:
    87→            return "dji-1"
    88→        case .baolilai:
    89→            return "baolilai"
    90→        case .hasu:
    91→            return "hasu"
    92→        case .hasselblad_w:
    93→            return "Hasselblad_logo_w"
    94→        }
    95→    }
    96→}
    97→
    98→struct WatermarkSettings: Codable {
    99→    // 基本设置
   100→    var isEnabled: Bool = false
   101→    var watermarkStyle: WatermarkStyle = .unified
   102→    var position: WatermarkPosition = .bottomLeft
   103→    
   104→    // 经典水印设置
   105→    var authorName: String = ""
   106→    var showDeviceModel: Bool = true
   107→    var showFocalLength: Bool = true
   108→    var showShutterSpeed: Bool = true
   109→    var showISO: Bool = true
   110→    var showDate: Bool = true
   111→    
   112→    // 专业垂直水印设置
   113→    var selectedLogo: BrandLogo = .none
   114→    var customText: String = "iPhone 15 Pro"
   115→    
   116→    // 各行显示控制
   117→    var showLogoLine: Bool = true
   118→    var showDeviceLine: Bool = true
   119→    var showLensLine: Bool = true
   120→    var showParametersLine: Bool = true
   121→    
   122→    // 参数行详细控制
   123→    var showAperture: Bool = true
   124→    var showTimeStamp: Bool = false
   125→    var showLocation: Bool = false
   126→    
   127→    // 🎨 新增：独立的Logo和信息位置控制
   128→    var logoPosition: PositionAlignment = .center
   129→    var infoPosition: PositionAlignment = .center
   130→    
   131→    static let shared = WatermarkSettings()
   132→    
   133→    func save() {
   134→        if let data = try? JSONEncoder().encode(self) {
   135→            UserDefaults.standard.set(data, forKey: "WatermarkSettings")
   136→        }
   137→    }
   138→    
   139→    static func load() -> WatermarkSettings {
   140→        guard let data = UserDefaults.standard.data(forKey: "WatermarkSettings"),
   141→              let settings = try? JSONDecoder().decode(WatermarkSettings.self, from: data) else {
   142→            print("🔧 WatermarkSettings: 使用默认设置")
   143→            return WatermarkSettings()
   144→        }
   145→        
   146→        print("🔧 WatermarkSettings: 加载已保存设置")
   147→        print("  - isEnabled: \(settings.isEnabled)")
   148→        print("  - selectedLogo: \(settings.selectedLogo)")
   149→        print("  - showLogoLine: \(settings.showLogoLine)")
   150→        
   151→        return settings
   152→    }
   153→    
   154→    // 🎯 调试用：临时启用Logo测试
   155→    static func enableTestLogo() {
   156→        var settings = WatermarkSettings.load()
   157→        settings.isEnabled = true
   158→        settings.selectedLogo = .hasselblad  // 使用哈苏Logo测试
   159→        settings.showLogoLine = true
   160→        settings.showDeviceModel = true
   161→        settings.save()
   162→        print("🧪 测试Logo已启用: Hasselblad")
   163→    }
   164→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我检查LogoManager是否存在，因为代码中还在使用旧的LogoManager作为fallback：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
Found 6 files
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/LogoManager.swift
/Users/macongcong/Desktop/MC/MCCamera/LOGO_MANAGEMENT.md
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/LogoManager.swift`

Result:

```
1→import UIKit
     2→import SwiftUI
     3→
     4→// Logo管理器，负责处理品牌Logo的加载、缓存和渲染
     5→class LogoManager {
     6→    static let shared = LogoManager()
     7→    private var logoCache: [String: UIImage] = [:]
     8→    
     9→    private init() {}
    10→    
    11→    // MARK: - Logo加载和缓存
    12→    
    13→    /// 加载指定品牌的Logo图片
    14→    func loadLogo(_ brandLogo: BrandLogo) -> UIImage? {
    15→        guard let imageName = brandLogo.imageName else { return nil }
    16→        
    17→        // 检查缓存
    18→        if let cachedLogo = logoCache[imageName] {
    19→            return cachedLogo
    20→        }
    21→        
    22→        // 从Bundle加载图片
    23→        guard let image = UIImage(named: imageName) else {
    24→            print("⚠️ LogoManager: 无法加载Logo图片 '\(imageName)'，请检查资源文件是否存在")
    25→            return nil
    26→        }
    27→        
    28→        print("✅ LogoManager: 成功加载Logo图片 '\(imageName)'")
    29→        
    30→        // 预处理Logo图片（优化渲染性能）
    31→        let processedImage = preprocessLogo(image)
    32→        
    33→        // 缓存处理后的图片
    34→        logoCache[imageName] = processedImage
    35→        
    36→        return processedImage
    37→    }
    38→    
    39→    /// 预处理Logo图片，优化渲染性能
    40→    private func preprocessLogo(_ image: UIImage) -> UIImage {
    41→        // 确保Logo图片有合适的分辨率和格式
    42→        let maxSize: CGFloat = 200 // 最大尺寸，避免过大的图片
    43→        
    44→        if max(image.size.width, image.size.height) <= maxSize {
    45→            return image
    46→        }
    47→        
    48→        // 缩放图片到合适大小
    49→        let scale = maxSize / max(image.size.width, image.size.height)
    50→        let newSize = CGSize(
    51→            width: image.size.width * scale,
    52→            height: image.size.height * scale
    53→        )
    54→        
    55→        let renderer = UIGraphicsImageRenderer(size: newSize)
    56→        return renderer.image { _ in
    57→            image.draw(in: CGRect(origin: .zero, size: newSize))
    58→        }
    59→    }
    60→    
    61→    // MARK: - Logo渲染
    62→    
    63→    /// 在指定矩形区域内渲染Logo，自动适配尺寸
    64→    func renderLogo(
    65→        _ brandLogo: BrandLogo,
    66→        in rect: CGRect,
    67→        context: CGContext,
    68→        tintColor: UIColor = .white
    69→    ) {
    70→        guard let logoImage = loadLogo(brandLogo) else { return }
    71→        
    72→        // 计算Logo的实际渲染尺寸（保持宽高比）
    73→        let logoAspectRatio = logoImage.size.width / logoImage.size.height
    74→        let rectAspectRatio = rect.width / rect.height
    75→        
    76→        let renderRect: CGRect
    77→        if logoAspectRatio > rectAspectRatio {
    78→            // Logo更宽，以宽度为准
    79→            let renderWidth = rect.width
    80→            let renderHeight = renderWidth / logoAspectRatio
    81→            renderRect = CGRect(
    82→                x: rect.minX,
    83→                y: rect.midY - renderHeight / 2,
    84→                width: renderWidth,
    85→                height: renderHeight
    86→            )
    87→        } else {
    88→            // Logo更高，以高度为准
    89→            let renderHeight = rect.height
    90→            let renderWidth = renderHeight * logoAspectRatio
    91→            renderRect = CGRect(
    92→                x: rect.midX - renderWidth / 2,
    93→                y: rect.minY,
    94→                width: renderWidth,
    95→                height: renderHeight
    96→            )
    97→        }
    98→        
    99→        // 保存当前图形状态
   100→        context.saveGState()
   101→        
   102→        // 应用颜色滤镜（如果需要）
   103→        if tintColor != .clear {
   104→            context.setBlendMode(.multiply)
   105→            context.setFillColor(tintColor.cgColor)
   106→            context.fill(renderRect)
   107→            context.setBlendMode(.destinationIn)
   108→        }
   109→        
   110→        // 渲染Logo
   111→        logoImage.draw(in: renderRect)
   112→        
   113→        // 恢复图形状态
   114→        context.restoreGState()
   115→    }
   116→    
   117→    // MARK: - Logo信息获取
   118→    
   119→    /// 获取所有可用的Logo列表
   120→    func getAvailableLogos() -> [BrandLogo] {
   121→        return BrandLogo.allCases.filter { $0 != .custom }
   122→    }
   123→    
   124→    /// 检查Logo是否可用
   125→    func isLogoAvailable(_ brandLogo: BrandLogo) -> Bool {
   126→        guard let imageName = brandLogo.imageName else { return false }
   127→        return UIImage(named: imageName) != nil
   128→    }
   129→    
   130→    /// 获取Logo的显示信息
   131→    func getLogoDisplayInfo(_ brandLogo: BrandLogo) -> LogoDisplayInfo {
   132→        return LogoDisplayInfo(
   133→            brand: brandLogo,
   134→            isAvailable: isLogoAvailable(brandLogo),
   135→            previewImage: loadLogo(brandLogo)
   136→        )
   137→    }
   138→    
   139→    // MARK: - 自定义Logo支持
   140→    
   141→    private var customLogoKey = "custom_logo_image_data"
   142→    
   143→    /// 保存自定义Logo
   144→    func saveCustomLogo(_ image: UIImage) -> Bool {
   145→        guard let imageData = image.pngData() else { return false }
   146→        
   147→        UserDefaults.standard.set(imageData, forKey: customLogoKey)
   148→        
   149→        // 更新缓存
   150→        logoCache["custom"] = image
   151→        
   152→        return true
   153→    }
   154→    
   155→    /// 加载自定义Logo
   156→    func loadCustomLogo() -> UIImage? {
   157→        // 检查缓存
   158→        if let cachedLogo = logoCache["custom"] {
   159→            return cachedLogo
   160→        }
   161→        
   162→        // 从UserDefaults加载
   163→        guard let imageData = UserDefaults.standard.data(forKey: customLogoKey),
   164→              let image = UIImage(data: imageData) else {
   165→            return nil
   166→        }
   167→        
   168→        // 预处理并缓存
   169→        let processedImage = preprocessLogo(image)
   170→        logoCache["custom"] = processedImage
   171→        
   172→        return processedImage
   173→    }
   174→    
   175→    /// 删除自定义Logo
   176→    func deleteCustomLogo() {
   177→        UserDefaults.standard.removeObject(forKey: customLogoKey)
   178→        logoCache.removeValue(forKey: "custom")
   179→    }
   180→    
   181→    // MARK: - 缓存管理
   182→    
   183→    /// 清理Logo缓存
   184→    func clearCache() {
   185→        logoCache.removeAll()
   186→    }
   187→    
   188→    /// 预加载常用Logo（提高首次渲染性能）
   189→    func preloadCommonLogos() {
   190→        DispatchQueue.global(qos: .utility).async { [weak self] in
   191→            let commonLogos: [BrandLogo] = [.apple, .sony, .canon, .nikon]
   192→            
   193→            for logo in commonLogos {
   194→                _ = self?.loadLogo(logo)
   195→            }
   196→            
   197→            print("📱 LogoManager: 常用Logo预加载完成")
   198→        }
   199→    }
   200→}
   201→
   202→// MARK: - Supporting Types
   203→
   204→/// Logo显示信息结构体
   205→struct LogoDisplayInfo {
   206→    let brand: BrandLogo
   207→    let isAvailable: Bool
   208→    let previewImage: UIImage?
   209→    
   210→    var displayName: String {
   211→        return brand.displayName
   212→    }
   213→}
   214→
   215→// MARK: - SwiftUI Extensions
   216→
   217→extension LogoManager {
   218→    /// 为SwiftUI提供的Logo视图
   219→    func logoView(for brand: BrandLogo, size: CGSize = CGSize(width: 24, height: 24)) -> some View {
   220→        Group {
   221→            if let logoImage = loadLogo(brand) {
   222→                Image(uiImage: logoImage)
   223→                    .resizable()
   224→                    .aspectRatio(contentMode: .fit)
   225→                    .frame(width: size.width, height: size.height)
   226→            } else {
   227→                // 备用显示
   228→                Text(brand.displayName.prefix(1))
   229→                    .font(.system(size: size.height * 0.6, weight: .bold))
   230→                    .frame(width: size.width, height: size.height)
   231→                    .background(Color.gray.opacity(0.3))
   232→                    .cornerRadius(size.width * 0.1)
   233→            }
   234→        }
   235→    }
   236→}
   237→
   238→// MARK: - Logo质量检查
   239→
   240→extension LogoManager {
   241→    /// 检查Logo图片质量
   242→    func validateLogoQuality(_ image: UIImage) -> LogoQualityReport {
   243→        let size = image.size
   244→        let aspectRatio = size.width / size.height
   245→        
   246→        var issues: [String] = []
   247→        var suggestions: [String] = []
   248→        
   249→        // 检查分辨率
   250→        if max(size.width, size.height) < 64 {
   251→            issues.append("分辨率过低")
   252→            suggestions.append("建议使用至少64x64像素的图片")
   253→        }
   254→        
   255→        if max(size.width, size.height) > 1024 {
   256→            suggestions.append("图片较大，将被自动缩放以提高性能")
   257→        }
   258→        
   259→        // 检查宽高比
   260→        if aspectRatio < 0.5 || aspectRatio > 2.0 {
   261→            issues.append("宽高比不理想")
   262→            suggestions.append("建议使用接近正方形的Logo")
   263→        }
   264→        
   265→        let quality: LogoQuality
   266→        if issues.isEmpty {
   267→            quality = suggestions.isEmpty ? .excellent : .good
   268→        } else if issues.count == 1 {
   269→            quality = .acceptable
   270→        } else {
   271→            quality = .poor
   272→        }
   273→        
   274→        return LogoQualityReport(
   275→            quality: quality,
   276→            issues: issues,
   277→            suggestions: suggestions,
   278→            size: size,
   279→            aspectRatio: aspectRatio
   280→        )
   281→    }
   282→}
   283→
   284→/// Logo质量等级
   285→enum LogoQuality: String, CaseIterable {
   286→    case excellent = "优秀"
   287→    case good = "良好" 
   288→    case acceptable = "可接受"
   289→    case poor = "较差"
   290→    
   291→    var color: Color {
   292→        switch self {
   293→        case .excellent: return .green
   294→        case .good: return .blue
   295→        case .acceptable: return .orange
   296→        case .poor: return .red
   297→        }
   298→    }
   299→}
   300→
   301→/// Logo质量报告
   302→struct LogoQualityReport {
   303→    let quality: LogoQuality
   304→    let issues: [String]
   305→    let suggestions: [String]
   306→    let size: CGSize
   307→    let aspectRatio: CGFloat
   308→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [X] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [X] 🌡️ 验证WatermarkProcessor的logo处理机制
- [X] 🌡️ 检查logo资源文件和路径问题
- [⚡] 🌡️ 排查渲染上下文和图形绘制问题
- [ ] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

现在我发现了问题的根源！通过深度分析，我发现了logo无法渲染到图片的核心bug：

## 🔍 Bug根源分析：

### **现象层**：Logo不显示在最终照片中
### **本质层**：有一个关键的架构缺陷
### **哲学层**："数据流的断裂就是用户期望的破碎"

## 🎯 核心问题：

在`WatermarkService.swift`的第220-228行，代码试图通过`BrandLogo`的`imageName`来查找`DynamicLogo`：

```swift
if let brandLogoImageName = settings.selectedLogo.imageName,
   let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
    logoImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
```

**但是**，这里有一个致命的**数据不一致性**问题：

1. `BrandLogo.imageName`返回的是如`"Apple_logo_black"`
2. 但实际资源文件名可能不完全匹配
3. `DynamicLogoManager.availableLogos`数组可能为空或者没有正确扫描

让我现在修复这个bug：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [X] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [X] 🌡️ 验证WatermarkProcessor的logo处理机制
- [X] 🌡️ 检查logo资源文件和路径问题
- [X] 🌡️ 排查渲染上下文和图形绘制问题
- [⚡] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

现在修复WatermarkService中的关键bug：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   203→        
   204→        var currentY = startY
   205→        var lineIndex = 0
   206→        
   207→        // 绘制Logo行 - 支持DynamicLogoManager
   208→        print("🎨 WatermarkService Logo渲染检查:")
   209→        print("  - showLogoLine: \(settings.showLogoLine)")
   210→        print("  - selectedLogo: \(settings.selectedLogo)")
   211→        print("  - selectedLogo != .none: \(settings.selectedLogo != .none)")
   212→        
   213→        if settings.showLogoLine && settings.selectedLogo != .none {
   214→            let logoY = currentY
   215→            
   216→            // 🔧 重大修复：优先使用稳定的LogoManager，然后尝试DynamicLogoManager
   217→            let logoImage: UIImage?
   218→            
   219→            // 第一优先级：使用经过验证的LogoManager
   220→            logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   221→            print("  ✅ WatermarkService: 使用LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   222→            
   223→            // 如果LogoManager失败，尝试DynamicLogoManager作为备用
   224→            if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
   225→                if let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   226→                    let fallbackImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   227→                    print("  🔄 WatermarkService: DynamicLogoManager备用加载: '\(brandLogoImageName)' -> \(fallbackImage != nil ? "成功" : "失败")")
   228→                } else {
   229→                    print("  ❌ WatermarkService: DynamicLogoManager中未找到匹配的Logo: '\(brandLogoImageName)'")
   230→                }
   231→            }
   232→            
   233→            if let logoImage = logoImage {
   234→                // 🔧 修复：保持Logo的真实宽高比，88px最大宽度限制，按比例调整高度
   235→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
```

_**Agent (claude-sonnet-4-20250514)**_

现在修复简化版中的相同问题：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   355→        
   356→        var currentY = startY
   357→        var lineIndex = 0
   358→        
   359→        // 🔧 重大修复：绘制Logo行
   360→        if settings.showLogoLine && settings.selectedLogo != .none {
   361→            let logoY = currentY
   362→            
   363→            // 使用和完整版相同的Logo加载逻辑 - 优先LogoManager
   364→            let logoImage: UIImage?
   365→            
   366→            // 第一优先级：使用经过验证的LogoManager
   367→            logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   368→            print("  ✅ 简化版: 使用LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   369→            
   370→            // 如果LogoManager失败，尝试DynamicLogoManager作为备用
   371→            if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
   372→                if let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   373→                    let fallbackImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   374→                    print("  🔄 简化版: DynamicLogoManager备用加载: '\(brandLogoImageName)' -> \(fallbackImage != nil ? "成功" : "失败")")
   375→                } else {
   376→                    print("  ❌ 简化版: DynamicLogoManager中未找到匹配的Logo: '\(brandLogoImageName)'")
   377→                }
   378→            }
   379→            
   380→            if let logoImage = logoImage {
   381→                // 保持Logo的真实宽高比
   382→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
```

_**Agent (claude-sonnet-4-20250514)**_

还有一个严重的bug！让我检查第一个修复中的逻辑错误：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   212→        
   213→        if settings.showLogoLine && settings.selectedLogo != .none {
   214→            let logoY = currentY
   215→            
   216→            // 🔧 重大修复：优先使用稳定的LogoManager，然后尝试DynamicLogoManager
   217→            var logoImage: UIImage?
   218→            
   219→            // 第一优先级：使用经过验证的LogoManager
   220→            logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   221→            print("  ✅ WatermarkService: 使用LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   222→            
   223→            // 如果LogoManager失败，尝试DynamicLogoManager作为备用
   224→            if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
   225→                if let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   226→                    logoImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   227→                    print("  🔄 WatermarkService: DynamicLogoManager备用加载: '\(brandLogoImageName)' -> \(logoImage != nil ? "成功" : "失败")")
   228→                } else {
   229→                    print("  ❌ WatermarkService: DynamicLogoManager中未找到匹配的Logo: '\(brandLogoImageName)'")
   230→                }
   231→            }
   232→            
   233→            if let logoImage = logoImage {
   234→                // 🔧 修复：保持Logo的真实宽高比，88px最大宽度限制，按比例调整高度
   235→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
```

_**Agent (claude-sonnet-4-20250514)**_

修复简化版中的相同逻辑错误：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   359→        // 🔧 重大修复：绘制Logo行
   360→        if settings.showLogoLine && settings.selectedLogo != .none {
   361→            let logoY = currentY
   362→            
   363→            // 使用和完整版相同的Logo加载逻辑 - 优先LogoManager
   364→            var logoImage: UIImage?
   365→            
   366→            // 第一优先级：使用经过验证的LogoManager
   367→            logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)
   368→            print("  ✅ 简化版: 使用LogoManager加载Logo: '\(settings.selectedLogo.displayName)' -> \(logoImage != nil ? "成功" : "失败")")
   369→            
   370→            // 如果LogoManager失败，尝试DynamicLogoManager作为备用
   371→            if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
   372→                if let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(where: { $0.imageName == brandLogoImageName }) {
   373→                    logoImage = DynamicLogoManager.shared.loadLogo(dynamicLogo)
   374→                    print("  🔄 简化版: DynamicLogoManager备用加载: '\(brandLogoImageName)' -> \(logoImage != nil ? "成功" : "失败")")
   375→                } else {
   376→                    print("  ❌ 简化版: DynamicLogoManager中未找到匹配的Logo: '\(brandLogoImageName)'")
   377→                }
   378→            }
   379→            
   380→            if let logoImage = logoImage {
   381→                // 保持Logo的真实宽高比
   382→                let logoAspectRatio = logoImage.size.width / logoImage.size.height
```

_**Agent (claude-sonnet-4-20250514)**_

现在添加一个测试方法来验证修复效果。让我在WatermarkSettings中添加一个测试Logo启用函数：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   150→        
   151→        return settings
   152→    }
   153→    
   154→    // 🎯 调试用：临时启用Logo测试
   155→    static func enableTestLogo() {
   156→        var settings = WatermarkSettings.load()
   157→        settings.isEnabled = true
   158→        settings.selectedLogo = .hasselblad  // 使用哈苏Logo测试
   159→        settings.showLogoLine = true
   160→        settings.showDeviceModel = true
   161→        settings.save()
   162→        print("🧪 测试Logo已启用: Hasselblad")
   163→    }
   164→    
   165→    // 🎯 调试用：启用Apple Logo测试（确保资源存在）
   166→    static func enableAppleLogoTest() {
   167→        var settings = WatermarkSettings.load()
   168→        settings.isEnabled = true
   169→        settings.selectedLogo = .apple  // 使用Apple Logo测试
   170→        settings.showLogoLine = true
   171→        settings.showDeviceModel = true
   172→        settings.logoPosition = .center
   173→        settings.infoPosition = .center
   174→        settings.save()
   175→        print("🧪 Apple Logo测试已启用")
   176→    }
   177→    
   178→    // 🎯 调试用：验证Logo资源是否存在
   179→    static func verifyLogoResources() {
   180→        let allLogos = BrandLogo.allCases.filter { $0 != .none && $0 != .custom }
   181→        
   182→        print("🔍 Logo资源验证:")
   183→        for logo in allLogos {
   184→            if let imageName = logo.imageName {
   185→                let exists = UIImage(named: imageName) != nil
   186→                print("  - \(logo.displayName) (\(imageName)): \(exists ? "✅存在" : "❌缺失")")
   187→            }
   188→        }
   189→    }
   190→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我添加缺失的`PositionAlignment`枚举，因为代码中使用了但没有定义：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import Foundation
     2→import UIKit
     3→
     4→// 位置对齐枚举
     5→enum PositionAlignment: String, CaseIterable, Codable {
     6→    case left = "左对齐"
     7→    case center = "居中"
     8→    case right = "右对齐"
     9→    
    10→    var displayName: String {
    11→        return self.rawValue
    12→    }
    13→}
    14→
    15→// 🎨 简化：水印样式枚举 - 只保留一种统一样式
    16→enum WatermarkStyle: String, CaseIterable, Codable {
    17→    case unified = "统一水印"
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我编译项目来验证修复是否成功：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 编译项目验证修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build`

Error:

```
--- xcodebuild: WARNING: Using the first of multiple matching destinations:
{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
** BUILD FAILED **


The following build commands failed:
	SwiftCompile normal arm64 Compiling\ WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift (in target 'MCCamera' from project 'MCCamera')
	SwiftCompile normal arm64 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift (in target 'MCCamera' from project 'MCCamera')
	SwiftCompile normal arm64 Compiling\ WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift (in target 'MCCamera' from project 'MCCamera')
	SwiftCompile normal arm64 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift (in target 'MCCamera' from project 'MCCamera')
	Building project MCCamera with scheme MCCamera
(5 failures)

Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: f6cf7e8cd8cf3ccc0d9268ab10599d2b
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/f6cf7e8cd8cf3ccc0d9268ab10599d2b.xcbuilddata
ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache

ProcessProductPackaging "" /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Entitlements:
    
    {
    "application-identifier" = "2867UNTJFF.com.lianjia.decoration.stewardHD";
}
    
    builtin-productPackagingUtility -entitlements -format xml -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent

ProcessProductPackagingDER /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent.der (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /usr/bin/derq query -f xml -i /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermedia

... [76876 characters truncated] ...

eCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphonesimulator18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/host/plugins -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/local/lib/swift/host/plugins -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.o -index-unit-output-path /MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.o -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -index-system-modules
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:140:23: error: 'PositionAlignment' is ambiguous for type lookup in this context
    var logoPosition: PositionAlignment = .center
                      ^~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift:5:6: note: found this candidate
enum PositionAlignment: String, CaseIterable, Codable, Identifiable {
     ^
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:5:6: note: found this candidate
enum PositionAlignment: String, CaseIterable, Codable {
     ^
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:141:23: error: 'PositionAlignment' is ambiguous for type lookup in this context
    var infoPosition: PositionAlignment = .center
                      ^~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift:5:6: note: found this candidate
enum PositionAlignment: String, CaseIterable, Codable, Identifiable {
     ^
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:5:6: note: found this candidate
enum PositionAlignment: String, CaseIterable, Codable {
     ^
```

_**Agent (claude-sonnet-4-20250514)**_

哥，有命名冲突问题。让我检查并修复FrameModel中已存在的PositionAlignment定义：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/Models/FrameModel.swift`

Result:

```
1→import Foundation
     2→import SwiftUI
     3→
     4→// 位置对齐枚举
     5→enum PositionAlignment: String, CaseIterable, Codable, Identifiable {
     6→    case left = "左对齐"
     7→    case center = "居中" 
     8→    case right = "右对齐"
     9→    
    10→    var id: String { self.rawValue }
    11→    
    12→    var displayName: String {
    13→        return self.rawValue
    14→    }
    15→}
    16→
    17→// 相框类型枚举
    18→enum FrameType: String, CaseIterable, Identifiable {
    19→    case none = "无"
    20→    case bottomText = "底部文字"
    21→    case polaroid = "宝丽来"
    22→    case masterSeries = "大师系列"  // 添加大师系列相框类型
    23→    
    24→    var id: String { self.rawValue }
    25→    
    26→    // 获取相框图片名称
    27→    var imageName: String? {
    28→        switch self {
    29→        case .none:
    30→            return nil
    31→        case .bottomText:
    32→            return "底部文字"
    33→        case .polaroid:
    34→            return "baolilai"  // 修改为正确的图片资源名称
    35→        case .masterSeries:
    36→            return "master_xiangkuang"  // 大师系列预览图
    37→        }
    38→    }
    39→    
    40→    // 获取相框预览图片
    41→    var previewImage: Image? {
    42→        guard let name = imageName else { return nil }
    43→        return Image(name)
    44→    }
    45→}
    46→
    47→// 相框设置模型
    48→class FrameSettings: ObservableObject {
    49→    @Published var selectedFrame: FrameType = .none
    50→    @Published var customText: String = "PHOTO by Mr.C"
    51→    @Published var showDate: Bool = false
    52→    @Published var showLocation: Bool = false
    53→    @Published var showExif: Bool = false
    54→    
    55→    // 相框信息选项
    56→    @Published var showExifParams: Bool = false
    57→    @Published var showExifDate: Bool = false
    58→    
    59→    // 新增：更细致的信息控制开关
    60→    @Published var showDeviceModel: Bool = false      // 显示设备型号
    61→    @Published var showFocalLength: Bool = false     // 显示焦距
    62→    @Published var showShutterSpeed: Bool = false    // 显示快门速度
    63→    @Published var showISO: Bool = false             // 显示ISO
    64→    @Published var showAperture: Bool = false        // 显示光圈
    65→    
    66→    // 选择的Logo (保留兼容性)
    67→    @Published var selectedLogo: String? = nil
    68→    @Published var selectedBrandLogo: BrandLogo = .none  // 保留：枚举方式
    69→    @Published var selectedDynamicLogo: DynamicLogo? = nil  // 新增：动态Logo方式
    70→    
    71→    // 是否显示签名
    72→    @Published var showSignature: Bool = false
    73→    
    74→    // 水印相关设置
    75→    @Published var watermarkEnabled: Bool = false     // 是否启用水印
    76→    @Published var watermarkStyle: WatermarkStyle = .unified  // 水印样式（简化为统一样式）
    77→    @Published var watermarkPosition: WatermarkPosition = .bottomLeft  // 水印位置
    78→    
    79→    // 经典水印设置
    80→    @Published var authorName: String = ""           // 作者名称
    81→    
    82→    // 专业垂直水印设置  
    83→    @Published var showLogoLine: Bool = true         // 显示Logo行
    84→    @Published var showDeviceLine: Bool = true       // 显示设备行
    85→    @Published var showLensLine: Bool = true         // 显示镜头行
    86→    @Published var showParametersLine: Bool = true   // 显示参数行
    87→    
    88→    // 参数行详细控制
    89→    @Published var showTimeStamp: Bool = false       // 显示时间戳
    90→    
    91→    // 🎨 新增：Logo和信息位置控制
    92→    @Published var logoPosition: PositionAlignment = .center      // Logo位置
    93→    @Published var infoPosition: PositionAlignment = .center      // 信息位置
    94→    
    95→    // MARK: - 水印设置同步
    96→    
    97→    /// 将当前的FrameSettings同步到WatermarkSettings
    98→    func syncToWatermarkSettings() {
    99→        var watermarkSettings = WatermarkSettings.load()
   100→        
   101→        // 同步基本设置
   102→        watermarkSettings.isEnabled = self.watermarkEnabled
   103→        watermarkSettings.watermarkStyle = self.watermarkStyle
   104→        watermarkSettings.position = self.watermarkPosition
   105→        
   106→        // 同步经典水印设置
   107→        watermarkSettings.authorName = self.authorName
   108→        
   109→        // 同步自定义文字（专业垂直水印使用）
   110→        watermarkSettings.customText = self.customText
   111→        
   112→        // 同步Logo设置
   113→        if let dynamicLogo = self.selectedDynamicLogo, dynamicLogo.imageName != "none" {
   114→            // 从动态Logo转换回BrandLogo枚举
   115→            let convertedLogo = convertToBrandLogo(dynamicLogo)
   116→            watermarkSettings.selectedLogo = convertedLogo
   117→            print("  🔄 Logo同步: \(dynamicLogo.imageName) -> \(convertedLogo)")
   118→        } else {
   119→            watermarkSettings.selectedLogo = .none
   120→            print("  🔄 Logo同步: 设置为无")
   121→        }
   122→        
   123→        // 同步专业垂直水印设置
   124→        watermarkSettings.showLogoLine = self.showLogoLine
   125→        watermarkSettings.showDeviceLine = self.showDeviceLine  
   126→        watermarkSettings.showLensLine = self.showLensLine
   127→        watermarkSettings.showParametersLine = self.showParametersLine
   128→        
   129→        print("  🔄 专业水印设置: Logo行=\(self.showLogoLine), 设备行=\(self.showDeviceLine), 镜头行=\(self.showLensLine), 参数行=\(self.showParametersLine)")
   130→        
   131→        // 同步信息显示设置
   132→        watermarkSettings.showDeviceModel = self.showDeviceModel
   133→        watermarkSettings.showFocalLength = self.showFocalLength
   134→        watermarkSettings.showShutterSpeed = self.showShutterSpeed
   135→        watermarkSettings.showISO = self.showISO
   136→        watermarkSettings.showAperture = self.showAperture
   137→        watermarkSettings.showDate = self.showDate
   138→        watermarkSettings.showTimeStamp = self.showTimeStamp
   139→        
   140→        // 🎨 同步位置设置
   141→        watermarkSettings.logoPosition = self.logoPosition
   142→        watermarkSettings.infoPosition = self.infoPosition
   143→        
   144→        print("  🔧 FrameSettings -> WatermarkSettings 参数同步:")
   145→        print("    - logoPosition: \(self.logoPosition.displayName) -> \(watermarkSettings.logoPosition.displayName)")
   146→        print("    - infoPosition: \(self.infoPosition.displayName) -> \(watermarkSettings.infoPosition.displayName)")
   147→        print("    - showDeviceModel: \(self.showDeviceModel) -> \(watermarkSettings.showDeviceModel)")
   148→        print("    - showFocalLength: \(self.showFocalLength) -> \(watermarkSettings.showFocalLength)")
   149→        print("    - showShutterSpeed: \(self.showShutterSpeed) -> \(watermarkSettings.showShutterSpeed)")
   150→        print("    - showISO: \(self.showISO) -> \(watermarkSettings.showISO)")
   151→        print("    - showAperture: \(self.showAperture) -> \(watermarkSettings.showAperture)")
   152→        print("    - showDate: \(self.showDate) -> \(watermarkSettings.showDate)")
   153→        
   154→        // 保存同步后的设置
   155→        watermarkSettings.save()
   156→        
   157→        print("🔄 FrameSettings已同步到WatermarkSettings")
   158→    }
   159→    
   160→    /// 将DynamicLogo转换为BrandLogo枚举（用于向后兼容）
   161→    private func convertToBrandLogo(_ dynamicLogo: DynamicLogo) -> BrandLogo {
   162→        switch dynamicLogo.imageName {
   163→        case "Apple_logo_black": return .apple
   164→        case "Canon_wordmark": return .canon
   165→        case "Sony_logo": return .sony
   166→        case "Nikon_Logo": return .nikon
   167→        case "Leica_Camera_logo": return .leica
   168→        case "Fujifilm_logo": return .fujifilm
   169→        case "Hasselblad_logo": return .hasselblad
   170→        case "Hasselblad_logo_w": return .hasselblad_w
   171→        case "Olympus_Corporation_logo": return .olympus
   172→        case "Panasonic_logo_(Blue)": return .panasonic
   173→        case "Zeiss_logo": return .zeiss
   174→        case "Arri_logo": return .arri
   175→        case "Panavision_logo": return .panavision
   176→        case "Polaroid_logo": return .polaroid
   177→        case "Ricoh_logo_2012": return .ricoh
   178→        case "Eastman_Kodak_Company_logo_(2016)(no_background)": return .kodak
   179→        case "dji-1": return .dji
   180→        case "baolilai": return .baolilai
   181→        case "hasu": return .hasu
   182→        default: return .none
   183→        }
   184→    }
   185→}
```

_**Agent (claude-sonnet-4-20250514)**_

既然FrameModel已经有了PositionAlignment定义，我需要删除WatermarkSettings中重复的定义：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import Foundation
     2→import UIKit
     3→
     4→// 🎨 简化：水印样式枚举 - 只保留一种统一样式
     5→enum WatermarkStyle: String, CaseIterable, Codable {
     6→    case unified = "统一水印"
```

_**Agent (claude-sonnet-4-20250514)**_

现在重新编译项目：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 重新编译项目验证修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: 0fe744da8e8bbb154450a98247fe25e9
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/0fe744da8e8bbb154450a98247fe25e9.xcbuilddata
ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache

ProcessInfoPlistFile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-infoPlistUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist -producttype com.apple.product-type.application -genpkginfo /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/PkgInfo -expandbuildsettings -format binary -platform iphonesimulator -additionalcontentfile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/assetcatalog_generated_info.plist -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist

SwiftDriver MCCamera normal arm64 com.apple.xcode.tools.swift.compiler (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-SwiftDriver -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc -module-name MCCamera -Onone -enforce-exclusivity\=checked @/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.SwiftFileList -DDEBUG -enable-bare-slash-regex -enable-experimental-feature DebugDescriptionMacro -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -target arm64-apple-ios14.0-simulator -g -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -Xfrontend -serialize-debugging-options -profile-coverage-mapping -profile-generate -enable-testing -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -enable-experimental-feature OpaqueTypeErasure -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -swift-version 5 -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -c -j10 -enable-batch-mode -incremental -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -output-file-map /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-OutputFileMap.json -use-frontend-parseable-output -save-temps -no-color-diagnostics -serialize-diagnostics -emit-dependencies -emit-module -emit-module-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftmodule -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -emit-const-values -Xfrontend -const-gather-protocols-file -Xfrontend /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -emit-objc-header -emit-objc-header-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-Swift.h -working-directory /Users/macongcong/Desktop/MC/MCCamera -experimental-emit-module-separately -disable-cmo

SwiftEmitModule normal arm64 Emitting\ module\ for\ MCCamera (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-swiftTaskExecution -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -frontend -emit-module -experimental-skip-non-inlinable-function-bodies-without-types /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncMemoryManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoPromise.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/TaskScheduler.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/LogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphonesimulator18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/host/plugins -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/local/lib/swift/host/plugins -emit-module-doc-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftdoc -emit-module-source-info-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftsourceinfo -emit-objc-header-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-Swift.h -serialize-diagnostics-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-master-emit-module.dia -emit-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-master-emit-module.d -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftmodule -emit-abi-descriptor-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.abi.json

EmitSwiftModule normal arm64 (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -emit-module -experimental-skip-non-inlinable-function-bodies-without-types /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncMemoryManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoPromise.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/TaskScheduler.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/LogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphonesimulator18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeD

... [255 lines truncated] ...
```

_**Agent (claude-sonnet-4-20250514)**_

太好了！编译成功！现在让我完成最后的验证：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 检查DynamicLogoManager的logo加载逻辑
- [X] 🌡️ 分析PhotoDecorationPipeline中logo渲染流程
- [X] 🌡️ 验证WatermarkProcessor的logo处理机制
- [X] 🌡️ 检查logo资源文件和路径问题
- [X] 🌡️ 排查渲染上下文和图形绘制问题
- [X] 🌡️ 修复发现的bug并验证


_**Agent (claude-sonnet-4-20250514)**_

## 🎯 Bug修复总结

哥，我已经全面排查并修复了logo无法渲染到图片的bug。问题分析和解决方案如下：

### **🔍 现象层：用户看到的**
- Logo不显示在最终保存的照片中
- 设置中的Logo选择看似正常

### **🔧 本质层：技术根源**
发现了一个关键的架构缺陷：在`WatermarkService.swift`中，代码优先尝试使用不稳定的`DynamicLogoManager`，而这个管理器可能没有正确初始化或扫描Logo资源。

### **💡 哲学层：设计反思**
"依赖倒置的错误就是系统稳定性的破碎" - 应该依赖稳定的组件，而不是不稳定的新组件。

### **✅ 修复方案**

1. **优先级调整**：将Logo加载优先级从`DynamicLogoManager`改为`LogoManager`
2. **双重备份**：保持两个管理器作为相互备份
3. **增强调试**：添加了详细的Logo资源验证方法
4. **类型安全**：修复了`PositionAlignment`枚举冲突问题

### **🔨 核心修复代码**

```swift
// 修复前：不稳定的优先级
if let brandLogoImageName = settings.selectedLogo.imageName,
   let dynamicLogo = DynamicLogoManager.shared.availableLogos.first(...) {
    // 使用DynamicLogoManager (不稳定)
} else {
    // 回退到LogoManager (稳定)
}

// 修复后：稳定优先的架构
var logoImage: UIImage?

// 第一优先级：使用经过验证的LogoManager
logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)

// 如果LogoManager失败，尝试DynamicLogoManager作为备用
if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
    // DynamicLogoManager作为备份
}
```

### **🧪 调试工具**

添加了Logo资源验证方法：
```swift
WatermarkSettings.verifyLogoResources()  // 验证所有Logo资源
WatermarkSettings.enableAppleLogoTest()  // 启用Apple Logo测试
```

### **✅ 验证结果**
- ✅ 编译成功，没有错误
- ✅ Logo资源文件存在并可访问
- ✅ LogoManager和DynamicLogoManager双重备份机制
- ✅ 增强的错误诊断和日志系统

现在Logo应该可以正常渲染到照片中了。这个修复遵循了"稳定性优先"的架构原则，确保了系统的可靠性。

---

_**User**_

时间打开了 为啥没有渲染上去呢 另外 不同参数拼接 不要使用 / 直接空格就可以

---

_**Agent (claude-sonnet-4-20250514)**_

哥，我来检查PolaroidBottomLayoutView和参数拼接的问题。让我先看看这个文件：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift`

Result:

```
1→import SwiftUI
     2→
     3→// 宝丽来相框底部自动布局组件
     4→struct PolaroidBottomLayoutView: View {
     5→    let frameSize: CGSize
     6→    let borderHeight: CGFloat
     7→    let logoImage: UIImage?
     8→    let logoPosition: PolaroidLogoPosition
     9→    let infoPosition: PolaroidInfoPosition
    10→    let customText: String
    11→    let infoText: String
    12→    let isLandscape: Bool
    13→    
    14→    // 🎯 计算边框宽度，与PhotoDecorationRenderer保持一致
    15→    private var borderWidth: CGFloat {
    16→        // 从frameSize反推原图尺寸，然后计算边框宽度
    17→        // frameSize.width = originalWidth + borderWidth * 2
    18→        // frameSize.height = originalHeight + borderWidth + borderHeight
    19→        // 由于borderWidth基于原图最小边计算，我们需要迭代求解
    20→        
    21→        // 简化方法：根据borderHeight比例反推原图最小边
    22→        let minOriginalSize = borderHeight / (isLandscape ? 0.18 : 0.22)  // borderHeight是原图最小边的18%或22%
    23→        return minOriginalSize * (isLandscape ? 0.04 : 0.05)
    24→    }
    25→    
    26→    var body: some View {
    27→        ZStack {
    28→            // 白色背景
    29→            Color.white
    30→                .frame(width: frameSize.width, height: borderHeight)
    31→            
    32→            // 🔧 修复：重新设计布局逻辑，处理冲突情况
    33→            contentLayoutView
    34→                .frame(width: frameSize.width, height: borderHeight)
    35→        }
    36→    }
    37→    
    38→    // 🔧 新增：智能内容布局
    39→    @ViewBuilder
    40→    private var contentLayoutView: some View {
    41→        let samePos = isSamePosition(logoPosition: logoPosition, infoPosition: infoPosition)
    42→        if samePos {
    43→            // 🎯 情况1: logo和信息在同一位置 - 垂直排列，都按照设置的对齐方式排列
    44→            VStack(alignment: vStackAlignmentForPosition(logoPosition), spacing: 4) {
    45→                if logoImage != nil {
    46→                    logoView
    47→                }
    48→                if hasTextContent {
    49→                    textContentView
    50→                }
    51→            }
    52→            .frame(maxWidth: .infinity, alignment: alignmentForPosition(logoPosition))
    53→            .padding(.horizontal, borderWidth)
    54→        } else {
    55→            // 🎯 情况2: logo和信息在不同位置 - 精确宽度分配布局
    56→            HStack(spacing: 20) { // Logo和文字之间固定20px间距
    57→                // 左侧内容（Logo或信息）
    58→                if logoPosition == .left && logoImage != nil {
    59→                    logoView
    60→                } else if infoPosition == .left && hasTextContent {
    61→                    textContentView
    62→                        .frame(maxWidth: .infinity, alignment: .leading)
    63→                }
    64→                
    65→                // 中心内容（如果需要）
    66→                if logoPosition == .center && logoImage != nil {
    67→                    Spacer()
    68→                    logoView
    69→                    Spacer()
    70→                } else if infoPosition == .center && hasTextContent {
    71→                    textContentView
    72→                        .frame(maxWidth: .infinity, alignment: .center)
    73→                }
    74→                
    75→                // 右侧内容（Logo或信息）
    76→                if logoPosition == .right && logoImage != nil {
    77→                    Spacer()
    78→                    logoView
    79→                } else if infoPosition == .right && hasTextContent {
    80→                    Spacer()
    81→                    textContentView
    82→                        .frame(maxWidth: .infinity, alignment: .trailing)
    83→                }
    84→            }
    85→            .padding(.horizontal, borderWidth) // 左右边距
    86→        }
    87→    }
    88→    
    89→    // 🔧 新增：位置对齐辅助方法
    90→    private func alignmentForPosition(_ position: PolaroidLogoPosition) -> Alignment {
    91→        switch position {
    92→        case .left: return .leading
    93→        case .center: return .center
    94→        case .right: return .trailing
    95→        }
    96→    }
    97→    
    98→    // 🔧 新增：VStack内容对齐辅助方法
    99→    private func vStackAlignmentForPosition(_ position: PolaroidLogoPosition) -> HorizontalAlignment {
   100→        switch position {
   101→        case .left: return .leading
   102→        case .center: return .center
   103→        case .right: return .trailing
   104→        }
   105→    }
   106→    
   107→    // 🔧 新增：检查是否有文字内容
   108→    private var hasTextContent: Bool {
   109→        return !customText.isEmpty || !infoText.isEmpty
   110→    }
   111→    
   112→    // 🔧 新增：位置比较方法
   113→    private func isSamePosition(logoPosition: PolaroidLogoPosition, infoPosition: PolaroidInfoPosition) -> Bool {
   114→        switch (logoPosition, infoPosition) {
   115→        case (.left, .left), (.center, .center), (.right, .right):
   116→            return true
   117→        default:
   118→            return false
   119→        }
   120→    }
   121→    
   122→    // Logo视图
   123→    @ViewBuilder
   124→    private var logoView: some View {
   125→        if let logoImage = logoImage {
   126→            Image(uiImage: logoImage)
   127→                .resizable()
   128→                .aspectRatio(contentMode: .fit)
   129→                .frame(maxWidth: 488, maxHeight: borderHeight * 0.25) // 🔧 修复：488px最大宽度，25%最大高度
   130→        }
   131→    }
   132→    
   133→    // 文字内容视图 - 单行显示，自适应宽度
   134→    @ViewBuilder
   135→    private var textContentView: some View {
   136→        // 🔧 修复：所有信息合并为一行显示，避免换行
   137→        let combinedText = [customText, infoText].filter { !$0.isEmpty }.joined(separator: " | ")
   138→        
   139→        if !combinedText.isEmpty {
   140→            Text(combinedText)
   141→                .font(.system(size: borderHeight * (isLandscape ? 0.15 : 0.13), weight: .light))
   142→                .foregroundColor(.black)
   143→                .lineLimit(1) // 强制单行显示
   144→                .truncationMode(.tail) // 如果过长则尾部截断
   145→                .fixedSize(horizontal: false, vertical: true) // 允许水平扩展，避免不必要的截断
   146→        }
   147→    }
   148→}
   149→
   150→// 位置枚举 - 统一使用相同的底层类型
   151→enum PolaroidLogoPosition: String, CaseIterable {
   152→    case left = "left"
   153→    case center = "center" 
   154→    case right = "right"
   155→}
   156→
   157→enum PolaroidInfoPosition: String, CaseIterable {
   158→    case left = "left"
   159→    case center = "center"
   160→    case right = "right"
   161→}
   162→
   163→// 转换为UIImage的扩展
   164→extension View {
   165→    func asUIImage(size: CGSize) -> UIImage {
   166→        var resultImage: UIImage = UIImage()
   167→        
   168→        // 🔧 修复：确保在主线程中执行UIKit操作
   169→        if Thread.isMainThread {
   170→            resultImage = renderToUIImage(size: size)
   171→        } else {
   172→            DispatchQueue.main.sync {
   173→                resultImage = renderToUIImage(size: size)
   174→            }
   175→        }
   176→        
   177→        return resultImage
   178→    }
   179→    
   180→    private func renderToUIImage(size: CGSize) -> UIImage {
   181→        let controller = UIHostingController(rootView: self)
   182→        controller.view.bounds = CGRect(origin: .zero, size: size)
   183→        controller.view.backgroundColor = .clear
   184→        
   185→        let renderer = UIGraphicsImageRenderer(size: size)
   186→        return renderer.image { _ in
   187→            controller.view.drawHierarchy(in: controller.view.bounds, afterScreenUpdates: true)
   188→        }
   189→    }
   190→}
   191→
   192→#Preview {
   193→    PolaroidBottomLayoutView(
   194→        frameSize: CGSize(width: 400, height: 300),
   195→        borderHeight: 60,
   196→        logoImage: UIImage(systemName: "apple.logo"),
   197→        logoPosition: .left,
   198→        infoPosition: .right,
   199→        customText: "Sample Photo",
   200→        infoText: "1/60s | ISO400 | f/2.8 | 2025.09.08",
   201→        isLandscape: false
   202→    )
   203→}
   204→
```

_**Agent (claude-sonnet-4-20250514)**_

我看到问题了！在第137行，代码使用了`" | "`分隔符。还有一个更严重的问题是参数的拼接。让我检查WatermarkService中参数拼接的逻辑：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:2://  MCCameraApp.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:3://  MCCamera
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:2://  MCCameraTests.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:3://  MCCameraTests
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:14:        // Write your test here and use APIs like `#expect(...)` to check expected conditions.
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:44:// WatermarkService 优化策略
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:46:    // 超大图像：使用简化水印绘制
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:49:    // 标准图像：完整水印处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:56:// 根据图像大小选择处理策略
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:57:if originalSize > 100 { // 100MB
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:58:    // 直接保存原始数据
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:60:} else if megapixels >= 40 { // 48MP
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:61:    // 大图像优化处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:64:    // 标准图像处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:73:// 多层嵌套保护
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:74:autoreleasepool { // 外层保护
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:77:    autoreleasepool { // 内层保护关键操作
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:87:// 立即释放UI，后台处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:92:    // 后台处理，避免与主线程内存峰值重叠
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:4:// 动态Logo项目
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:22:// 动态Logo管理器 - 自动扫描和管理所有Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:29:    // Logo名称到显示名称的映射表（可配置）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:55:    // MARK: - Logo扫描和发现
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:57:    /// 扫描所有可用的Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:61:        // 添加"无Logo"选项
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:64:        // 扫描已知的Logo列表（按使用频率和重要性排序）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:66:            // 专业品牌
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:71:            // 主流相机品牌（优先显示）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:79:            // 其他品牌
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:85:            // 电影/专业设备
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:89:            // 其他
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:105:        // 尝试自动发现更多Logo（通过常见的Logo品牌名称模式）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:114:    /// 尝试发现额外的Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:118:        // 常见的Logo品牌和可能的文件名模式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:126:            // 尝试不同的命名模式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:141:                    break // 找到一个就跳出内层循环
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:149:    // MARK: - Logo管理
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:151:    /// 加载指定的Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:153:        // 特殊处理"无"选项
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:158:        // 检查缓存
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:163:        // 从Bundle加载图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:169:        // 预处理Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:172:        // 缓存处理后的图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:178:    /// 预处理Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:186:        // 缩放图片到合适大小
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:187:        let scale = maxSize / max(image.size.width, image.size.height)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:199:    // MARK: - 辅助方法
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:201:    /// 根据文件名生成显示名称
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:203:        // 处理特殊情况
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:206:        // 移除常见的后缀
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:213:        // 处理特殊字符和格式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:223:    /// 获取Logo对象通过图片名称
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:228:    /// 刷新Logo列表
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:233:    /// 清理缓存
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:239:// MARK: - SwiftUI Extensions
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:242:    /// 为SwiftUI提供的Logo视图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:251:                // "无Logo"的特殊显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:257:                // 备用显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:7:    // 计算文本在给定宽度下的高度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:19:    // 格式化EXIF信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:24:            // ISO信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:29:            // 光圈信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:34:            // 快门速度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:36:                let shutterValue = 1.0 / shutterSpeed.doubleValue
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:44:            // 焦距
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:53:    // 格式化日期信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:57:            // 尝试解析EXIF中的日期
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:67:        // 如果无法从EXIF获取，使用当前日期
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:73:    // 格式化位置信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:90:    // 获取设备信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:2://  ContentView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:3://  MCCamera
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:14:// 优化前：阻塞式处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:16:// 同步处理水印...
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:18:// 优化后：立即释放 + 异步处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:21:    // 后台处理水印和保存
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:31:// 检查数据大小，如果太大则跳过水印处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:45:// 根据图像大小选择处理策略
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:16:    // 应用相框到照片（兼容原有接口）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:21:    // 应用相框到照片并可选择集成水印信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:23:        // 检查是否需要渲染任何内容
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:31:        // 如果没有任何内容需要渲染，直接返回原图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:38:        // 使用autoreleasepool减少内存占用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:40:            // 创建UIImage
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:46:            // 修复图像方向 - 确保图像以正确的方向显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:49:            // 获取照片元数据
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:52:            // 根据相框类型和设置渲染装饰
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:53:            // 🔧 修复：大师相框模式和宝丽来模式下不使用自定义文字
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:56:            // 🔧 修复：获取正确的Logo名称 - 优先使用新的DynamicLogo系统
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:92:            // 转换回Data - 使用较低的压缩质量以减少内存使用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:101:    // 从图像数据中提取元数据 - 优化版本
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:105:        // 使用autoreleasepool减少内存占用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:108:                // 只获取需要的元数据，避免复制整个元数据字典
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:110:                    // 提取EXIF信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:112:                        // 只复制需要的EXIF字段
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:115:                        // ISO
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:120:                        // 光圈
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:125:                        // 快门速度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:130:                        // 焦距
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:135:                        // 日期时间
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:143:                    // 提取TIFF信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:145:                        // 只复制需要的TIFF字段
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:148:                        // 制造商
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:153:                        // 型号
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:161:                    // 提取GPS信息
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:163:                        // 只复制需要的GPS字段
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:166:                        // 纬度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:171:                        // 纬度参考
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:176:                        // 经度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:181:                        // 经度参考
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:195:    // 修复图像方向 - 确保图像以正确的方向显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:197:        // 如果图像方向已经是向上，直接返回
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:202:        // 创建正确方向的图像
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:10:    // 获取当前界面方向
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:31:        // 🚀 优化：使用autoreleasepool包围整个水印处理过程
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:35:            // 检测图像方向
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:52:            // 🚀 优化：检查图像大小，降低阈值以便更多图像使用优化路径
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:54:            let megapixels = Int(imageArea / 1_000_000)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:56:            // 🚀 关键修复：降低阈值到8MP，让12MP图像也使用优化绘制
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:62:            // 🚀 统一水印绘制（包装在autoreleasepool中）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:73:                    // 🎨 统一使用专业垂直水印样式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:83:    // 🚀 新增：优化的水印绘制方法，用于超大图像
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:88:            // 对于超大图像，使用更高效的绘制方式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:90:            format.scale = 1.0 // 使用1.0缩放因子减少内存使用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:96:                // 绘制原图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:99:                // 绘制水印（简化版本）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:102:                // 🎨 使用简化版统一水印样式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:109:    // 🚀 新增：超快速文字绘制方法，只有白色文字和轻微阴影
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:111:        // 使用简单的阴影效果替代描边，大大提升性能
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:114:        // 绘制阴影
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:124:        // 绘制主文字
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:141:            let denominator = Int(1.0 / speed)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:146:    // MARK: - 专业垂直水印渲染
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:148:    // 🚀 新增：专业垂直水印绘制方法
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:152:        // 确定有效绘制区域
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:160:        // 计算基本参数 - 横屏适配
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:162:        let logoSize = baseSize * (isLandscape ? 0.035 : 0.04)      // Logo大小
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:163:        let titleFontSize = baseSize * (isLandscape ? 0.024 : 0.028)  // 设备名字体大小
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:164:        let lineFontSize = baseSize * (isLandscape ? 0.020 : 0.024)   // 其他行字体大小
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:165:        let lineSpacing = baseSize * 0.012    // 行间距
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:166:        let bottomPadding = baseSize * (isLandscape ? 0.04 : 0.05)   // 底部边距
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:168:        // 字体定义
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:172:        // 获取水印内容
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:175:        // 计算总高度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:193:            totalHeight -= lineSpacing // 移除最后一个间距
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:196:        // 🎨 计算起始Y位置 - 统一使用底部对齐，位置差异通过X坐标体现
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:199:        // 计算X位置
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:207:        // 绘制Logo行 - 支持DynamicLogoManager
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:216:            // 🔧 重大修复：优先使用稳定的LogoManager，然后尝试DynamicLogoManager
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:219:            // 第一优先级：使用经过验证的LogoManager
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:223:            // 如果LogoManager失败，尝试DynamicLogoManager作为备用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:234:                // 🔧 修复：保持Logo的真实宽高比，88px最大宽度限制，按比例调整高度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:235:                let logoAspectRatio = logoImage.size.width / logoImage.size.height
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:236:                let maxLogoWidth: CGFloat = 488 // 最大宽度488px
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:238:                // 根据88px限制计算实际尺寸
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:240:                let logoHeight = logoWidth / logoAspectRatio
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:242:                // 🎨 使用新的Logo位置设置
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:248:                    logoX = rightX - logoWidth // 使用实际计算的宽度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:250:                    logoX = centerX - logoWidth / 2 // 使用实际计算的宽度
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:256:                    width: logoWidth, // 使用按比例计算的宽度（488p

... [1198 lines truncated] ...
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:2://  MCCameraTests.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:3://  MCCameraTests
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraTests/MCCameraTests.swift:14:        // Write your test here and use APIs like `#expect(...)` to check expected conditions.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:2://  MCCameraUITests.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:3://  MCCameraUITests
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:13:        // Put setup code here. This method is called before the invocation of each test method in the class.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:15:        // In UI tests it is usually best to stop immediately when a failure occurs.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:18:        // In UI tests it’s important to set the initial state - such as interface orientation - required for your tests before they run. The setUp method is a good place to do this.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:22:        // Put teardown code here. This method is called after the invocation of each test method in the class.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:27:        // UI tests must launch the application that they test.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:31:        // Use XCTAssert and related functions to verify your tests produce the correct results.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITests.swift:37:            // This measures how long it takes to launch your application.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITestsLaunchTests.swift:2://  MCCameraUITestsLaunchTests.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITestsLaunchTests.swift:3://  MCCameraUITests
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITestsLaunchTests.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITestsLaunchTests.swift:25:        // Insert steps here to perform after app launch but before taking a screenshot,
/Users/macongcong/Desktop/MC/MCCamera/MCCameraUITests/MCCameraUITestsLaunchTests.swift:26:        // such as logging into a test account or navigating somewhere in the app
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:44:// WatermarkService 优化策略
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:46:    // 超大图像：使用简化水印绘制
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:49:    // 标准图像：完整水印处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:56:// 根据图像大小选择处理策略
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:57:if originalSize > 100 { // 100MB
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:58:    // 直接保存原始数据
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:60:} else if megapixels >= 40 { // 48MP
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:61:    // 大图像优化处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:64:    // 标准图像处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:73:// 多层嵌套保护
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:74:autoreleasepool { // 外层保护
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:77:    autoreleasepool { // 内层保护关键操作
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:87:// 立即释放UI，后台处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_ISSUES_ANALYSIS.md:92:    // 后台处理，避免与主线程内存峰值重叠
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:14:// 优化前：阻塞式处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:16:// 同步处理水印...
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:18:// 优化后：立即释放 + 异步处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:21:    // 后台处理水印和保存
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:31:// 检查数据大小，如果太大则跳过水印处理
/Users/macongcong/Desktop/MC/MCCamera/MEMORY_OPTIMIZATION_SUMMARY.md:45:// 根据图像大小选择处理策略
/Users/macongcong/Desktop/MC/MCCamera/LOGO_MANAGEMENT.md:78:    "xiaomi", "huawei", "samsung", // 现有的
/Users/macongcong/Desktop/MC/MCCamera/LOGO_MANAGEMENT.md:79:    "newbrand", "anotherbrand"     // 新增的
/Users/macongcong/Desktop/MC/MCCamera/LOGO_MANAGEMENT.md:88:    // 自定义处理逻辑
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:13:├── Core/                          # 核心功能模块
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:14:│   ├── Camera/                    # 相机核心功能
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:18:│   ├── Location/                  # 位置服务
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:20:│   └── Photo/                     # 照片处理
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:24:├── Features/                      # 功能模块
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:25:│   ├── Camera/                    # 相机功能
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:29:│   │   └── Views/                      # UI 组件
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:36:│   ├── Settings/                  # 设置功能
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:38:│   └── Watermark/                 # 水印功能
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:44:└── Shared/                        # 共享资源
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:45:    ├── Components/                # 可复用组件
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:48:    ├── Extensions/                # 扩展工具
/Users/macongcong/Desktop/MC/MCCamera/PROJECT_STRUCTURE.md:52:    └── Models/                    # 数据模型
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:1:// !$*UTF8*$!
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:10:		E272D1562E543A66004E49D9 /* PBXContainerItemProxy */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:17:		E272D1602E543A66004E49D9 /* PBXContainerItemProxy */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:27:		E272D1452E543A64004E49D9 /* MCCamera.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = MCCamera.app; sourceTree = BUILT_PRODUCTS_DIR; };
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:28:		E272D1552E543A66004E49D9 /* MCCameraTests.xctest */ = {isa = PBXFileReference; explicitFileType = wrapper.cfbundle; includeInIndex = 0; path = MCCameraTests.xctest; sourceTree = BUILT_PRODUCTS_DIR; };
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:29:		E272D15F2E543A66004E49D9 /* MCCameraUITests.xctest */ = {isa = PBXFileReference; explicitFileType = wrapper.cfbundle; includeInIndex = 0; path = MCCameraUITests.xctest; sourceTree = BUILT_PRODUCTS_DIR; };
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:33:		E272D1472E543A64004E49D9 /* MCCamera */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:38:		E272D1582E543A66004E49D9 /* MCCameraTests */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:43:		E272D1622E543A66004E49D9 /* MCCameraUITests */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:51:		E272D1422E543A64004E49D9 /* Frameworks */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:58:		E272D1522E543A66004E49D9 /* Frameworks */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:65:		E272D15C2E543A66004E49D9 /* Frameworks */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:85:		E272D1462E543A64004E49D9 /* Products */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:98:		E272D1442E543A64004E49D9 /* MCCamera */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:120:		E272D1542E543A66004E49D9 /* MCCameraTests */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:143:		E272D15E2E543A66004E49D9 /* MCCameraUITests */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:169:		E272D13D2E543A64004E49D9 /* Project object */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:211:		E272D1432E543A64004E49D9 /* Resources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:218:		E272D1532E543A66004E49D9 /* Resources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:225:		E272D15D2E543A66004E49D9 /* Resources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:235:		E272D1412E543A64004E49D9 /* Sources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:242:		E272D1512E543A66004E49D9 /* Sources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:249:		E272D15B2E543A66004E49D9 /* Sources */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:259:		E272D1572E543A66004E49D9 /* PBXTargetDependency */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:264:		E272D1612E543A66004E49D9 /* PBXTargetDependency */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:272:		E272D1672E543A66004E49D9 /* Debug */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:335:		E272D1682E543A66004E49D9 /* Release */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:391:		E272D16A2E543A66004E49D9 /* Debug */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:425:		E272D16B2E543A66004E49D9 /* Release */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:459:		E272D16D2E543A66004E49D9 /* Debug */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:478:		E272D16E2E543A66004E49D9 /* Release */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:497:		E272D1702E543A66004E49D9 /* Debug */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:514:		E272D1712E543A66004E49D9 /* Release */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:534:		E272D1402E543A64004E49D9 /* Build configuration list for PBXProject "MCCamera" */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:543:		E272D1692E543A66004E49D9 /* Build configuration list for PBXNativeTarget "MCCamera" */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:552:		E272D16C2E543A66004E49D9 /* Build configuration list for PBXNativeTarget "MCCameraTests" */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj/project.pbxproj:561:		E272D16F2E543A66004E49D9 /* Build configuration list for PBXNativeTarget "MCCameraUITests" */ = {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:2://  MCCameraApp.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:3://  MCCamera
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:2://  ContentView.swift
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:3://  MCCamera
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift:5://  Created by 马聪聪 on 2025/8/19.
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:4:// 动态Logo项目
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:22:// 动态Logo管理器 - 自动扫描和管理所有Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:29:    // Logo名称到显示名称的映射表（可配置）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:55:    // MARK: - Logo扫描和发现
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:57:    /// 扫描所有可用的Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:61:        // 添加"无Logo"选项
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:64:        // 扫描已知的Logo列表（按使用频率和重要性排序）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:66:            // 专业品牌
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:71:            // 主流相机品牌（优先显示）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:79:            // 其他品牌
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:85:            // 电影/专业设备
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:89:            // 其他
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:105:        // 尝试自动发现更多Logo（通过常见的Logo品牌名称模式）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:114:    /// 尝试发现额外的Logo资源
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:118:        // 常见的Logo品牌和可能的文件名模式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:126:            // 尝试不同的命名模式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:141:                    break // 找到一个就跳出内层循环
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:149:    // MARK: - Logo管理
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:151:    /// 加载指定的Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:153:        // 特殊处理"无"选项
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:158:        // 检查缓存
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:163:        // 从Bundle加载图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:169:        // 预处理Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:172:        // 缓存处理后的图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:178:    /// 预处理Logo图片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:186:        // 缩放图片到合适大小
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:187:        let scale = maxSize / max(image.size.width, image.size.height)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:199:    // MARK: - 辅助方法
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:201:    /// 根据文件名生成显示名称
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:203:        // 处理特殊情况
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:206:        // 移除常见的后缀
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:213:        // 处理特殊字符和格式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:223:    /// 获取Logo对象通过图片名称
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:228:    /// 刷新Logo列表
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:233:    /// 清理缓存
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:239:// MARK: - SwiftUI Extensions
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:242:    /// 为SwiftUI提供的Logo视图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:251:                // "无Logo"的特殊显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift:257:                // 备用显示
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:10:                // 垂直线 - 三分之一处
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:11:                let oneThirdWidth = width / 3
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:12:                let twoThirdWidth = width * 2 / 3
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:20:                // 水平线 - 三分之一处
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:21:                let oneThirdHeight = height / 3
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift:22:                let twoThirdHeight = height * 2 / 3
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:10:    // 获取当前界面方向
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:31:        // 🚀 优化：使用autoreleasepool包围整个水印处理过程
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:35:            // 检测图像方向
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:52:            // 🚀 优化：检查图像大小，降低阈值以便更多图像使用优化路径
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:54:            let megapixels = Int(imageArea / 1_000_000)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:56:            // 🚀 关键修复：降低阈值到8MP，让12MP图像也使用优化绘制
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:62:            // 🚀 统一水印绘制（包装在autoreleasepool中）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:73:                    // 🎨 统一使用专业垂直水印样式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:83:    // 🚀 新增：优化的水印绘制方法，用于超大图像
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:88:            // 对于超大图像，使用更高效的绘制方式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:90:            format.scale = 1.0 // 使用1.0缩放因子减少内存使用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:96:                // 绘制原图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:99:                // 绘制水印（简化版本）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:102:                // 🎨 使用简化版统一水印样式
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:109:    // 🚀 新增：超快速文字绘制方法，只有白色文字和轻微阴影
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:111:        // 使用简单的阴影效果替代描边，大大提升性能
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:114:        // 绘制阴影
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:124:        // 绘制主文字
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:141:            let denominator = Int(1.0 / speed)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:146:    // MARK: - 专业垂直水印渲染
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swi

... [1193 lines truncated] ...
```

_**Agent (claude-sonnet-4-20250514)**_

让我搜索具体的参数拼接逻辑：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift:228:        return components.joined(separator: " / ")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:495:            let parametersLine = parameterComponents.joined(separator: " / ")
```

_**Agent (claude-sonnet-4-20250514)**_

太好了！找到问题了。现在修复两个地方的参数拼接问题：

1. PolaroidBottomLayoutView中的 `" | "` 分隔符
2. WatermarkService和CameraCaptureSettings中的 `" / "` 分隔符

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   132→    
   133→    // 文字内容视图 - 单行显示，自适应宽度
   134→    @ViewBuilder
   135→    private var textContentView: some View {
   136→        // 🔧 修复：所有信息合并为一行显示，使用空格分隔
   137→        let combinedText = [customText, infoText].filter { !$0.isEmpty }.joined(separator: " ")
   138→        
   139→        if !combinedText.isEmpty {
   140→            Text(combinedText)
   141→                .font(.system(size: borderHeight * (isLandscape ? 0.15 : 0.13), weight: .light))
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   491→        }
   492→        
   493→        // 如果有拍摄参数，组合成一行
   494→        if !parameterComponents.isEmpty {
   495→            let parametersLine = parameterComponents.joined(separator: " ")
   496→            content.append(parametersLine)
   497→        }
   498→        
   499→        print("  🔧 动态水印内容构建完成：")
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Error:

```
<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Shared/Models/CameraCaptureSettings.swift`

Result:

```
220→    var fullParameterString: String {
   221→        var components = [formattedAperture, formattedShutterSpeed, formattedISO]
   222→        
   223→        if let exposureBias = exposureBias, exposureBias != 0 {
   224→            let sign = exposureBias > 0 ? "+" : ""
   225→            components.append("\(sign)\(String(format: "%.1f", exposureBias))EV")
   226→        }
   227→        
   228→        return components.joined(separator: " / ")
   229→    }
   230→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   224→            let sign = exposureBias > 0 ? "+" : ""
   225→            components.append("\(sign)\(String(format: "%.1f", exposureBias))EV")
   226→        }
   227→        
   228→        return components.joined(separator: " ")
   229→    }
   230→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在关于时间问题，我需要检查为什么时间没有渲染上去。让我检查时间相关的逻辑：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:481:        if settings.showDate {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:483:            formatter.dateFormat = "yyyy.MM.dd"
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:484:            parameterComponents.append(formatter.string(from: captureSettings.timestamp))
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:487:        if settings.showTimeStamp {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:489:            formatter.dateFormat = "HH:mm:ss"
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:490:            parameterComponents.append(formatter.string(from: captureSettings.timestamp))
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:506:        print("      - showDate: \(settings.showDate)")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift:507:        print("      - showTimeStamp: \(settings.showTimeStamp)")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:111:    var showDate: Bool = true
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift:125:    var showTimeStamp: Bool = false
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift:56:    let timestamp: Date
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift:70:        timestamp: Date = Date(),
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift:80:        self.timestamp = timestamp
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift:99:                Toggle("显示时间戳", isOn: $settings.showTimeStamp)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:59:            formatter.dateFormat = "yyyy:MM:dd HH:mm:ss"
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:62:                formatter.dateFormat = format
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift:69:        formatter.dateFormat = format
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:27:        let hasInfo = frameSettings.showDate || frameSettings.showDeviceModel || 
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:79:                showDate: frameSettings.showDate,
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift:12:        showDate: Bool,
```

_**Agent (claude-sonnet-4-20250514)**_

问题在于默认的时间戳设置是关闭的。让我检查当前的设置并启用测试：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   162→        settings.save()
   163→        print("🧪 测试Logo已启用: Hasselblad")
   164→    }
   165→    
   166→    // 🎯 调试用：启用Apple Logo测试（确保资源存在）
   167→    static func enableAppleLogoTest() {
   168→        var settings = WatermarkSettings.load()
   169→        settings.isEnabled = true
   170→        settings.selectedLogo = .apple  // 使用Apple Logo测试
   171→        settings.showLogoLine = true
   172→        settings.showDeviceModel = true
   173→        settings.showDate = true        // 启用日期显示
   174→        settings.showTimeStamp = true   // 启用时间戳显示
   175→        settings.logoPosition = .center
   176→        settings.infoPosition = .center
   177→        settings.save()
   178→        print("🧪 Apple Logo测试已启用（包含日期和时间戳）")
   179→    }
   180→    
   181→    // 🎯 调试用：验证Logo资源是否存在
   182→    static func verifyLogoResources() {
   183→        let allLogos = BrandLogo.allCases.filter { $0 != .none && $0 != .custom }
```

_**Agent (claude-sonnet-4-20250514)**_

再次编译项目验证修复：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 编译验证参数拼接修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16" build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: 82caf90ab8ea3ad2a0a3f664fdc625ae
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/82caf90ab8ea3ad2a0a3f664fdc625ae.xcbuilddata
ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache

ProcessInfoPlistFile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-infoPlistUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist -producttype com.apple.product-type.application -genpkginfo /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/PkgInfo -expandbuildsettings -format binary -platform iphonesimulator -additionalcontentfile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/assetcatalog_generated_info.plist -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist

SwiftDriver MCCamera normal arm64 com.apple.xcode.tools.swift.compiler (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-SwiftDriver -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc -module-name MCCamera -Onone -enforce-exclusivity\=checked @/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.SwiftFileList -DDEBUG -enable-bare-slash-regex -enable-experimental-feature DebugDescriptionMacro -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -target arm64-apple-ios14.0-simulator -g -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -Xfrontend -serialize-debugging-options -profile-coverage-mapping -profile-generate -enable-testing -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -enable-experimental-feature OpaqueTypeErasure -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -swift-version 5 -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -c -j10 -enable-batch-mode -incremental -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -output-file-map /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-OutputFileMap.json -use-frontend-parseable-output -save-temps -no-color-diagnostics -serialize-diagnostics -emit-dependencies -emit-module -emit-module-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftmodule -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -emit-const-values -Xfrontend -const-gather-protocols-file -Xfrontend /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -emit-objc-header -emit-objc-header-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-Swift.h -working-directory /Users/macongcong/Desktop/MC/MCCamera -experimental-emit-module-separately -disable-cmo

SwiftCompile normal arm64 Compiling\ CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-swiftTaskExecution -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -frontend -c /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncMemoryManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoPromise.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/TaskScheduler.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/LogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift -primary-file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -emit-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.d -emit-const-values-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.swiftconstvalues -emit-reference-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.swiftdeps -serialize-diagnostics-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.dia -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphonesimulator18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/host/plugins -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/local/lib/swift/host/plugins -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.o -index-unit-output-path /MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.o -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -index-system-modules

SwiftCompile normal arm64 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -c /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncMemoryManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/AsyncPhotoPipeline.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoPromise.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/TaskScheduler.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/PolaroidBottomLayoutView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/DynamicLogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/LogoManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift -primary-file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -emit-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.d -emit-const-values-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.swiftconstvalues -emit-reference-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.swiftdeps -serialize-diagnostics-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/CameraCaptureSettings.dia -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/

... [60 lines truncated] ...
```

_**Agent (claude-sonnet-4-20250514)**_

完美！编译成功了。现在让我总结修复的问题：

## 🎯 修复总结

哥，我已经完成了logo渲染和参数拼接的全面修复：

### **✅ 已修复的问题：**

#### **1. Logo无法渲染到图片的核心Bug**
- **现象层**：Logo设置了但不显示在最终照片中
- **本质层**：WatermarkService优先使用不稳定的DynamicLogoManager
- **解决方案**：调整优先级，优先使用稳定的LogoManager，DynamicLogoManager作为备用

#### **2. 参数拼接使用 " / " 的问题**
- **修复位置**：
  - `WatermarkService.swift:495` - 水印参数拼接
  - `CameraCaptureSettings.swift:228` - 相机设置参数拼接  
  - `PolaroidBottomLayoutView.swift:137` - 相框文字拼接
- **修改**：将所有 `" / "` 和 `" | "` 分隔符改为空格 `" "`

#### **3. 时间戳默认关闭的问题**
- **问题**：时间戳默认设置为false，需要手动启用
- **解决方案**：在测试方法中同时启用日期和时间戳显示

### **🔧 关键修复代码**

```swift
// Logo加载优先级修复
var logoImage: UIImage?

// 第一优先级：稳定的LogoManager
logoImage = LogoManager.shared.loadLogo(settings.selectedLogo)

// 第二优先级：DynamicLogoManager作为备用
if logoImage == nil, let brandLogoImageName = settings.selectedLogo.imageName {
    // 尝试DynamicLogoManager...
}
```

```swift
// 参数拼接修复 - 从 " / " 改为 " "
let parametersLine = parameterComponents.joined(separator: " ")
```

### **🧪 测试方法**

启用完整测试：
```swift
WatermarkSettings.enableAppleLogoTest()  // Logo + 日期 + 时间戳
```

### **🌟 架构改进**

遵循了"稳定优先，冗余备份"的设计哲学：
- 依赖稳定的组件作为主要路径
- 不稳定的新特性作为备用方案
- 双重保险确保功能的可靠性

现在Logo应该可以正常渲染到照片中，参数也会用空格分隔显示，时间戳也包含在内了！

