<!-- Generated by SpecStory -->

# Watermark Performance Fix: Memory and Speed Optimization (2025-08-25 09:53:04Z)

<!-- Claude Code Session ed5ad967-f12b-4584-8f29-a003e04f7c13 (2025-08-25_09-53-04Z) -->

_**User**_

完整阅读当前项目.梳理清晰逻辑

---

_**Agent (claude-sonnet-4-20250514)**_

I'll analyze the current MCCamera project structure and logic to provide you with a clear understanding.

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [⚡] 🌡️ Read project structure and main files
- [ ] 🌡️ Analyze SwiftUI views and camera implementation
- [ ] 🌡️ Review camera service and MVVM architecture
- [ ] 🌡️ Check settings and configuration files
- [ ] 🌡️ Summarize project logic and structure


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **LS**

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/MCCameraApp.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/ContentView.swift`

Result:

```
- /Users/macongcong/Desktop/MC/MCCamera/
  - CLAUDE.md
  - DEVELOPMENT_ROADMAP.md
  - MCCamera.xcodeproj/
    - project.pbxproj
    - project.xcworkspace/
      - contents.xcworkspacedata
      - xcshareddata/
        - swiftpm/
          - configuration/
      - xcuserdata/
        - macongcong.xcuserdatad/
          - UserInterfaceState.xcuserstate
    - xcuserdata/
      - macongcong.xcuserdatad/
        - xcschemes/
          - xcschememanagement.plist
  - MCCamera/
    - Assets.xcassets/
      - AccentColor.colorset/
        - Contents.json
      - AppIcon.appiconset/
        - Contents.json
        - WechatIMG31 1.png
        - WechatIMG31 2.png
        - WechatIMG31.png
        - backup/
          - WechatIMG31 1.png
          - WechatIMG31 2.png
          - WechatIMG31.png
      - Apple_logo_black.imageset/
        - Apple_logo_black.png
        - Contents.json
      - Arri_logo.imageset/
        - Arri_logo.png
        - Contents.json
      - Canon_wordmark.imageset/
        - Canon_wordmark.png
        - Contents.json
      - Contents.json
      - Eastman_Kodak_Company_logo_(2016)(no_background).imageset/
        - Contents.json
        - Eastman_Kodak_Company_logo_(2016)(no_background).png
      - Fujifilm_logo.imageset/
        - Contents.json
        - Fujifilm_logo.png
      - Hasselblad_logo.imageset/
        - Contents.json
        - Hasselblad_logo.png
      - Icons.imageset/
      - Leica_Camera_logo.imageset/
        - Contents.json
        - Leica_Camera_logo.png
      - Nikon_Logo.imageset/
        - Contents.json
        - Nikon_Logo.png
      - Olympus_Corporation_logo.imageset/
        - Contents.json
        - Olympus_Corporation_logo.png
      - Panasonic_logo_(Blue).imageset/
        - Contents.json
        - Panasonic_logo_(Blue).png
      - Panavision_logo.imageset/
        - Contents.json
        - Panavision_logo.png
      - Polaroid_logo.imageset/
        - Contents.json
        - Polaroid_logo.png
      - Ricoh_logo_2012.imageset/
        - Contents.json
        - Ricoh_logo_2012.png
      - Sony_logo.imageset/
        - Contents.json
        - Sony_logo.png
      - Zeiss_logo.imageset/
        - Contents.json
        - Zeiss_logo.png
      - baolilai.imageset/
        - Contents.json
        - baolilai.png
      - dji-1.imageset/
        - Contents.json
        - dji-1.png
      - 底部文字.imageset/
        - Contents.json
        - 底部文字@2x.png
      - 杂志封面.imageset/
        - Contents.json
        - 杂志封面.png
      - 水印居中.imageset/
        - Contents.json
        - 水印居中.png
    - ContentView.swift
    - Core/
      - Camera/
        - CameraDiscovery.swift
        - CameraService.swift
        - FlashController.swift
        - HighResolutionCameraManager.swift
      - Location/
        - LocationManager.swift
      - Photo/
        - PhotoProcessor.swift
        - PhotoSettingsManager.swift
    - Features/
      - Border/
      - Camera/
        - CameraPreview.swift
        - CameraView.swift
        - CameraViewModel.swift
        - Views/
          - AspectRatioPreviewOverlay.swift
          - AspectRatioSelectionView.swift
          - CameraControlsView.swift
          - CameraManualControlsView.swift
          - CameraManualSliderView.swift
          - FlashControlView.swift
          - GalleryButtonView.swift
          - LensSelectorView.swift
          - PermissionView.swift
          - ShutterButtonView.swift
          - ThumbnailView.swift
      - Frame/
        - Models/
          - FrameModel.swift
        - Services/
          - InfoLayoutEngine.swift
          - PhotoDecorationRenderer.swift
          - PhotoDecorationService.swift
        - Views/
          - FrameSettingsView.swift
          - SimplePhotoDecorationView.swift
      - Settings/
        - SettingsView.swift
      - Watermark/
        - WatermarkProcessor.swift
        - WatermarkService.swift
        - WatermarkSettings.swift
        - WatermarkSettingsView.swift
    - MCCameraApp.swift
    - Preview Content/
      - Preview Assets.xcassets/
        - Contents.json
    - Shared/
      - Components/
        - ExposureSlider.swift
        - GridOverlay.swift
      - Extensions/
        - CameraHelper.swift
        - DeviceInfoHelper.swift
        - MemoryMonitor.swift
        - UIImage+Extensions.swift
      - Models/
        - AspectRatio.swift
        - CameraCaptureSettings.swift
        - CameraManualSettings.swift
        - FlashMode.swift
        - PhotoFormat.swift
        - PhotoResolution.swift
  - MCCameraTests/
    - MCCameraTests.swift
  - MCCameraUITests/
    - MCCameraUITests.swift
    - MCCameraUITestsLaunchTests.swift
  - MEMORY_ISSUES_ANALYSIS.md
  - MEMORY_OPTIMIZATION_SUMMARY.md
  - PROJECT_STRUCTURE.md
  - WatermarkFeature.md
  - XCODE_PROJECT_UPDATE.md
  - create_logo_assets.sh
  - log.md

NOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work.
```

Result:

```
1→//
     2→//  MCCameraApp.swift
     3→//  MCCamera
     4→//
     5→//  Created by 马聪聪 on 2025/8/19.
     6→//
     7→
     8→import SwiftUI
     9→
    10→@main
    11→struct MCCameraApp: App {
    12→    var body: some Scene {
    13→        WindowGroup {
    14→            ContentView()
    15→        }
    16→    }
    17→}
    18→
```

Result:

```
1→//
     2→//  ContentView.swift
     3→//  MCCamera
     4→//
     5→//  Created by 马聪聪 on 2025/8/19.
     6→//
     7→
     8→import SwiftUI
     9→
    10→struct ContentView: View {
    11→    var body: some View {
    12→        CameraView()
    13→            .ignoresSafeArea()
    14→            .onAppear {
    15→                print("📱 ContentView onAppear - 应用启动完成")
    16→            }
    17→    }
    18→}
    19→
    20→#Preview {
    21→    ContentView()
    22→}
    23→
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Read project structure and main files
- [⚡] 🌡️ Analyze SwiftUI views and camera implementation
- [ ] 🌡️ Review camera service and MVVM architecture
- [ ] 🌡️ Check settings and configuration files
- [ ] 🌡️ Summarize project logic and structure


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Camera/CameraView.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Camera/CameraViewModel.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Core/Camera/CameraService.swift`

Result:

```
1→import SwiftUI
     2→
     3→struct CameraView: View {
     4→    @StateObject private var viewModel = CameraViewModel()
     5→    @State private var showingSettings = false
     6→    
     7→    var body: some View {
     8→        GeometryReader { geometry in
     9→            ZStack {
    10→                Color.black.ignoresSafeArea()
    11→                
    12→                if viewModel.isAuthorized {
    13→                    cameraPreviewLayer(geometry: geometry)
    14→                    
    15→                    CameraControlsView(
    16→                        viewModel: viewModel,
    17→                        showingSettings: $showingSettings
    18→                    )
    19→                } else {
    20→                    PermissionView()
    21→                }
    22→            }
    23→        }
    24→        .onAppear {
    25→            print("📄 CameraView onAppear")
    26→            viewModel.startCamera()
    27→        }
    28→        .onDisappear {
    29→            print("📄 CameraView onDisappear")  
    30→            viewModel.stopCamera()
    31→        }
    32→        .alert(isPresented: $viewModel.showingAlert) {
    33→            Alert(
    34→                title: Text("提示"),
    35→                message: Text(viewModel.alertMessage),
    36→                dismissButton: .default(Text("确定"))
    37→            )
    38→        }
    39→        .sheet(isPresented: $showingSettings) {
    40→            SettingsView()
    41→        }
    42→        .overlay(
    43→            // 比例选择弹窗
    44→            Group {
    45→                if viewModel.showingAspectRatioSelection {
    46→                    AspectRatioSelectionView(
    47→                        selectedAspectRatio: $viewModel.selectedAspectRatio,
    48→                        isPresented: $viewModel.showingAspectRatioSelection
    49→                    )
    50→                }
    51→            }
    52→        )
    53→        .overlay(
    54→            // 相框设置弹窗
    55→            Group {
    56→                if viewModel.showingFrameSettings {
    57→                    FrameSettingsView(
    58→                        frameSettings: viewModel.frameSettings,
    59→                        isPresented: $viewModel.showingFrameSettings
    60→                    )
    61→                }
    62→            }
    63→        )
    64→    }
    65→    
    66→    private func cameraPreviewLayer(geometry: GeometryProxy) -> some View {
    67→        ZStack {
    68→            CameraPreview(
    69→                session: viewModel.session,
    70→                onTap: { point in
    71→                    viewModel.setFocusPoint(point)
    72→                },
    73→                onLongPress: { point in
    74→                    viewModel.lockFocusAndExposure(at: point)
    75→                }
    76→            )
    77→            
    78→            if viewModel.isGridVisible {
    79→                GridOverlay()
    80→            }
    81→            
    82→            if viewModel.showingExposureSlider {
    83→                ExposureSlider(
    84→                    value: $viewModel.exposureValue,
    85→                    focusPoint: viewModel.focusPoint,
    86→                    geometry: geometry,
    87→                    onValueChanged: { value in
    88→                        viewModel.setExposureCompensation(value)
    89→                    }
    90→                )
    91→            }
    92→            
    93→            // 画面比例遮罩
    94→            AspectRatioPreviewOverlay(
    95→                aspectRatio: viewModel.selectedAspectRatio,
    96→                geometry: geometry
    97→            )
    98→        }
    99→    }
   100→}
   101→
   102→#Preview {
   103→    CameraView()
   104→}
```

Result:

```
1→import SwiftUI
     2→import AVFoundation
     3→import Combine
     4→
     5→class CameraViewModel: ObservableObject {
     6→    // 添加frameSettings属性
     7→    @Published var frameSettings = FrameSettings()
     8→    @Published var showingFrameSettings = false
     9→    
    10→    @Published var isAuthorized = false
    11→    @Published var showingAlert = false
    12→    @Published var alertMessage = ""
    13→    @Published var capturedImage: UIImage?
    14→    @Published var isCapturing = false
    15→    @Published var currentLensIndex = 0
    16→    @Published var exposureValue: Float = 0.0
    17→    @Published var showingExposureSlider = false
    18→    @Published var focusPoint: CGPoint = .zero
    19→    @Published var isGridVisible = false
    20→    
    21→    // 🚀 新增：后台处理状态指示器
    22→    @Published var isProcessingInBackground = false
    23→    @Published var backgroundProcessingCount = 0
    24→    
    25→    // 添加设置监听
    26→    private var cancellables = Set<AnyCancellable>()
    27→    
    28→    // 监听设置变化
    29→    @Published var currentPhotoFormat: PhotoFormat = .heic
    30→    @Published var currentPhotoResolution: PhotoResolution = .resolution12MP
    31→    @Published var is48MPAvailable = false
    32→    
    33→    // 添加手动相机控制
    34→    @Published var manualSettings = CameraManualSettings()
    35→    @Published var isManualControlsVisible = false
    36→    
    37→    // 画面比例设置
    38→    @Published var selectedAspectRatio: AspectRatio = .default
    39→    @Published var showingAspectRatioSelection = false
    40→    
    41→    // 🔦 闪光灯控制
    42→    @Published var flashController = FlashController()
    43→    
    44→    private let cameraService = CameraService()
    45→    
    46→    var session: AVCaptureSession {
    47→        cameraService.session
    48→    }
    49→    
    50→    var availableLenses: [String] {
    51→        let devices = cameraService.availableCameras
    52→        return devices.map { device in
    53→            switch device.deviceType {
    54→            case .builtInUltraWideCamera:
    55→                return "0.5×"
    56→            case .builtInWideAngleCamera:
    57→                return "1×"
    58→            case .builtInTelephotoCamera:
    59→                return "3×"
    60→            case .builtInTripleCamera:
    61→                return "1×"
    62→            case .builtInDualCamera:
    63→                return "2×"
    64→            case .builtInDualWideCamera:
    65→                return "1×"
    66→            default:
    67→                return "1×"
    68→            }
    69→        }
    70→    }
    71→    
    72→    init() {
    73→        print("🎯 CameraViewModel 初始化")
    74→        loadSettings()
    75→        
    76→        // 立即设置为已授权，先显示UI
    77→        isAuthorized = true
    78→        
    79→        // 设置默认选中1x镜头（索引为1）
    80→        currentLensIndex = 1
    81→        
    82→        // 监听手动设置变化通知
    83→        NotificationCenter.default.addObserver(
    84→            self,
    85→            selector: #selector(handleManualSettingChanged(_:)),
    86→            name: NSNotification.Name("ManualSettingChanged"),
    87→            object: nil
    88→        )
    89→        
    90→        // 🚀 监听后台处理完成通知
    91→        NotificationCenter.default.addObserver(
    92→            self,
    93→            selector: #selector(handleBackgroundProcessingCompleted),
    94→            name: NSNotification.Name("BackgroundProcessingCompleted"),
    95→            object: nil
    96→        )
    97→        
    98→        // 异步检查权限，避免阻塞UI
    99→        DispatchQueue.global(qos: .userInitiated).async { [weak self] in
   100→            self?.checkCameraPermission()
   101→        }
   102→    }
   103→    
   104→    @objc private func handleManualSettingChanged(_ notification: Notification) {
   105→        print("📱 收到手动设置变化通知")
   106→        if let type = notification.userInfo?["type"] as? CameraManualSettingType,
   107→           let value = notification.userInfo?["value"] as? Float {
   108→            print("📱 设置类型: \(type.rawValue), 值: \(value)")
   109→            applyManualSettings()
   110→        }
   111→    }
   112→    
   113→    // 🚀 新增：处理后台处理完成通知
   114→    @objc private func handleBackgroundProcessingCompleted() {
   115→        print("📱 收到后台处理完成通知")
   116→        finishBackgroundProcessing()
   117→    }
   118→    
   119→    private func loadSettings() {
   120→        isGridVisible = UserDefaults.standard.bool(forKey: "grid_overlay_enabled")
   121→        
   122→        // 读取照片格式设置
   123→        if let formatString = UserDefaults.standard.string(forKey: "photo_format"),
   124→           let format = PhotoFormat(rawValue: formatString) {
   125→            currentPhotoFormat = format
   126→        }
   127→        
   128→        // 读取分辨率设置
   129→        if let resolutionString = UserDefaults.standard.string(forKey: "photo_resolution"),
   130→           let resolution = PhotoResolution(rawValue: resolutionString) {
   131→            currentPhotoResolution = resolution
   132→        }
   133→        
   134→        // 读取画面比例设置
   135→        if let aspectRatioString = UserDefaults.standard.string(forKey: "selected_aspect_ratio"),
   136→           let aspectRatio = AspectRatio(rawValue: aspectRatioString) {
   137→            selectedAspectRatio = aspectRatio
   138→        }
   139→        
   140→        // 更新相机服务设置
   141→        cameraService.updatePhotoSettings(format: currentPhotoFormat, resolution: currentPhotoResolution)
   142→        
   143→        // 监听设置变化
   144→        setupSettingsObservers()
   145→        
   146→        // 监听相机切换通知
   147→        setupCameraSwitchNotifications()
   148→    }
   149→    
   150→    private func setupSettingsObservers() {
   151→        // 监听照片格式变化
   152→        UserDefaults.standard.publisher(for: \.photo_format)
   153→            .compactMap { PhotoFormat(rawValue: $0 ?? "") }
   154→            .sink { [weak self] format in
   155→                self?.currentPhotoFormat = format
   156→                self?.updateCameraSettings()
   157→            }
   158→            .store(in: &cancellables)
   159→        
   160→        // 监听分辨率变化
   161→        UserDefaults.standard.publisher(for: \.photo_resolution)
   162→            .compactMap { PhotoResolution(rawValue: $0 ?? "") }
   163→            .sink { [weak self] resolution in
   164→                self?.currentPhotoResolution = resolution
   165→                self?.updateCameraSettings()
   166→            }
   167→            .store(in: &cancellables)
   168→    }
   169→    
   170→    private func updateCameraSettings() {
   171→        cameraService.updatePhotoSettings(format: currentPhotoFormat, resolution: currentPhotoResolution)
   172→    }
   173→    
   174→    private func setupCameraSwitchNotifications() {
   175→        NotificationCenter.default.publisher(for: NSNotification.Name("CameraSwitchRequires12MP"))
   176→            .sink { [weak self] _ in
   177→                DispatchQueue.main.async {
   178→                    // 自动切换回12MP并提醒用户
   179→                    self?.currentPhotoResolution = .resolution12MP
   180→                    UserDefaults.standard.set("12MP", forKey: "photo_resolution")
   181→                    self?.updateCameraSettings()
   182→                    self?.showAlert(message: "已切换到12MP，当前镜头不支持48MP")
   183→                }
   184→            }
   185→            .store(in: &cancellables)
   186→    }
   187→    
   188→    private func checkCameraPermission() {
   189→        print("🔐 检查相机权限...")
   190→        let status = AVCaptureDevice.authorizationStatus(for: .video)
   191→        
   192→        DispatchQueue.main.async { [weak self] in
   193→            switch status {
   194→            case .authorized:
   195→                print("✅ 相机权限已授权")
   196→                self?.isAuthorized = true
   197→                // 异步启动相机
   198→                DispatchQueue.global(qos: .userInitiated).async {
   199→                    self?.cameraService.startSession()
   200→                }
   201→            case .notDetermined:
   202→                print("❓ 相机权限未确定，请求权限")
   203→                self?.requestCameraPermission()
   204→            case .denied, .restricted:
   205→                print("❌ 相机权限被拒绝")
   206→                self?.isAuthorized = false
   207→            @unknown default:
   208→                print("❓ 未知相机权限状态")
   209→                self?.isAuthorized = false
   210→            }
   211→        }
   212→    }
   213→    
   214→    func requestCameraPermission() {
   215→        cameraService.requestPermissions { [weak self] authorized in
   216→            DispatchQueue.main.async {
   217→                self?.isAuthorized = authorized
   218→                if authorized {
   219→                    self?.cameraService.startSession()
   220→                } else {
   221→                    self?.showAlert(message: "需要相机权限才能使用此功能")
   222→                }
   223→            }
   224→        }
   225→    }
   226→    
   227→    func startCamera() {
   228→        guard isAuthorized else {
   229→            requestCameraPermission()
   230→            return
   231→        }
   232→        cameraService.startSession()
   233→        
   234→        // 启动后更新48MP可用性
   235→        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
   236→            self?.update48MPAvailability()
   237→            // 🔦 初始化闪光灯控制器
   238→            self?.updateFlashController()
   239→            // 检查设备能力
   240→            self?.checkDeviceCapabilities()
   241→        }
   242→    }
   243→    
   244→    func stopCamera() {
   245→        cameraService.stopSession()
   246→    }
   247→    
   248→    func capturePhoto() {
   249→        guard !isCapturing else { return }
   250→        
   251→        print("📸 开始拍照")
   252→        isCapturing = true
   253→        
   254→        cameraService.capturePhoto(
   255→            aspectRatio: selectedAspectRatio,
   256→            flashMode: flashController.getPhotoFlashMode(),
   257→            frameSettings: frameSettings  // 添加frameSettings参数
   258→        ) { [weak self] result in
   259→            DispatchQueue.main.async {
   260→                // 🚀 立即释放拍摄状态，允许连续拍摄
   261→                self?.isCapturing = false
   262→                
   263→                switch result {
   264→                case .success(let imageData):
   265→                    let dataSize = imageData.count / (1024 * 1024)
   266→                    print("📸 拍照成功，数据大小: \(dataSize)MB")
   267→                    
   268→                    self?.capturedImage = UIImage(data: imageData)
   269→                    
   270→                    // 🚀 启动后台处理指示
   271→                    self?.startBackgroundProcessing()
   272→                    
   273→                    // 显示快速反馈
   274→                    self?.showTemporaryCaptureFeedback()
   275→                    
   276→                case .failure(let error):
   277→                    print("📸 拍照失败: \(error.localizedDescription)")
   278→                    self?.showAlert(message: "拍照失败: \(error.localizedDescription)")
   279→                }
   280→            }
   281→        }
   282→    }
   283→    
   284→    // 🚀 新增：后台处理管理
   285→    private func startBackgroundProcessing() {
   286→        backgroundProcessingCount += 1
   287→        isProcessingInBackground = true
   288→        
   289→        print("🚀 开始后台处理，当前处理数量: \(backgroundProcessingCount)")
   290→    }
   291→    
   292→    private func finishBackgroundProcessing() {
   293→        backgroundProcessingCount = max(0, backgroundProcessingCount - 1)
   294→        isProcessingInBackground = backgroundProcessingCount > 0
   295→        
   296→        print("🚀 完成后台处理，剩余处理数量: \(backgroundProcessingCount)")
   297→    }
   298→    
   299→    private func showTemporaryCaptureFeedback() {
   300→        // 可以触发相机快门动画或短暂的视觉反馈
   301→        print("📸 拍摄成功，正在后台处理水印...")
   302→    }
   303→    
   304→    func switchLens(to index: Int) {
   305→        guard index != currentLensIndex && index < cameraService.availableCameras.count else { return }
   306→        
   307→        currentLensIndex = index
   308→        cameraService.switchCamera(to: index)
   309→        
   310→        // 切换镜头后更新48MP可用性
   311→        update48MPAvailability()
   312→        
   313→        // 🔦 更新闪光灯控制器的当前设备
   314→        updateFlashController()
   315→        
   316→        // 切换镜头时重置手动设置
   317→        manualSettings.resetToDefaults()
   318→        manualSettings.selectedSetting = nil
   319→    }
   320→    
   321→    // 更新48MP可用性状态
   322→    private func update48MPAvailability() {
   323→        DispatchQueue.main.async { [weak self] in
   324→            self?.is48MPAvailable = self?.cameraService.is48MPAvailable ?? false
   325→        }
   326→    }
   327→    
   328→    // 🔦 更新闪光灯控制器
   329→    private func updateFlashController() {
   330→        flashController.updateDevice(cameraService.currentDevice)
   331→    }
   332→    
   333→    func setFocusPoint(_ point: CGPoint) {
   334→        focusPoint = point
   335→        cameraService.setFocusPoint(point)
   336→        
   337→        showingExposureSlider = true
   338→        
   339→        DispatchQueue.main.asyncAfter(deadline: .now() + 3.0) {
   340→            self.showingExposureSlider = false
   341→        }
   342→    }
   343→    
   344→    func lockFocusAndExposure(at point: CGPoint) {
   345→        focusPoint = point
   346→        cameraService.setFocusPoint(point)
   347→        showAlert(message: "已锁定对焦和曝光")
   348→    }
   349→    
   350→    func setExposureCompensation(_ value: Float) {
   351→        exposureValue = value
   352→        cameraService.setExposureCompensation(value)
   353→    }
   354→    
   355→    func toggleGrid() {
   356→        isGridVisible.toggle()
   357→        UserDefaults.standard.set(isGridVisible, forKey: "grid_overlay_enabled")
   358→    }
   359→    
   360→    // 重置所有相机设置为自动模式
   361→    func resetToAutoMode() {
   362→        print("\n📸 重置所有相机设置为自动模式...")
   363→        
   364→        guard let device = cameraService.currentDevice else {
   365→            print("❌ 当前没有可用的相机设备")
   366→            return
   367→        }
   368→        
   369→        do {
   370→            try device.lockForConfiguration()
   371→            print("📸 成功锁定设备配置")
   372→            
   373→            // 重置曝光为自动模式
   374→            if device.isExposureModeSupported(.continuousAutoExposure) {
   375→                device.exposureMode = .continuousAutoExposure
   376→                print("📸 设置为连续自动曝光模式")
   377→                
   378→                // 重置曝光补偿为0
   379→                device.setExposureTargetBias(0.0, completionHandler: { (time) in
   380→                    print("📸 曝光补偿已重置为0")
   381→                })
   382→            }
   383→            
   384→            // 重置对焦为自动模式
   385→            if device.isFocusModeSupported(.continuousAutoFocus) {
   386→                device.focusMode = .continuousAutoFocus
   387→                print("📸 设置为连续自动对焦模式")
   388→            }
   389→            
   390→            // 重置白平衡为自动模式
   391→            if device.isWhiteBalanceModeSupported(.continuousAutoWhiteBalance) {
   392→                device.whiteBalanceMode = .continuousAutoWhiteBalance
   393→                print("📸 设置为连续自动白平衡模式")
   394→            }
   395→            
   396→            device.unlockForConfiguration()
   397→            print("📸 所有设置已重置为自动模式")
   398→            
   399→            // 重置曝光滑块值
   400→            exposureValue = 0.0
   401→            
   402→            // 重置手动设置为默认值
   403→            manualSettings.resetToDefaults()
   404→            manualSettings.selectedSetting = nil
   405→            
   406→        } catch {
   407→            print("❌ 无法配置相机设备: \(error)")
   408→        }
   409→    }
   410→    
   411→    // 应用手动相机设置
   412→    func applyManualSettings() {
   413→        print("\n📸 开始应用手动相机设置...")
   414→        
   415→        guard let device = cameraService.currentDevice else {
   416→            print("❌ 当前没有可用的相机设备")
   417→            return
   418→        }
   419→        
   420→        print("📸 当前设备: \(device.localizedName)")
   421→        print("📸 设备类型: \(device.deviceType.rawValue)")
   422→        print("📸 尝试应用的设置值:")
   423→        print("  - 快门速度: \(manualSettings.getDisplayText(for: .shutterSpeed)) (\(manualSettings.shutterSpeed))")
   424→        print("  - ISO: \(manualSettings.iso)")
   425→        print("  - 曝光补偿: \(manualSettings.exposure)")
   426→        print("  - 对焦: \(manualSettings.focus)")
   427→        print("  - 色温: \(manualSettings.whiteBalance)K")
   428→        print("  - 色调: \(manualSettings.tint)")
   429→        
   430→        do {
   431→            try device.lockForConfiguration()
   432→            print("📸 成功锁定设备配置")
   433→            
   434→            // 检查当前选中的设置类型，只应用相关设置
   435→            if let selectedSetting = manualSettings.selectedSetting {
   436→                print("📸 当前选中设置: \(selectedSetting.rawValue)")
   437→                
   438→                switch selectedSetting {
   439→                case .exposure:
   440→                    // 曝光补偿模式 - 保持自动曝光但应用补偿
   441→                    if device.isExposureModeSupported(.continuousAutoExposure) {
   442→                        print("📸 设置连续自动曝光模式")
   443→                        device.exposureMode = .continuousAutoExposure
   444→                        
   445→                        let exposureValue = manualSettings.exposure
   446→                        let clampedExposure = max(device.minExposureTargetBias, min(exposureValue, device.maxExposureTargetBias))
   447→                        print("📸 应用曝光补偿: \(clampedExposure) (限制在 \(device.minExposureTargetBias) 到 \(device.maxExposureTargetBias))")
   448→                        
   449→                        device.setExposureTargetBias(clampedExposure, completionHandler: { (time) in
   450→                            print("📸 曝光补偿设置完成，时间: \(time.seconds)秒")
   451→                        })
   452→                        
   453→                        // 验证曝光补偿是否生效
   454→                        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
   455→                            print("📸 验证曝光补偿: 当前值=\(device.exposureTargetBias), 目标值=\(clampedExposure)")
   456→                        }
   457→                    }
   458→                    
   459→                case .shutterSpeed, .iso:
   460→                    // 手动曝光模式 - 完全手动控制ISO和快门速度
   461→                    if device.isExposureModeSupported(.custom) {
   462→                        let minISO = device.activeFormat.minISO
   463→                        let maxISO = device.activeFormat.maxISO
   464→                        let isoValue = max(minISO, min(manualSettings.iso, maxISO))
   465→                        
   466→                        let shutterSeconds = shutterSpeedToSeconds(manualSettings.shutterSpeed)
   467→                        let minExposureSeconds = device.activeFormat.minExposureDuration.seconds
   468→                        let maxExposureSeconds = device.activeFormat.maxExposureDuration.seconds
   469→                        let clampedShutterSeconds = max(minExposureSeconds, min(shutterSeconds, maxExposureSeconds))
   470→                        
   471→                        print("📸 设置自定义曝光模式:")
   472→                        print("  - ISO: \(isoValue) (限制在 \(minISO)-\(maxISO))")
   473→                        print("  - 快门速度: \(clampedShutterSeconds)秒 (限制在 \(minExposureSeconds)-\(maxExposureSeconds)秒)")
   474→                        
   475→                        let exposureDuration = CMTime(seconds: clampedShutterSeconds, preferredTimescale: 1000000)
   476→                        
   477→                        device.exposureMode = .custom
   478→                        device.setExposureModeCustom(
   479→                            duration: exposureDuration,
   480→                            iso: isoValue,
   481→                            completionHandler: { (time) in
   482→                                print("📸 自定义曝光设置完成，实际曝光时间: \(time.seconds)秒")
   483→                            }
   484→                        )
   485→                    }
   486→                    
   487→                case .focus:
   488→                    // 对焦设置
   489→                    if device.isFocusModeSupported(.locked) {
   490→                        print("📸 设置对焦模式为锁定")
   491→                        device.focusMode = .locked
   492→                        let focusValue = manualSettings.focus
   493→                        print("📸 对焦值: \(focusValue)")
   494→                        
   495→                        if device.isFocusPointOfInterestSupported {
   496→                            device.focusPointOfInterest = CGPoint(x: 0.5, y: 0.5)
   497→                        }
   498→                    }
   499→                    
   500→                case .whiteBalance, .tint:
   501→                    // 白平衡设置
   502→                    if device.isWhiteBalanceModeSupported(.locked) {
   503→                        print("📸 设置白平衡模式为锁定")
   504→                        device.whiteBalanceMode = .locked
   505→                        
   506→                        var temperatureAndTint = AVCaptureDevice.WhiteBalanceTemperatureAndTintValues()
   507→                        temperatureAndTint.temperature = manualSettings.whiteBalance
   508→                        temperatureAndTint.tint = manualSettings.tint
   509→                        print("📸 色温: \(temperatureAndTint.temperature)K, 色调: \(temperatureAndTint.tint)")
   510→                        
   511→                        do {
   512→                            let whiteBalanceGains = try device.deviceWhiteBalanceGains(for: temperatureAndTint)
   513→                            let normalizedGains = AVCaptureDevice.WhiteBalanceGains(
   514→                                redGain: min(max(whiteBalanceGains.redGain, 1.0), device.maxWhiteBalanceGain),
   515→                                greenGain: min(max(whiteBalanceGains.greenGain, 1.0), device.maxWhiteBalanceGain),
   516→                                blueGain: min(max(whiteBalanceGains.blueGain, 1.0), device.maxWhiteBalanceGain)
   517→                            )
   518→                            
   519→                            device.setWhiteBalanceModeLocked(with: normalizedGains, completionHandler: { (time) in
   520→                                print("📸 白平衡设置完成，时间: \(time.seconds)秒")
   521→                            })
   522→                        } catch {
   523→                            print("❌ 无法计算白平衡增益: \(error)")
   524→                        }
   525→                    }
   526→                }
   527→            } else {
   528→                print("📸 没有选中特定设置，跳过应用")
   529→            }
   530→            
   531→            device.unlockForConfiguration()
   532→            print("📸 设备配置已解锁")
   533→            
   534→        } catch {
   535→            print("❌ 无法配置相机设备: \(error)")
   536→        }
   537→    }
   538→    
   539→    // 将快门速度值转换为秒数
   540→    private func shutterSpeedToSeconds(_ value: Float) -> Double {
   541→        if value <= 0 {
   542→            // 小于等于0的值表示分数形式，如1/60, 1/125等
   543→            return 1.0 / Double(60 * pow(2, -value))
   544→        } else {
   545→            // 大于0的值表示秒数，如1", 2"等
   546→            return Double(pow(2, value - 1))
   547→        }
   548→    }
   549→    
   550→    // 切换手动控制可见性
   551→    func toggleManualControls() {
   552→        isManualControlsVisible.toggle()
   553→    }
   554→    
   555→    // 在 CameraViewModel 类中添加以下方法
   556→    func checkDeviceCapabilities() {
   557→        print("\n📱 检查相机设备能力...")
   558→        
   559→        guard let device = cameraService.currentDevice else {
   560→            print("❌ 当前没有可用的相机设备")
   561→            return
   562→        }
   563→        
   564→        print("📱 当前设备: \(device.localizedName)")
   565→        print("📱 设备类型: \(device.deviceType.rawValue)")
   566→        
   567→        // 检查曝光控制能力
   568→        print("\n📱 曝光控制能力:")
   569→        print("  - 支持自定义曝光模式: \(device.isExposureModeSupported(.custom))")
   570→        print("  - 支持锁定曝光模式: \(device.isExposureModeSupported(.locked))")
   571→        print("  - 支持连续自动曝光模式: \(device.isExposureModeSupported(.continuousAutoExposure))")
   572→        print("  - 最小ISO: \(device.activeFormat.minISO)")
   573→        print("  - 最大ISO: \(device.activeFormat.maxISO)")
   574→        print("  - 支持曝光点设置: \(device.isExposurePointOfInterestSupported)")
   575→        
   576→        // 检查对焦控制能力
   577→        print("\n📱 对焦控制能力:")
   578→        print("  - 支持锁定对焦模式: \(device.isFocusModeSupported(.locked))")
   579→        print("  - 支持自动对焦模式: \(device.isFocusModeSupported(.autoFocus))")
   580→        print("  - 支持连续自动对焦模式: \(device.isFocusModeSupported(.continuousAutoFocus))")
   581→        print("  - 支持对焦点设置: \(device.isFocusPointOfInterestSupported)")
   582→        
   583→        // 检查白平衡控制能力
   584→        print("\n📱 白平衡控制能力:")
   585→        print("  - 支持锁定白平衡模式: \(device.isWhiteBalanceModeSupported(.locked))")
   586→        print("  - 支持自动白平衡模式: \(device.isWhiteBalanceModeSupported(.autoWhiteBalance))")
   587→        print("  - 支持连续自动白平衡模式: \(device.isWhiteBalanceModeSupported(.continuousAutoWhiteBalance))")
   588→        
   589→        // 检查其他能力
   590→        print("\n📱 其他能力:")
   591→        print("  - 支持手电筒: \(device.hasTorch)")
   592→        print("  - 支持闪光灯: \(device.hasFlash)")
   593→        print("  - 支持平滑对焦: \(device.isSmoothAutoFocusSupported)")
   594→        print("  - 支持视频稳定: \(device.activeFormat.isVideoStabilizationModeSupported(.auto))")
   595→        
   596→        print("\n📱 设备格式信息:")
   597→        print("  - 最大照片ISO: \(device.activeFormat.maxISO)")
   598→        print("  - 最小照片ISO: \(device.activeFormat.minISO)")
   599→        print("  - 最大曝光时间: \(device.activeFormat.maxExposureDuration.seconds)秒")
   600→        print("  - 最小曝光时间: \(device.activeFormat.minExposureDuration.seconds)秒")
   601→        
   602→        print("\n📱 当前设置:")
   603→        print("  - 当前ISO: \(device.iso)")
   604→        print("  - 当前曝光时间: \(device.exposureDuration.seconds)秒")
   605→        print("  - 当前曝光模式: \(device.exposureMode.rawValue)")
   606→        print("  - 当前对焦模式: \(device.focusMode.rawValue)")
   607→        print("  - 当前白平衡模式: \(device.whiteBalanceMode.rawValue)")
   608→    }
   609→    
   610→    private func showAlert(message: String) {
   611→        alertMessage = message
   612→        showingAlert = true
   613→    }
   614→    
   615→    // 添加切换相框设置视图的方法
   616→    func toggleFrameSettings() {
   617→        showingFrameSettings.toggle()
   618→    }
   619→}
   620→
   621→extension UserDefaults {
   622→    @objc dynamic var photo_format: String? {
   623→        return string(forKey: "photo_format")
   624→    }
   625→    
   626→    @objc dynamic var photo_resolution: String? {
   627→        return string(forKey: "photo_resolution")
   628→    }
   629→}
```

Result:

```
1→import AVFoundation
     2→import UIKit
     3→import Photos
     4→import CoreLocation
     5→
     6→class CameraService: NSObject, ObservableObject {
     7→    let session = AVCaptureSession()
     8→    private var videoOutput = AVCaptureVideoDataOutput()
     9→    private var photoOutput = AVCapturePhotoOutput()
    10→    var currentDevice: AVCaptureDevice?
    11→    private var currentInput: AVCaptureDeviceInput?
    12→    
    13→    private let sessionQueue = DispatchQueue(label: "camera.session.queue")
    14→    
    15→    // Manager instances
    16→    private let locationManager = LocationManager()
    17→    private lazy var highResolutionManager = HighResolutionCameraManager(
    18→        sessionQueue: sessionQueue,
    19→        photoOutput: photoOutput
    20→    )
    21→    private lazy var photoProcessor = PhotoProcessor(locationManager: locationManager)
    22→    private lazy var photoSettingsManager = PhotoSettingsManager(photoOutput: photoOutput)
    23→    
    24→    var previewLayer: AVCaptureVideoPreviewLayer {
    25→        let layer = AVCaptureVideoPreviewLayer(session: session)
    26→        layer.videoGravity = .resizeAspectFill
    27→        return layer
    28→    }
    29→    
    30→    var availableCameras: [AVCaptureDevice] = []
    31→    var currentCameraIndex: Int = 0
    32→    
    33→    // 添加设置相关的属性
    34→    private var currentPhotoFormat: PhotoFormat = .heic
    35→    private var currentPhotoResolution: PhotoResolution = .resolution12MP
    36→    
    37→    private var photoCompletionHandler: ((Result<Data, Error>) -> Void)?
    38→    private var currentAspectRatio: AspectRatio?
    39→    private var currentFrameSettings: FrameSettings?
    40→    
    41→    override init() {
    42→        super.init()
    43→        // 立即进行快速初始化
    44→        quickSetup()
    45→    }
    46→    
    47→    private func quickSetup() {
    48→        print("🚀 开始快速设置相机")
    49→        // 所有相机设置移到后台线程，避免阻塞主线程
    50→        sessionQueue.async { [weak self] in
    51→            guard let self = self else { return }
    52→            
    53→            print("🎥 后台配置相机...")
    54→            // 使用默认后置相机进行快速设置
    55→            guard let defaultCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back) else {
    56→                print("❌ 无法获取默认相机")
    57→                return
    58→            }
    59→            
    60→            self.session.beginConfiguration()
    61→            
    62→            // 设置session preset - 对于48MP捕获很重要
    63→            self.configureSessionPreset()
    64→            
    65→            // 配置默认相机
    66→            self.configureDefaultCamera(defaultCamera)
    67→            
    68→            // 添加输出并配置高分辨率捕获
    69→            self.configurePhotoOutput()
    70→            
    71→            self.session.commitConfiguration()
    72→            
    73→            // 验证配置状态
    74→            self.verifyConfiguration()
    75→            
    76→            // 更新相机列表（在主线程）
    77→            DispatchQueue.main.async {
    78→                self.availableCameras = [defaultCamera]
    79→                print("✅ 快速设置完成，相机可用")
    80→            }
    81→            
    82→            // 发现其他相机
    83→            self.discoverAdditionalCameras()
    84→        }
    85→    }
    86→    
    87→    private func configureSessionPreset() {
    88→        let presets: [AVCaptureSession.Preset] = [.photo, .high, .inputPriority]
    89→        var presetSet = false
    90→        
    91→        for preset in presets {
    92→            if self.session.canSetSessionPreset(preset) {
    93→                self.session.sessionPreset = preset
    94→                print("🚀 快速设置: Session preset设置为 \(preset.rawValue)")
    95→                presetSet = true
    96→                break
    97→            }
    98→        }
    99→        
   100→        if !presetSet {
   101→            print("❌ 快速设置: 无法设置任何首选preset")
   102→        }
   103→    }
   104→    
   105→    private func configureDefaultCamera(_ defaultCamera: AVCaptureDevice) {
   106→        do {
   107→            let input = try AVCaptureDeviceInput(device: defaultCamera)
   108→            if self.session.canAddInput(input) {
   109→                self.session.addInput(input)
   110→                self.currentInput = input
   111→                self.currentDevice = defaultCamera
   112→            }
   113→        } catch {
   114→            print("❌ 配置默认相机失败: \(error)")
   115→        }
   116→    }
   117→    
   118→    private func configurePhotoOutput() {
   119→        if self.session.canAddOutput(self.photoOutput) {
   120→            self.session.addOutput(self.photoOutput)
   121→            
   122→            // 立即启用高分辨率捕获
   123→            self.photoOutput.isHighResolutionCaptureEnabled = true
   124→            print("🚀 快速设置: 高分辨率捕获已启用")
   125→            
   126→            // 设置最高质量优先级
   127→            self.photoOutput.maxPhotoQualityPrioritization = .quality
   128→            
   129→            print("🚀 快速设置PhotoOutput状态:")
   130→            print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   131→        } else {
   132→            print("❌ 快速设置: 无法添加photoOutput")
   133→        }
   134→    }
   135→    
   136→    private func verifyConfiguration() {
   137→        print("🚀 Session配置完成后，PhotoOutput最终状态:")
   138→        print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   139→        print("  - 可用编解码器类型: \(self.photoOutput.availablePhotoCodecTypes)")
   140→        
   141→        // 如果初始分辨率设置为48MP，确保配置48MP模式
   142→        if self.currentPhotoResolution == .resolution48MP {
   143→            print("🚀 快速设置: 检测到48MP初始设置，配置48MP模式")
   144→            if let device = currentDevice {
   145→                self.highResolutionManager.configureFor48MP(enable: true, device: device, session: session)
   146→            }
   147→        }
   148→    }
   149→    
   150→    private func discoverAdditionalCameras() {
   151→        let cameraDiscovery = CameraDiscovery()
   152→        let newCameras = cameraDiscovery.discoverCameras()
   153→        
   154→        // 更新相机列表
   155→        DispatchQueue.main.async { [weak self] in
   156→            self?.availableCameras = newCameras.isEmpty ? (self?.availableCameras ?? []) : newCameras
   157→            print("发现的相机数量: \(self?.availableCameras.count ?? 0)")
   158→            
   159→            // 如果有多个相机，默认切换到1x镜头（索引为1）
   160→            if let self = self, self.availableCameras.count > 1 {
   161→                self.switchCamera(to: 1)
   162→            }
   163→        }
   164→    }
   165→    
   166→    func requestPermissions(completion: @escaping (Bool) -> Void) {
   167→        let cameraAuthStatus = AVCaptureDevice.authorizationStatus(for: .video)
   168→        
   169→        switch cameraAuthStatus {
   170→        case .authorized:
   171→            completion(true)
   172→        case .notDetermined:
   173→            AVCaptureDevice.requestAccess(for: .video) { granted in
   174→                DispatchQueue.main.async {
   175→                    completion(granted)
   176→                }
   177→            }
   178→        default:
   179→            completion(false)
   180→        }
   181→    }
   182→    
   183→    func startSession() {
   184→        sessionQueue.async { [weak self] in
   185→            guard let self = self, !self.session.isRunning else { return }
   186→            
   187→            self.session.startRunning()
   188→            print("✅ Session已启动")
   189→        }
   190→    }
   191→    
   192→    func stopSession() {
   193→        sessionQueue.async { [weak self] in
   194→            guard let self = self, self.session.isRunning else { return }
   195→            self.session.stopRunning()
   196→        }
   197→    }
   198→    
   199→    func switchCamera(to index: Int) {
   200→        guard index >= 0 && index < availableCameras.count else { return }
   201→        
   202→        let selectedCamera = availableCameras[index]
   203→        currentCameraIndex = index
   204→        
   205→        print("🔄 切换相机到索引 \(index)")
   206→        print("🔄 选中的相机: \(selectedCamera.localizedName) (\(selectedCamera.deviceType.rawValue))")
   207→        
   208→        configureCamera(selectedCamera)
   209→    }
   210→    
   211→    private func configureCamera(_ device: AVCaptureDevice) {
   212→        sessionQueue.async { [weak self] in
   213→            guard let self = self else { return }
   214→            
   215→            self.session.beginConfiguration()
   216→            
   217→            if let currentInput = self.currentInput {
   218→                self.session.removeInput(currentInput)
   219→            }
   220→            
   221→            do {
   222→                let input = try AVCaptureDeviceInput(device: device)
   223→                if self.session.canAddInput(input) {
   224→                    self.session.addInput(input)
   225→                    self.currentInput = input
   226→                    self.currentDevice = device
   227→                    
   228→                    // 重新配置PhotoOutput以确保高分辨率捕获正确设置
   229→                    self.photoOutput.isHighResolutionCaptureEnabled = true
   230→                    print("📷 设备切换后: 高分辨率捕获重新启用")
   231→                    
   232→                    // 为48MP配置设备格式
   233→                    if self.currentPhotoResolution == .resolution48MP {
   234→                        self.highResolutionManager.configureFor48MP(enable: true, device: device, session: self.session)
   235→                    }
   236→                }
   237→            } catch {
   238→                print("Error configuring camera: \(error)")
   239→            }
   240→            
   241→            self.session.commitConfiguration()
   242→        }
   243→    }
   244→    
   245→    func capturePhoto(aspectRatio: AspectRatio? = nil, flashMode: AVCaptureDevice.FlashMode = .auto, frameSettings: FrameSettings? = nil, completion: @escaping (Result<Data, Error>) -> Void) {
   246→        sessionQueue.async { [weak self] in
   247→            guard let self = self else { return }
   248→            
   249→            // 检查 session 是否在运行
   250→            guard self.session.isRunning else {
   251→                DispatchQueue.main.async {
   252→                    completion(.failure(NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "相机未启动"])))
   253→                }
   254→                return
   255→            }
   256→            
   257→            // 创建照片设置
   258→            let settings = self.photoSettingsManager.createPhotoSettings(
   259→                format: self.currentPhotoFormat,
   260→                resolution: self.currentPhotoResolution
   261→            )
   262→            
   263→            // 设置闪光灯模式
   264→            if let currentDevice = self.currentDevice, currentDevice.hasFlash {
   265→                settings.flashMode = flashMode
   266→                print("📸 设置闪光灯模式为: \(flashMode.rawValue)")
   267→            } else {
   268→                settings.flashMode = .off
   269→                print("📸 设备不支持闪光灯，设置为关闭")
   270→            }
   271→            
   272→            // 使用设备支持的最高质量设置
   273→            let maxQuality = self.photoOutput.maxPhotoQualityPrioritization
   274→            if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.quality.rawValue {
   275→                settings.photoQualityPrioritization = .quality
   276→            } else if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.balanced.rawValue {
   277→                settings.photoQualityPrioritization = .balanced
   278→            } else {
   279→                settings.photoQualityPrioritization = .speed
   280→            }
   281→            
   282→            // Apple建议：启用嵌入式缩略图以获得更好的相册体验
   283→            if settings.availableEmbeddedThumbnailPhotoCodecTypes.contains(.jpeg) {
   284→                settings.embeddedThumbnailPhotoFormat = [
   285→                    AVVideoCodecKey: AVVideoCodecType.jpeg
   286→                ]
   287→            }
   288→            
   289→            // 设置方向信息
   290→            if let connection = self.photoOutput.connection(with: .video) {
   291→                if connection.isVideoOrientationSupported {
   292→                    connection.videoOrientation = .portrait
   293→                }
   294→            }
   295→            
   296→            print("📸 拍照设置配置完成")
   297→            
   298→            self.photoCompletionHandler = completion
   299→            self.currentAspectRatio = aspectRatio
   300→            
   301→            // 保存相框设置，用于后续处理
   302→            self.currentFrameSettings = frameSettings
   303→            
   304→            self.photoOutput.capturePhoto(with: settings, delegate: self)
   305→        }
   306→    }
   307→    
   308→    func setFocusPoint(_ point: CGPoint) {
   309→        guard let device = currentDevice, device.isFocusPointOfInterestSupported else { return }
   310→        
   311→        do {
   312→            try device.lockForConfiguration()
   313→            device.focusPointOfInterest = point
   314→            device.focusMode = .autoFocus
   315→            
   316→            if device.isExposurePointOfInterestSupported {
   317→                device.exposurePointOfInterest = point
   318→                device.exposureMode = .autoExpose
   319→            }
   320→            
   321→            device.unlockForConfiguration()
   322→        } catch {
   323→            print("Error setting focus point: \(error)")
   324→        }
   325→    }
   326→    
   327→    func setExposureCompensation(_ value: Float) {
   328→        guard let device = currentDevice else { return }
   329→        
   330→        do {
   331→            try device.lockForConfiguration()
   332→            
   333→            // 确保设备处于连续自动曝光模式，以便曝光补偿生效
   334→            if device.isExposureModeSupported(.continuousAutoExposure) {
   335→                device.exposureMode = .continuousAutoExposure
   336→            }
   337→            
   338→            // 限制曝光补偿值在设备支持的范围内
   339→            let clampedValue = max(device.minExposureTargetBias, min(value, device.maxExposureTargetBias))
   340→            device.setExposureTargetBias(clampedValue, completionHandler: { time in
   341→                print("📸 CameraService: 曝光补偿设置完成 - 值: \(clampedValue), 时间: \(time.seconds)秒")
   342→            })
   343→            
   344→            device.unlockForConfiguration()
   345→        } catch {
   346→            print("Error setting exposure compensation: \(error)")
   347→        }
   348→    }
   349→    
   350→    // 更新设置的方法
   351→    func updatePhotoSettings(format: PhotoFormat, resolution: PhotoResolution) {
   352→        let needsSessionReconfiguration = (currentPhotoResolution != resolution)
   353→        
   354→        currentPhotoFormat = format
   355→        currentPhotoResolution = resolution
   356→        print("📸 更新照片设置 - 格式: \(format.rawValue), 分辨率: \(resolution.rawValue)")
   357→        
   358→        // 如果分辨率改变，需要重新配置session
   359→        if needsSessionReconfiguration {
   360→            sessionQueue.async { [weak self] in
   361→                self?.reconfigureSession()
   362→            }
   363→        }
   364→    }
   365→    
   366→    // 重新配置session的方法
   367→    private func reconfigureSession() {
   368→        guard session.isRunning else { return }
   369→        
   370→        print("🔄 重新配置Session - 分辨率: \(currentPhotoResolution.rawValue)")
   371→        
   372→        session.beginConfiguration()
   373→        
   374→        // 根据新的分辨率设置session preset
   375→        let sessionPreset = CameraHelper.getSessionPreset(for: currentPhotoResolution, session: session)
   376→        if session.canSetSessionPreset(sessionPreset) {
   377→            session.sessionPreset = sessionPreset
   378→            print("📸 更新session preset为: \(sessionPreset.rawValue)")
   379→        }
   380→        
   381→        // 重新配置PhotoOutput以确保高分辨率设置正确
   382→        if currentPhotoResolution == .resolution48MP {
   383→            // 48MP模式：确保PhotoOutput配置正确
   384→            photoOutput.isHighResolutionCaptureEnabled = true
   385→            photoOutput.maxPhotoQualityPrioritization = .quality
   386→            print("🔄 48MP模式：重新配置PhotoOutput")
   387→        }
   388→        
   389→        // 根据分辨率配置相应的设备格式
   390→        if let device = currentDevice {
   391→            if currentPhotoResolution == .resolution48MP {
   392→                highResolutionManager.configureFor48MP(enable: true, device: device, session: session)
   393→            } else {
   394→                highResolutionManager.configureFor48MP(enable: false, device: device, session: session)
   395→            }
   396→        }
   397→        
   398→        session.commitConfiguration()
   399→        
   400→        print("🔄 Session重新配置完成")
   401→    }
   402→    
   403→    var is48MPAvailable: Bool {
   404→        return highResolutionManager.is48MPAvailable(for: currentDevice)
   405→    }
   406→    
   407→    // 🚀 优化后的水印功能：减少内存峰值
   408→    private func applyWatermarkIfNeeded(to imageData: Data, photo: AVCapturePhoto) -> Data {
   409→        print("🎨 开始应用水印和相框，原始大小: \(imageData.count / 1024 / 1024)MB")
   410→        
   411→        var processedData = imageData
   412→        
   413→        // 分阶段处理，每个阶段都有独立的内存管理
   414→        
   415→        // 第一阶段：应用水印
   416→        autoreleasepool {
   417→            print("🎨 第一阶段：应用水印")
   418→            let watermarkProcessor = WatermarkProcessor(currentDevice: currentDevice)
   419→            processedData = watermarkProcessor.processWatermark(
   420→                imageData: processedData, 
   421→                photo: photo, 
   422→                format: currentPhotoFormat, 
   423→                aspectRatio: currentAspectRatio
   424→            )
   425→            print("🎨 水印处理完成，大小: \(processedData.count / 1024 / 1024)MB")
   426→        }
   427→        
   428→        // 第二阶段：应用相框（如果需要）
   429→        if let frameSettings = currentFrameSettings, frameSettings.selectedFrame != .none {
   430→            autoreleasepool {
   431→                print("🎨 第二阶段：应用相框")
   432→                let photoDecorationService = PhotoDecorationService(frameSettings: frameSettings)
   433→                processedData = photoDecorationService.applyFrameToPhoto(processedData)
   434→                print("🎨 相框处理完成，最终大小: \(processedData.count / 1024 / 1024)MB")
   435→            }
   436→        }
   437→        
   438→        return processedData
   439→    }
   440→}
   441→
   442→extension CameraService: AVCapturePhotoCaptureDelegate {
   443→    func photoOutput(_ output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto, error: Error?) {
   444→        if let error = error {
   445→            photoCompletionHandler?(.failure(error))
   446→            return
   447→        }
   448→        
   449→        // 🚀 关键优化：立即返回成功，释放拍摄状态，允许连续拍摄
   450→        print("🚀 拍摄完成，立即释放拍摄状态，水印将在后台处理")
   451→        
   452→        // 使用最小的数据量进行快速返回
   453→        autoreleasepool {
   454→            guard let imageData = photo.fileDataRepresentation() else {
   455→                let error = NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "Failed to get image data"])
   456→                photoCompletionHandler?(.failure(error))
   457→                return
   458→            }
   459→            
   460→            // 立即返回成功状态（使用小数据量）
   461→            photoCompletionHandler?(.success(imageData))
   462→            photoCompletionHandler = nil
   463→            
   464→            // 🚀 在独立的后台线程中处理，避免内存峰值重叠
   465→            DispatchQueue.global(qos: .utility).async { [weak self] in
   466→                self?.processPhotoInBackground(photo: photo, originalData: imageData)
   467→            }
   468→        }
   469→    }
   470→    
   471→    // 🚀 新增：独立的后台处理方法，优化内存使用
   472→    private func processPhotoInBackground(photo: AVCapturePhoto, originalData: Data) {
   473→        // 使用最大的autoreleasepool包围整个处理过程
   474→        autoreleasepool {
   475→            print("🎨 开始后台处理 - 当前内存压力较低的线程")
   476→            let dataSize = originalData.count / (1024 * 1024)
   477→            print("📊 原始数据大小: \(dataSize)MB")
   478→            
   479→            // 先验证图像（减少内存占用版本）
   480→            print("📊 步骤1: 验证图像")
   481→            self.verifyImageDataLightweight(originalData)
   482→            
   483→            // 分步处理，每一步都用autoreleasepool
   484→            let finalImageData: Data
   485→            
   486→            // 第一步：应用水印和相框
   487→            finalImageData = autoreleasepool {
   488→                print("📊 步骤2: 应用水印和相框")
   489→                let processedData = self.applyWatermarkIfNeeded(to: originalData, photo: photo)
   490→                let processedSize = processedData.count / (1024 * 1024)
   491→                print("📊 水印处理完成，大小: \(processedSize)MB")
   492→                return processedData
   493→            }
   494→            
   495→            // 第二步：保存到相册
   496→            autoreleasepool {
   497→                print("📊 步骤3: 保存到相册")
   498→                self.photoProcessor.savePhotoToLibrary(
   499→                    finalImageData,
   500→                    format: self.currentPhotoFormat,
   501→                    aspectRatio: self.currentAspectRatio
   502→                )
   503→                print("✅ 保存完成")
   504→            }
   505→            
   506→            print("✅ 后台处理完成：水印 + 相框 + 保存")
   507→            
   508→            // 🚀 通知主线程处理完成
   509→            DispatchQueue.main.async { [weak self] in
   510→                // 通知ViewModel处理完成（如果需要）
   511→                NotificationCenter.default.post(name: NSNotification.Name("BackgroundProcessingCompleted"), object: nil)
   512→            }
   513→        }
   514→    }
   515→    
   516→    // 🚀 新增：轻量级图像验证，减少内存占用
   517→    private func verifyImageDataLightweight(_ imageData: Data) {
   518→        autoreleasepool {
   519→            // 只获取基本的图像属性，不创建完整的图像对象
   520→            guard let source = CGImageSourceCreateWithData(imageData as CFData, nil) else { 
   521→                print("❌ 无法创建图像源")
   522→                return 
   523→            }
   524→            
   525→            // 只获取图像属性，不加载图像数据
   526→            guard let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] else {
   527→                print("❌ 无法获取图像属性")
   528→                return
   529→            }
   530→            
   531→            if let pixelWidth = properties[kCGImagePropertyPixelWidth as String] as? Int,
   532→               let pixelHeight = properties[kCGImagePropertyPixelHeight as String] as? Int {
   533→                let megapixels = (pixelWidth * pixelHeight) / 1_000_000
   534→                let dataSize = imageData.count / (1024 * 1024) // MB
   535→                
   536→                print("🔍 图像信息: \(pixelWidth)x\(pixelHeight) (\(megapixels)MP), 大小: \(dataSize)MB")
   537→                
   538→                if currentPhotoResolution == .resolution48MP && megapixels < 40 {
   539→                    print("❌ 警告：预期48MP但实际拍摄\(megapixels)MP")
   540→                } else if currentPhotoResolution == .resolution48MP && megapixels >= 40 {
   541→                    print("✅ 成功：48MP模式")
   542→                }
   543→            }
   544→        }
   545→    }
   546→    
   547→    private func verifyImageData(_ imageData: Data) {
   548→        // 保留原方法用于兼容，但标记为已弃用
   549→        verifyImageDataLightweight(imageData)
   550→    }
   551→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Read project structure and main files
- [X] 🌡️ Analyze SwiftUI views and camera implementation
- [⚡] 🌡️ Review camera service and MVVM architecture
- [ ] 🌡️ Check settings and configuration files
- [ ] 🌡️ Summarize project logic and structure


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Settings/SettingsView.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Shared/Models/PhotoFormat.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkService.swift`

Result:

```
1→import SwiftUI
     2→
     3→struct SettingsView: View {
     4→    @Environment(\.presentationMode) var presentationMode
     5→    @AppStorage("grid_overlay_enabled") private var gridOverlayEnabled = false
     6→    @AppStorage("photo_format") private var photoFormat: PhotoFormat = .heic
     7→    @AppStorage("photo_resolution") private var photoResolution: PhotoResolution = .resolution12MP
     8→    @AppStorage("location_tagging_enabled") private var locationTaggingEnabled = false
     9→    @StateObject private var cameraService = CameraService()
    10→    @State private var showingWatermarkSettings = false
    11→    
    12→    var body: some View {
    13→        NavigationView {
    14→            List {
    15→                Section(header: Text("相机设置")) {
    16→                    // 网格线设置
    17→                    HStack {
    18→                        Image(systemName: "grid")
    19→                            .foregroundColor(.blue)
    20→                            .frame(width: 24)
    21→                        
    22→                        VStack(alignment: .leading) {
    23→                            Text("网格线")
    24→                                .font(.body)
    25→                            Text("显示三分法构图网格线")
    26→                                .font(.caption)
    27→                                .foregroundColor(.secondary)
    28→                        }
    29→                        
    30→                        Spacer()
    31→                        
    32→                        Toggle("", isOn: $gridOverlayEnabled)
    33→                    }
    34→                    .padding(.vertical, 4)
    35→                    
    36→                    // 照片格式设置
    37→                    HStack {
    38→                        Image(systemName: "photo")
    39→                            .foregroundColor(.green)
    40→                            .frame(width: 24)
    41→                        
    42→                        VStack(alignment: .leading) {
    43→                            Text("照片格式")
    44→                                .font(.body)
    45→                            
    46→                            Picker("照片格式", selection: $photoFormat) {
    47→                                ForEach(PhotoFormat.allCases, id: \.self) { format in
    48→                                    Text(format.displayName).tag(format)
    49→                                }
    50→                            }
    51→                            .pickerStyle(SegmentedPickerStyle())
    52→                        }
    53→                    }
    54→                    .padding(.vertical, 4)
    55→                    
    56→                    // 分辨率设置
    57→                    HStack {
    58→                        Image(systemName: "camera.aperture")
    59→                            .foregroundColor(.orange)
    60→                            .frame(width: 24)
    61→                        
    62→                        VStack(alignment: .leading) {
    63→                            Text("分辨率")
    64→                                .font(.body)
    65→                            
    66→                            Picker("分辨率", selection: $photoResolution) {
    67→                                // 总是显示12MP选项
    68→                                Text(PhotoResolution.resolution12MP.displayName)
    69→                                    .tag(PhotoResolution.resolution12MP)
    70→                                
    71→                                // 只有当设备支持时才显示48MP选项
    72→                                if cameraService.is48MPAvailable {
    73→                                    Text(PhotoResolution.resolution48MP.displayName)
    74→                                        .tag(PhotoResolution.resolution48MP)
    75→                                }
    76→                            }
    77→                            .pickerStyle(SegmentedPickerStyle())
    78→                            
    79→                            // 显示48MP不可用的提示
    80→                            if !cameraService.is48MPAvailable {
    81→                                Text("当前设备不支持48MP或需要切换到主摄像头")
    82→                                    .font(.caption)
    83→                                    .foregroundColor(.secondary)
    84→                            }
    85→                        }
    86→                    }
    87→                    .padding(.vertical, 4)
    88→                    
    89→                    // 位置信息设置
    90→                    HStack {
    91→                        Image(systemName: "location")
    92→                            .foregroundColor(.red)
    93→                            .frame(width: 24)
    94→                        
    95→                        VStack(alignment: .leading) {
    96→                            Text("位置信息")
    97→                                .font(.body)
    98→                            Text("在照片中保存位置信息")
    99→                                .font(.caption)
   100→                                .foregroundColor(.secondary)
   101→                        }
   102→                        
   103→                        Spacer()
   104→                        
   105→                        Toggle("", isOn: $locationTaggingEnabled)
   106→                    }
   107→                    .padding(.vertical, 4)
   108→                    
   109→                    // 水印设置
   110→                    Button(action: {
   111→                        showingWatermarkSettings = true
   112→                    }) {
   113→                        HStack {
   114→                            Image(systemName: "text.below.photo")
   115→                                .foregroundColor(.blue)
   116→                                .frame(width: 24)
   117→                            
   118→                            VStack(alignment: .leading) {
   119→                                Text("水印设置")
   120→                                    .font(.body)
   121→                                    .foregroundColor(.primary)
   122→                                Text("配置照片水印信息")
   123→                                    .font(.caption)
   124→                                    .foregroundColor(.secondary)
   125→                            }
   126→                            
   127→                            Spacer()
   128→                            
   129→                            Image(systemName: "chevron.right")
   130→                                .foregroundColor(.secondary)
   131→                                .font(.caption)
   132→                        }
   133→                    }
   134→                    .padding(.vertical, 4)
   135→                }
   136→                
   137→                Section(header: Text("关于")) {
   138→                    HStack {
   139→                        Image(systemName: "info.circle")
   140→                            .foregroundColor(.blue)
   141→                            .frame(width: 24)
   142→                        
   143→                        VStack(alignment: .leading) {
   144→                            Text("版本")
   145→                                .font(.body)
   146→                            Text("1.0.0")
   147→                                .font(.caption)
   148→                                .foregroundColor(.secondary)
   149→                        }
   150→                    }
   151→                    .padding(.vertical, 4)
   152→                    
   153→                    HStack {
   154→                        Image(systemName: "person.circle")
   155→                            .foregroundColor(.purple)
   156→                            .frame(width: 24)
   157→                        
   158→                        VStack(alignment: .leading) {
   159→                            Text("开发者")
   160→                                .font(.body)
   161→                            Text("马聪聪")
   162→                                .font(.caption)
   163→                                .foregroundColor(.secondary)
   164→                        }
   165→                    }
   166→                    .padding(.vertical, 4)
   167→                }
   168→            }
   169→            .navigationBarTitle("设置", displayMode: .inline)
   170→            .navigationBarItems(trailing: Button("完成") {
   171→                presentationMode.wrappedValue.dismiss()
   172→            })
   173→            .sheet(isPresented: $showingWatermarkSettings) {
   174→                WatermarkSettingsView()
   175→            }
   176→        }
   177→    }
   178→}
   179→
   180→#Preview {
   181→    SettingsView()
   182→}
```

Result:

```
1→import Foundation
     2→
     3→// 图片格式枚举
     4→enum PhotoFormat: String, CaseIterable {
     5→    case heic = "HEIC"
     6→    case jpeg = "JPEG" 
     7→    case raw = "RAW"
     8→    
     9→    var displayName: String {
    10→        switch self {
    11→        case .heic: return "高效率 (HEIC)"
    12→        case .jpeg: return "最兼容 (JPEG)"
    13→        case .raw: return "专业 (RAW)"
    14→        }
    15→    }
    16→}
```

Result:

```
1→import UIKit
     2→import AVFoundation
     3→import Foundation
     4→
     5→class WatermarkService {
     6→    static let shared = WatermarkService()
     7→    
     8→    private init() {}
     9→    
    10→    func addWatermark(to image: UIImage, with captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) -> UIImage? {
    11→        // 🚀 优化：使用autoreleasepool包围整个水印处理过程
    12→        return autoreleasepool {
    13→            let settings = WatermarkSettings.load()
    14→            
    15→            print("🎨 WatermarkService.addWatermark 被调用")
    16→            print("  - 设置启用: \(settings.isEnabled)")
    17→            print("  - 作者名字: '\(settings.authorName)'")
    18→            print("  - 图像尺寸: \(image.size)")
    19→            
    20→            guard settings.isEnabled else { 
    21→                print("  - 水印未启用，返回原图")
    22→                return image 
    23→            }
    24→            
    25→            // 🚀 优化：检查图像大小，降低阈值以便更多图像使用优化路径
    26→            let imageArea = image.size.width * image.size.height
    27→            let megapixels = Int(imageArea / 1_000_000)
    28→            
    29→            // 🚀 关键修复：降低阈值到8MP，让12MP图像也使用优化绘制
    30→            if megapixels > 8 {
    31→                print("  ⚠️ 大图像(\(megapixels)MP)，使用优化的水印绘制")
    32→                return drawWatermarkOptimized(image: image, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio)
    33→            }
    34→            
    35→            // 🚀 标准水印绘制（包装在autoreleasepool中）
    36→            var result: UIImage?
    37→            autoreleasepool {
    38→                let renderer = UIGraphicsImageRenderer(size: image.size)
    39→                
    40→                print("  - 开始绘制水印...")
    41→                result = renderer.image { context in
    42→                    image.draw(at: CGPoint.zero)
    43→                    
    44→                    let rect = CGRect(origin: CGPoint.zero, size: image.size)
    45→                    drawWatermark(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio)
    46→                }
    47→            }
    48→            
    49→            print("  ✅ 水印绘制完成")
    50→            return result
    51→        }
    52→    }
    53→    
    54→    // 🚀 新增：优化的水印绘制方法，用于超大图像
    55→    private func drawWatermarkOptimized(image: UIImage, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio?) -> UIImage? {
    56→        return autoreleasepool {
    57→            print("  🎨 使用优化水印绘制")
    58→            
    59→            // 对于超大图像，使用更高效的绘制方式
    60→            let format = UIGraphicsImageRendererFormat()
    61→            format.scale = 1.0 // 使用1.0缩放因子减少内存使用
    62→            format.opaque = false
    63→            
    64→            let renderer = UIGraphicsImageRenderer(size: image.size, format: format)
    65→            
    66→            return renderer.image { context in
    67→                // 绘制原图
    68→                image.draw(at: CGPoint.zero)
    69→                
    70→                // 绘制水印（简化版本）
    71→                let rect = CGRect(origin: CGPoint.zero, size: image.size)
    72→                drawWatermarkSimplified(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio)
    73→            }
    74→        }
    75→    }
    76→    
    77→    // 🚀 新增：简化但功能完整的水印绘制方法，减少内存使用
    78→    private func drawWatermarkSimplified(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio?) {
    79→        context.saveGState()
    80→        
    81→        // 确定有效绘制区域
    82→        let effectiveRect: CGRect
    83→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
    84→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
    85→        } else {
    86→            effectiveRect = rect
    87→        }
    88→        
    89→        // 使用合适的字体大小
    90→        let baseSize = min(effectiveRect.width, effectiveRect.height)
    91→        let firstLineFontSize = baseSize * 0.032
    92→        let secondLineFontSize = baseSize * 0.025
    93→        
    94→        let firstLineFont = UIFont.systemFont(ofSize: firstLineFontSize, weight: .medium)
    95→        let secondLineFont = UIFont.systemFont(ofSize: secondLineFontSize, weight: .regular)
    96→        
    97→        let padding = baseSize * 0.02
    98→        let bottomPadding = baseSize * 0.04
    99→        let lineSpacing = baseSize * 0.008
   100→        
   101→        let firstLineY = effectiveRect.maxY - bottomPadding - firstLineFont.lineHeight - lineSpacing - secondLineFont.lineHeight
   102→        let secondLineY = effectiveRect.maxY - bottomPadding - secondLineFont.lineHeight
   103→        
   104→        // 第一行：作者信息
   105→        if !settings.authorName.isEmpty {
   106→            let firstLineText = "PHOTO BY \(settings.authorName)"
   107→            let textSize = firstLineText.size(withAttributes: [.font: firstLineFont])
   108→            let centerX = effectiveRect.minX + (effectiveRect.width - textSize.width) / 2
   109→            
   110→            drawTextSimplified(firstLineText, 
   111→                             font: firstLineFont, 
   112→                             at: CGPoint(x: centerX, y: firstLineY))
   113→        }
   114→        
   115→        // 第二行：相机信息
   116→        var secondLineComponents: [String] = []
   117→        
   118→        if settings.showDeviceModel {
   119→            let deviceModel = DeviceInfoHelper.getDetailedDeviceModel()
   120→            secondLineComponents.append(deviceModel)
   121→        }
   122→        
   123→        if settings.showFocalLength {
   124→            let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   125→            secondLineComponents.append(focalLength)
   126→        }
   127→        
   128→        if settings.showShutterSpeed {
   129→            let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   130→            secondLineComponents.append(shutterSpeed)
   131→        }
   132→        
   133→        if settings.showISO {
   134→            let iso = String(format: "ISO%.0f", captureSettings.iso)
   135→            secondLineComponents.append(iso)
   136→        }
   137→        
   138→        if settings.showDate {
   139→            let dateFormatter = DateFormatter()
   140→            dateFormatter.dateFormat = "yyyy.MM.dd"
   141→            let dateString = dateFormatter.string(from: Date())
   142→            secondLineComponents.append(dateString)
   143→        }
   144→        
   145→        if !secondLineComponents.isEmpty {
   146→            let leftText = secondLineComponents.first ?? ""
   147→            let centerText = secondLineComponents.count > 1 ? secondLineComponents[1...].prefix(2).joined(separator: "  ") : ""
   148→            let rightText = secondLineComponents.count > 3 ? secondLineComponents.last ?? "" : (secondLineComponents.count == 2 ? "" : secondLineComponents.last ?? "")
   149→            
   150→            drawTextSimplified(leftText, 
   151→                             font: secondLineFont, 
   152→                             at: CGPoint(x: effectiveRect.minX + padding, y: secondLineY))
   153→            
   154→            if !centerText.isEmpty {
   155→                let centerX = effectiveRect.minX + effectiveRect.width / 2
   156→                let centerSize = centerText.size(withAttributes: [.font: secondLineFont])
   157→                drawTextSimplified(centerText, 
   158→                                 font: secondLineFont, 
   159→                                 at: CGPoint(x: centerX - centerSize.width / 2, y: secondLineY))
   160→            }
   161→            
   162→            if !rightText.isEmpty && rightText != centerText && rightText != leftText {
   163→                let rightSize = rightText.size(withAttributes: [.font: secondLineFont])
   164→                drawTextSimplified(rightText, 
   165→                                 font: secondLineFont, 
   166→                                 at: CGPoint(x: effectiveRect.maxX - padding - rightSize.width, y: secondLineY))
   167→            }
   168→        }
   169→        
   170→        context.restoreGState()
   171→    }
   172→    
   173→    // 🚀 新增：超快速文字绘制方法，只有白色文字和轻微阴影
   174→    private func drawTextSimplified(_ text: String, font: UIFont, at point: CGPoint) {
   175→        // 使用简单的阴影效果替代描边，大大提升性能
   176→        let shadowOffset = CGSize(width: 1, height: 1)
   177→        
   178→        // 绘制阴影
   179→        let shadowAttributes: [NSAttributedString.Key: Any] = [
   180→            .font: font,
   181→            .foregroundColor: UIColor.black.withAlphaComponent(0.3),
   182→        ]
   183→        
   184→        let shadowString = NSAttributedString(string: text, attributes: shadowAttributes)
   185→        let shadowRect = CGRect(x: point.x + shadowOffset.width, y: point.y + shadowOffset.height, width: 1000, height: font.lineHeight)
   186→        shadowString.draw(in: shadowRect)
   187→        
   188→        // 绘制主文字
   189→        let textAttributes: [NSAttributedString.Key: Any] = [
   190→            .font: font,
   191→            .foregroundColor: UIColor.white
   192→        ]
   193→        
   194→        let attributedString = NSAttributedString(string: text, attributes: textAttributes)
   195→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   196→        attributedString.draw(in: textRect)
   197→    }
   198→    
   199→    private func drawWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) {
   200→        print("    🖌️ drawWatermark 开始")
   201→        print("      - 画布尺寸: \(rect.size)")
   202→        print("      - 作者名字: '\(settings.authorName)'")
   203→        
   204→        context.saveGState()
   205→        
   206→        // 确定有效绘制区域（考虑比例裁剪）
   207→        let effectiveRect: CGRect
   208→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
   209→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
   210→            print("      - 应用比例裁剪: \(aspectRatio.rawValue)")
   211→            print("      - 有效绘制区域: \(effectiveRect)")
   212→        } else {
   213→            effectiveRect = rect
   214→            print("      - 使用完整画布")
   215→        }
   216→        
   217→        // 根据有效区域尺寸动态计算字体大小，确保在不同分辨率下都有合适的比例
   218→        let imageWidth = effectiveRect.width
   219→        let imageHeight = effectiveRect.height
   220→        let baseSize = min(imageWidth, imageHeight)
   221→        
   222→        // 根据图片尺寸动态计算间距
   223→        let basePadding = baseSize * 0.02  // 2%的边距
   224→        let lineSpacing = baseSize * 0.008 // 0.8%的行间距
   225→        let bottomPadding = baseSize * 0.04 // 4%的底部边距
   226→        
   227→        let padding = basePadding
   228→        
   229→        // 根据参考图片，调小字体大小
   230→        let firstLineFontSize = baseSize * 0.032  // 调小到3.2%
   231→        let secondLineFontSize = baseSize * 0.025 // 调小到2.5%
   232→        
   233→        let firstLineFont = UIFont.systemFont(ofSize: firstLineFontSize, weight: .medium)
   234→        let secondLineFont = UIFont.systemFont(ofSize: secondLineFontSize, weight: .regular)
   235→        
   236→        print("      - 图片尺寸: \(imageWidth) x \(imageHeight)")
   237→        print("      - 第一行字体大小: \(firstLineFontSize)")
   238→        print("      - 第二行字体大小: \(secondLineFontSize)")
   239→        
   240→        let firstLineY = effectiveRect.maxY - bottomPadding - firstLineFont.lineHeight - lineSpacing - secondLineFont.lineHeight
   241→        let secondLineY = effectiveRect.maxY - bottomPadding - secondLineFont.lineHeight
   242→        
   243→        if !settings.authorName.isEmpty {
   244→            let firstLineText = "PHOTO BY \(settings.authorName)"
   245→            let textSize = firstLineText.size(withAttributes: [.font: firstLineFont])
   246→            let centerX = effectiveRect.minX + (effectiveRect.width - textSize.width) / 2
   247→            
   248→            drawText(firstLineText, 
   249→                    font: firstLineFont, 
   250→                    color: .white, 
   251→                    at: CGPoint(x: centerX, y: firstLineY), 
   252→                    in: context)
   253→        }
   254→        
   255→        var secondLineComponents: [String] = []
   256→        
   257→        if settings.showDeviceModel {
   258→            let deviceModel = DeviceInfoHelper.getDetailedDeviceModel()
   259→            secondLineComponents.append(deviceModel)
   260→        }
   261→        
   262→        if settings.showFocalLength {
   263→            let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   264→            secondLineComponents.append(focalLength)
   265→        }
   266→        
   267→        if settings.showShutterSpeed {
   268→            let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   269→            secondLineComponents.append(shutterSpeed)
   270→        }
   271→        
   272→        if settings.showISO {
   273→            let iso = String(format: "ISO%.0f", captureSettings.iso)
   274→            secondLineComponents.append(iso)
   275→        }
   276→        
   277→        if settings.showDate {
   278→            let dateFormatter = DateFormatter()
   279→            dateFormatter.dateFormat = "yyyy.MM.dd"
   280→            let dateString = dateFormatter.string(from: Date())
   281→            secondLineComponents.append(dateString)
   282→        }
   283→        
   284→        if !secondLineComponents.isEmpty {
   285→            let leftText = secondLineComponents.first ?? ""
   286→            let centerText = secondLineComponents.count > 1 ? secondLineComponents[1...].prefix(2).joined(separator: "  ") : ""
   287→            let rightText = secondLineComponents.count > 3 ? secondLineComponents.last ?? "" : (secondLineComponents.count == 2 ? "" : secondLineComponents.last ?? "")
   288→            
   289→            drawText(leftText, 
   290→                    font: secondLineFont, 
   291→                    color: .white, 
   292→                    at: CGPoint(x: effectiveRect.minX + padding, y: secondLineY), 
   293→                    in: context)
   294→            
   295→            if !centerText.isEmpty {
   296→                let centerX = effectiveRect.minX + effectiveRect.width / 2
   297→                let centerSize = centerText.size(withAttributes: [.font: secondLineFont])
   298→                drawText(centerText, 
   299→                        font: secondLineFont, 
   300→                        color: .white, 
   301→                        at: CGPoint(x: centerX - centerSize.width / 2, y: secondLineY), 
   302→                        in: context)
   303→            }
   304→            
   305→            if !rightText.isEmpty && rightText != centerText && rightText != leftText {
   306→                let rightSize = rightText.size(withAttributes: [.font: secondLineFont])
   307→                drawText(rightText, 
   308→                        font: secondLineFont, 
   309→                        color: .white, 
   310→                        at: CGPoint(x: effectiveRect.maxX - padding - rightSize.width, y: secondLineY), 
   311→                        in: context)
   312→            }
   313→        }
   314→        
   315→        context.restoreGState()
   316→    }
   317→    
   318→    private func drawText(_ text: String, font: UIFont, color: UIColor, at point: CGPoint, in context: CGContext) {
   319→        // 先绘制黑色描边
   320→        let strokeAttributes: [NSAttributedString.Key: Any] = [
   321→            .font: font,
   322→            .foregroundColor: UIColor.black,
   323→            .strokeColor: UIColor.black,
   324→            .strokeWidth: 3.0  // 正值表示只绘制描边
   325→        ]
   326→        
   327→        let strokeString = NSAttributedString(string: text, attributes: strokeAttributes)
   328→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   329→        strokeString.draw(in: textRect)
   330→        
   331→        // 再绘制白色文字
   332→        let fillAttributes: [NSAttributedString.Key: Any] = [
   333→            .font: font,
   334→            .foregroundColor: color
   335→        ]
   336→        
   337→        let fillString = NSAttributedString(string: text, attributes: fillAttributes)
   338→        fillString.draw(in: textRect)
   339→    }
   340→    
   341→    private func formatShutterSpeed(_ speed: Double) -> String {
   342→        if speed >= 1.0 {
   343→            return String(format: "%.0fs", speed)
   344→        } else {
   345→            let denominator = Int(1.0 / speed)
   346→            return "1/\(denominator)s"
   347→        }
   348→    }
   349→    
   350→}
   351→
   352→
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Read project structure and main files
- [X] 🌡️ Analyze SwiftUI views and camera implementation
- [X] 🌡️ Review camera service and MVVM architecture
- [X] 🌡️ Check settings and configuration files
- [⚡] 🌡️ Summarize project logic and structure


_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ Read project structure and main files
- [X] 🌡️ Analyze SwiftUI views and camera implementation
- [X] 🌡️ Review camera service and MVVM architecture
- [X] 🌡️ Check settings and configuration files
- [X] 🌡️ Summarize project logic and structure


_**Agent (claude-sonnet-4-20250514)**_

# MCCamera 项目结构与逻辑梳理

## 🏗️ 整体架构

### MVVM 架构模式
- **View**: SwiftUI视图层（CameraView.swift, SettingsView.swift等）
- **ViewModel**: CameraViewModel.swift - 业务逻辑和状态管理
- **Service**: CameraService.swift - 核心相机功能实现

### 技术栈
- **UI框架**: SwiftUI (iOS 14.0+)
- **相机API**: AVFoundation
- **图像处理**: Core Image, UIKit
- **存储**: UserDefaults, PhotoKit
- **定位**: CoreLocation

## 📁 项目结构

```
MCCamera/
├── App Entry Point
│   ├── MCCameraApp.swift          # 应用入口
│   └── ContentView.swift          # 主视图容器
├── Core/                          # 核心功能模块
│   ├── Camera/
│   │   ├── CameraService.swift            # 核心相机服务
│   │   ├── CameraDiscovery.swift          # 相机设备发现
│   │   ├── FlashController.swift          # 闪光灯控制
│   │   └── HighResolutionCameraManager.swift # 48MP高分辨率管理
│   ├── Location/
│   │   └── LocationManager.swift          # 位置信息管理
│   └── Photo/
│       ├── PhotoProcessor.swift           # 照片处理
│       └── PhotoSettingsManager.swift     # 拍照设置管理
├── Features/                      # 功能模块
│   ├── Camera/                    # 相机功能
│   │   ├── CameraView.swift              # 主相机界面
│   │   ├── CameraViewModel.swift         # 相机视图模型
│   │   ├── CameraPreview.swift           # 相机预览组件
│   │   └── Views/                        # 相机子组件
│   ├── Settings/
│   │   └── SettingsView.swift            # 设置界面
│   ├── Watermark/                 # 水印功能
│   │   ├── WatermarkService.swift        # 水印服务
│   │   ├── WatermarkProcessor.swift      # 水印处理器
│   │   └── WatermarkSettings.swift       # 水印设置
│   └── Frame/                     # 相框功能
│       ├── Models/FrameModel.swift
│       ├── Services/PhotoDecorationService.swift
│       └── Views/FrameSettingsView.swift
└── Shared/                        # 共享组件
    ├── Components/                # UI组件
    ├── Extensions/                # 扩展
    ├── Models/                    # 数据模型
    └── Assets.xcassets/           # 资源文件
```

## 🎯 核心功能流程

### 1. 应用启动流程
```
MCCameraApp → ContentView → CameraView → CameraViewModel.init() → CameraService.quickSetup()
```

### 2. 相机初始化
- **快速设置**: 立即配置默认后置相机，避免UI阻塞
- **后台发现**: 异步发现所有可用相机设备
- **权限检查**: 检查并请求相机和相册权限

### 3. 拍照流程
```
用户点击快门 → CameraViewModel.capturePhoto() → CameraService.capturePhoto() 
→ 应用水印 → 应用相框 → 保存到相册 → 通知完成
```

### 4. 内存优化策略
- **autoreleasepool**: 包围图像处理过程
- **后台处理**: 水印和相框处理移至后台线程
- **立即释放**: 拍照完成立即释放拍摄状态，允许连续拍摄

## 🔧 关键特性

### 48MP 高分辨率拍摄
- **设备检测**: 自动检测设备是否支持48MP
- **格式配置**: 配置相应的AVCaptureDevice.Format
- **HEIF编码**: 优先使用HEIF格式以获得更小文件体积

### 多镜头支持
- **动态发现**: 自动发现超广角(0.5×)、广角(1×)、长焦(3×)镜头
- **智能切换**: 切换镜头时自动调整设置
- **能力检查**: 检查每个镜头的特定能力(闪光灯、48MP等)

### 手动相机控制
- **曝光控制**: 支持曝光补偿和自定义曝光模式
- **对焦控制**: 点触对焦、对焦锁定
- **白平衡**: 色温和色调调节
- **ISO/快门**: 完全手动控制(专业模式)

### 水印系统
- **动态信息**: 设备型号、拍摄参数、日期、作者信息
- **自适应布局**: 根据图像尺寸自动调整字体大小和间距
- **性能优化**: 大图像使用简化绘制减少内存使用

### 相框功能  
- **多种相框**: 支持多种相框样式
- **信息嵌入**: 在相框中嵌入拍摄信息
- **灵活布局**: 自适应不同画面比例

## ⚙️ 设置系统

### 持久化设置
- **网格线**: 三分法构图网格线
- **照片格式**: HEIC/JPEG/RAW
- **分辨率**: 12MP/48MP(设备支持时)
- **位置信息**: GPS坐标嵌入
- **水印配置**: 自定义水印内容和样式

### 动态更新
- **实时生效**: 设置更改立即应用到相机
- **智能切换**: 不支持的设置自动回退
- **用户提示**: 清晰的能力限制说明

## 🔄 数据流

### 状态管理
```
CameraViewModel (@Published 属性) → SwiftUI Views (自动更新)
UserDefaults → @AppStorage → 实时设置同步
AVFoundation 回调 → ViewModel → UI 状态更新
```

### 图像处理管道
```
AVCapturePhoto → 原始数据 → 水印处理 → 相框装饰 → PhotoKit 保存
```

### 内存管理
- **分阶段处理**: 每个处理步骤独立的内存池
- **后台队列**: 避免主线程阻塞
- **资源释放**: 及时清理临时图像数据

这个项目体现了现代iOS相机应用开发的最佳实践，具有清晰的架构分离、完善的功能实现和优秀的性能优化。

---

_**User**_

现在有个 bug.设置了相框,但是保存后只有相框没有拍照的图片,问题图:'/Users/macongcong/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/073c5b2788a892d1cb1288e6118dcd34/Message/MessageTemp/cf3d5709196b0eb4f88c51dcfac03090/Image/361756115558_.pic.jpg'

---

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `/Users/macongcong/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/073c5b2788a892d1cb1288e6118dcd34/Message/MessageTemp/cf3d5709196b0eb4f88c51dcfac03090/Image/361756115558_.pic.jpg`

_**Agent (claude-sonnet-4-20250514)**_

我看到了问题！图片显示只有相框和水印，但是没有实际拍摄的照片内容。让我分析相框处理的代码来找出问题所在。

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [⚡] 🌡️ 分析相框处理Bug - 只显示相框没有照片
- [ ] 🌡️ 检查PhotoDecorationService代码
- [ ] 🌡️ 查看相框应用流程
- [ ] 🌡️ 修复相框处理Bug


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/Services/PhotoDecorationService.swift`

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep**

Result:

```
1→import Foundation
     2→import UIKit
     3→import CoreLocation
     4→
     5→class PhotoDecorationService {
     6→    private let frameSettings: FrameSettings
     7→    private let renderer: PhotoDecorationRenderer
     8→    private let layoutEngine: InfoLayoutEngine
     9→    
    10→    init(frameSettings: FrameSettings) {
    11→        self.frameSettings = frameSettings
    12→        self.renderer = PhotoDecorationRenderer()
    13→        self.layoutEngine = InfoLayoutEngine()
    14→    }
    15→    
    16→    // 应用相框到照片
    17→    func applyFrameToPhoto(_ imageData: Data) -> Data {
    18→        // 如果没有选择相框，直接返回原图
    19→        guard frameSettings.selectedFrame != .none else {
    20→            return imageData
    21→        }
    22→        
    23→        var finalImageData = imageData
    24→        
    25→        // 使用autoreleasepool减少内存占用
    26→        autoreleasepool {
    27→            // 创建UIImage
    28→            guard let image = UIImage(data: imageData) else {
    29→                print("❌ 无法从数据创建图像")
    30→                return
    31→            }
    32→            
    33→            // 获取照片元数据
    34→            let metadata = getMetadataFromImageData(imageData)
    35→            
    36→            // 根据相框类型和设置渲染装饰
    37→            let decoratedImage = renderer.renderDecoration(
    38→                on: image,
    39→                frameType: frameSettings.selectedFrame,
    40→                customText: frameSettings.customText,
    41→                showDate: frameSettings.showDate,
    42→                showLocation: frameSettings.showLocation,
    43→                showExif: frameSettings.showExif,
    44→                showExifParams: frameSettings.showExifParams,
    45→                showExifDate: frameSettings.showExifDate,
    46→                selectedLogo: frameSettings.selectedLogo,
    47→                showSignature: frameSettings.showSignature,
    48→                metadata: metadata
    49→            )
    50→            
    51→            // 转换回Data - 使用较低的压缩质量以减少内存使用
    52→            if let jpegData = decoratedImage.jpegData(compressionQuality: 0.9) {
    53→                finalImageData = jpegData
    54→            }
    55→        }
    56→        
    57→        return finalImageData
    58→    }
    59→    
    60→    // 从图像数据中提取元数据 - 优化版本
    61→    private func getMetadataFromImageData(_ imageData: Data) -> [String: Any] {
    62→        var metadata: [String: Any] = [:]
    63→        
    64→        // 使用autoreleasepool减少内存占用
    65→        autoreleasepool {
    66→            if let source = CGImageSourceCreateWithData(imageData as CFData, nil) {
    67→                // 只获取需要的元数据，避免复制整个元数据字典
    68→                if let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] {
    69→                    // 提取EXIF信息
    70→                    if let exif = properties[kCGImagePropertyExifDictionary as String] as? [String: Any] {
    71→                        // 只复制需要的EXIF字段
    72→                        var exifSubset: [String: Any] = [:]
    73→                        
    74→                        // ISO
    75→                        if let iso = exif[kCGImagePropertyExifISOSpeedRatings as String] {
    76→                            exifSubset[kCGImagePropertyExifISOSpeedRatings as String] = iso
    77→                        }
    78→                        
    79→                        // 光圈
    80→                        if let aperture = exif[kCGImagePropertyExifFNumber as String] {
    81→                            exifSubset[kCGImagePropertyExifFNumber as String] = aperture
    82→                        }
    83→                        
    84→                        // 快门速度
    85→                        if let shutterSpeed = exif[kCGImagePropertyExifExposureTime as String] {
    86→                            exifSubset[kCGImagePropertyExifExposureTime as String] = shutterSpeed
    87→                        }
    88→                        
    89→                        // 焦距
    90→                        if let focalLength = exif[kCGImagePropertyExifFocalLength as String] {
    91→                            exifSubset[kCGImagePropertyExifFocalLength as String] = focalLength
    92→                        }
    93→                        
    94→                        // 日期时间
    95→                        if let dateTime = exif[kCGImagePropertyExifDateTimeOriginal as String] {
    96→                            exifSubset[kCGImagePropertyExifDateTimeOriginal as String] = dateTime
    97→                        }
    98→                        
    99→                        metadata["exif"] = exifSubset
   100→                    }
   101→                    
   102→                    // 提取TIFF信息
   103→                    if let tiff = properties[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   104→                        // 只复制需要的TIFF字段
   105→                        var tiffSubset: [String: Any] = [:]
   106→                        
   107→                        // 制造商
   108→                        if let make = tiff[kCGImagePropertyTIFFMake as String] {
   109→                            tiffSubset[kCGImagePropertyTIFFMake as String] = make
   110→                        }
   111→                        
   112→                        // 型号
   113→                        if let model = tiff[kCGImagePropertyTIFFModel as String] {
   114→                            tiffSubset[kCGImagePropertyTIFFModel as String] = model
   115→                        }
   116→                        
   117→                        metadata["tiff"] = tiffSubset
   118→                    }
   119→                    
   120→                    // 提取GPS信息
   121→                    if let gps = properties[kCGImagePropertyGPSDictionary as String] as? [String: Any] {
   122→                        // 只复制需要的GPS字段
   123→                        var gpsSubset: [String: Any] = [:]
   124→                        
   125→                        // 纬度
   126→                        if let latitude = gps[kCGImagePropertyGPSLatitude as String] {
   127→                            gpsSubset[kCGImagePropertyGPSLatitude as String] = latitude
   128→                        }
   129→                        
   130→                        // 纬度参考
   131→                        if let latitudeRef = gps[kCGImagePropertyGPSLatitudeRef as String] {
   132→                            gpsSubset[kCGImagePropertyGPSLatitudeRef as String] = latitudeRef
   133→                        }
   134→                        
   135→                        // 经度
   136→                        if let longitude = gps[kCGImagePropertyGPSLongitude as String] {
   137→                            gpsSubset[kCGImagePropertyGPSLongitude as String] = longitude
   138→                        }
   139→                        
   140→                        // 经度参考
   141→                        if let longitudeRef = gps[kCGImagePropertyGPSLongitudeRef as String] {
   142→                            gpsSubset[kCGImagePropertyGPSLongitudeRef as String] = longitudeRef
   143→                        }
   144→                        
   145→                        metadata["gps"] = gpsSubset
   146→                    }
   147→                }
   148→            }
   149→        }
   150→        
   151→        return metadata
   152→    }
   153→}
```

Result:

```
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            var processedImageData = imageData
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            if let frameSettings = frameSettings, frameSettings.selectedFrame != .none {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-                autoreleasepool {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-                    print("💾 步骤1：应用相框")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-                    let photoDecorationService = PhotoDecorationService(frameSettings: frameSettings)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift:                    processedImageData = photoDecorationService.applyFrameToPhoto(imageData)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-                    print("✅ 相框应用完成")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-                }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            // 步骤2：🚀 智能处理 - 避免重复处理
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            var finalImageData: Data? = processedImageData // 默认使用已处理的数据
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            // 🚀 关键优化：只有在需要比例裁剪时才进行图像重处理
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            let needsImageProcessing = (aspectRatio != nil && aspectRatio != .ratio4_3)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift-            
--
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        self.renderer = PhotoDecorationRenderer()
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        self.layoutEngine = InfoLayoutEngine()
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-    }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-    
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-    // 应用相框到照片
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift:    func applyFrameToPhoto(_ imageData: Data) -> Data {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        // 如果没有选择相框，直接返回原图
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        guard frameSettings.selectedFrame != .none else {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-            return imageData
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        var finalImageData = imageData
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        // 使用autoreleasepool减少内存占用
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-        autoreleasepool {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift-            // 创建UIImage
--
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-        // 第二阶段：应用相框（如果需要）
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-        if let frameSettings = currentFrameSettings, frameSettings.selectedFrame != .none {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-            autoreleasepool {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-                print("🎨 第二阶段：应用相框")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-                let photoDecorationService = PhotoDecorationService(frameSettings: frameSettings)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift:                processedData = photoDecorationService.applyFrameToPhoto(processedData)
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-                print("🎨 相框处理完成，最终大小: \(processedData.count / 1024 / 1024)MB")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-            }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-        }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-        
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-        return processedData
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-    }
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-}
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-extension CameraService: AVCapturePhotoCaptureDelegate {
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift-    func photoOutput(_ output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto, error: Error?) {
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析相框处理Bug - 只显示相框没有照片
- [⚡] 🌡️ 检查PhotoDecorationService代码
- [ ] 🌡️ 查看相框应用流程
- [ ] 🌡️ 修复相框处理Bug


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift`

Result:

```
1→
     2→import UIKit
     3→import CoreLocation
     4→
     5→class PhotoDecorationRenderer {
     6→    
     7→    // 渲染装饰到照片上
     8→    func renderDecoration(
     9→        on image: UIImage,
    10→        frameType: FrameType,
    11→        customText: String,
    12→        showDate: Bool,
    13→        showLocation: Bool,
    14→        showExif: Bool,
    15→        showExifParams: Bool,
    16→        showExifDate: Bool,
    17→        selectedLogo: String?,
    18→        showSignature: Bool,
    19→        metadata: [String: Any]
    20→    ) -> UIImage {
    21→        // 优化：使用更严格的内存管理策略
    22→        var finalImage: UIImage?
    23→        
    24→        // 使用autoreleasepool包装整个处理过程
    25→        autoreleasepool {
    26→            // 优化：对于高分辨率图像，先缩小尺寸再渲染
    27→            let maxSize: CGFloat = 2500 // 降低最大尺寸以减少内存使用
    28→            var renderImage: UIImage?
    29→            var scale: CGFloat = image.scale
    30→            
    31→            // 如果图像尺寸超过最大尺寸，进行缩放
    32→            if image.size.width > maxSize || image.size.height > maxSize {
    33→                let resizeScale = maxSize / max(image.size.width, image.size.height)
    34→                let newSize = CGSize(width: image.size.width * resizeScale, height: image.size.height * resizeScale)
    35→                
    36→                // 使用autoreleasepool减少内存占用
    37→                autoreleasepool {
    38→                    UIGraphicsBeginImageContextWithOptions(newSize, false, 0)
    39→                    defer { UIGraphicsEndImageContext() }
    40→                    
    41→                    image.draw(in: CGRect(origin: .zero, size: newSize))
    42→                    renderImage = UIGraphicsGetImageFromCurrentImageContext()
    43→                }
    44→                
    45→                // 保存原始比例，以便后续可能的放大
    46→                scale = image.scale / resizeScale
    47→            } else {
    48→                renderImage = image
    49→            }
    50→            
    51→            guard let renderImage = renderImage else {
    52→                finalImage = image
    53→                return
    54→            }
    55→            
    56→            // 创建绘图上下文
    57→            UIGraphicsBeginImageContextWithOptions(renderImage.size, false, renderImage.scale)
    58→            defer { UIGraphicsEndImageContext() }
    59→            
    60→            // 绘制原始图像
    61→            renderImage.draw(at: CGPoint.zero)
    62→            
    63→            // 根据相框类型应用不同的装饰
    64→            switch frameType {
    65→            case .bottomText:
    66→                renderBottomTextFrame(
    67→                    imageSize: renderImage.size,
    68→                    customText: customText,
    69→                    showDate: showDate,
    70→                    showLocation: showLocation,
    71→                    showExif: showExif,
    72→                    showExifParams: showExifParams,
    73→                    showExifDate: showExifDate,
    74→                    selectedLogo: selectedLogo,
    75→                    showSignature: showSignature,
    76→                    metadata: metadata
    77→                )
    78→                
    79→            case .centerWatermark:
    80→                renderCenterWatermarkFrame(
    81→                    imageSize: renderImage.size,
    82→                    customText: customText,
    83→                    selectedLogo: selectedLogo,
    84→                    metadata: metadata
    85→                )
    86→                
    87→            case .magazineCover:
    88→                renderMagazineCoverFrame(
    89→                    imageSize: renderImage.size,
    90→                    customText: customText,
    91→                    showDate: showDate,
    92→                    selectedLogo: selectedLogo,
    93→                    metadata: metadata
    94→                )
    95→                
    96→            case .polaroid:
    97→                renderPolaroidFrame(
    98→                    imageSize: renderImage.size,
    99→                    customText: customText,
   100→                    showDate: showDate,
   101→                    metadata: metadata
   102→                )
   103→                
   104→            case .none:
   105→                // 不应用任何装饰
   106→                break
   107→            }
   108→            
   109→            // 获取最终图像
   110→            finalImage = UIGraphicsGetImageFromCurrentImageContext()
   111→        }
   112→        
   113→        // 如果处理失败，返回原始图像
   114→        return finalImage ?? image
   115→    }
   116→    
   117→    // 优化：预加载和缓存Logo图像
   118→    private func getLogoImage(_ logoName: String, maxSize: CGFloat) -> UIImage? {
   119→        guard let logoImage = UIImage(named: logoName) else { return nil }
   120→        
   121→        // 如果Logo图像过大，缩小它
   122→        if max(logoImage.size.width, logoImage.size.height) > maxSize {
   123→            var result: UIImage?
   124→            autoreleasepool {
   125→                let scale = maxSize / max(logoImage.size.width, logoImage.size.height)
   126→                let newSize = CGSize(width: logoImage.size.width * scale, height: logoImage.size.height * scale)
   127→                
   128→                UIGraphicsBeginImageContextWithOptions(newSize, false, 0)
   129→                defer { UIGraphicsEndImageContext() }
   130→                
   131→                logoImage.draw(in: CGRect(origin: .zero, size: newSize))
   132→                result = UIGraphicsGetImageFromCurrentImageContext()
   133→            }
   134→            return result
   135→        }
   136→        
   137→        return logoImage
   138→    }
   139→    
   140→    // 渲染底部文字相框
   141→    private func renderBottomTextFrame(
   142→        imageSize: CGSize,
   143→        customText: String,
   144→        showDate: Bool,
   145→        showLocation: Bool,
   146→        showExif: Bool,
   147→        showExifParams: Bool,
   148→        showExifDate: Bool,
   149→        selectedLogo: String?,
   150→        showSignature: Bool,
   151→        metadata: [String: Any]
   152→    ) {
   153→        // 底部黑色条
   154→        let barHeight = imageSize.height * 0.08
   155→        let barRect = CGRect(x: 0, y: imageSize.height - barHeight, width: imageSize.width, height: barHeight)
   156→        UIColor.black.setFill()
   157→        UIRectFill(barRect)
   158→        
   159→        // 文字颜色
   160→        UIColor.white.setFill()
   161→        UIColor.white.setStroke()
   162→        
   163→        // 绘制自定义文字
   164→        if !customText.isEmpty {
   165→            autoreleasepool {
   166→                let textFont = UIFont.systemFont(ofSize: barHeight * 0.4, weight: .medium)
   167→                let textAttributes: [NSAttributedString.Key: Any] = [
   168→                    .font: textFont,
   169→                    .foregroundColor: UIColor.white
   170→                ]
   171→                
   172→                let textSize = customText.size(withAttributes: textAttributes)
   173→                let textRect = CGRect(
   174→                    x: imageSize.width / 2 - textSize.width / 2,
   175→                    y: imageSize.height - barHeight / 2 - textSize.height / 2,
   176→                    width: textSize.width,
   177→                    height: textSize.height
   178→                )
   179→                
   180→                customText.draw(in: textRect, withAttributes: textAttributes)
   181→            }
   182→        }
   183→        
   184→        // 绘制日期
   185→        if showDate {
   186→            autoreleasepool {
   187→                let dateFormatter = DateFormatter()
   188→                dateFormatter.dateFormat = "yyyy-MM-dd"
   189→                let dateString = dateFormatter.string(from: Date())
   190→                
   191→                let dateFont = UIFont.systemFont(ofSize: barHeight * 0.3, weight: .regular)
   192→                let dateAttributes: [NSAttributedString.Key: Any] = [
   193→                    .font: dateFont,
   194→                    .foregroundColor: UIColor.white
   195→                ]
   196→                
   197→                let dateSize = dateString.size(withAttributes: dateAttributes)
   198→                let dateRect = CGRect(
   199→                    x: imageSize.width - dateSize.width - 20,
   200→                    y: imageSize.height - barHeight / 2 - dateSize.height / 2,
   201→                    width: dateSize.width,
   202→                    height: dateSize.height
   203→                )
   204→                
   205→                dateString.draw(in: dateRect, withAttributes: dateAttributes)
   206→            }
   207→        }
   208→        
   209→        // 绘制Logo
   210→        if let logoName = selectedLogo {
   211→            autoreleasepool {
   212→                let logoSize = barHeight * 0.7
   213→                if let logoImage = getLogoImage(logoName, maxSize: logoSize * 2) {
   214→                    let logoRect = CGRect(
   215→                        x: 20,
   216→                        y: imageSize.height - barHeight / 2 - logoSize / 2,
   217→                        width: logoSize,
   218→                        height: logoSize
   219→                    )
   220→                    
   221→                    logoImage.draw(in: logoRect)
   222→                }
   223→            }
   224→        }
   225→        
   226→        // 绘制EXIF信息
   227→        if showExif {
   228→            autoreleasepool {
   229→                var exifText = ""
   230→                
   231→                if showExifParams, let exif = metadata["exif"] as? [String: Any] {
   232→                    if let iso = exif[kCGImagePropertyExifISOSpeedRatings as String] as? [NSNumber], let isoValue = iso.first {
   233→                        exifText += "ISO \(isoValue) "
   234→                    }
   235→                    
   236→                    if let aperture = exif[kCGImagePropertyExifFNumber as String] as? NSNumber {
   237→                        exifText += "f/\(aperture) "
   238→                    }
   239→                    
   240→                    if let shutterSpeed = exif[kCGImagePropertyExifExposureTime as String] as? NSNumber {
   241→                        let shutterValue = 1.0 / shutterSpeed.doubleValue
   242→                        exifText += "1/\(Int(shutterValue))s "
   243→                    }
   244→                }
   245→                
   246→                if !exifText.isEmpty {
   247→                    let exifFont = UIFont.systemFont(ofSize: barHeight * 0.25, weight: .regular)
   248→                    let exifAttributes: [NSAttributedString.Key: Any] = [
   249→                        .font: exifFont,
   250→                        .foregroundColor: UIColor.white
   251→                    ]
   252→                    
   253→                    let exifSize = exifText.size(withAttributes: exifAttributes)
   254→                    let exifRect = CGRect(
   255→                        x: 20,
   256→                        y: imageSize.height - barHeight + 5,
   257→                        width: exifSize.width,
   258→                        height: exifSize.height
   259→                    )
   260→                    
   261→                    exifText.draw(in: exifRect, withAttributes: exifAttributes)
   262→                }
   263→            }
   264→        }
   265→    }
   266→    
   267→    // 渲染中心水印相框
   268→    private func renderCenterWatermarkFrame(
   269→        imageSize: CGSize,
   270→        customText: String,
   271→        selectedLogo: String?,
   272→        metadata: [String: Any]
   273→    ) {
   274→        // 绘制半透明Logo
   275→        if let logoName = selectedLogo {
   276→            autoreleasepool {
   277→                let logoSize = min(imageSize.width, imageSize.height) * 0.2
   278→                if let logoImage = getLogoImage(logoName, maxSize: logoSize * 1.5) {
   279→                    let logoRect = CGRect(
   280→                        x: imageSize.width / 2 - logoSize / 2,
   281→                        y: imageSize.height / 2 - logoSize / 2,
   282→                        width: logoSize,
   283→                        height: logoSize
   284→                    )
   285→                    
   286→                    // 设置透明度
   287→                    UIGraphicsGetCurrentContext()?.setAlpha(0.3)
   288→                    logoImage.draw(in: logoRect)
   289→                    UIGraphicsGetCurrentContext()?.setAlpha(1.0)
   290→                }
   291→            }
   292→        }
   293→        
   294→        // 绘制自定义文字
   295→        if !customText.isEmpty {
   296→            autoreleasepool {
   297→                let textFont = UIFont.systemFont(ofSize: min(imageSize.width, imageSize.height) * 0.03, weight: .medium)
   298→                let textAttributes: [NSAttributedString.Key: Any] = [
   299→                    .font: textFont,
   300→                    .foregroundColor: UIColor.white.withAlphaComponent(0.7)
   301→                ]
   302→                
   303→                let textSize = customText.size(withAttributes: textAttributes)
   304→                let textRect = CGRect(
   305→                    x: imageSize.width / 2 - textSize.width / 2,
   306→                    y: imageSize.height / 2 + min(imageSize.width, imageSize.height) * 0.12,
   307→                    width: textSize.width,
   308→                    height: textSize.height
   309→                )
   310→                
   311→                // 添加文字背景
   312→                let textBackground = UIBezierPath(rect: textRect.insetBy(dx: -10, dy: -5))
   313→                UIColor.black.withAlphaComponent(0.3).setFill()
   314→                textBackground.fill()
   315→                
   316→                customText.draw(in: textRect, withAttributes: textAttributes)
   317→            }
   318→        }
   319→    }
   320→    
   321→    // 渲染杂志封面相框
   322→    private func renderMagazineCoverFrame(
   323→        imageSize: CGSize,
   324→        customText: String,
   325→        showDate: Bool,
   326→        selectedLogo: String?,
   327→        metadata: [String: Any]
   328→    ) {
   329→        autoreleasepool {
   330→            // 顶部黑色条
   331→            let topBarHeight = imageSize.height * 0.1
   332→            let topBarRect = CGRect(x: 0, y: 0, width: imageSize.width, height: topBarHeight)
   333→            UIColor.black.setFill()
   334→            UIRectFill(topBarRect)
   335→            
   336→            // 底部黑色条
   337→            let bottomBarHeight = imageSize.height * 0.05
   338→            let bottomBarRect = CGRect(x: 0, y: imageSize.height - bottomBarHeight, width: imageSize.width, height: bottomBarHeight)
   339→            UIColor.black.setFill()
   340→            UIRectFill(bottomBarRect)
   341→            
   342→            // 绘制Logo
   343→            if let logoName = selectedLogo {
   344→                let logoHeight = topBarHeight * 0.6
   345→                if let logoImage = getLogoImage(logoName, maxSize: logoHeight * 2) {
   346→                    let logoWidth = logoHeight * (logoImage.size.width / logoImage.size.height)
   347→                    let logoRect = CGRect(
   348→                        x: 20,
   349→                        y: topBarHeight / 2 - logoHeight / 2,
   350→                        width: logoWidth,
   351→                        height: logoHeight
   352→                    )
   353→                    
   354→                    logoImage.draw(in: logoRect)
   355→                }
   356→            }
   357→            
   358→            // 绘制自定义文字（标题）
   359→            if !customText.isEmpty {
   360→                let textFont = UIFont.systemFont(ofSize: topBarHeight * 0.4, weight: .bold)
   361→                let textAttributes: [NSAttributedString.Key: Any] = [
   362→                    .font: textFont,
   363→                    .foregroundColor: UIColor.white
   364→                ]
   365→                
   366→                let textSize = customText.size(withAttributes: textAttributes)
   367→                let textRect = CGRect(
   368→                    x: imageSize.width - textSize.width - 20,
   369→                    y: topBarHeight / 2 - textSize.height / 2,
   370→                    width: textSize.width,
   371→                    height: textSize.height
   372→                )
   373→                
   374→                customText.draw(in: textRect, withAttributes: textAttributes)
   375→            }
   376→            
   377→            // 绘制日期
   378→            if showDate {
   379→                let dateFormatter = DateFormatter()
   380→                dateFormatter.dateFormat = "yyyy年MM月"
   381→                let dateString = dateFormatter.string(from: Date())
   382→                
   383→                let dateFont = UIFont.systemFont(ofSize: bottomBarHeight * 0.6, weight: .medium)
   384→                let dateAttributes: [NSAttributedString.Key: Any] = [
   385→                    .font: dateFont,
   386→                    .foregroundColor: UIColor.white
   387→                ]
   388→                
   389→                let dateSize = dateString.size(withAttributes: dateAttributes)
   390→                let dateRect = CGRect(
   391→                    x: imageSize.width / 2 - dateSize.width / 2,
   392→                    y: imageSize.height - bottomBarHeight / 2 - dateSize.height / 2,
   393→                    width: dateSize.width,
   394→                    height: dateSize.height
   395→                )
   396→                
   397→                dateString.draw(in: dateRect, withAttributes: dateAttributes)
   398→            }
   399→        }
   400→    }
   401→    
   402→    // 渲染宝丽来相框
   403→    private func renderPolaroidFrame(
   404→        imageSize: CGSize,
   405→        customText: String,
   406→        showDate: Bool,
   407→        metadata: [String: Any]
   408→    ) {
   409→        autoreleasepool {
   410→            // 计算宝丽来相框的尺寸和位置
   411→            let borderWidth: CGFloat = min(imageSize.width, imageSize.height) * 0.05
   412→            let bottomBorderHeight: CGFloat = min(imageSize.width, imageSize.height) * 0.15
   413→            
   414→            // 绘制白色背景框
   415→            let frameRect = CGRect(
   416→                x: 0,
   417→                y: 0,
   418→                width: imageSize.width,
   419→                height: imageSize.height
   420→            )
   421→            UIColor.white.setFill()
   422→            UIRectFill(frameRect)
   423→            
   424→            // 绘制照片区域（稍微缩小以留出边框）
   425→            let photoRect = CGRect(
   426→                x: borderWidth,
   427→                y: borderWidth,
   428→                width: imageSize.width - borderWidth * 2,
   429→                height: imageSize.height - borderWidth - bottomBorderHeight
   430→            )
   431→            
   432→            // 添加照片区域的阴影效果
   433→            let shadowPath = UIBezierPath(rect: photoRect)
   434→            UIColor.black.withAlphaComponent(0.1).setFill()
   435→            shadowPath.fill()
   436→            
   437→            // 绘制自定义文字
   438→            if !customText.isEmpty {
   439→                let textFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.4) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.4, weight: .medium)
   440→                let textAttributes: [NSAttributedString.Key: Any] = [
   441→                    .font: textFont,
   442→                    .foregroundColor: UIColor.black
   443→                ]
   444→                
   445→                let textSize = customText.size(withAttributes: textAttributes)
   446→                let textRect = CGRect(
   447→                    x: imageSize.width / 2 - textSize.width / 2,
   448→                    y: imageSize.height - bottomBorderHeight / 2 - textSize.height / 2,
   449→                    width: textSize.width,
   450→                    height: textSize.height
   451→                )
   452→                
   453→                customText.draw(in: textRect, withAttributes: textAttributes)
   454→            }
   455→            
   456→            // 绘制日期
   457→            if showDate {
   458→                let dateFormatter = DateFormatter()
   459→                dateFormatter.dateFormat = "yyyy.MM.dd"
   460→                let dateString = dateFormatter.string(from: Date())
   461→                
   462→                let dateFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.25) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.25, weight: .light)
   463→                let dateAttributes: [NSAttributedString.Key: Any] = [
   464→                    .font: dateFont,
   465→                    .foregroundColor: UIColor.black.withAlphaComponent(0.6)
   466→                ]
   467→                
   468→                let dateSize = dateString.size(withAttributes: dateAttributes)
   469→                let dateRect = CGRect(
   470→                    x: imageSize.width - dateSize.width - borderWidth,
   471→                    y: imageSize.height - dateSize.height - borderWidth * 0.5,
   472→                    width: dateSize.width,
   473→                    height: dateSize.height
   474→                )
   475→                
   476→                dateString.draw(in: dateRect, withAttributes: dateAttributes)
   477→            }
   478→        }
   479→    }
   480→}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析相框处理Bug - 只显示相框没有照片
- [X] 🌡️ 检查PhotoDecorationService代码
- [X] 🌡️ 查看相框应用流程
- [⚡] 🌡️ 修复相框处理Bug


_**Agent (claude-sonnet-4-20250514)**_

找到问题了！在 `PhotoDecorationRenderer.swift` 的第 **61行**，代码只绘制了处理后的图像：

```swift
// 绘制原始图像
renderImage.draw(at: CGPoint.zero)
```

但是在宝丽来相框 (`renderPolaroidFrame`) 中，代码存在致命的错误：

1. **第421-422行**：绘制了白色背景覆盖整个画布
2. **第425-430行**：定义了照片区域，但**没有在照片区域绘制实际的照片**
3. **第433-435行**：只绘制了阴影效果，但照片本身被白色背景覆盖了

这就是为什么你看到的图片只有相框和水印，没有实际照片的原因。

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   398→            }
   399→        }
   400→    }
   401→    
   402→    // 渲染宝丽来相框
   403→    private func renderPolaroidFrame(
   404→        imageSize: CGSize,
   405→        customText: String,
   406→        showDate: Bool,
   407→        metadata: [String: Any]
   408→    ) {
   409→        autoreleasepool {
   410→            // 🐛 修复：宝丽来相框需要重新构建，不能直接覆盖原图
   411→            // 计算宝丽来相框的尺寸和位置
   412→            let borderWidth: CGFloat = min(imageSize.width, imageSize.height) * 0.05
   413→            let bottomBorderHeight: CGFloat = min(imageSize.width, imageSize.height) * 0.15
   414→            
   415→            // 🐛 修复：不要在这里绘制白色背景，因为这会覆盖原始照片
   416→            // 我们需要先保存当前的图像内容
   417→            
   418→            // 获取当前绘图上下文中的图像
   419→            guard let currentImage = UIGraphicsGetImageFromCurrentImageContext() else { return }
   420→            
   421→            // 清除当前内容
   422→            let fullRect = CGRect(x: 0, y: 0, width: imageSize.width, height: imageSize.height)
   423→            UIColor.clear.setFill()
   424→            UIRectFill(fullRect)
   425→            
   426→            // 绘制白色背景框（现在是整个相框的背景）
   427→            UIColor.white.setFill()
   428→            UIRectFill(fullRect)
   429→            
   430→            // 计算照片在相框中的位置（稍微缩小以留出边框）
   431→            let photoRect = CGRect(
   432→                x: borderWidth,
   433→                y: borderWidth,
   434→                width: imageSize.width - borderWidth * 2,
   435→                height: imageSize.height - borderWidth - bottomBorderHeight
   436→            )
   437→            
   438→            // 🐛 修复：重新绘制原始照片到指定的照片区域
   439→            currentImage.draw(in: photoRect)
   440→            
   441→            // 添加照片区域的阴影效果（可选）
   442→            let shadowPath = UIBezierPath(rect: photoRect)
   443→            UIColor.black.withAlphaComponent(0.1).setStroke()
   444→            shadowPath.lineWidth = 2
   445→            shadowPath.stroke()
   446→            
   447→            // 绘制自定义文字
   448→            if !customText.isEmpty {
   449→                let textFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.4) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.4, weight: .medium)
```

_**Agent (claude-sonnet-4-20250514)**_

上面的修复方法有问题，因为在绘图过程中获取当前图像会有问题。让我用更好的方法修复：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     3→import CoreLocation
     4→
     5→class PhotoDecorationRenderer {
     6→    
     7→    // 渲染装饰到照片上
     8→    func renderDecoration(
     9→        on image: UIImage,
    10→        frameType: FrameType,
    11→        customText: String,
    12→        showDate: Bool,
    13→        showLocation: Bool,
    14→        showExif: Bool,
    15→        showExifParams: Bool,
    16→        showExifDate: Bool,
    17→        selectedLogo: String?,
    18→        showSignature: Bool,
    19→        metadata: [String: Any]
    20→    ) -> UIImage {
    21→        // 优化：使用更严格的内存管理策略
    22→        var finalImage: UIImage?
    23→        
    24→        // 使用autoreleasepool包装整个处理过程
    25→        autoreleasepool {
    26→            // 优化：对于高分辨率图像，先缩小尺寸再渲染
    27→            let maxSize: CGFloat = 2500 // 降低最大尺寸以减少内存使用
    28→            var renderImage: UIImage?
    29→            var scale: CGFloat = image.scale
    30→            
    31→            // 如果图像尺寸超过最大尺寸，进行缩放
    32→            if image.size.width > maxSize || image.size.height > maxSize {
    33→                let resizeScale = maxSize / max(image.size.width, image.size.height)
    34→                let newSize = CGSize(width: image.size.width * resizeScale, height: image.size.height * resizeScale)
    35→                
    36→                // 使用autoreleasepool减少内存占用
    37→                autoreleasepool {
    38→                    UIGraphicsBeginImageContextWithOptions(newSize, false, 0)
    39→                    defer { UIGraphicsEndImageContext() }
    40→                    
    41→                    image.draw(in: CGRect(origin: .zero, size: newSize))
    42→                    renderImage = UIGraphicsGetImageFromCurrentImageContext()
    43→                }
    44→                
    45→                // 保存原始比例，以便后续可能的放大
    46→                scale = image.scale / resizeScale
    47→            } else {
    48→                renderImage = image
    49→            }
    50→            
    51→            guard let renderImage = renderImage else {
    52→                finalImage = image
    53→                return
    54→            }
    55→            
    56→            // 🐛 修复：根据相框类型决定是否需要特殊处理
    57→            if frameType == .polaroid {
    58→                // 宝丽来相框需要特殊处理：创建更大的画布
    59→                let borderWidth: CGFloat = min(renderImage.size.width, renderImage.size.height) * 0.05
    60→                let bottomBorderHeight: CGFloat = min(renderImage.size.width, renderImage.size.height) * 0.15
    61→                let frameSize = CGSize(
    62→                    width: renderImage.size.width + borderWidth * 2,
    63→                    height: renderImage.size.height + borderWidth + bottomBorderHeight
    64→                )
    65→                
    66→                UIGraphicsBeginImageContextWithOptions(frameSize, false, renderImage.scale)
    67→                defer { UIGraphicsEndImageContext() }
    68→                
    69→                renderPolaroidFrame(
    70→                    image: renderImage,
    71→                    frameSize: frameSize,
    72→                    customText: customText,
    73→                    showDate: showDate,
    74→                    metadata: metadata
    75→                )
    76→            } else {
    77→                // 其他相框类型：在原图上添加装饰
    78→                UIGraphicsBeginImageContextWithOptions(renderImage.size, false, renderImage.scale)
    79→                defer { UIGraphicsEndImageContext() }
    80→                
    81→                // 绘制原始图像
    82→                renderImage.draw(at: CGPoint.zero)
    83→                
    84→                // 根据相框类型应用不同的装饰
    85→                switch frameType {
    86→                case .bottomText:
    87→                    renderBottomTextFrame(
    88→                        imageSize: renderImage.size,
    89→                        customText: customText,
    90→                        showDate: showDate,
    91→                        showLocation: showLocation,
    92→                        showExif: showExif,
    93→                        showExifParams: showExifParams,
    94→                        showExifDate: showExifDate,
    95→                        selectedLogo: selectedLogo,
    96→                        showSignature: showSignature,
    97→                        metadata: metadata
    98→                    )
    99→                    
   100→                case .centerWatermark:
   101→                    renderCenterWatermarkFrame(
   102→                        imageSize: renderImage.size,
   103→                        customText: customText,
   104→                        selectedLogo: selectedLogo,
   105→                        metadata: metadata
   106→                    )
   107→                    
   108→                case .magazineCover:
   109→                    renderMagazineCoverFrame(
   110→                        imageSize: renderImage.size,
   111→                        customText: customText,
   112→                        showDate: showDate,
   113→                        selectedLogo: selectedLogo,
   114→                        metadata: metadata
   115→                    )
   116→                    
   117→                case .none:
   118→                    // 不应用任何装饰
   119→                    break
   120→                case .polaroid:
   121→                    // 已在上面处理
   122→                    break
   123→                }
   124→            }
   125→            
   126→            // 获取最终图像
   127→            finalImage = UIGraphicsGetImageFromCurrentImageContext()
   128→        }
   129→        
   130→        // 如果处理失败，返回原始图像
   131→        return finalImage ?? image
   132→    }
   133→    
   134→    // 优化：预加载和缓存Logo图像
   135→    private func getLogoImage(_ logoName: String, maxSize: CGFloat) -> UIImage? {
   136→        guard let logoImage = UIImage(named: logoName) else { return nil }
```

_**Agent (claude-sonnet-4-20250514)**_

现在需要更新宝丽来相框的渲染方法，让它接受原始图像参数：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   415→            }
   416→        }
   417→    }
   418→    
   419→    // 🐛 修复：新的宝丽来相框渲染方法，接受原始图像参数
   420→    private func renderPolaroidFrame(
   421→        image: UIImage,
   422→        frameSize: CGSize,
   423→        customText: String,
   424→        showDate: Bool,
   425→        metadata: [String: Any]
   426→    ) {
   427→        autoreleasepool {
   428→            // 计算宝丽来相框的尺寸和位置
   429→            let borderWidth: CGFloat = min(image.size.width, image.size.height) * 0.05
   430→            let bottomBorderHeight: CGFloat = min(image.size.width, image.size.height) * 0.15
   431→            
   432→            // 绘制白色背景框（整个相框的背景）
   433→            let fullRect = CGRect(x: 0, y: 0, width: frameSize.width, height: frameSize.height)
   434→            UIColor.white.setFill()
   435→            UIRectFill(fullRect)
   436→            
   437→            // 计算照片在相框中的位置
   438→            let photoRect = CGRect(
   439→                x: borderWidth,
   440→                y: borderWidth,
   441→                width: image.size.width,
   442→                height: image.size.height
   443→            )
   444→            
   445→            // 🐛 修复：绘制原始照片到指定的照片区域
   446→            image.draw(in: photoRect)
   447→            
   448→            // 添加照片区域的阴影效果（可选）
   449→            let shadowPath = UIBezierPath(rect: photoRect)
   450→            UIColor.black.withAlphaComponent(0.1).setStroke()
   451→            shadowPath.lineWidth = 2
   452→            shadowPath.stroke()
   453→            
   454→            // 绘制自定义文字
   455→            if !customText.isEmpty {
   456→                let textFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.4) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.4, weight: .medium)
```

_**Agent (claude-sonnet-4-20250514)**_

还需要更新文字和日期的绘制位置，因为现在画布尺寸变了：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   450→            UIColor.black.withAlphaComponent(0.1).setStroke()
   451→            shadowPath.lineWidth = 2
   452→            shadowPath.stroke()
   453→            
   454→            // 绘制自定义文字
   455→            if !customText.isEmpty {
   456→                let textFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.4) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.4, weight: .medium)
   457→                let textAttributes: [NSAttributedString.Key: Any] = [
   458→                    .font: textFont,
   459→                    .foregroundColor: UIColor.black
   460→                ]
   461→                
   462→                let textSize = customText.size(withAttributes: textAttributes)
   463→                let textRect = CGRect(
   464→                    x: frameSize.width / 2 - textSize.width / 2,
   465→                    y: frameSize.height - bottomBorderHeight / 2 - textSize.height / 2,
   466→                    width: textSize.width,
   467→                    height: textSize.height
   468→                )
   469→                
   470→                customText.draw(in: textRect, withAttributes: textAttributes)
   471→            }
   472→            
   473→            // 绘制日期
   474→            if showDate {
   475→                let dateFormatter = DateFormatter()
   476→                dateFormatter.dateFormat = "yyyy.MM.dd"
   477→                let dateString = dateFormatter.string(from: Date())
   478→                
   479→                let dateFont = UIFont(name: "Marker Felt", size: bottomBorderHeight * 0.25) ?? UIFont.systemFont(ofSize: bottomBorderHeight * 0.25, weight: .light)
   480→                let dateAttributes: [NSAttributedString.Key: Any] = [
   481→                    .font: dateFont,
   482→                    .foregroundColor: UIColor.black.withAlphaComponent(0.6)
   483→                ]
   484→                
   485→                let dateSize = dateString.size(withAttributes: dateAttributes)
   486→                let dateRect = CGRect(
   487→                    x: frameSize.width - dateSize.width - borderWidth,
   488→                    y: frameSize.height - dateSize.height - borderWidth * 0.5,
   489→                    width: dateSize.width,
   490→                    height: dateSize.height
   491→                )
   492→                
   493→                dateString.draw(in: dateRect, withAttributes: dateAttributes)
   494→            }
   495→        }
   496→    }
   497→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在我们还需要删除旧的方法定义。让我检查是否有重复的方法：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep** path `./MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift`

Result:

```
renderPolaroidFrame(
    private func renderPolaroidFrame(
```

_**Agent (claude-sonnet-4-20250514)**_

看起来方法定义是正确的。现在让我们构建并测试修复：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析相框处理Bug - 只显示相框没有照片
- [X] 🌡️ 检查PhotoDecorationService代码
- [X] 🌡️ 查看相框应用流程
- [X] 🌡️ 修复相框处理Bug


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 构建项目以验证修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' build`

Error:

```
2025-08-25 18:01:12.243 xcodebuild[20315:1796366] Writing error result bundle to /var/folders/t0/nfp_9bjx59527f4pv_1p2v300000gn/T/ResultBundle_2025-25-08_18-01-0012.xcresult
xcodebuild: error: Unable to find a device matching the provided destination specifier:
		{ platform:iOS Simulator, OS:latest, name:iPhone 15 Pro }

	The requested device could not be found because no available devices matched the request.

	Available destinations for the "MCCamera" scheme:
		{ platform:macOS, arch:arm64, variant:Designed for [iPad,iPhone], id:00008132-001C695E01C3001C, name:My Mac }
		{ platform:iOS, id:dvtdevice-DVTiPhonePlaceholder-iphoneos:placeholder, name:Any iOS Device }
		{ platform:iOS Simulator, id:dvtdevice-DVTiOSDeviceSimulatorPlaceholder-iphonesimulator:placeholder, name:Any iOS Simulator Device }
		{ platform:iOS, id:00008101-000354490C90001E, name:huilei的iPhone }
		{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
		{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
		{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
		{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
		{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
		{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
		{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
		{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
		{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
		{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
		{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
		{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
		{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
		{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
		{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
		{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
		{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
		{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
		{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
		{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
		{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }
		{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }

Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 15 Pro,OS=latest" build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 使用可用的iPhone 16 Pro模拟器构建项目

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.3.1' build`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.3.1" build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: dedc929d98f25587a01351b89bcfbdbf
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/dedc929d98f25587a01351b89bcfbdbf.xcbuilddata
ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache

ProcessProductPackaging "" /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Entitlements:
    
    {
    "application-identifier" = "2867UNTJFF.com.lianjia.decoration.stewardHD";
}
    
    builtin-productPackagingUtility -entitlements -format xml -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent

ProcessProductPackagingDER /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent.der (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /usr/bin/derq query -f xml -i /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera.app-Simulated.xcent.der --raw

ProcessInfoPlistFile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-infoPlistUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/empty-MCCamera.plist -producttype com.apple.product-type.application -genpkginfo /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/PkgInfo -expandbuildsettings -format binary -platform iphonesimulator -additionalcontentfile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/assetcatalog_generated_info.plist -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/MCCamera.app/Info.plist

SwiftDriver MCCamera normal arm64 com.apple.xcode.tools.swift.compiler (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-SwiftDriver -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc -module-name MCCamera -Onone -enforce-exclusivity\=checked @/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.SwiftFileList -DDEBUG -enable-bare-slash-regex -enable-experimental-feature DebugDescriptionMacro -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -target arm64-apple-ios14.0-simulator -g -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -Xfrontend -serialize-debugging-options -profile-coverage-mapping -profile-generate -enable-testing -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -enable-experimental-feature OpaqueTypeErasure -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -swift-version 5 -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -c -j10 -enable-batch-mode -incremental -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -output-file-map /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-OutputFileMap.json -use-frontend-parseable-output -save-temps -no-color-diagnostics -serialize-diagnostics -emit-dependencies -emit-module -emit-module-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera.swiftmodule -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -emit-const-values -Xfrontend -const-gather-protocols-file -Xfrontend /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -emit-objc-header -emit-objc-header-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera-Swift.h -working-directory /Users/macongcong/Desktop/MC/MCCamera -experimental-emit-module-separately -disable-cmo

SwiftCompile normal arm64 Compiling\ WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-swiftTaskExecution -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -frontend -c /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift -primary-file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -emit-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.d -emit-const-values-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.swiftconstvalues -emit-reference-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.swiftdeps -serialize-diagnostics-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.dia -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphonesimulator18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/host/plugins -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/local/lib/swift/host/plugins -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.o -index-unit-output-path /MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.o -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -index-system-modules

SwiftCompile normal arm64 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -c /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraDiscovery.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/FlashController.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Camera/HighResolutionCameraManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Location/LocationManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoProcessor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Core/Photo/PhotoSettingsManager.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioPreviewOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/AspectRatioSelectionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualControlsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/CameraManualSliderView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/FlashControlView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/GalleryButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/LensSelectorView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/PermissionView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ShutterButtonView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/Views/ThumbnailView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraPreview.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Camera/CameraViewModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Models/FrameModel.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/InfoLayoutEngine.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationRenderer.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Services/PhotoDecorationService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/FrameSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/Views/SimplePhotoDecorationView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Settings/SettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkProcessor.swift -primary-file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/ExposureSlider.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Components/GridOverlay.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/CameraHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/DeviceInfoHelper.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/MemoryMonitor.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Extensions/UIImage+Extensions.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/AspectRatio.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraCaptureSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/CameraManualSettings.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/FlashMode.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoFormat.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Shared/Models/PhotoResolution.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/ContentView.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/MCCameraApp.swift /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/DerivedSources/GeneratedAssetSymbols.swift -emit-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.d -emit-const-values-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.swiftconstvalues -emit-reference-dependencies-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.swiftdeps -serialize-diagnostics-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/WatermarkService.dia -emit-localized-strings -emit-localized-strings-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64 -target arm64-apple-ios14.0-simulator -Xllvm -aarch64-use-tbi -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator18.2.sdk -I /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -F /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphonesimulator -no-color-diagnostics -enable-testing -g -debug-info-format\=dwarf -dwarf-version\=4 -module-cache-path /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex -profile-generate -profile-coverage-mapping -swift-version 5 -enforce-exclusivity\=checked -Onone -D DEBUG -serialize-debugging-options -const-gather-protocols-file /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/Objects-normal/arm64/MCCamera_const_extract_protocols.json -enable-experimental-feature DebugDescriptionMacro -enable-experimental-feature OpaqueTypeErasure -enable-bare-slash-regex -empty-abi-descriptor -validate-clang-modules-once -clang-build-session-file /Users/macongcong/Library/Developer/Xcode/DerivedData/ModuleCache.noindex/Session.modulevalidation -Xcc -working-directory -Xcc /Users/macongcong/Desktop/MC/MCCamera -resource-dir /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -enable-anonymous-context-mangled-names -file-compilation-dir /Users/macongcong/Desktop/MC/MCCamera -Xcc -D_LIBCPP_HARDENING_MODE\=_LIBCPP_HARDENING_MODE_DEBUG -Xcc -ivfsstatcache -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphonesimulator18.2-22C146-07b28473f605e47e75261259d3ef3b5a.sdkstatcache -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/swift-overrides.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphonesimulator/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/

... [169 lines truncated] ...
```

_**Agent (claude-sonnet-4-20250514)**_

构建成功！现在我们已经修复了宝丽来相框的Bug。让我们总结一下修复的内容：

## 🐛 相框Bug修复总结

### 问题分析
原始的宝丽来相框渲染代码存在致命问题：
1. **完全覆盖原图**：在`renderPolaroidFrame`方法中，代码直接绘制白色背景覆盖整个画布
2. **缺失照片绘制**：定义了照片区域但没有在该区域绘制实际的照片内容
3. **错误的绘制顺序**：先绘制背景，后定义照片区域，导致照片内容被覆盖

### 修复方案
1. **重构宝丽来相框逻辑**：
   - 创建更大的画布来容纳相框边框
   - 先绘制白色背景，再在指定区域绘制原始照片
   - 确保照片内容不被覆盖

2. **修改方法签名**：
   - 新增接受原始图像参数的`renderPolaroidFrame`方法
   - 传递`image`参数以便在照片区域正确绘制

3. **调整布局计算**：
   - 使用`frameSize`而不是`imageSize`来计算文字和日期位置
   - 确保所有元素在新的画布尺寸下正确定位

### 关键代码修复
```swift
// 修复前：只绘制背景，覆盖原图
UIColor.white.setFill()
UIRectFill(frameRect)

// 修复后：先绘制背景，再绘制照片
UIColor.white.setFill()
UIRectFill(fullRect)
image.draw(in: photoRect)  // 🔑 关键修复：绘制原始照片
```

### 预期效果
修复后的宝丽来相框应该：
- ✅ 显示完整的原始照片
- ✅ 照片周围有白色边框
- ✅ 底部有更宽的白色区域用于文字
- ✅ 正确显示自定义文字和日期
- ✅ 保持宝丽来风格的视觉效果

现在你可以重新测试相框功能，应该能够看到完整的照片加上相框效果了！

