<!-- Generated by SpecStory -->

# Photo Border System: EXIF, Layout, and Metadata Fixes (2025-08-25 02:09:16Z)

<!-- Claude Code Session e5e474b2-f199-4575-a695-679fd4e1f643 (2025-08-25_02-09-16Z) -->

_**User**_

我需要给当前项目添加一个相框的能力,支持配置相框样式及水印样式.

---

_**Agent (claude-sonnet-4-20250514)**_

我需要先了解当前项目的结构，然后为添加相框功能制定一个计划。

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **LS**

Result:

```
- /Users/macongcong/Desktop/MC/MCCamera/
  - CLAUDE.md
  - DEVELOPMENT_ROADMAP.md
  - MCCamera.xcodeproj/
    - project.pbxproj
    - project.xcworkspace/
      - contents.xcworkspacedata
      - xcshareddata/
        - swiftpm/
          - configuration/
      - xcuserdata/
        - macongcong.xcuserdatad/
          - UserInterfaceState.xcuserstate
    - xcuserdata/
      - macongcong.xcuserdatad/
        - xcschemes/
          - xcschememanagement.plist
  - MCCamera/
    - Assets.xcassets/
      - AccentColor.colorset/
        - Contents.json
      - AppIcon.appiconset/
        - Contents.json
        - WechatIMG31 1.png
        - WechatIMG31 2.png
        - WechatIMG31.png
        - backup/
          - WechatIMG31 1.png
          - WechatIMG31 2.png
          - WechatIMG31.png
      - Apple_logo_black.imageset/
        - Apple_logo_black.png
        - Contents.json
      - Arri_logo.imageset/
        - Arri_logo.png
        - Contents.json
      - Canon_wordmark.imageset/
        - Canon_wordmark.png
        - Contents.json
      - Contents.json
      - Eastman_Kodak_Company_logo_(2016)(no_background).imageset/
        - Contents.json
        - Eastman_Kodak_Company_logo_(2016)(no_background).png
      - Fujifilm_logo.imageset/
        - Contents.json
        - Fujifilm_logo.png
      - Hasselblad_logo.imageset/
        - Contents.json
        - Hasselblad_logo.png
      - Leica_Camera_logo.imageset/
        - Contents.json
        - Leica_Camera_logo.png
      - Nikon_Logo.imageset/
        - Contents.json
        - Nikon_Logo.png
      - Olympus_Corporation_logo.imageset/
        - Contents.json
        - Olympus_Corporation_logo.png
      - Panasonic_logo_(Blue).imageset/
        - Contents.json
        - Panasonic_logo_(Blue).png
      - Panavision_logo.imageset/
        - Contents.json
        - Panavision_logo.png
      - Polaroid_logo.imageset/
        - Contents.json
        - Polaroid_logo.png
      - Ricoh_logo_2012.imageset/
        - Contents.json
        - Ricoh_logo_2012.png
      - Sony_logo.imageset/
        - Contents.json
        - Sony_logo.png
      - Zeiss_logo.imageset/
        - Contents.json
        - Zeiss_logo.png
      - dji-1.imageset/
        - Contents.json
        - dji-1.png
    - ContentView.swift
    - Core/
      - Camera/
        - CameraDiscovery.swift
        - CameraService.swift
        - FlashController.swift
        - HighResolutionCameraManager.swift
      - Location/
        - LocationManager.swift
      - Photo/
        - PhotoProcessor.swift
        - PhotoSettingsManager.swift
    - Features/
      - Border/
      - Camera/
        - CameraPreview.swift
        - CameraView.swift
        - CameraViewModel.swift
        - Views/
          - AspectRatioPreviewOverlay.swift
          - AspectRatioSelectionView.swift
          - CameraControlsView.swift
          - CameraManualControlsView.swift
          - CameraManualSliderView.swift
          - FlashControlView.swift
          - GalleryButtonView.swift
          - LensSelectorView.swift
          - PermissionView.swift
          - ShutterButtonView.swift
          - ThumbnailView.swift
      - Frame/
        - FrameProcessor.swift
        - FrameService.swift
        - FrameSettings.swift
        - FrameSettingsView.swift
      - Settings/
        - SettingsView.swift
      - Watermark/
        - WatermarkProcessor.swift
        - WatermarkService.swift
        - WatermarkSettings.swift
        - WatermarkSettingsView.swift
    - MCCameraApp.swift
    - Preview Content/
      - Preview Assets.xcassets/
        - Contents.json
    - Shared/
      - Components/
        - ExposureSlider.swift
        - GridOverlay.swift
      - Extensions/
        - CameraHelper.swift
        - DeviceInfoHelper.swift
        - UIImage+Extensions.swift
      - Models/
        - AspectRatio.swift
        - CameraCaptureSettings.swift
        - CameraManualSettings.swift
        - FlashMode.swift
        - PhotoFormat.swift
        - PhotoResolution.swift
  - MCCameraTests/
    - MCCameraTests.swift
  - MCCameraUITests/
    - MCCameraUITests.swift
    - MCCameraUITestsLaunchTests.swift
  - PROJECT_STRUCTURE.md
  - WatermarkFeature.md
  - XCODE_PROJECT_UPDATE.md
  - create_logo_assets.sh
  - log.md

NOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work.
```

_**Agent (claude-sonnet-4-20250514)**_

我看到项目已经有了相框功能的基础结构，让我查看一下现有的相框实现：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/FrameSettings.swift`

Result:

```
1→import Foundation
     2→import UIKit
     3→
     4→// 边框布局类型
     5→enum FrameLayoutType: String, CaseIterable, Codable {
     6→    case centerFloat = "居中悬浮"
     7→    case bottomSymmetric = "底部对称"
     8→    case polaroid = "宝丽来"
     9→    case bottomLeft = "左下角"
    10→    case bottomInfoBar = "底部信息条"
    11→    case magazineSidebar = "杂志侧栏"
    12→}
    13→
    14→// 内容对齐方式
    15→enum ContentAlignment: String, CaseIterable, Codable {
    16→    case left = "居左"
    17→    case center = "居中"
    18→    case right = "居右"
    19→    case distributed = "分散"
    20→}
    21→
    22→// 显示内容类型
    23→struct DisplayContent: Codable {
    24→    var showParameters: Bool = true
    25→    var showLocation: Bool = false
    26→    var showDate: Bool = true
    27→}
    28→
    29→// 相框设置
    30→struct FrameSettings: Codable {
    31→    var isEnabled: Bool = false
    32→    var frameLayout: FrameLayoutType = .polaroid
    33→    var logoIndex: Int = 0
    34→    var contentAlignment: ContentAlignment = .center
    35→    var displayContent: DisplayContent = DisplayContent()
    36→    var customText: String = ""
    37→    
    38→    // 边框颜色 - 使用十六进制字符串表示，方便存储
    39→    var borderColorHex: String = "#FFFFFF"
    40→    
    41→    // 获取UIColor
    42→    var borderColor: UIColor {
    43→        get {
    44→            return UIColor(hex: borderColorHex) ?? .white
    45→        }
    46→        set {
    47→            borderColorHex = newValue.toHex() ?? "#FFFFFF"
    48→        }
    49→    }
    50→    
    51→    static let shared = FrameSettings()
    52→    
    53→    func save() {
    54→        if let data = try? JSONEncoder().encode(self) {
    55→            UserDefaults.standard.set(data, forKey: "FrameSettings")
    56→        }
    57→    }
    58→    
    59→    static func load() -> FrameSettings {
    60→        guard let data = UserDefaults.standard.data(forKey: "FrameSettings"),
    61→              let settings = try? JSONDecoder().decode(FrameSettings.self, from: data) else {
    62→            return FrameSettings()
    63→        }
    64→        return settings
    65→    }
    66→}
    67→
    68→// 扩展UIColor，添加十六进制颜色转换
    69→extension UIColor {
    70→    convenience init?(hex: String) {
    71→        var hexSanitized = hex.trimmingCharacters(in: .whitespacesAndNewlines)
    72→        hexSanitized = hexSanitized.replacingOccurrences(of: "#", with: "")
    73→        
    74→        var rgb: UInt64 = 0
    75→        
    76→        guard Scanner(string: hexSanitized).scanHexInt64(&rgb) else { return nil }
    77→        
    78→        let red = CGFloat((rgb & 0xFF0000) >> 16) / 255.0
    79→        let green = CGFloat((rgb & 0x00FF00) >> 8) / 255.0
    80→        let blue = CGFloat(rgb & 0x0000FF) / 255.0
    81→        
    82→        self.init(red: red, green: green, blue: blue, alpha: 1.0)
    83→    }
    84→    
    85→    func toHex() -> String? {
    86→        guard let components = self.cgColor.components, components.count >= 3 else {
    87→            return nil
    88→        }
    89→        
    90→        let r = Float(components[0])
    91→        let g = Float(components[1])
    92→        let b = Float(components[2])
    93→        
    94→        return String(format: "#%02lX%02lX%02lX", lroundf(r * 255), lroundf(g * 255), lroundf(b * 255))
    95→    }
    96→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/FrameService.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→import Foundation
     4→
     5→class FrameService {
     6→    static let shared = FrameService()
     7→    
     8→    private init() {}
     9→    
    10→    func addFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String? = nil, aspectRatio: AspectRatio? = nil) -> UIImage? {
    11→        let settings = FrameSettings.load()
    12→        
    13→        print("🖼️ FrameService.addFrame 被调用")
    14→        print("  - 设置启用: \(settings.isEnabled)")
    15→        print("  - 相框布局: \(settings.frameLayout.rawValue)")
    16→        print("  - 图像尺寸: \(image.size)")
    17→        
    18→        guard settings.isEnabled else { 
    19→            print("  - 相框未启用，返回原图")
    20→            return image 
    21→        }
    22→        
    23→        // 根据不同的布局类型应用不同的相框
    24→        switch settings.frameLayout {
    25→        case .centerFloat:
    26→            return applyCenterFloatFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    27→        case .bottomSymmetric:
    28→            return applyBottomSymmetricFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    29→        case .polaroid:
    30→            return applyPolaroidFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    31→        case .bottomLeft:
    32→            return applyBottomLeftFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    33→        case .bottomInfoBar:
    34→            return applyBottomInfoBarFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    35→        case .magazineSidebar:
    36→            return applyMagazineSidebarFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    37→        }
    38→    }
    39→    
    40→    // 居中悬浮相框
    41→    private func applyCenterFloatFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
    42→        let renderer = UIGraphicsImageRenderer(size: image.size)
    43→        
    44→        return renderer.image { context in
    45→            // 绘制原始图像
    46→            image.draw(at: CGPoint.zero)
    47→            
    48→            // 获取图像尺寸
    49→            let width = image.size.width
    50→            let height = image.size.height
    51→            
    52→            // 计算居中位置
    53→            let centerX = width / 2
    54→            let centerY = height / 2
    55→            
    56→            // 绘制半透明背景
    57→            let infoBackgroundRect = CGRect(x: width * 0.2, y: centerY - height * 0.1, width: width * 0.6, height: height * 0.2)
    58→            context.cgContext.setFillColor(UIColor.black.withAlphaComponent(0.6).cgColor)
    59→            context.cgContext.fillEllipse(in: infoBackgroundRect)
    60→            
    61→            // 绘制Logo（如果有）
    62→            if settings.logoIndex > 0 {
    63→                drawLogo(at: CGPoint(x: centerX, y: centerY - height * 0.05), size: CGSize(width: 50, height: 50), in: context.cgContext)
    64→            }
    65→            
    66→            // 绘制信息文本
    67→            let infoText = formatInfoText(captureSettings: captureSettings, locationInfo: locationInfo, settings: settings)
    68→            drawText(infoText, at: CGPoint(x: centerX, y: centerY + height * 0.05), alignment: settings.contentAlignment, color: .white, fontSize: width * 0.03, in: context.cgContext)
    69→            
    70→            // 绘制自定义文本（如果有）
    71→            if !settings.customText.isEmpty {
    72→                drawText(settings.customText, at: CGPoint(x: centerX, y: centerY + height * 0.1), alignment: settings.contentAlignment, color: .white, fontSize: width * 0.035, in: context.cgContext)
    73→            }
    74→        }
    75→    }
    76→    
    77→    // 底部对称相框
    78→    private func applyBottomSymmetricFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
    79→        // 计算新的图像尺寸（增加底部区域）
    80→        let originalWidth = image.size.width
    81→        let originalHeight = image.size.height
    82→        let bottomBarHeight = originalHeight * 0.15
    83→        let newSize = CGSize(width: originalWidth, height: originalHeight + bottomBarHeight)
    84→        
    85→        let renderer = UIGraphicsImageRenderer(size: newSize)
    86→        
    87→        return renderer.image { context in
    88→            // 绘制原始图像
    89→            image.draw(at: CGPoint.zero)
    90→            
    91→            // 绘制底部区域
    92→            let bottomRect = CGRect(x: 0, y: originalHeight, width: originalWidth, height: bottomBarHeight)
    93→            context.cgContext.setFillColor(settings.borderColor.cgColor)
    94→            context.cgContext.fill(bottomRect)
    95→            
    96→            // 绘制左侧信息
    97→            if settings.displayContent.showParameters {
    98→                let parametersText = formatParametersText(captureSettings: captureSettings)
    99→                drawText(parametersText, at: CGPoint(x: originalWidth * 0.15, y: originalHeight + bottomBarHeight * 0.5), alignment: .left, color: .black, fontSize: originalWidth * 0.03, in: context.cgContext)
   100→            }
   101→            
   102→            // 绘制Logo（如果有）
   103→            if settings.logoIndex > 0 {
   104→                drawLogo(at: CGPoint(x: originalWidth * 0.5, y: originalHeight + bottomBarHeight * 0.5), size: CGSize(width: 50, height: 50), in: context.cgContext)
   105→            }
   106→            
   107→            // 绘制右侧信息
   108→            if settings.displayContent.showDate {
   109→                let dateText = formatDateText()
   110→                drawText(dateText, at: CGPoint(x: originalWidth * 0.85, y: originalHeight + bottomBarHeight * 0.5), alignment: .right, color: .black, fontSize: originalWidth * 0.03, in: context.cgContext)
   111→            }
   112→        }
   113→    }
   114→    
   115→    // 宝丽来相框
   116→    private func applyPolaroidFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   117→        // 计算新的图像尺寸（增加边框）
   118→        let borderWidth = image.size.width * 0.15  // 左右边框宽度为15%
   119→        let topBorderHeight = image.size.height * 0.08  // 上边框高度为8%
   120→        let bottomBorderHeight = image.size.height * 0.2  // 下边框高度为20%
   121→        let newSize = CGSize(
   122→            width: image.size.width + borderWidth * 2,
   123→            height: image.size.height + topBorderHeight + bottomBorderHeight
   124→        )
   125→        
   126→        let renderer = UIGraphicsImageRenderer(size: newSize)
   127→        
   128→        return renderer.image { context in
   129→            // 绘制白色背景
   130→            UIColor.white.setFill()
   131→            context.fill(CGRect(origin: .zero, size: newSize))
   132→            
   133→            // 绘制边框 - 使用明确的矩形绘制四个边框
   134→            let borderColor = settings.borderColor
   135→            borderColor.setFill()
   136→            
   137→            // 上边框
   138→            let topBorderRect = CGRect(x: 0, y: 0, width: newSize.width, height: topBorderHeight)
   139→            context.fill(topBorderRect)
   140→            
   141→            // 下边框
   142→            let bottomBorderRect = CGRect(x: 0, y: newSize.height - bottomBorderHeight, width: newSize.width, height: bottomBorderHeight)
   143→            context.fill(bottomBorderRect)
   144→            
   145→            // 左边框
   146→            let leftBorderRect = CGRect(x: 0, y: topBorderHeight, width: borderWidth, height: image.size.height)
   147→            context.fill(leftBorderRect)
   148→            
   149→            // 右边框
   150→            let rightBorderRect = CGRect(x: newSize.width - borderWidth, y: topBorderHeight, width: borderWidth, height: image.size.height)
   151→            context.fill(rightBorderRect)
   152→            
   153→            // 绘制原始图像
   154→            image.draw(at: CGPoint(x: borderWidth, y: topBorderHeight))
   155→            
   156→            // 添加调试信息
   157→            print("🖼️ 宝丽来相框尺寸:")
   158→            print("  - 原始图像: \(image.size.width) x \(image.size.height)")
   159→            print("  - 新尺寸: \(newSize.width) x \(newSize.height)")
   160→            print("  - 左右边框: \(borderWidth)像素")
   161→            print("  - 上边框: \(topBorderHeight)像素")
   162→            print("  - 下边框: \(bottomBorderHeight)像素")
   163→            
   164→            // 绘制Logo（如果有）
   165→            if settings.logoIndex > 0 {
   166→                let logoX: CGFloat
   167→                switch settings.contentAlignment {
   168→                case .left: logoX = borderWidth * 2
   169→                case .center: logoX = newSize.width / 2
   170→                case .right: logoX = newSize.width - borderWidth * 2
   171→                case .distributed: logoX = newSize.width / 2
   172→                }
   173→                
   174→                // 增大logo尺寸，从50x50增加到70x70
   175→                drawLogo(at: CGPoint(x: logoX, y: newSize.height - bottomBorderHeight * 0.6), size: CGSize(width: 70, height: 70), in: context.cgContext)
   176→            }
   177→            
   178→            // 绘制自定义文本（如果有）
   179→            if !settings.customText.isEmpty {
   180→                let textX: CGFloat
   181→                switch settings.contentAlignment {
   182→                case .left: textX = borderWidth * 2
   183→                case .center: textX = newSize.width / 2
   184→                case .right: textX = newSize.width - borderWidth * 2
   185→                case .distributed: textX = newSize.width / 2
   186→                }
   187→                
   188→                drawText(settings.customText, at: CGPoint(x: textX, y: newSize.height - bottomBorderHeight * 0.3), alignment: settings.contentAlignment, color: .black, fontSize: newSize.width * 0.03, in: context.cgContext)
   189→            } else {
   190→                // 如果没有自定义文本，则显示相机参数
   191→                let infoText = formatInfoText(captureSettings: captureSettings, locationInfo: locationInfo, settings: settings)
   192→                let textX: CGFloat
   193→                switch settings.contentAlignment {
   194→                case .left: textX = borderWidth * 2
   195→                case .center: textX = newSize.width / 2
   196→                case .right: textX = newSize.width - borderWidth * 2
   197→                case .distributed: textX = newSize.width / 2
   198→                }
   199→                
   200→                drawText(infoText, at: CGPoint(x: textX, y: newSize.height - bottomBorderHeight * 0.3), alignment: settings.contentAlignment, color: .black, fontSize: newSize.width * 0.025, in: context.cgContext)
   201→            }
   202→        }
   203→    }
   204→    
   205→    // 左下角相框
   206→    private func applyBottomLeftFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   207→        let renderer = UIGraphicsImageRenderer(size: image.size)
   208→        
   209→        return renderer.image { context in
   210→            // 绘制原始图像
   211→            image.draw(at: CGPoint.zero)
   212→            
   213→            // 获取图像尺寸
   214→            let width = image.size.width
   215→            let height = image.size.height
   216→            
   217→            // 绘制左下角半透明背景
   218→            let infoBackgroundWidth = width * 0.4
   219→            let infoBackgroundHeight = height * 0.15
   220→            let infoBackgroundRect = CGRect(x: 0, y: height - infoBackgroundHeight, width: infoBackgroundWidth, height: infoBackgroundHeight)
   221→            context.cgContext.setFillColor(UIColor.black.withAlphaComponent(0.7).cgColor)
   222→            context.cgContext.fill(infoBackgroundRect)
   223→            
   224→            // 绘制Logo（如果有）
   225→            if settings.logoIndex > 0 {
   226→                drawLogo(at: CGPoint(x: infoBackgroundWidth * 0.15, y: height - infoBackgroundHeight * 0.7), size: CGSize(width: 40, height: 40), in: context.cgContext)
   227→            }
   228→            
   229→            // 绘制信息文本
   230→            let infoText = formatInfoText(captureSettings: captureSettings, locationInfo: locationInfo, settings: settings)
   231→            drawText(infoText, at: CGPoint(x: infoBackgroundWidth * 0.15, y: height - infoBackgroundHeight * 0.3), alignment: .left, color: .white, fontSize: width * 0.025, in: context.cgContext)
   232→        }
   233→    }
   234→    
   235→    // 底部信息条相框
   236→    private func applyBottomInfoBarFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   237→        // 计算新的图像尺寸（增加底部区域）
   238→        let originalWidth = image.size.width
   239→        let originalHeight = image.size.height
   240→        let bottomBarHeight = originalHeight * 0.15
   241→        let newSize = CGSize(width: originalWidth, height: originalHeight + bottomBarHeight)
   242→        
   243→        let renderer = UIGraphicsImageRenderer(size: newSize)
   244→        
   245→        return renderer.image { context in
   246→            // 绘制原始图像
   247→            image.draw(at: CGPoint.zero)
   248→            
   249→            // 绘制底部区域
   250→            let bottomRect = CGRect(x: 0, y: originalHeight, width: originalWidth, height: bottomBarHeight)
   251→            context.cgContext.setFillColor(settings.borderColor.cgColor)
   252→            context.cgContext.fill(bottomRect)
   253→            
   254→            // 绘制自定义文本（如果有）
   255→            let textY = originalHeight + bottomBarHeight * 0.3
   256→            if !settings.customText.isEmpty {
   257→                drawText(settings.customText, at: CGPoint(x: originalWidth * 0.05, y: textY), alignment: .left, color: .black, fontSize: originalWidth * 0.035, in: context.cgContext)
   258→            } else {
   259→                drawText("PHOTO BY", at: CGPoint(x: originalWidth * 0.05, y: textY), alignment: .left, color: .black, fontSize: originalWidth * 0.035, in: context.cgContext)
   260→            }
   261→            
   262→            // 绘制参数信息
   263→            if settings.displayContent.showParameters {
   264→                let parametersText = formatParametersText(captureSettings: captureSettings)
   265→                drawText(parametersText, at: CGPoint(x: originalWidth * 0.05, y: originalHeight + bottomBarHeight * 0.7), alignment: .left, color: .black, fontSize: originalWidth * 0.025, in: context.cgContext)
   266→            }
   267→            
   268→            // 绘制Logo（如果有）
   269→            if settings.logoIndex > 0 {
   270→                drawLogo(at: CGPoint(x: originalWidth * 0.9, y: originalHeight + bottomBarHeight * 0.5), size: CGSize(width: 50, height: 50), in: context.cgContext)
   271→            }
   272→        }
   273→    }
   274→    
   275→    // 杂志侧栏相框
   276→    private func applyMagazineSidebarFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   277→        // 计算新的图像尺寸（增加侧边栏）
   278→        let originalWidth = image.size.width
   279→        let originalHeight = image.size.height
   280→        let sidebarWidth = originalWidth * 0.25
   281→        let newSize = CGSize(width: originalWidth + sidebarWidth, height: originalHeight)
   282→        
   283→        let renderer = UIGraphicsImageRenderer(size: newSize)
   284→        
   285→        return renderer.image { context in
   286→            // 绘制侧边栏背景
   287→            let sidebarRect = CGRect(x: 0, y: 0, width: sidebarWidth, height: originalHeight)
   288→            context.cgContext.setFillColor(settings.borderColor.cgColor)
   289→            context.cgContext.fill(sidebarRect)
   290→            
   291→            // 绘制原始图像
   292→            image.draw(at: CGPoint(x: sidebarWidth, y: 0))
   293→            
   294→            // 绘制Logo（如果有）
   295→            if settings.logoIndex > 0 {
   296→                let logoX: CGFloat
   297→                switch settings.contentAlignment {
   298→                case .left: logoX = sidebarWidth * 0.2
   299→                case .center: logoX = sidebarWidth * 0.5
   300→                case .right: logoX = sidebarWidth * 0.8
   301→                case .distributed: logoX = sidebarWidth * 0.5
   302→                }
   303→                
   304→                drawLogo(at: CGPoint(x: logoX, y: originalHeight * 0.1), size: CGSize(width: 50, height: 50), in: context.cgContext)
   305→            }
   306→            
   307→            // 绘制自定义文本（如果有）
   308→            let textY = originalHeight * 0.2
   309→            if !settings.customText.isEmpty {
   310→                let textX: CGFloat
   311→                switch settings.contentAlignment {
   312→                case .left: textX = sidebarWidth * 0.2
   313→                case .center: textX = sidebarWidth * 0.5
   314→                case .right: textX = sidebarWidth * 0.8
   315→                case .distributed: textX = sidebarWidth * 0.5
   316→                }
   317→                
   318→                drawText(settings.customText, at: CGPoint(x: textX, y: textY), alignment: settings.contentAlignment, color: .black, fontSize: sidebarWidth * 0.15, in: context.cgContext)
   319→            }
   320→            
   321→            // 绘制信息文本
   322→            let infoTextY = originalHeight * 0.4
   323→            let infoText = formatInfoText(captureSettings: captureSettings, locationInfo: locationInfo, settings: settings)
   324→            let infoTextX: CGFloat
   325→            switch settings.contentAlignment {
   326→            case .left: infoTextX = sidebarWidth * 0.2
   327→            case .center: infoTextX = sidebarWidth * 0.5
   328→            case .right: infoTextX = sidebarWidth * 0.8
   329→            case .distributed: infoTextX = sidebarWidth * 0.5
   330→            }
   331→            
   332→            drawText(infoText, at: CGPoint(x: infoTextX, y: infoTextY), alignment: settings.contentAlignment, color: .black, fontSize: sidebarWidth * 0.1, in: context.cgContext, multiline: true, maxWidth: sidebarWidth * 0.8)
   333→        }
   334→    }
   335→    
   336→    // 绘制Logo
   337→    private func drawLogo(at point: CGPoint, size: CGSize, in context: CGContext) {
   338→        // 根据logoIndex加载不同的Logo图像
   339→        let logoNames = [
   340→            "Apple_logo_black", 
   341→            "Canon_wordmark", 
   342→            "Nikon_Logo", 
   343→            "Sony_logo", 
   344→            "Fujifilm_logo", 
   345→            "Leica_Camera_logo", 
   346→            "Hasselblad_logo", 
   347→            "Olympus_Corporation_logo", 
   348→            "Panasonic_logo_(Blue)", 
   349→            "Polaroid_logo", 
   350→            "Ricoh_logo_2012", 
   351→            "Zeiss_logo", 
   352→            "Eastman_Kodak_Company_logo_(2016)(no_background)", 
   353→            "Arri_logo", 
   354→            "Panavision_logo", 
   355→            "dji-1"
   356→        ]
   357→        let settings = FrameSettings.load()
   358→        
   359→        if settings.logoIndex > 0 && settings.logoIndex <= logoNames.count {
   360→            let logoName = logoNames[settings.logoIndex - 1]
   361→            if let logoImage = UIImage(named: logoName) {
   362→                // 计算宽高比
   363→                let aspectRatio = logoImage.size.width / logoImage.size.height
   364→                
   365→                // 固定高度，等比例调整宽度
   366→                let fixedHeight = size.height
   367→                let adjustedWidth = fixedHeight * aspectRatio
   368→                
   369→                // 计算绘制区域
   370→                let logoRect = CGRect(
   371→                    x: point.x - adjustedWidth/2, 
   372→                    y: point.y - fixedHeight/2, 
   373→                    width: adjustedWidth, 
   374→                    height: fixedHeight
   375→                )
   376→                
   377→                // 绘制logo图像，保持原始宽高比
   378→                logoImage.draw(in: logoRect)
   379→                
   380→                // 调试信息
   381→                print("🖼️ 绘制Logo: \(logoName)")
   382→                print("  - 原始尺寸: \(logoImage.size.width) x \(logoImage.size.height)")
   383→                print("  - 调整后尺寸: \(adjustedWidth) x \(fixedHeight)")
   384→            } else {
   385→                // 如果找不到图像，绘制一个灰色圆形作为占位符
   386→                context.setFillColor(UIColor.gray.cgColor)
   387→                let logoRect = CGRect(x: point.x - size.width/2, y: point.y - size.height/2, width: size.width, height: size.height)
   388→                context.fillEllipse(in: logoRect)
   389→                print("⚠️ 找不到Logo图像: \(logoName)")
   390→            }
   391→        }
   392→    }
   393→    
   394→    // 绘制文本
   395→    private func drawText(_ text: String, at point: CGPoint, alignment: ContentAlignment, color: UIColor, fontSize: CGFloat, in context: CGContext, multiline: Bool = false, maxWidth: CGFloat = 0) {
   396→        let font = UIFont.systemFont(ofSize: fontSize)
   397→        let textAttributes: [NSAttributedString.Key: Any] = [
   398→            .font: font,
   399→            .foregroundColor: color
   400→        ]
   401→        
   402→        if multiline && maxWidth > 0 {
   403→            let attributedText = NSAttributedString(string: text, attributes: textAttributes)
   404→            let textRect = CGRect(x: point.x - maxWidth/2, y: point.y - fontSize/2, width: maxWidth, height: fontSize * 5) // 允许5行文本
   405→            attributedText.draw(in: textRect)
   406→        } else {
   407→            let textSize = text.size(withAttributes: textAttributes)
   408→            var xPosition: CGFloat
   409→            
   410→            switch alignment {
   411→            case .left:
   412→                xPosition = point.x
   413→            case .center:
   414→                xPosition = point.x - textSize.width / 2
   415→            case .right:
   416→                xPosition = point.x - textSize.width
   417→            case .distributed:
   418→                // 分散对齐在单行文本中等同于居中
   419→                xPosition = point.x - textSize.width / 2
   420→            }
   421→            
   422→            let yPosition = point.y - textSize.height / 2
   423→            let textRect = CGRect(x: xPosition, y: yPosition, width: textSize.width, height: textSize.height)
   424→            text.draw(in: textRect, withAttributes: textAttributes)
   425→        }
   426→    }
   427→    
   428→    // 格式化参数文本
   429→    private func formatParametersText(captureSettings: CameraCaptureSettings) -> String {
   430→        let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   431→        let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   432→        let iso = String(format: "ISO%.0f", captureSettings.iso)
   433→        
   434→        return "\(focalLength) \(shutterSpeed) \(iso)"
   435→    }
   436→    
   437→    // 格式化日期文本
   438→    private func formatDateText() -> String {
   439→        let dateFormatter = DateFormatter()
   440→        dateFormatter.dateFormat = "yyyy.MM.dd"
   441→        return dateFormatter.string(from: Date())
   442→    }
   443→    
   444→    // 格式化信息文本
   445→    private func formatInfoText(captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> String {
   446→        var components: [String] = []
   447→        
   448→        if settings.displayContent.showParameters {
   449→            components.append(formatParametersText(captureSettings: captureSettings))
   450→        }
   451→        
   452→        if settings.displayContent.showLocation, let location = locationInfo {
   453→            components.append(location)
   454→        }
   455→        
   456→        if settings.displayContent.showDate {
   457→            components.append(formatDateText())
   458→        }
   459→        
   460→        return components.joined(separator: " | ")
   461→    }
   462→    
   463→    // 格式化快门速度
   464→    private func formatShutterSpeed(_ speed: Double) -> String {
   465→        if speed >= 1.0 {
   466→            return String(format: "%.0fs", speed)
   467→        } else {
   468→            let denominator = Int(1.0 / speed)
   469→            return "1/\(denominator)s"
   470→        }
   471→    }
   472→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/FrameSettingsView.swift`

Result:

```
1→import SwiftUI
     2→
     3→struct FrameSettingsView: View {
     4→    @State private var settings = FrameSettings.load()
     5→    @Environment(\.presentationMode) var presentationMode
     6→    
     7→    // 示例Logo图片名称数组
     8→    private let logoImages = [
     9→        "Apple_logo_black", 
    10→        "Canon_wordmark", 
    11→        "Nikon_Logo", 
    12→        "Sony_logo", 
    13→        "Fujifilm_logo", 
    14→        "Leica_Camera_logo", 
    15→        "Hasselblad_logo", 
    16→        "Olympus_Corporation_logo", 
    17→        "Panasonic_logo_(Blue)", 
    18→        "Polaroid_logo", 
    19→        "Ricoh_logo_2012", 
    20→        "Zeiss_logo", 
    21→        "Eastman_Kodak_Company_logo_(2016)(no_background)", 
    22→        "Arri_logo", 
    23→        "Panavision_logo", 
    24→        "dji-1"
    25→    ]
    26→    
    27→    var body: some View {
    28→        NavigationView {
    29→            Form {
    30→                // 拆分为多个子视图
    31→                FrameEnableSection(settings: $settings)
    32→                FrameLayoutSection(settings: $settings, logoImages: logoImages)
    33→                FrameContentSection(settings: $settings)
    34→                FramePreviewSection(settings: settings)
    35→            }
    36→            .navigationTitle("相框设置")
    37→            .navigationBarItems(
    38→                leading: Button("取消") {
    39→                    presentationMode.wrappedValue.dismiss()
    40→                },
    41→                trailing: Button("保存") {
    42→                    settings.save()
    43→                    presentationMode.wrappedValue.dismiss()
    44→                }
    45→            )
    46→        }
    47→    }
    48→}
    49→
    50→// 启用相框部分
    51→struct FrameEnableSection: View {
    52→    @Binding var settings: FrameSettings
    53→    
    54→    var body: some View {
    55→        Section(header: Text("相框设置")) {
    56→            Toggle("启用相框水印", isOn: $settings.isEnabled)
    57→        }
    58→    }
    59→}
    60→
    61→// 布局和Logo部分
    62→struct FrameLayoutSection: View {
    63→    @Binding var settings: FrameSettings
    64→    let logoImages: [String]
    65→    
    66→    var body: some View {
    67→        Group {
    68→            Section(header: Text("边框布局")) {
    69→                ScrollView(.horizontal, showsIndicators: false) {
    70→                    HStack(spacing: 12) {
    71→                        ForEach(FrameLayoutType.allCases, id: \.self) { layoutType in
    72→                            FrameLayoutButton(
    73→                                layoutType: layoutType,
    74→                                isSelected: settings.frameLayout == layoutType,
    75→                                action: {
    76→                                    settings.frameLayout = layoutType
    77→                                }
    78→                            )
    79→                        }
    80→                    }
    81→                    .padding(.vertical, 8)
    82→                }
    83→                .listRowInsets(EdgeInsets())
    84→            }
    85→            
    86→            Section(header: Text("品牌 Logo")) {
    87→                ScrollView(.horizontal, showsIndicators: false) {
    88→                    HStack(spacing: 12) {
    89→                        ForEach(0..<logoImages.count, id: \.self) { index in
    90→                            LogoButton(
    91→                                imageName: logoImages[index],
    92→                                isSelected: settings.logoIndex == index,
    93→                                action: {
    94→                                    settings.logoIndex = index
    95→                                }
    96→                            )
    97→                        }
    98→                    }
    99→                    .padding(.vertical, 8)
   100→                }
   101→                .listRowInsets(EdgeInsets())
   102→            }
   103→            
   104→            Section(header: Text("内容对齐")) {
   105→                ScrollView(.horizontal, showsIndicators: false) {
   106→                    HStack(spacing: 12) {
   107→                        ForEach(ContentAlignment.allCases, id: \.self) { alignment in
   108→                            ContentAlignmentButton(
   109→                                alignment: alignment,
   110→                                isSelected: settings.contentAlignment == alignment,
   111→                                action: {
   112→                                    settings.contentAlignment = alignment
   113→                                }
   114→                            )
   115→                        }
   116→                    }
   117→                    .padding(.vertical, 8)
   118→                }
   119→                .listRowInsets(EdgeInsets())
   120→            }
   121→        }
   122→    }
   123→}
   124→
   125→// 内容设置部分
   126→struct FrameContentSection: View {
   127→    @Binding var settings: FrameSettings
   128→    
   129→    var body: some View {
   130→        Group {
   131→            Section(header: Text("显示内容")) {
   132→                Toggle("相机参数", isOn: $settings.displayContent.showParameters)
   133→                Toggle("位置信息", isOn: $settings.displayContent.showLocation)
   134→                Toggle("拍摄日期", isOn: $settings.displayContent.showDate)
   135→            }
   136→            
   137→            Section(header: Text("自定义文本")) {
   138→                TextField("输入您的故事...", text: $settings.customText)
   139→                    .frame(height: 80)
   140→                    .multilineTextAlignment(.leading)
   141→            }
   142→            
   143→            Section(header: Text("边框颜色")) {
   144→                ColorPicker("选择颜色", selection: Binding<Color>(
   145→                    get: { Color(settings.borderColor) },
   146→                    set: { newColor in
   147→                        settings.borderColor = UIColor(newColor)
   148→                    }
   149→                ))
   150→            }
   151→        }
   152→    }
   153→}
   154→
   155→// 预览部分
   156→struct FramePreviewSection: View {
   157→    let settings: FrameSettings
   158→    
   159→    var body: some View {
   160→        Section(header: Text("预览效果")) {
   161→            FramePreview(settings: settings)
   162→                .frame(height: 200)
   163→                .background(Color.black)
   164→                .cornerRadius(8)
   165→        }
   166→    }
   167→}
   168→
   169→// 边框布局按钮
   170→struct FrameLayoutButton: View {
   171→    let layoutType: FrameLayoutType
   172→    let isSelected: Bool
   173→    let action: () -> Void
   174→    
   175→    var body: some View {
   176→        Button(action: action) {
   177→            VStack {
   178→                ZStack {
   179→                    RoundedRectangle(cornerRadius: 8)
   180→                        .fill(Color.gray.opacity(0.2))
   181→                        .frame(width: 60, height: 60)
   182→                    
   183→                    // 这里可以根据不同的布局类型显示不同的图标或预览
   184→                    Image(systemName: layoutIcon)
   185→                        .font(.system(size: 24))
   186→                }
   187→                .overlay(
   188→                    RoundedRectangle(cornerRadius: 8)
   189→                        .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 2)
   190→                )
   191→                
   192→                Text(layoutType.rawValue)
   193→                    .font(.caption)
   194→                    .foregroundColor(isSelected ? .orange : .primary)
   195→            }
   196→        }
   197→    }
   198→    
   199→    // 根据布局类型返回对应的图标
   200→    private var layoutIcon: String {
   201→        switch layoutType {
   202→        case .centerFloat: return "rectangle.center.inset.filled"
   203→        case .bottomSymmetric: return "rectangle.bottomthird.inset.filled"
   204→        case .polaroid: return "rectangle.inset.bottomleading.filled"
   205→        case .bottomLeft: return "rectangle.bottomleft.inset.filled"
   206→        case .bottomInfoBar: return "rectangle.bottomthird.inset.filled"
   207→        case .magazineSidebar: return "rectangle.leadinghalf.inset.filled"
   208→        }
   209→    }
   210→}
   211→
   212→// Logo按钮
   213→struct LogoButton: View {
   214→    let imageName: String
   215→    let isSelected: Bool
   216→    let action: () -> Void
   217→    
   218→    var body: some View {
   219→        Button(action: action) {
   220→            Image(imageName)
   221→                .resizable()
   222→                .scaledToFit()
   223→                .frame(width: 50, height: 50)
   224→                .background(Color.gray.opacity(0.2))
   225→                .clipShape(Circle())
   226→                .overlay(
   227→                    Circle()
   228→                        .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 2)
   229→                )
   230→        }
   231→    }
   232→}
   233→
   234→// 内容对齐按钮
   235→struct ContentAlignmentButton: View {
   236→    let alignment: ContentAlignment
   237→    let isSelected: Bool
   238→    let action: () -> Void
   239→    
   240→    var body: some View {
   241→        Button(action: action) {
   242→            VStack {
   243→                ZStack {
   244→                    RoundedRectangle(cornerRadius: 8)
   245→                        .fill(Color.gray.opacity(0.2))
   246→                        .frame(width: 60, height: 40)
   247→                    
   248→                    // 根据对齐方式显示不同的图标
   249→                    Image(systemName: alignmentIcon)
   250→                        .font(.system(size: 18))
   251→                }
   252→                .overlay(
   253→                    RoundedRectangle(cornerRadius: 8)
   254→                        .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 2)
   255→                )
   256→                
   257→                Text(alignment.rawValue)
   258→                    .font(.caption)
   259→                    .foregroundColor(isSelected ? .orange : .primary)
   260→            }
   261→        }
   262→    }
   263→    
   264→    // 根据对齐方式返回对应的图标
   265→    private var alignmentIcon: String {
   266→        switch alignment {
   267→        case .left: return "text.align.left"
   268→        case .center: return "text.align.center"
   269→        case .right: return "text.align.right"
   270→        case .distributed: return "text.justify"
   271→        }
   272→    }
   273→}
   274→
   275→// 相框预览
   276→struct FramePreview: View {
   277→    let settings: FrameSettings
   278→    
   279→    var body: some View {
   280→        GeometryReader { geometry in
   281→            ZStack {
   282→                // 根据不同的布局类型显示不同的预览
   283→                switch settings.frameLayout {
   284→                case .centerFloat:
   285→                    centerFloatPreview(geometry: geometry)
   286→                case .bottomSymmetric:
   287→                    bottomSymmetricPreview(geometry: geometry)
   288→                case .polaroid:
   289→                    polaroidPreview(geometry: geometry)
   290→                case .bottomLeft:
   291→                    bottomLeftPreview(geometry: geometry)
   292→                case .bottomInfoBar:
   293→                    bottomInfoBarPreview(geometry: geometry)
   294→                case .magazineSidebar:
   295→                    magazineSidebarPreview(geometry: geometry)
   296→                }
   297→            }
   298→        }
   299→    }
   300→    
   301→    // 居中悬浮预览
   302→    private func centerFloatPreview(geometry: GeometryProxy) -> some View {
   303→        ZStack {
   304→            Color.gray.opacity(0.5) // 照片占位符
   305→            
   306→            VStack {
   307→                if settings.logoIndex > 0 {
   308→                    Circle()
   309→                        .fill(Color.white.opacity(0.8))
   310→                        .frame(width: 30, height: 30)
   311→                }
   312→                
   313→                Text(previewText)
   314→                    .font(.caption)
   315→                    .foregroundColor(.white)
   316→                    .padding(6)
   317→                    .background(Color.black.opacity(0.6))
   318→                    .cornerRadius(4)
   319→            }
   320→        }
   321→    }
   322→    
   323→    // 底部对称预览
   324→    private func bottomSymmetricPreview(geometry: GeometryProxy) -> some View {
   325→        VStack(spacing: 0) {
   326→            Color.gray.opacity(0.5) // 照片占位符
   327→                .frame(height: geometry.size.height * 0.8)
   328→            
   329→            HStack {
   330→                if settings.displayContent.showParameters {
   331→                    Text("24mm 1/60s ISO100")
   332→                        .font(.caption)
   333→                        .foregroundColor(.black)
   334→                }
   335→                
   336→                Spacer()
   337→                
   338→                if settings.logoIndex > 0 {
   339→                    Circle()
   340→                        .fill(Color.gray)
   341→                        .frame(width: 20, height: 20)
   342→                }
   343→                
   344→                Spacer()
   345→                
   346→                if settings.displayContent.showDate {
   347→                    Text("2024.12.19")
   348→                        .font(.caption)
   349→                        .foregroundColor(.black)
   350→                }
   351→            }
   352→            .padding(.horizontal, 10)
   353→            .padding(.vertical, 8)
   354→            .frame(height: geometry.size.height * 0.2)
   355→            .background(Color(settings.borderColor))
   356→        }
   357→    }
   358→    
   359→    // 宝丽来预览
   360→    private func polaroidPreview(geometry: GeometryProxy) -> some View {
   361→        ZStack {
   362→            Color(settings.borderColor) // 边框颜色
   363→            
   364→            VStack(spacing: 0) {
   365→                Color.gray.opacity(0.5) // 照片占位符
   366→                    .frame(height: geometry.size.height * 0.7)
   367→                    .padding(.horizontal, 10)
   368→                    .padding(.top, 10)
   369→                
   370→                VStack(alignment: contentAlignment) {
   371→                    if settings.logoIndex > 0 {
   372→                        Circle()
   373→                            .fill(Color.gray)
   374→                            .frame(width: 20, height: 20)
   375→                    }
   376→                    
   377→                    if !settings.customText.isEmpty {
   378→                        Text(settings.customText)
   379→                            .font(.caption)
   380→                            .foregroundColor(.black)
   381→                    } else {
   382→                        Text(previewText)
   383→                            .font(.caption)
   384→                            .foregroundColor(.black)
   385→                    }
   386→                }
   387→                .padding()
   388→                .frame(maxWidth: .infinity, alignment: .leading)
   389→            }
   390→        }
   391→    }
   392→    
   393→    // 左下角预览
   394→    private func bottomLeftPreview(geometry: GeometryProxy) -> some View {
   395→        ZStack {
   396→            Color.gray.opacity(0.5) // 照片占位符
   397→            
   398→            VStack {
   399→                Spacer()
   400→                
   401→                HStack {
   402→                    VStack(alignment: .leading) {
   403→                        if settings.logoIndex > 0 {
   404→                            Circle()
   405→                                .fill(Color.white.opacity(0.8))
   406→                                .frame(width: 20, height: 20)
   407→                        }
   408→                        
   409→                        Text(previewText)
   410→                            .font(.caption)
   411→                            .foregroundColor(.white)
   412→                    }
   413→                    
   414→                    Spacer()
   415→                }
   416→                .padding()
   417→                .background(Color.black.opacity(0.6))
   418→            }
   419→        }
   420→    }
   421→    
   422→    // 底部信息条预览
   423→    private func bottomInfoBarPreview(geometry: GeometryProxy) -> some View {
   424→        VStack(spacing: 0) {
   425→            Color.gray.opacity(0.5) // 照片占位符
   426→                .frame(height: geometry.size.height * 0.8)
   427→            
   428→            HStack {
   429→                VStack(alignment: .leading) {
   430→                    if !settings.customText.isEmpty {
   431→                        Text(settings.customText)
   432→                            .font(.caption)
   433→                            .foregroundColor(.black)
   434→                    } else {
   435→                        Text("PHOTO BY")
   436→                            .font(.caption)
   437→                            .foregroundColor(.black)
   438→                    }
   439→                    
   440→                    if settings.displayContent.showParameters {
   441→                        Text("24mm 1/60s ISO100")
   442→                            .font(.caption2)
   443→                            .foregroundColor(.black)
   444→                    }
   445→                }
   446→                
   447→                Spacer()
   448→                
   449→                if settings.logoIndex > 0 {
   450→                    Circle()
   451→                        .fill(Color.gray)
   452→                        .frame(width: 20, height: 20)
   453→                }
   454→            }
   455→            .padding(.horizontal, 10)
   456→            .padding(.vertical, 8)
   457→            .frame(height: geometry.size.height * 0.2)
   458→            .background(Color(settings.borderColor))
   459→        }
   460→    }
   461→    
   462→    // 杂志侧栏预览
   463→    private func magazineSidebarPreview(geometry: GeometryProxy) -> some View {
   464→        HStack(spacing: 0) {
   465→            VStack(alignment: contentAlignment) {
   466→                if settings.logoIndex > 0 {
   467→                    Circle()
   468→                        .fill(Color.gray)
   469→                        .frame(width: 20, height: 20)
   470→                }
   471→                
   472→                if !settings.customText.isEmpty {
   473→                    Text(settings.customText)
   474→                        .font(.caption)
   475→                        .foregroundColor(.black)
   476→                } else {
   477→                    Text(previewText)
   478→                        .font(.caption)
   479→                        .foregroundColor(.black)
   480→                }
   481→                
   482→                Spacer()
   483→            }
   484→            .padding()
   485→            .frame(width: geometry.size.width * 0.3)
   486→            .background(Color(settings.borderColor))
   487→            
   488→            Color.gray.opacity(0.5) // 照片占位符
   489→                .frame(width: geometry.size.width * 0.7)
   490→        }
   491→    }
   492→    
   493→    // 根据内容对齐方式返回对应的SwiftUI对齐方式
   494→    private var contentAlignment: HorizontalAlignment {
   495→        switch settings.contentAlignment {
   496→        case .left: return .leading
   497→        case .center: return .center
   498→        case .right: return .trailing
   499→        case .distributed: return .center // SwiftUI没有分散对齐，使用居中代替
   500→        }
   501→    }
   502→    
   503→    // 预览文本
   504→    private var previewText: String {
   505→        var components: [String] = []
   506→        
   507→        if settings.displayContent.showParameters {
   508→            components.append("24mm 1/60s ISO100")
   509→        }
   510→        
   511→        if settings.displayContent.showLocation {
   512→            components.append("北京市")
   513→        }
   514→        
   515→        if settings.displayContent.showDate {
   516→            components.append("2024.12.19")
   517→        }
   518→        
   519→        return components.joined(separator: " | ")
   520→    }
   521→}
   522→
   523→struct FrameSettingsView_Previews: PreviewProvider {
   524→    static var previews: some View {
   525→        FrameSettingsView()
   526→    }
   527→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkSettings.swift`

Result:

```
1→import Foundation
     2→
     3→struct WatermarkSettings: Codable {
     4→    var isEnabled: Bool = false
     5→    var authorName: String = ""
     6→    var showDeviceModel: Bool = true
     7→    var showFocalLength: Bool = true
     8→    var showShutterSpeed: Bool = true
     9→    var showISO: Bool = true
    10→    var showDate: Bool = true
    11→    
    12→    static let shared = WatermarkSettings()
    13→    
    14→    func save() {
    15→        if let data = try? JSONEncoder().encode(self) {
    16→            UserDefaults.standard.set(data, forKey: "WatermarkSettings")
    17→        }
    18→    }
    19→    
    20→    static func load() -> WatermarkSettings {
    21→        guard let data = UserDefaults.standard.data(forKey: "WatermarkSettings"),
    22→              let settings = try? JSONDecoder().decode(WatermarkSettings.self, from: data) else {
    23→            return WatermarkSettings()
    24→        }
    25→        return settings
    26→    }
    27→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Camera/CameraViewModel.swift`

Result:

```
1→import SwiftUI
     2→import AVFoundation
     3→import Combine
     4→
     5→class CameraViewModel: ObservableObject {
     6→    @Published var isAuthorized = false
     7→    @Published var showingAlert = false
     8→    @Published var alertMessage = ""
     9→    @Published var capturedImage: UIImage?
    10→    @Published var isCapturing = false
    11→    @Published var currentLensIndex = 0
    12→    @Published var exposureValue: Float = 0.0
    13→    @Published var showingExposureSlider = false
    14→    @Published var focusPoint: CGPoint = .zero
    15→    @Published var isGridVisible = false
    16→    
    17→    // 🚀 新增：后台处理状态指示器
    18→    @Published var isProcessingInBackground = false
    19→    @Published var backgroundProcessingCount = 0
    20→    
    21→    // 添加设置监听
    22→    private var cancellables = Set<AnyCancellable>()
    23→    
    24→    // 监听设置变化
    25→    @Published var currentPhotoFormat: PhotoFormat = .heic
    26→    @Published var currentPhotoResolution: PhotoResolution = .resolution12MP
    27→    @Published var is48MPAvailable = false
    28→    
    29→    // 添加手动相机控制
    30→    @Published var manualSettings = CameraManualSettings()
    31→    @Published var isManualControlsVisible = false
    32→    
    33→    // 画面比例设置
    34→    @Published var selectedAspectRatio: AspectRatio = .default
    35→    @Published var showingAspectRatioSelection = false
    36→    
    37→    // 🔦 闪光灯控制
    38→    @Published var flashController = FlashController()
    39→    
    40→    private let cameraService = CameraService()
    41→    
    42→    var session: AVCaptureSession {
    43→        cameraService.session
    44→    }
    45→    
    46→    var availableLenses: [String] {
    47→        let devices = cameraService.availableCameras
    48→        return devices.map { device in
    49→            switch device.deviceType {
    50→            case .builtInUltraWideCamera:
    51→                return "0.5×"
    52→            case .builtInWideAngleCamera:
    53→                return "1×"
    54→            case .builtInTelephotoCamera:
    55→                return "3×"
    56→            case .builtInTripleCamera:
    57→                return "1×"
    58→            case .builtInDualCamera:
    59→                return "2×"
    60→            case .builtInDualWideCamera:
    61→                return "1×"
    62→            default:
    63→                return "1×"
    64→            }
    65→        }
    66→    }
    67→    
    68→    init() {
    69→        print("🎯 CameraViewModel 初始化")
    70→        loadSettings()
    71→        
    72→        // 立即设置为已授权，先显示UI
    73→        isAuthorized = true
    74→        
    75→        // 设置默认选中1x镜头（索引为1）
    76→        currentLensIndex = 1
    77→        
    78→        // 监听手动设置变化通知
    79→        NotificationCenter.default.addObserver(
    80→            self,
    81→            selector: #selector(handleManualSettingChanged(_:)),
    82→            name: NSNotification.Name("ManualSettingChanged"),
    83→            object: nil
    84→        )
    85→        
    86→        // 异步检查权限，避免阻塞UI
    87→        DispatchQueue.global(qos: .userInitiated).async { [weak self] in
    88→            self?.checkCameraPermission()
    89→        }
    90→    }
    91→    
    92→    @objc private func handleManualSettingChanged(_ notification: Notification) {
    93→        print("📱 收到手动设置变化通知")
    94→        if let type = notification.userInfo?["type"] as? CameraManualSettingType,
    95→           let value = notification.userInfo?["value"] as? Float {
    96→            print("📱 设置类型: \(type.rawValue), 值: \(value)")
    97→            applyManualSettings()
    98→        }
    99→    }
   100→    
   101→    private func loadSettings() {
   102→        isGridVisible = UserDefaults.standard.bool(forKey: "grid_overlay_enabled")
   103→        
   104→        // 读取照片格式设置
   105→        if let formatString = UserDefaults.standard.string(forKey: "photo_format"),
   106→           let format = PhotoFormat(rawValue: formatString) {
   107→            currentPhotoFormat = format
   108→        }
   109→        
   110→        // 读取分辨率设置
   111→        if let resolutionString = UserDefaults.standard.string(forKey: "photo_resolution"),
   112→           let resolution = PhotoResolution(rawValue: resolutionString) {
   113→            currentPhotoResolution = resolution
   114→        }
   115→        
   116→        // 读取画面比例设置
   117→        if let aspectRatioString = UserDefaults.standard.string(forKey: "selected_aspect_ratio"),
   118→           let aspectRatio = AspectRatio(rawValue: aspectRatioString) {
   119→            selectedAspectRatio = aspectRatio
   120→        }
   121→        
   122→        // 更新相机服务设置
   123→        cameraService.updatePhotoSettings(format: currentPhotoFormat, resolution: currentPhotoResolution)
   124→        
   125→        // 监听设置变化
   126→        setupSettingsObservers()
   127→        
   128→        // 监听相机切换通知
   129→        setupCameraSwitchNotifications()
   130→    }
   131→    
   132→    private func setupSettingsObservers() {
   133→        // 监听照片格式变化
   134→        UserDefaults.standard.publisher(for: \.photo_format)
   135→            .compactMap { PhotoFormat(rawValue: $0 ?? "") }
   136→            .sink { [weak self] format in
   137→                self?.currentPhotoFormat = format
   138→                self?.updateCameraSettings()
   139→            }
   140→            .store(in: &cancellables)
   141→        
   142→        // 监听分辨率变化
   143→        UserDefaults.standard.publisher(for: \.photo_resolution)
   144→            .compactMap { PhotoResolution(rawValue: $0 ?? "") }
   145→            .sink { [weak self] resolution in
   146→                self?.currentPhotoResolution = resolution
   147→                self?.updateCameraSettings()
   148→            }
   149→            .store(in: &cancellables)
   150→    }
   151→    
   152→    private func updateCameraSettings() {
   153→        cameraService.updatePhotoSettings(format: currentPhotoFormat, resolution: currentPhotoResolution)
   154→    }
   155→    
   156→    private func setupCameraSwitchNotifications() {
   157→        NotificationCenter.default.publisher(for: NSNotification.Name("CameraSwitchRequires12MP"))
   158→            .sink { [weak self] _ in
   159→                DispatchQueue.main.async {
   160→                    // 自动切换回12MP并提醒用户
   161→                    self?.currentPhotoResolution = .resolution12MP
   162→                    UserDefaults.standard.set("12MP", forKey: "photo_resolution")
   163→                    self?.updateCameraSettings()
   164→                    self?.showAlert(message: "已切换到12MP，当前镜头不支持48MP")
   165→                }
   166→            }
   167→            .store(in: &cancellables)
   168→    }
   169→    
   170→    private func checkCameraPermission() {
   171→        print("🔐 检查相机权限...")
   172→        let status = AVCaptureDevice.authorizationStatus(for: .video)
   173→        
   174→        DispatchQueue.main.async { [weak self] in
   175→            switch status {
   176→            case .authorized:
   177→                print("✅ 相机权限已授权")
   178→                self?.isAuthorized = true
   179→                // 异步启动相机
   180→                DispatchQueue.global(qos: .userInitiated).async {
   181→                    self?.cameraService.startSession()
   182→                }
   183→            case .notDetermined:
   184→                print("❓ 相机权限未确定，请求权限")
   185→                self?.requestCameraPermission()
   186→            case .denied, .restricted:
   187→                print("❌ 相机权限被拒绝")
   188→                self?.isAuthorized = false
   189→            @unknown default:
   190→                print("❓ 未知相机权限状态")
   191→                self?.isAuthorized = false
   192→            }
   193→        }
   194→    }
   195→    
   196→    func requestCameraPermission() {
   197→        cameraService.requestPermissions { [weak self] authorized in
   198→            DispatchQueue.main.async {
   199→                self?.isAuthorized = authorized
   200→                if authorized {
   201→                    self?.cameraService.startSession()
   202→                } else {
   203→                    self?.showAlert(message: "需要相机权限才能使用此功能")
   204→                }
   205→            }
   206→        }
   207→    }
   208→    
   209→    func startCamera() {
   210→        guard isAuthorized else {
   211→            requestCameraPermission()
   212→            return
   213→        }
   214→        cameraService.startSession()
   215→        
   216→        // 启动后更新48MP可用性
   217→        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
   218→            self?.update48MPAvailability()
   219→            // 🔦 初始化闪光灯控制器
   220→            self?.updateFlashController()
   221→            // 检查设备能力
   222→            self?.checkDeviceCapabilities()
   223→        }
   224→    }
   225→    
   226→    func stopCamera() {
   227→        cameraService.stopSession()
   228→    }
   229→    
   230→    func capturePhoto() {
   231→        guard !isCapturing else { return }
   232→        
   233→        isCapturing = true
   234→        
   235→        cameraService.capturePhoto(
   236→            aspectRatio: selectedAspectRatio,
   237→            flashMode: flashController.getPhotoFlashMode()
   238→        ) { [weak self] result in
   239→            DispatchQueue.main.async {
   240→                // 🚀 立即释放拍摄状态，允许连续拍摄
   241→                self?.isCapturing = false
   242→                
   243→                switch result {
   244→                case .success(let imageData):
   245→                    // 直接使用原始图像数据，相框水印处理将在CameraService中进行
   246→                    self?.capturedImage = UIImage(data: imageData)
   247→                    
   248→                    // 🚀 启动后台处理指示
   249→                    self?.startBackgroundProcessing()
   250→                    
   251→                    // 显示快速反馈
   252→                    self?.showTemporaryCaptureFeedback()
   253→                    
   254→                case .failure(let error):
   255→                    self?.showAlert(message: "拍照失败: \(error.localizedDescription)")
   256→                }
   257→            }
   258→        }
   259→    }
   260→    
   261→    // 🚀 新增：后台处理管理
   262→    private func startBackgroundProcessing() {
   263→        backgroundProcessingCount += 1
   264→        isProcessingInBackground = true
   265→        
   266→        print("🚀 开始后台处理，当前处理数量: \(backgroundProcessingCount)")
   267→        
   268→        // 模拟后台处理完成（实际中CameraService会通知完成）
   269→        DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) { [weak self] in
   270→            self?.finishBackgroundProcessing()
   271→        }
   272→    }
   273→    
   274→    private func finishBackgroundProcessing() {
   275→        backgroundProcessingCount = max(0, backgroundProcessingCount - 1)
   276→        isProcessingInBackground = backgroundProcessingCount > 0
   277→        
   278→        print("🚀 完成后台处理，剩余处理数量: \(backgroundProcessingCount)")
   279→    }
   280→    
   281→    private func showTemporaryCaptureFeedback() {
   282→        // 可以触发相机快门动画或短暂的视觉反馈
   283→        print("📸 拍摄成功，正在后台处理水印...")
   284→    }
   285→    
   286→    func switchLens(to index: Int) {
   287→        guard index != currentLensIndex && index < cameraService.availableCameras.count else { return }
   288→        
   289→        currentLensIndex = index
   290→        cameraService.switchCamera(to: index)
   291→        
   292→        // 切换镜头后更新48MP可用性
   293→        update48MPAvailability()
   294→        
   295→        // 🔦 更新闪光灯控制器的当前设备
   296→        updateFlashController()
   297→        
   298→        // 切换镜头时重置手动设置
   299→        manualSettings.resetToDefaults()
   300→        manualSettings.selectedSetting = nil
   301→    }
   302→    
   303→    // 更新48MP可用性状态
   304→    private func update48MPAvailability() {
   305→        DispatchQueue.main.async { [weak self] in
   306→            self?.is48MPAvailable = self?.cameraService.is48MPAvailable ?? false
   307→        }
   308→    }
   309→    
   310→    // 🔦 更新闪光灯控制器
   311→    private func updateFlashController() {
   312→        flashController.updateDevice(cameraService.currentDevice)
   313→    }
   314→    
   315→    func setFocusPoint(_ point: CGPoint) {
   316→        focusPoint = point
   317→        cameraService.setFocusPoint(point)
   318→        
   319→        showingExposureSlider = true
   320→        
   321→        DispatchQueue.main.asyncAfter(deadline: .now() + 3.0) {
   322→            self.showingExposureSlider = false
   323→        }
   324→    }
   325→    
   326→    func lockFocusAndExposure(at point: CGPoint) {
   327→        focusPoint = point
   328→        cameraService.setFocusPoint(point)
   329→        showAlert(message: "已锁定对焦和曝光")
   330→    }
   331→    
   332→    func setExposureCompensation(_ value: Float) {
   333→        exposureValue = value
   334→        cameraService.setExposureCompensation(value)
   335→    }
   336→    
   337→    func toggleGrid() {
   338→        isGridVisible.toggle()
   339→        UserDefaults.standard.set(isGridVisible, forKey: "grid_overlay_enabled")
   340→    }
   341→    
   342→    // 重置所有相机设置为自动模式
   343→    func resetToAutoMode() {
   344→        print("\n📸 重置所有相机设置为自动模式...")
   345→        
   346→        guard let device = cameraService.currentDevice else {
   347→            print("❌ 当前没有可用的相机设备")
   348→            return
   349→        }
   350→        
   351→        do {
   352→            try device.lockForConfiguration()
   353→            print("📸 成功锁定设备配置")
   354→            
   355→            // 重置曝光为自动模式
   356→            if device.isExposureModeSupported(.continuousAutoExposure) {
   357→                device.exposureMode = .continuousAutoExposure
   358→                print("📸 设置为连续自动曝光模式")
   359→                
   360→                // 重置曝光补偿为0
   361→                device.setExposureTargetBias(0.0, completionHandler: { (time) in
   362→                    print("📸 曝光补偿已重置为0")
   363→                })
   364→            }
   365→            
   366→            // 重置对焦为自动模式
   367→            if device.isFocusModeSupported(.continuousAutoFocus) {
   368→                device.focusMode = .continuousAutoFocus
   369→                print("📸 设置为连续自动对焦模式")
   370→            }
   371→            
   372→            // 重置白平衡为自动模式
   373→            if device.isWhiteBalanceModeSupported(.continuousAutoWhiteBalance) {
   374→                device.whiteBalanceMode = .continuousAutoWhiteBalance
   375→                print("📸 设置为连续自动白平衡模式")
   376→            }
   377→            
   378→            device.unlockForConfiguration()
   379→            print("📸 所有设置已重置为自动模式")
   380→            
   381→            // 重置曝光滑块值
   382→            exposureValue = 0.0
   383→            
   384→            // 重置手动设置为默认值
   385→            manualSettings.resetToDefaults()
   386→            manualSettings.selectedSetting = nil
   387→            
   388→        } catch {
   389→            print("❌ 无法配置相机设备: \(error)")
   390→        }
   391→    }
   392→    
   393→    // 应用手动相机设置
   394→    func applyManualSettings() {
   395→        print("\n📸 开始应用手动相机设置...")
   396→        
   397→        guard let device = cameraService.currentDevice else {
   398→            print("❌ 当前没有可用的相机设备")
   399→            return
   400→        }
   401→        
   402→        print("📸 当前设备: \(device.localizedName)")
   403→        print("📸 设备类型: \(device.deviceType.rawValue)")
   404→        print("📸 尝试应用的设置值:")
   405→        print("  - 快门速度: \(manualSettings.getDisplayText(for: .shutterSpeed)) (\(manualSettings.shutterSpeed))")
   406→        print("  - ISO: \(manualSettings.iso)")
   407→        print("  - 曝光补偿: \(manualSettings.exposure)")
   408→        print("  - 对焦: \(manualSettings.focus)")
   409→        print("  - 色温: \(manualSettings.whiteBalance)K")
   410→        print("  - 色调: \(manualSettings.tint)")
   411→        
   412→        do {
   413→            try device.lockForConfiguration()
   414→            print("📸 成功锁定设备配置")
   415→            
   416→            // 检查当前选中的设置类型，只应用相关设置
   417→            if let selectedSetting = manualSettings.selectedSetting {
   418→                print("📸 当前选中设置: \(selectedSetting.rawValue)")
   419→                
   420→                switch selectedSetting {
   421→                case .exposure:
   422→                    // 曝光补偿模式 - 保持自动曝光但应用补偿
   423→                    if device.isExposureModeSupported(.continuousAutoExposure) {
   424→                        print("📸 设置连续自动曝光模式")
   425→                        device.exposureMode = .continuousAutoExposure
   426→                        
   427→                        let exposureValue = manualSettings.exposure
   428→                        let clampedExposure = max(device.minExposureTargetBias, min(exposureValue, device.maxExposureTargetBias))
   429→                        print("📸 应用曝光补偿: \(clampedExposure) (限制在 \(device.minExposureTargetBias) 到 \(device.maxExposureTargetBias))")
   430→                        
   431→                        device.setExposureTargetBias(clampedExposure, completionHandler: { (time) in
   432→                            print("📸 曝光补偿设置完成，时间: \(time.seconds)秒")
   433→                        })
   434→                        
   435→                        // 验证曝光补偿是否生效
   436→                        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
   437→                            print("📸 验证曝光补偿: 当前值=\(device.exposureTargetBias), 目标值=\(clampedExposure)")
   438→                        }
   439→                    }
   440→                    
   441→                case .shutterSpeed, .iso:
   442→                    // 手动曝光模式 - 完全手动控制ISO和快门速度
   443→                    if device.isExposureModeSupported(.custom) {
   444→                        let minISO = device.activeFormat.minISO
   445→                        let maxISO = device.activeFormat.maxISO
   446→                        let isoValue = max(minISO, min(manualSettings.iso, maxISO))
   447→                        
   448→                        let shutterSeconds = shutterSpeedToSeconds(manualSettings.shutterSpeed)
   449→                        let minExposureSeconds = device.activeFormat.minExposureDuration.seconds
   450→                        let maxExposureSeconds = device.activeFormat.maxExposureDuration.seconds
   451→                        let clampedShutterSeconds = max(minExposureSeconds, min(shutterSeconds, maxExposureSeconds))
   452→                        
   453→                        print("📸 设置自定义曝光模式:")
   454→                        print("  - ISO: \(isoValue) (限制在 \(minISO)-\(maxISO))")
   455→                        print("  - 快门速度: \(clampedShutterSeconds)秒 (限制在 \(minExposureSeconds)-\(maxExposureSeconds)秒)")
   456→                        
   457→                        let exposureDuration = CMTime(seconds: clampedShutterSeconds, preferredTimescale: 1000000)
   458→                        
   459→                        device.exposureMode = .custom
   460→                        device.setExposureModeCustom(
   461→                            duration: exposureDuration,
   462→                            iso: isoValue,
   463→                            completionHandler: { (time) in
   464→                                print("📸 自定义曝光设置完成，实际曝光时间: \(time.seconds)秒")
   465→                            }
   466→                        )
   467→                    }
   468→                    
   469→                case .focus:
   470→                    // 对焦设置
   471→                    if device.isFocusModeSupported(.locked) {
   472→                        print("📸 设置对焦模式为锁定")
   473→                        device.focusMode = .locked
   474→                        let focusValue = manualSettings.focus
   475→                        print("📸 对焦值: \(focusValue)")
   476→                        
   477→                        if device.isFocusPointOfInterestSupported {
   478→                            device.focusPointOfInterest = CGPoint(x: 0.5, y: 0.5)
   479→                        }
   480→                    }
   481→                    
   482→                case .whiteBalance, .tint:
   483→                    // 白平衡设置
   484→                    if device.isWhiteBalanceModeSupported(.locked) {
   485→                        print("📸 设置白平衡模式为锁定")
   486→                        device.whiteBalanceMode = .locked
   487→                        
   488→                        var temperatureAndTint = AVCaptureDevice.WhiteBalanceTemperatureAndTintValues()
   489→                        temperatureAndTint.temperature = manualSettings.whiteBalance
   490→                        temperatureAndTint.tint = manualSettings.tint
   491→                        print("📸 色温: \(temperatureAndTint.temperature)K, 色调: \(temperatureAndTint.tint)")
   492→                        
   493→                        do {
   494→                            let whiteBalanceGains = try device.deviceWhiteBalanceGains(for: temperatureAndTint)
   495→                            let normalizedGains = AVCaptureDevice.WhiteBalanceGains(
   496→                                redGain: min(max(whiteBalanceGains.redGain, 1.0), device.maxWhiteBalanceGain),
   497→                                greenGain: min(max(whiteBalanceGains.greenGain, 1.0), device.maxWhiteBalanceGain),
   498→                                blueGain: min(max(whiteBalanceGains.blueGain, 1.0), device.maxWhiteBalanceGain)
   499→                            )
   500→                            
   501→                            device.setWhiteBalanceModeLocked(with: normalizedGains, completionHandler: { (time) in
   502→                                print("📸 白平衡设置完成，时间: \(time.seconds)秒")
   503→                            })
   504→                        } catch {
   505→                            print("❌ 无法计算白平衡增益: \(error)")
   506→                        }
   507→                    }
   508→                }
   509→            } else {
   510→                print("📸 没有选中特定设置，跳过应用")
   511→            }
   512→            
   513→            device.unlockForConfiguration()
   514→            print("📸 设备配置已解锁")
   515→            
   516→        } catch {
   517→            print("❌ 无法配置相机设备: \(error)")
   518→        }
   519→    }
   520→    
   521→    // 将快门速度值转换为秒数
   522→    private func shutterSpeedToSeconds(_ value: Float) -> Double {
   523→        if value <= 0 {
   524→            // 小于等于0的值表示分数形式，如1/60, 1/125等
   525→            return 1.0 / Double(60 * pow(2, -value))
   526→        } else {
   527→            // 大于0的值表示秒数，如1", 2"等
   528→            return Double(pow(2, value - 1))
   529→        }
   530→    }
   531→    
   532→    // 切换手动控制可见性
   533→    func toggleManualControls() {
   534→        isManualControlsVisible.toggle()
   535→    }
   536→    
   537→    // 在 CameraViewModel 类中添加以下方法
   538→    func checkDeviceCapabilities() {
   539→        print("\n📱 检查相机设备能力...")
   540→        
   541→        guard let device = cameraService.currentDevice else {
   542→            print("❌ 当前没有可用的相机设备")
   543→            return
   544→        }
   545→        
   546→        print("📱 当前设备: \(device.localizedName)")
   547→        print("📱 设备类型: \(device.deviceType.rawValue)")
   548→        
   549→        // 检查曝光控制能力
   550→        print("\n📱 曝光控制能力:")
   551→        print("  - 支持自定义曝光模式: \(device.isExposureModeSupported(.custom))")
   552→        print("  - 支持锁定曝光模式: \(device.isExposureModeSupported(.locked))")
   553→        print("  - 支持连续自动曝光模式: \(device.isExposureModeSupported(.continuousAutoExposure))")
   554→        print("  - 最小ISO: \(device.activeFormat.minISO)")
   555→        print("  - 最大ISO: \(device.activeFormat.maxISO)")
   556→        print("  - 支持曝光点设置: \(device.isExposurePointOfInterestSupported)")
   557→        
   558→        // 检查对焦控制能力
   559→        print("\n📱 对焦控制能力:")
   560→        print("  - 支持锁定对焦模式: \(device.isFocusModeSupported(.locked))")
   561→        print("  - 支持自动对焦模式: \(device.isFocusModeSupported(.autoFocus))")
   562→        print("  - 支持连续自动对焦模式: \(device.isFocusModeSupported(.continuousAutoFocus))")
   563→        print("  - 支持对焦点设置: \(device.isFocusPointOfInterestSupported)")
   564→        
   565→        // 检查白平衡控制能力
   566→        print("\n📱 白平衡控制能力:")
   567→        print("  - 支持锁定白平衡模式: \(device.isWhiteBalanceModeSupported(.locked))")
   568→        print("  - 支持自动白平衡模式: \(device.isWhiteBalanceModeSupported(.autoWhiteBalance))")
   569→        print("  - 支持连续自动白平衡模式: \(device.isWhiteBalanceModeSupported(.continuousAutoWhiteBalance))")
   570→        
   571→        // 检查其他能力
   572→        print("\n📱 其他能力:")
   573→        print("  - 支持手电筒: \(device.hasTorch)")
   574→        print("  - 支持闪光灯: \(device.hasFlash)")
   575→        print("  - 支持平滑对焦: \(device.isSmoothAutoFocusSupported)")
   576→        print("  - 支持视频稳定: \(device.activeFormat.isVideoStabilizationModeSupported(.auto))")
   577→        
   578→        print("\n📱 设备格式信息:")
   579→        print("  - 最大照片ISO: \(device.activeFormat.maxISO)")
   580→        print("  - 最小照片ISO: \(device.activeFormat.minISO)")
   581→        print("  - 最大曝光时间: \(device.activeFormat.maxExposureDuration.seconds)秒")
   582→        print("  - 最小曝光时间: \(device.activeFormat.minExposureDuration.seconds)秒")
   583→        
   584→        print("\n📱 当前设置:")
   585→        print("  - 当前ISO: \(device.iso)")
   586→        print("  - 当前曝光时间: \(device.exposureDuration.seconds)秒")
   587→        print("  - 当前曝光模式: \(device.exposureMode.rawValue)")
   588→        print("  - 当前对焦模式: \(device.focusMode.rawValue)")
   589→        print("  - 当前白平衡模式: \(device.whiteBalanceMode.rawValue)")
   590→    }
   591→    
   592→    private func showAlert(message: String) {
   593→        alertMessage = message
   594→        showingAlert = true
   595→    }
   596→}
   597→
   598→extension UserDefaults {
   599→    @objc dynamic var photo_format: String? {
   600→        return string(forKey: "photo_format")
   601→    }
   602→    
   603→    @objc dynamic var photo_resolution: String? {
   604→        return string(forKey: "photo_resolution")
   605→    }
   606→}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Settings/SettingsView.swift`

Result:

```
1→import SwiftUI
     2→
     3→struct SettingsView: View {
     4→    @Environment(\.presentationMode) var presentationMode
     5→    @AppStorage("grid_overlay_enabled") private var gridOverlayEnabled = false
     6→    @AppStorage("photo_format") private var photoFormat: PhotoFormat = .heic
     7→    @AppStorage("photo_resolution") private var photoResolution: PhotoResolution = .resolution12MP
     8→    @AppStorage("location_tagging_enabled") private var locationTaggingEnabled = false
     9→    @StateObject private var cameraService = CameraService()
    10→    @State private var showingWatermarkSettings = false
    11→    @State private var showingFrameSettings = false
    12→    
    13→    var body: some View {
    14→        NavigationView {
    15→            List {
    16→                Section(header: Text("相机设置")) {
    17→                    // 网格线设置
    18→                    HStack {
    19→                        Image(systemName: "grid")
    20→                            .foregroundColor(.blue)
    21→                            .frame(width: 24)
    22→                        
    23→                        VStack(alignment: .leading) {
    24→                            Text("网格线")
    25→                                .font(.body)
    26→                            Text("显示三分法构图网格线")
    27→                                .font(.caption)
    28→                                .foregroundColor(.secondary)
    29→                        }
    30→                        
    31→                        Spacer()
    32→                        
    33→                        Toggle("", isOn: $gridOverlayEnabled)
    34→                    }
    35→                    .padding(.vertical, 4)
    36→                    
    37→                    // 照片格式设置
    38→                    HStack {
    39→                        Image(systemName: "photo")
    40→                            .foregroundColor(.green)
    41→                            .frame(width: 24)
    42→                        
    43→                        VStack(alignment: .leading) {
    44→                            Text("照片格式")
    45→                                .font(.body)
    46→                            
    47→                            Picker("照片格式", selection: $photoFormat) {
    48→                                ForEach(PhotoFormat.allCases, id: \.self) { format in
    49→                                    Text(format.displayName).tag(format)
    50→                                }
    51→                            }
    52→                            .pickerStyle(SegmentedPickerStyle())
    53→                        }
    54→                    }
    55→                    .padding(.vertical, 4)
    56→                    
    57→                    // 分辨率设置
    58→                    HStack {
    59→                        Image(systemName: "camera.aperture")
    60→                            .foregroundColor(.orange)
    61→                            .frame(width: 24)
    62→                        
    63→                        VStack(alignment: .leading) {
    64→                            Text("分辨率")
    65→                                .font(.body)
    66→                            
    67→                            Picker("分辨率", selection: $photoResolution) {
    68→                                // 总是显示12MP选项
    69→                                Text(PhotoResolution.resolution12MP.displayName)
    70→                                    .tag(PhotoResolution.resolution12MP)
    71→                                
    72→                                // 只有当设备支持时才显示48MP选项
    73→                                if cameraService.is48MPAvailable {
    74→                                    Text(PhotoResolution.resolution48MP.displayName)
    75→                                        .tag(PhotoResolution.resolution48MP)
    76→                                }
    77→                            }
    78→                            .pickerStyle(SegmentedPickerStyle())
    79→                            
    80→                            // 显示48MP不可用的提示
    81→                            if !cameraService.is48MPAvailable {
    82→                                Text("当前设备不支持48MP或需要切换到主摄像头")
    83→                                    .font(.caption)
    84→                                    .foregroundColor(.secondary)
    85→                            }
    86→                        }
    87→                    }
    88→                    .padding(.vertical, 4)
    89→                    
    90→                    // 位置信息设置
    91→                    HStack {
    92→                        Image(systemName: "location")
    93→                            .foregroundColor(.red)
    94→                            .frame(width: 24)
    95→                        
    96→                        VStack(alignment: .leading) {
    97→                            Text("位置信息")
    98→                                .font(.body)
    99→                            Text("在照片中保存位置信息")
   100→                                .font(.caption)
   101→                                .foregroundColor(.secondary)
   102→                        }
   103→                        
   104→                        Spacer()
   105→                        
   106→                        Toggle("", isOn: $locationTaggingEnabled)
   107→                    }
   108→                    .padding(.vertical, 4)
   109→                    
   110→                    // 水印设置
   111→                    Button(action: {
   112→                        showingWatermarkSettings = true
   113→                    }) {
   114→                        HStack {
   115→                            Image(systemName: "text.below.photo")
   116→                                .foregroundColor(.blue)
   117→                                .frame(width: 24)
   118→                            
   119→                            VStack(alignment: .leading) {
   120→                                Text("水印设置")
   121→                                    .font(.body)
   122→                                    .foregroundColor(.primary)
   123→                                Text("配置照片水印信息")
   124→                                    .font(.caption)
   125→                                    .foregroundColor(.secondary)
   126→                            }
   127→                            
   128→                            Spacer()
   129→                            
   130→                            Image(systemName: "chevron.right")
   131→                                .foregroundColor(.secondary)
   132→                                .font(.caption)
   133→                        }
   134→                    }
   135→                    .padding(.vertical, 4)
   136→                    
   137→                    // 相框设置
   138→                    Button(action: {
   139→                        showingFrameSettings = true
   140→                    }) {
   141→                        HStack {
   142→                            Image(systemName: "rectangle.on.rectangle")
   143→                                .foregroundColor(.purple)
   144→                                .frame(width: 24)
   145→                            
   146→                            VStack(alignment: .leading) {
   147→                                Text("相框设置")
   148→                                    .font(.body)
   149→                                    .foregroundColor(.primary)
   150→                                Text("配置照片相框样式")
   151→                                    .font(.caption)
   152→                                    .foregroundColor(.secondary)
   153→                            }
   154→                            
   155→                            Spacer()
   156→                            
   157→                            Image(systemName: "chevron.right")
   158→                                .foregroundColor(.secondary)
   159→                                .font(.caption)
   160→                        }
   161→                    }
   162→                    .padding(.vertical, 4)
   163→                }
   164→                
   165→                Section(header: Text("关于")) {
   166→                    HStack {
   167→                        Image(systemName: "info.circle")
   168→                            .foregroundColor(.blue)
   169→                            .frame(width: 24)
   170→                        
   171→                        VStack(alignment: .leading) {
   172→                            Text("版本")
   173→                                .font(.body)
   174→                            Text("1.0.0")
   175→                                .font(.caption)
   176→                                .foregroundColor(.secondary)
   177→                        }
   178→                    }
   179→                    .padding(.vertical, 4)
   180→                    
   181→                    HStack {
   182→                        Image(systemName: "person.circle")
   183→                            .foregroundColor(.purple)
   184→                            .frame(width: 24)
   185→                        
   186→                        VStack(alignment: .leading) {
   187→                            Text("开发者")
   188→                                .font(.body)
   189→                            Text("马聪聪")
   190→                                .font(.caption)
   191→                                .foregroundColor(.secondary)
   192→                        }
   193→                    }
   194→                    .padding(.vertical, 4)
   195→                }
   196→            }
   197→            .navigationBarTitle("设置", displayMode: .inline)
   198→            .navigationBarItems(trailing: Button("完成") {
   199→                presentationMode.wrappedValue.dismiss()
   200→            })
   201→            .sheet(isPresented: $showingWatermarkSettings) {
   202→                WatermarkSettingsView()
   203→            }
   204→            .sheet(isPresented: $showingFrameSettings) {
   205→                FrameSettingsView()
   206→            }
   207→        }
   208→    }
   209→}
   210→
   211→#Preview {
   212→    SettingsView()
   213→}
```

_**Agent (claude-sonnet-4-20250514)**_

基于我对项目的分析，我发现项目已经有了相框功能的完整实现，包括：

1. **现有相框功能**：
   - `FrameSettings.swift` - 相框配置设置
   - `FrameService.swift` - 相框处理服务 
   - `FrameSettingsView.swift` - 相框设置界面
   - 支持6种布局类型：居中悬浮、底部对称、宝丽来、左下角、底部信息条、杂志侧栏
   - 支持16种品牌Logo：Apple、Canon、Nikon、Sony等
   - 支持自定义颜色、文本对齐、显示内容配置

2. **现有水印功能**：
   - `WatermarkSettings.swift` - 水印配置设置
   - `WatermarkService.swift` - 水印处理服务
   - `WatermarkSettingsView.swift` - 水印设置界面

3. **集成状态**：
   - 设置页面已集成相框和水印设置入口
   - CameraViewModel 中已有相关处理逻辑

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **ExitPlanMode**

Result:

```
User has approved your plan. You can now start coding. Start with updating your todo list if applicable
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [ ] 🌡️ 扩展相框布局类型，添加新的创意样式
- [ ] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [ ] 🌡️ 优化水印功能，添加更多位置和效果选项
- [ ] 🌡️ 创建样式模板系统
- [ ] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

现在开始扩展相框布局类型，添加新的创意样式。首先更新 `FrameSettings.swift` 文件：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [⚡] 🌡️ 扩展相框布局类型，添加新的创意样式
- [ ] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [ ] 🌡️ 优化水印功能，添加更多位置和效果选项
- [ ] 🌡️ 创建样式模板系统
- [ ] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import Foundation
     2→import UIKit
     3→
     4→// 边框布局类型
     5→enum FrameLayoutType: String, CaseIterable, Codable {
     6→    case centerFloat = "居中悬浮"
     7→    case bottomSymmetric = "底部对称"
     8→    case polaroid = "宝丽来"
     9→    case bottomLeft = "左下角"
    10→    case bottomInfoBar = "底部信息条"
    11→    case magazineSidebar = "杂志侧栏"
    12→    // 新增创意样式
    13→    case filmStrip = "胶卷风格"
    14→    case instantCamera = "拍立得多格"
    15→    case vintageFrame = "复古电影"
    16→    case artGallery = "艺术画廊"
    17→    case modernMinimal = "现代简约"
    18→    case scrapbook = "剪贴簿"
    19→}
    20→
    21→// 内容对齐方式
    22→enum ContentAlignment: String, CaseIterable, Codable {
    23→    case left = "居左"
```

_**Agent (claude-sonnet-4-20250514)**_

现在添加新的相框属性，包括透明度、圆角、纹理等高级设置：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    25→    case right = "居右"
    26→    case distributed = "分散"
    27→}
    28→
    29→// 显示内容类型
    30→struct DisplayContent: Codable {
    31→    var showParameters: Bool = true
    32→    var showLocation: Bool = false
    33→    var showDate: Bool = true
    34→}
    35→
    36→// 相框纹理类型
    37→enum FrameTexture: String, CaseIterable, Codable {
    38→    case none = "无纹理"
    39→    case paper = "纸质纹理"
    40→    case fabric = "布料纹理"
    41→    case wood = "木纹纹理"
    42→    case metal = "金属纹理"
    43→    case canvas = "画布纹理"
    44→    case leather = "皮革纹理"
    45→}
    46→
    47→// 相框阴影设置
    48→struct FrameShadow: Codable {
    49→    var enabled: Bool = false
    50→    var opacity: Float = 0.3
    51→    var blur: Float = 10.0
    52→    var offsetX: Float = 0.0
    53→    var offsetY: Float = 5.0
    54→    
    55→    static let `default` = FrameShadow()
    56→}
    57→
    58→// 相框设置
    59→struct FrameSettings: Codable {
    60→    var isEnabled: Bool = false
```

_**Agent (claude-sonnet-4-20250514)**_

现在更新 FrameSettings 结构体，添加新的属性：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    54→    
    55→    static let `default` = FrameShadow()
    56→}
    57→
    58→// 相框设置
    59→struct FrameSettings: Codable {
    60→    var isEnabled: Bool = false
    61→    var frameLayout: FrameLayoutType = .polaroid
    62→    var logoIndex: Int = 0
    63→    var contentAlignment: ContentAlignment = .center
    64→    var displayContent: DisplayContent = DisplayContent()
    65→    var customText: String = ""
    66→    
    67→    // 边框颜色 - 使用十六进制字符串表示，方便存储
    68→    var borderColorHex: String = "#FFFFFF"
    69→    
    70→    // 新增高级设置
    71→    var borderOpacity: Float = 1.0 // 边框透明度 (0.0-1.0)
    72→    var cornerRadius: Float = 0.0 // 圆角半径 (0.0-50.0)
    73→    var frameTexture: FrameTexture = .none // 纹理类型
    74→    var frameShadow: FrameShadow = FrameShadow.default // 阴影设置
    75→    var borderWidth: Float = 15.0 // 边框宽度百分比 (5.0-30.0)
    76→    
    77→    // 获取UIColor
    78→    var borderColor: UIColor {
    79→        get {
```

_**Agent (claude-sonnet-4-20250514)**_

现在更新 FrameService.swift，为新的相框布局类型添加实现：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    19→            print("  - 相框未启用，返回原图")
    20→            return image 
    21→        }
    22→        
    23→        // 根据不同的布局类型应用不同的相框
    24→        switch settings.frameLayout {
    25→        case .centerFloat:
    26→            return applyCenterFloatFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    27→        case .bottomSymmetric:
    28→            return applyBottomSymmetricFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    29→        case .polaroid:
    30→            return applyPolaroidFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    31→        case .bottomLeft:
    32→            return applyBottomLeftFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    33→        case .bottomInfoBar:
    34→            return applyBottomInfoBarFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    35→        case .magazineSidebar:
    36→            return applyMagazineSidebarFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    37→        // 新增样式
    38→        case .filmStrip:
    39→            return applyFilmStripFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    40→        case .instantCamera:
    41→            return applyInstantCameraFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    42→        case .vintageFrame:
    43→            return applyVintageFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    44→        case .artGallery:
    45→            return applyArtGalleryFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    46→        case .modernMinimal:
    47→            return applyModernMinimalFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    48→        case .scrapbook:
    49→            return applyScrapbookFrame(to: image, with: captureSettings, locationInfo: locationInfo, settings: settings)
    50→        }
    51→    }
    52→    
    53→    // 居中悬浮相框
    54→    private func applyCenterFloatFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
```

_**Agent (claude-sonnet-4-20250514)**_

现在在 FrameService.swift 文件末尾添加新相框样式的实现：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   472→        
   473→        return components.joined(separator: " | ")
   474→    }
   475→    
   476→    // 格式化快门速度
   477→    private func formatShutterSpeed(_ speed: Double) -> String {
   478→        if speed >= 1.0 {
   479→            return String(format: "%.0fs", speed)
   480→        } else {
   481→            let denominator = Int(1.0 / speed)
   482→            return "1/\(denominator)s"
   483→        }
   484→    }
   485→    
   486→    // MARK: - 新增相框样式
   487→    
   488→    // 胶卷风格相框
   489→    private func applyFilmStripFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   490→        let originalWidth = image.size.width
   491→        let originalHeight = image.size.height
   492→        let sprocketHeight = originalHeight * 0.1 // 胶卷孔高度
   493→        let newSize = CGSize(width: originalWidth, height: originalHeight + sprocketHeight * 2)
   494→        
   495→        let renderer = UIGraphicsImageRenderer(size: newSize)
   496→        
   497→        return renderer.image { context in
   498→            // 绘制黑色胶卷背景
   499→            UIColor.black.setFill()
   500→            context.fill(CGRect(origin: .zero, size: newSize))
   501→            
   502→            // 绘制胶卷孔（上下各一排）
   503→            let holeSpacing: CGFloat = originalWidth / 8
   504→            let holeSize: CGFloat = sprocketHeight * 0.6
   505→            
   506→            for i in 0..<8 {
   507→                let x = CGFloat(i) * holeSpacing + holeSpacing * 0.5 - holeSize * 0.5
   508→                // 上排孔
   509→                let topHoleRect = CGRect(x: x, y: sprocketHeight * 0.2, width: holeSize, height: holeSize)
   510→                context.cgContext.setFillColor(UIColor.white.cgColor)
   511→                context.cgContext.fillEllipse(in: topHoleRect)
   512→                
   513→                // 下排孔
   514→                let bottomHoleRect = CGRect(x: x, y: newSize.height - sprocketHeight + sprocketHeight * 0.2, width: holeSize, height: holeSize)
   515→                context.cgContext.fillEllipse(in: bottomHoleRect)
   516→            }
   517→            
   518→            // 绘制原始图像
   519→            image.draw(at: CGPoint(x: 0, y: sprocketHeight))
   520→            
   521→            // 绘制信息文本在底部
   522→            if !settings.customText.isEmpty || settings.displayContent.showParameters {
   523→                let infoText = settings.customText.isEmpty ? formatInfoText(captureSettings: captureSettings, locationInfo: locationInfo, settings: settings) : settings.customText
   524→                drawText(infoText, at: CGPoint(x: originalWidth * 0.05, y: newSize.height - sprocketHeight * 0.6), alignment: .left, color: .white, fontSize: originalWidth * 0.025, in: context.cgContext)
   525→            }
   526→        }
   527→    }
   528→    
   529→    // 拍立得多格相框
   530→    private func applyInstantCameraFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   531→        let originalWidth = image.size.width
   532→        let originalHeight = image.size.height
   533→        let padding: CGFloat = originalWidth * 0.05
   534→        let gridSize: CGFloat = min(originalWidth, originalHeight) * 0.3
   535→        
   536→        // 创建包含多个小相框的布局
   537→        let newSize = CGSize(width: originalWidth + padding * 4 + gridSize, height: originalHeight + padding * 2)
   538→        
   539→        let renderer = UIGraphicsImageRenderer(size: newSize)
   540→        
   541→        return renderer.image { context in
   542→            // 绘制白色背景
   543→            UIColor.white.setFill()
   544→            context.fill(CGRect(origin: .zero, size: newSize))
   545→            
   546→            // 绘制主图像
   547→            image.draw(at: CGPoint(x: padding, y: padding))
   548→            
   549→            // 绘制右侧小相框网格
   550→            for row in 0..<2 {
   551→                for col in 0..<1 {
   552→                    let smallFrameSize = CGSize(width: gridSize, height: gridSize)
   553→                    let x = originalWidth + padding * 2 + CGFloat(col) * (gridSize + padding)
   554→                    let y = padding + CGFloat(row) * (gridSize + padding)
   555→                    
   556→                    // 绘制小相框边框
   557→                    let frameRect = CGRect(x: x, y: y, width: smallFrameSize.width, height: smallFrameSize.height)
   558→                    UIColor.lightGray.setStroke()
   559→                    context.cgContext.setLineWidth(2)
   560→                    context.cgContext.stroke(frameRect)
   561→                    
   562→                    // 绘制缩小的图像
   563→                    let smallImageRect = CGRect(x: x + 5, y: y + 5, width: smallFrameSize.width - 10, height: smallFrameSize.height - 10)
   564→                    image.draw(in: smallImageRect)
   565→                }
   566→            }
   567→            
   568→            // 绘制Logo和文本
   569→            if settings.logoIndex > 0 {
   570→                drawLogo(at: CGPoint(x: originalWidth * 0.9, y: newSize.height - padding * 2), size: CGSize(width: 40, height: 40), in: context.cgContext)
   571→            }
   572→        }
   573→    }
   574→    
   575→    // 复古电影相框
   576→    private func applyVintageFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   577→        let originalWidth = image.size.width
   578→        let originalHeight = image.size.height
   579→        let frameThickness = originalWidth * CGFloat(settings.borderWidth / 100.0)
   580→        let newSize = CGSize(width: originalWidth + frameThickness * 2, height: originalHeight + frameThickness * 2)
   581→        
   582→        let renderer = UIGraphicsImageRenderer(size: newSize)
   583→        
   584→        return renderer.image { context in
   585→            // 绘制复古金色渐变背景
   586→            let gradient = CGGradient(colorsSpace: CGColorSpaceCreateDeviceRGB(), colors: [
   587→                UIColor(red: 0.8, green: 0.6, blue: 0.2, alpha: CGFloat(settings.borderOpacity)).cgColor,
   588→                UIColor(red: 0.9, green: 0.7, blue: 0.3, alpha: CGFloat(settings.borderOpacity)).cgColor,
   589→                UIColor(red: 0.7, green: 0.5, blue: 0.1, alpha: CGFloat(settings.borderOpacity)).cgColor
   590→            ] as CFArray, locations: [0, 0.5, 1])!
   591→            
   592→            context.cgContext.drawLinearGradient(gradient, start: CGPoint(x: 0, y: 0), end: CGPoint(x: newSize.width, y: newSize.height), options: [])
   593→            
   594→            // 绘制装饰边框（内嵌效果）
   595→            let innerFrameRect = CGRect(x: frameThickness * 0.2, y: frameThickness * 0.2, 
   596→                                     width: newSize.width - frameThickness * 0.4, 
   597→                                     height: newSize.height - frameThickness * 0.4)
   598→            context.cgContext.setStrokeColor(UIColor(red: 0.5, green: 0.3, blue: 0.1, alpha: 1.0).cgColor)
   599→            context.cgContext.setLineWidth(3)
   600→            context.cgContext.stroke(innerFrameRect)
   601→            
   602→            // 绘制原始图像
   603→            let imageRect = CGRect(x: frameThickness, y: frameThickness, width: originalWidth, height: originalHeight)
   604→            
   605→            // 应用圆角
   606→            if settings.cornerRadius > 0 {
   607→                let path = UIBezierPath(roundedRect: imageRect, cornerRadius: CGFloat(settings.cornerRadius))
   608→                path.addClip()
   609→            }
   610→            
   611→            image.draw(in: imageRect)
   612→            
   613→            // 绘制信息文本
   614→            if !settings.customText.isEmpty {
   615→                drawText(settings.customText, at: CGPoint(x: newSize.width * 0.5, y: newSize.height - frameThickness * 0.4), 
   616→                        alignment: .center, color: .black, fontSize: frameThickness * 0.3, in: context.cgContext)
   617→            }
   618→        }
   619→    }
   620→    
   621→    // 艺术画廊相框
   622→    private func applyArtGalleryFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   623→        let originalWidth = image.size.width
   624→        let originalHeight = image.size.height
   625→        let frameWidth = originalWidth * CGFloat(settings.borderWidth / 100.0)
   626→        let matteWidth = frameWidth * 0.6
   627→        let newSize = CGSize(width: originalWidth + (frameWidth + matteWidth) * 2, 
   628→                           height: originalHeight + (frameWidth + matteWidth) * 2)
   629→        
   630→        let renderer = UIGraphicsImageRenderer(size: newSize)
   631→        
   632→        return renderer.image { context in
   633→            // 绘制外框（深色木纹效果）
   634→            UIColor.brown.setFill()
   635→            context.fill(CGRect(origin: .zero, size: newSize))
   636→            
   637→            // 绘制装饰条纹
   638→            context.cgContext.setStrokeColor(UIColor.darkBrown.cgColor)
   639→            context.cgContext.setLineWidth(2)
   640→            for i in stride(from: 0, to: Int(frameWidth), by: 8) {
   641→                // 左边框条纹
   642→                context.cgContext.move(to: CGPoint(x: CGFloat(i), y: 0))
   643→                context.cgContext.addLine(to: CGPoint(x: CGFloat(i), y: newSize.height))
   644→                context.cgContext.strokePath()
   645→            }
   646→            
   647→            // 绘制内部白色卡纸
   648→            let matteRect = CGRect(x: frameWidth, y: frameWidth, 
   649→                                 width: newSize.width - frameWidth * 2, 
   650→                                 height: newSize.height - frameWidth * 2)
   651→            UIColor.white.withAlphaComponent(CGFloat(settings.borderOpacity)).setFill()
   652→            context.fill(matteRect)
   653→            
   654→            // 绘制原始图像
   655→            let imageRect = CGRect(x: frameWidth + matteWidth, y: frameWidth + matteWidth, 
   656→                                 width: originalWidth, height: originalHeight)
   657→            image.draw(in: imageRect)
   658→            
   659→            // 绘制签名区域
   660→            if !settings.customText.isEmpty {
   661→                let signatureY = frameWidth + matteWidth + originalHeight + matteWidth * 0.3
   662→                drawText(settings.customText, at: CGPoint(x: frameWidth + matteWidth + originalWidth * 0.7, y: signatureY), 
   663→                        alignment: .right, color: .gray, fontSize: matteWidth * 0.4, in: context.cgContext)
   664→            }
   665→        }
   666→    }
   667→    
   668→    // 现代简约相框
   669→    private func applyModernMinimalFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   670→        let originalWidth = image.size.width
   671→        let originalHeight = image.size.height
   672→        let borderWidth = originalWidth * CGFloat(settings.borderWidth / 100.0) * 0.3 // 更细的边框
   673→        let newSize = CGSize(width: originalWidth + borderWidth * 2, height: originalHeight + borderWidth * 2)
   674→        
   675→        let renderer = UIGraphicsImageRenderer(size: newSize)
   676→        
   677→        return renderer.image { context in
   678→            // 绘制简约白色背景
   679→            UIColor.white.withAlphaComponent(CGFloat(settings.borderOpacity)).setFill()
   680→            context.fill(CGRect(origin: .zero, size: newSize))
   681→            
   682→            // 绘制极细边框线
   683→            let strokeRect = CGRect(x: borderWidth - 1, y: borderWidth - 1, 
   684→                                  width: originalWidth + 2, height: originalHeight + 2)
   685→            context.cgContext.setStrokeColor(UIColor.lightGray.cgColor)
   686→            context.cgContext.setLineWidth(0.5)
   687→            context.cgContext.stroke(strokeRect)
   688→            
   689→            // 绘制原始图像
   690→            let imageRect = CGRect(x: borderWidth, y: borderWidth, width: originalWidth, height: originalHeight)
   691→            
   692→            // 应用圆角
   693→            if settings.cornerRadius > 0 {
   694→                let path = UIBezierPath(roundedRect: imageRect, cornerRadius: CGFloat(settings.cornerRadius))
   695→                path.addClip()
   696→            }
   697→            
   698→            image.draw(in: imageRect)
   699→            
   700→            // 简约文字信息
   701→            if settings.displayContent.showParameters {
   702→                let infoText = formatParametersText(captureSettings: captureSettings)
   703→                drawText(infoText, at: CGPoint(x: newSize.width - borderWidth, y: newSize.height - borderWidth * 0.3), 
   704→                        alignment: .right, color: .gray, fontSize: borderWidth * 0.3, in: context.cgContext)
   705→            }
   706→        }
   707→    }
   708→    
   709→    // 剪贴簿相框
   710→    private func applyScrapbookFrame(to image: UIImage, with captureSettings: CameraCaptureSettings, locationInfo: String?, settings: FrameSettings) -> UIImage? {
   711→        let originalWidth = image.size.width
   712→        let originalHeight = image.size.height
   713→        let padding = originalWidth * 0.1
   714→        let newSize = CGSize(width: originalWidth + padding * 2, height: originalHeight + padding * 3)
   715→        
   716→        let renderer = UIGraphicsImageRenderer(size: newSize)
   717→        
   718→        return renderer.image { context in
   719→            // 绘制纸质纹理背景
   720→            UIColor(red: 0.96, green: 0.94, blue: 0.88, alpha: CGFloat(settings.borderOpacity)).setFill()
   721→            context.fill(CGRect(origin: .zero, size: newSize))
   722→            
   723→            // 添加纸质纹理效果（随机小点）
   724→            for _ in 0..<500 {
   725→                let x = CGFloat.random(in: 0...newSize.width)
   726→                let y = CGFloat.random(in: 0...newSize.height)
   727→                let size = CGFloat.random(in: 0.5...1.5)
   728→                
   729→                UIColor.gray.withAlphaComponent(0.1).setFill()
   730→                context.cgContext.fillEllipse(in: CGRect(x: x, y: y, width: size, height: size))
   731→            }
   732→            
   733→            // 绘制稍微倾斜的图像（模拟手工贴纸效果）
   734→            context.cgContext.saveGState()
   735→            let imageCenter = CGPoint(x: newSize.width * 0.5, y: padding + originalHeight * 0.5)
   736→            context.cgContext.translateBy(x: imageCenter.x, y: imageCenter.y)
   737→            context.cgContext.rotate(by: CGFloat.random(in: -0.05...0.05)) // 轻微旋转
   738→            context.cgContext.translateBy(x: -originalWidth * 0.5, y: -originalHeight * 0.5)
   739→            
   740→            // 绘制胶带效果
   741→            let tapeWidth: CGFloat = 80
   742→            let tapeHeight: CGFloat = 20
   743→            for i in 0..<4 {
   744→                let angle = CGFloat(i) * .pi / 2
   745→                let tapeX = originalWidth * 0.5 - tapeWidth * 0.5
   746→                let tapeY = originalHeight * 0.5 - tapeHeight * 0.5
   747→                
   748→                context.cgContext.saveGState()
   749→                context.cgContext.translateBy(x: tapeX + tapeWidth * 0.5, y: tapeY + tapeHeight * 0.5)
   750→                context.cgContext.rotate(by: angle)
   751→                
   752→                let tapeRect = CGRect(x: -tapeWidth * 0.5, y: -tapeHeight * 0.5, width: tapeWidth, height: tapeHeight)
   753→                UIColor.yellow.withAlphaComponent(0.7).setFill()
   754→                context.fill(tapeRect)
   755→                context.cgContext.restoreGState()
   756→            }
   757→            
   758→            image.draw(in: CGRect(x: 0, y: 0, width: originalWidth, height: originalHeight))
   759→            context.cgContext.restoreGState()
   760→            
   761→            // 绘制手写风格文字
   762→            if !settings.customText.isEmpty {
   763→                drawText(settings.customText, at: CGPoint(x: newSize.width * 0.5, y: newSize.height - padding * 0.5), 
   764→                        alignment: .center, color: .blue, fontSize: padding * 0.3, in: context.cgContext)
   765→            }
   766→        }
   767→    }
   768→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在标记第2个任务为完成，开始第3个任务 - 增强相框设置选项：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [X] 🌡️ 扩展相框布局类型，添加新的创意样式
- [⚡] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [ ] 🌡️ 优化水印功能，添加更多位置和效果选项
- [ ] 🌡️ 创建样式模板系统
- [ ] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

现在更新 FrameSettingsView.swift，添加新的高级设置选项：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    27→    var body: some View {
    28→        NavigationView {
    29→            Form {
    30→                // 拆分为多个子视图
    31→                FrameEnableSection(settings: $settings)
    32→                FrameLayoutSection(settings: $settings, logoImages: logoImages)
    33→                FrameContentSection(settings: $settings)
    34→                FrameAdvancedSection(settings: $settings)
    35→                FramePreviewSection(settings: settings)
    36→            }
    37→            .navigationTitle("相框设置")
    38→            .navigationBarItems(
    39→                leading: Button("取消") {
```

_**Agent (claude-sonnet-4-20250514)**_

现在在文件末尾添加新的高级设置部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Error:

```
<tool_use_error>String to replace not found in file.
String:                     .frame(height: geometry.size.width * 0.7)
            
            Color.gray.opacity(0.5) // 照片占位符
                .frame(width: geometry.size.width * 0.7)
        }
    }
    
    // 根据内容对齐方式返回对应的SwiftUI对齐方式
    private var contentAlignment: HorizontalAlignment {
        switch settings.contentAlignment {
        case .left: return .leading
        case .center: return .center
        case .right: return .trailing
        case .distributed: return .center // SwiftUI没有分散对齐，使用居中代替
        }
    }
    
    // 预览文本
    private var previewText: String {
        var components: [String] = []
        
        if settings.displayContent.showParameters {
            components.append("24mm 1/60s ISO100")
        }
        
        if settings.displayContent.showLocation {
            components.append("北京市")
        }
        
        if settings.displayContent.showDate {
            components.append("2024.12.19")
        }
        
        return components.joined(separator: " | ")
    }
}

struct FrameSettingsView_Previews: PreviewProvider {
    static var previews: some View {
        FrameSettingsView()
    }
}</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

让我查看文件末尾的内容，然后在正确的位置添加新的设置部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/FrameSettingsView.swift`

Result:

```
500→        case .distributed: return .center // SwiftUI没有分散对齐，使用居中代替
   501→        }
   502→    }
   503→    
   504→    // 预览文本
   505→    private var previewText: String {
   506→        var components: [String] = []
   507→        
   508→        if settings.displayContent.showParameters {
   509→            components.append("24mm 1/60s ISO100")
   510→        }
   511→        
   512→        if settings.displayContent.showLocation {
   513→            components.append("北京市")
   514→        }
   515→        
   516→        if settings.displayContent.showDate {
   517→            components.append("2024.12.19")
   518→        }
   519→        
   520→        return components.joined(separator: " | ")
   521→    }
   522→}
   523→
   524→struct FrameSettingsView_Previews: PreviewProvider {
   525→    static var previews: some View {
   526→        FrameSettingsView()
   527→    }
   528→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在在正确的位置添加高级设置部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   518→        }
   519→        
   520→        return components.joined(separator: " | ")
   521→    }
   522→}
   523→
   524→// 高级设置部分
   525→struct FrameAdvancedSection: View {
   526→    @Binding var settings: FrameSettings
   527→    
   528→    var body: some View {
   529→        Group {
   530→            Section(header: Text("高级设置")) {
   531→                // 透明度设置
   532→                VStack(alignment: .leading) {
   533→                    HStack {
   534→                        Text("边框透明度")
   535→                        Spacer()
   536→                        Text("\(Int(settings.borderOpacity * 100))%")
   537→                            .foregroundColor(.secondary)
   538→                    }
   539→                    
   540→                    Slider(value: $settings.borderOpacity, in: 0.1...1.0, step: 0.1)
   541→                        .accentColor(.orange)
   542→                }
   543→                .padding(.vertical, 4)
   544→                
   545→                // 圆角设置
   546→                VStack(alignment: .leading) {
   547→                    HStack {
   548→                        Text("圆角半径")
   549→                        Spacer()
   550→                        Text("\(Int(settings.cornerRadius))")
   551→                            .foregroundColor(.secondary)
   552→                    }
   553→                    
   554→                    Slider(value: $settings.cornerRadius, in: 0...50, step: 1)
   555→                        .accentColor(.blue)
   556→                }
   557→                .padding(.vertical, 4)
   558→                
   559→                // 边框宽度设置
   560→                VStack(alignment: .leading) {
   561→                    HStack {
   562→                        Text("边框宽度")
   563→                        Spacer()
   564→                        Text("\(Int(settings.borderWidth))%")
   565→                            .foregroundColor(.secondary)
   566→                    }
   567→                    
   568→                    Slider(value: $settings.borderWidth, in: 5...30, step: 1)
   569→                        .accentColor(.green)
   570→                }
   571→                .padding(.vertical, 4)
   572→                
   573→                // 纹理选择
   574→                VStack(alignment: .leading) {
   575→                    Text("相框纹理")
   576→                        .font(.body)
   577→                    
   578→                    ScrollView(.horizontal, showsIndicators: false) {
   579→                        HStack(spacing: 12) {
   580→                            ForEach(FrameTexture.allCases, id: \.self) { texture in
   581→                                TextureButton(
   582→                                    texture: texture,
   583→                                    isSelected: settings.frameTexture == texture,
   584→                                    action: {
   585→                                        settings.frameTexture = texture
   586→                                    }
   587→                                )
   588→                            }
   589→                        }
   590→                        .padding(.vertical, 8)
   591→                    }
   592→                }
   593→                .padding(.vertical, 4)
   594→                
   595→                // 阴影设置
   596→                VStack(alignment: .leading) {
   597→                    Toggle("启用阴影效果", isOn: $settings.frameShadow.enabled)
   598→                        .padding(.vertical, 2)
   599→                    
   600→                    if settings.frameShadow.enabled {
   601→                        Group {
   602→                            // 阴影透明度
   603→                            VStack(alignment: .leading) {
   604→                                HStack {
   605→                                    Text("阴影透明度")
   606→                                        .font(.caption)
   607→                                    Spacer()
   608→                                    Text("\(Int(settings.frameShadow.opacity * 100))%")
   609→                                        .font(.caption)
   610→                                        .foregroundColor(.secondary)
   611→                                }
   612→                                
   613→                                Slider(value: $settings.frameShadow.opacity, in: 0.1...1.0, step: 0.1)
   614→                                    .accentColor(.gray)
   615→                            }
   616→                            
   617→                            // 阴影模糊度
   618→                            VStack(alignment: .leading) {
   619→                                HStack {
   620→                                    Text("阴影模糊度")
   621→                                        .font(.caption)
   622→                                    Spacer()
   623→                                    Text("\(Int(settings.frameShadow.blur))")
   624→                                        .font(.caption)
   625→                                        .foregroundColor(.secondary)
   626→                                }
   627→                                
   628→                                Slider(value: $settings.frameShadow.blur, in: 0...20, step: 1)
   629→                                    .accentColor(.purple)
   630→                            }
   631→                            
   632→                            // 阴影偏移
   633→                            VStack(alignment: .leading) {
   634→                                HStack {
   635→                                    Text("垂直偏移")
   636→                                        .font(.caption)
   637→                                    Spacer()
   638→                                    Text("\(Int(settings.frameShadow.offsetY))")
   639→                                        .font(.caption)
   640→                                        .foregroundColor(.secondary)
   641→                                }
   642→                                
   643→                                Slider(value: $settings.frameShadow.offsetY, in: -10...10, step: 1)
   644→                                    .accentColor(.red)
   645→                            }
   646→                        }
   647→                        .padding(.leading, 16)
   648→                    }
   649→                }
   650→                .padding(.vertical, 4)
   651→            }
   652→        }
   653→    }
   654→}
   655→
   656→// 纹理按钮
   657→struct TextureButton: View {
   658→    let texture: FrameTexture
   659→    let isSelected: Bool
   660→    let action: () -> Void
   661→    
   662→    var body: some View {
   663→        Button(action: action) {
   664→            VStack {
   665→                ZStack {
   666→                    RoundedRectangle(cornerRadius: 8)
   667→                        .fill(textureColor)
   668→                        .frame(width: 60, height: 60)
   669→                        .overlay(
   670→                            texturePattern
   671→                        )
   672→                }
   673→                .overlay(
   674→                    RoundedRectangle(cornerRadius: 8)
   675→                        .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 2)
   676→                )
   677→                
   678→                Text(texture.rawValue)
   679→                    .font(.caption)
   680→                    .foregroundColor(isSelected ? .orange : .primary)
   681→                    .multilineTextAlignment(.center)
   682→            }
   683→        }
   684→    }
   685→    
   686→    // 纹理颜色
   687→    private var textureColor: Color {
   688→        switch texture {
   689→        case .none: return .gray.opacity(0.2)
   690→        case .paper: return .white
   691→        case .fabric: return Color(red: 0.9, green: 0.85, blue: 0.8)
   692→        case .wood: return Color(red: 0.7, green: 0.5, blue: 0.3)
   693→        case .metal: return Color(red: 0.8, green: 0.8, blue: 0.85)
   694→        case .canvas: return Color(red: 0.95, green: 0.92, blue: 0.85)
   695→        case .leather: return Color(red: 0.4, green: 0.25, blue: 0.15)
   696→        }
   697→    }
   698→    
   699→    // 纹理图案
   700→    private var texturePattern: some View {
   701→        Group {
   702→            switch texture {
   703→            case .none:
   704→                EmptyView()
   705→            case .paper:
   706→                // 纸质纹理 - 小点点
   707→                ForEach(0..<20, id: \.self) { _ in
   708→                    Circle()
   709→                        .fill(Color.gray.opacity(0.1))
   710→                        .frame(width: 2, height: 2)
   711→                        .position(
   712→                            x: CGFloat.random(in: 0...60),
   713→                            y: CGFloat.random(in: 0...60)
   714→                        )
   715→                }
   716→            case .fabric:
   717→                // 布料纹理 - 交叉线条
   718→                Path { path in
   719→                    for i in stride(from: 0, to: 60, by: 8) {
   720→                        path.move(to: CGPoint(x: CGFloat(i), y: 0))
   721→                        path.addLine(to: CGPoint(x: CGFloat(i), y: 60))
   722→                        path.move(to: CGPoint(x: 0, y: CGFloat(i)))
   723→                        path.addLine(to: CGPoint(x: 60, y: CGFloat(i)))
   724→                    }
   725→                }
   726→                .stroke(Color.gray.opacity(0.3), lineWidth: 0.5)
   727→            case .wood:
   728→                // 木纹纹理 - 波浪线
   729→                Path { path in
   730→                    for i in stride(from: 0, to: 60, by: 6) {
   731→                        path.move(to: CGPoint(x: 0, y: CGFloat(i)))
   732→                        path.addQuadCurve(to: CGPoint(x: 60, y: CGFloat(i)), 
   733→                                        control: CGPoint(x: 30, y: CGFloat(i) + 2))
   734→                    }
   735→                }
   736→                .stroke(Color.brown.opacity(0.4), lineWidth: 1)
   737→            case .metal:
   738→                // 金属纹理 - 反光条纹
   739→                LinearGradient(
   740→                    gradient: Gradient(colors: [
   741→                        .gray.opacity(0.3),
   742→                        .white.opacity(0.6),
   743→                        .gray.opacity(0.3)
   744→                    ]),
   745→                    startPoint: .topLeading,
   746→                    endPoint: .bottomTrailing
   747→                )
   748→            case .canvas:
   749→                // 画布纹理 - 十字交叉
   750→                Path { path in
   751→                    for i in stride(from: 0, to: 60, by: 4) {
   752→                        path.move(to: CGPoint(x: CGFloat(i), y: 0))
   753→                        path.addLine(to: CGPoint(x: CGFloat(i), y: 60))
   754→                        path.move(to: CGPoint(x: 0, y: CGFloat(i)))
   755→                        path.addLine(to: CGPoint(x: 60, y: CGFloat(i)))
   756→                    }
   757→                }
   758→                .stroke(Color.gray.opacity(0.2), lineWidth: 0.3)
   759→            case .leather:
   760→                // 皮革纹理 - 随机颗粒
   761→                ForEach(0..<50, id: \.self) { _ in
   762→                    Circle()
   763→                        .fill(Color.brown.opacity(0.2))
   764→                        .frame(width: CGFloat.random(in: 1...3), 
   765→                               height: CGFloat.random(in: 1...3))
   766→                        .position(
   767→                            x: CGFloat.random(in: 0...60),
   768→                            y: CGFloat.random(in: 0...60)
   769→                        )
   770→                }
   771→            }
   772→        }
   773→    }
   774→}
   775→
   776→struct FrameSettingsView_Previews: PreviewProvider {
   777→    static var previews: some View {
   778→        FrameSettingsView()
   779→    }
   780→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在也需要在 FrameSettingsView.swift 中更新布局按钮的图标，添加新样式的图标：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   196→            }
   197→        }
   198→    }
   199→    
   200→    // 根据布局类型返回对应的图标
   201→    private var layoutIcon: String {
   202→        switch layoutType {
   203→        case .centerFloat: return "rectangle.center.inset.filled"
   204→        case .bottomSymmetric: return "rectangle.bottomthird.inset.filled"
   205→        case .polaroid: return "rectangle.inset.bottomleading.filled"
   206→        case .bottomLeft: return "rectangle.bottomleft.inset.filled"
   207→        case .bottomInfoBar: return "rectangle.bottomthird.inset.filled"
   208→        case .magazineSidebar: return "rectangle.leadinghalf.inset.filled"
   209→        // 新增样式图标
   210→        case .filmStrip: return "film"
   211→        case .instantCamera: return "photo.on.rectangle.angled"
   212→        case .vintageFrame: return "rectangle.portrait.and.arrow.right"
   213→        case .artGallery: return "photo.artframe"
   214→        case .modernMinimal: return "rectangle.portrait"
   215→        case .scrapbook: return "photo.stack"
   216→        }
   217→    }
   218→}
   219→
   220→// Logo按钮
   221→struct LogoButton: View {
```

_**Agent (claude-sonnet-4-20250514)**_

现在完成第3个任务并开始第4个任务 - 优化水印功能：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [X] 🌡️ 扩展相框布局类型，添加新的创意样式
- [X] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [⚡] 🌡️ 优化水印功能，添加更多位置和效果选项
- [ ] 🌡️ 创建样式模板系统
- [ ] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

现在增强水印功能，首先更新 WatermarkSettings.swift：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettings.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import Foundation
     2→import UIKit
     3→
     4→// 水印位置类型（九宫格定位）
     5→enum WatermarkPosition: String, CaseIterable, Codable {
     6→    case topLeft = "左上角"
     7→    case topCenter = "上中"
     8→    case topRight = "右上角"
     9→    case centerLeft = "左中"
    10→    case center = "居中"
    11→    case centerRight = "右中"
    12→    case bottomLeft = "左下角"
    13→    case bottomCenter = "下中"
    14→    case bottomRight = "右下角"
    15→}
    16→
    17→// 水印样式类型
    18→enum WatermarkStyle: String, CaseIterable, Codable {
    19→    case simple = "简约"
    20→    case detailed = "详细"
    21→    case minimal = "极简"
    22→    case professional = "专业"
    23→    case creative = "创意"
    24→}
    25→
    26→// 水印阴影效果
    27→struct WatermarkShadow: Codable {
    28→    var enabled: Bool = false
    29→    var opacity: Float = 0.5
    30→    var blur: Float = 2.0
    31→    var offsetX: Float = 1.0
    32→    var offsetY: Float = 1.0
    33→    
    34→    static let `default` = WatermarkShadow()
    35→}
    36→
    37→struct WatermarkSettings: Codable {
    38→    var isEnabled: Bool = false
    39→    var authorName: String = ""
    40→    var showDeviceModel: Bool = true
    41→    var showFocalLength: Bool = true
    42→    var showShutterSpeed: Bool = true
    43→    var showISO: Bool = true
    44→    var showDate: Bool = true
    45→    
    46→    // 新增高级设置
    47→    var position: WatermarkPosition = .bottomRight
    48→    var style: WatermarkStyle = .simple
    49→    var textColorHex: String = "#FFFFFF"
    50→    var fontSize: Float = 16.0 // 字体大小 (10-30)
    51→    var opacity: Float = 0.8 // 透明度 (0.1-1.0)
    52→    var rotation: Float = 0.0 // 旋转角度 (-45到45度)
    53→    var shadow: WatermarkShadow = WatermarkShadow.default
    54→    var backgroundEnabled: Bool = false // 是否启用背景
    55→    var backgroundColorHex: String = "#000000"
    56→    var backgroundOpacity: Float = 0.3
    57→    
    58→    // 获取UIColor
    59→    var textColor: UIColor {
    60→        get {
    61→            return UIColor(hex: textColorHex) ?? .white
    62→        }
    63→        set {
    64→            textColorHex = newValue.toHex() ?? "#FFFFFF"
    65→        }
    66→    }
    67→    
    68→    var backgroundColor: UIColor {
    69→        get {
    70→            return UIColor(hex: backgroundColorHex) ?? .black
    71→        }
    72→        set {
    73→            backgroundColorHex = newValue.toHex() ?? "#000000"
    74→        }
    75→    }
    76→    
    77→    static let shared = WatermarkSettings()
    78→    
    79→    func save() {
    80→        if let data = try? JSONEncoder().encode(self) {
    81→            UserDefaults.standard.set(data, forKey: "WatermarkSettings")
```

_**Agent (claude-sonnet-4-20250514)**_

现在需要查看并更新 WatermarkService.swift 来实现新的功能：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkService.swift`

Result:

```
1→import UIKit
     2→import AVFoundation
     3→import Foundation
     4→
     5→class WatermarkService {
     6→    static let shared = WatermarkService()
     7→    
     8→    private init() {}
     9→    
    10→    func addWatermark(to image: UIImage, with captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) -> UIImage? {
    11→        let settings = WatermarkSettings.load()
    12→        
    13→        print("🎨 WatermarkService.addWatermark 被调用")
    14→        print("  - 设置启用: \(settings.isEnabled)")
    15→        print("  - 作者名字: '\(settings.authorName)'")
    16→        print("  - 图像尺寸: \(image.size)")
    17→        
    18→        guard settings.isEnabled else { 
    19→            print("  - 水印未启用，返回原图")
    20→            return image 
    21→        }
    22→        
    23→        let renderer = UIGraphicsImageRenderer(size: image.size)
    24→        
    25→        print("  - 开始绘制水印...")
    26→        let result = renderer.image { context in
    27→            image.draw(at: CGPoint.zero)
    28→            
    29→            let rect = CGRect(origin: CGPoint.zero, size: image.size)
    30→            drawWatermark(in: rect, context: context.cgContext, settings: settings, captureSettings: captureSettings, aspectRatio: aspectRatio)
    31→        }
    32→        
    33→        print("  ✅ 水印绘制完成")
    34→        return result
    35→    }
    36→    
    37→    private func drawWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) {
    38→        print("    🖌️ drawWatermark 开始")
    39→        print("      - 画布尺寸: \(rect.size)")
    40→        print("      - 作者名字: '\(settings.authorName)'")
    41→        
    42→        context.saveGState()
    43→        
    44→        // 确定有效绘制区域（考虑比例裁剪）
    45→        let effectiveRect: CGRect
    46→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
    47→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
    48→            print("      - 应用比例裁剪: \(aspectRatio.rawValue)")
    49→            print("      - 有效绘制区域: \(effectiveRect)")
    50→        } else {
    51→            effectiveRect = rect
    52→            print("      - 使用完整画布")
    53→        }
    54→        
    55→        // 根据有效区域尺寸动态计算字体大小，确保在不同分辨率下都有合适的比例
    56→        let imageWidth = effectiveRect.width
    57→        let imageHeight = effectiveRect.height
    58→        let baseSize = min(imageWidth, imageHeight)
    59→        
    60→        // 根据图片尺寸动态计算间距
    61→        let basePadding = baseSize * 0.02  // 2%的边距
    62→        let lineSpacing = baseSize * 0.008 // 0.8%的行间距
    63→        let bottomPadding = baseSize * 0.04 // 4%的底部边距
    64→        
    65→        let padding = basePadding
    66→        
    67→        // 根据参考图片，调小字体大小
    68→        let firstLineFontSize = baseSize * 0.032  // 调小到3.2%
    69→        let secondLineFontSize = baseSize * 0.025 // 调小到2.5%
    70→        
    71→        let firstLineFont = UIFont.systemFont(ofSize: firstLineFontSize, weight: .medium)
    72→        let secondLineFont = UIFont.systemFont(ofSize: secondLineFontSize, weight: .regular)
    73→        
    74→        print("      - 图片尺寸: \(imageWidth) x \(imageHeight)")
    75→        print("      - 第一行字体大小: \(firstLineFontSize)")
    76→        print("      - 第二行字体大小: \(secondLineFontSize)")
    77→        
    78→        let firstLineY = effectiveRect.maxY - bottomPadding - firstLineFont.lineHeight - lineSpacing - secondLineFont.lineHeight
    79→        let secondLineY = effectiveRect.maxY - bottomPadding - secondLineFont.lineHeight
    80→        
    81→        if !settings.authorName.isEmpty {
    82→            let firstLineText = "PHOTO BY \(settings.authorName)"
    83→            let textSize = firstLineText.size(withAttributes: [.font: firstLineFont])
    84→            let centerX = effectiveRect.minX + (effectiveRect.width - textSize.width) / 2
    85→            
    86→            drawText(firstLineText, 
    87→                    font: firstLineFont, 
    88→                    color: .white, 
    89→                    at: CGPoint(x: centerX, y: firstLineY), 
    90→                    in: context)
    91→        }
    92→        
    93→        var secondLineComponents: [String] = []
    94→        
    95→        if settings.showDeviceModel {
    96→            let deviceModel = getDetailedDeviceModel()
    97→            secondLineComponents.append(deviceModel)
    98→        }
    99→        
   100→        if settings.showFocalLength {
   101→            let focalLength = String(format: "%.0fmm", captureSettings.focalLength)
   102→            secondLineComponents.append(focalLength)
   103→        }
   104→        
   105→        if settings.showShutterSpeed {
   106→            let shutterSpeed = formatShutterSpeed(captureSettings.shutterSpeed)
   107→            secondLineComponents.append(shutterSpeed)
   108→        }
   109→        
   110→        if settings.showISO {
   111→            let iso = String(format: "ISO%.0f", captureSettings.iso)
   112→            secondLineComponents.append(iso)
   113→        }
   114→        
   115→        if settings.showDate {
   116→            let dateFormatter = DateFormatter()
   117→            dateFormatter.dateFormat = "yyyy.MM.dd"
   118→            let dateString = dateFormatter.string(from: Date())
   119→            secondLineComponents.append(dateString)
   120→        }
   121→        
   122→        if !secondLineComponents.isEmpty {
   123→            let leftText = secondLineComponents.first ?? ""
   124→            let centerText = secondLineComponents.count > 1 ? secondLineComponents[1...].prefix(2).joined(separator: "  ") : ""
   125→            let rightText = secondLineComponents.count > 3 ? secondLineComponents.last ?? "" : (secondLineComponents.count == 2 ? "" : secondLineComponents.last ?? "")
   126→            
   127→            drawText(leftText, 
   128→                    font: secondLineFont, 
   129→                    color: .white, 
   130→                    at: CGPoint(x: effectiveRect.minX + padding, y: secondLineY), 
   131→                    in: context)
   132→            
   133→            if !centerText.isEmpty {
   134→                let centerX = effectiveRect.minX + effectiveRect.width / 2
   135→                let centerSize = centerText.size(withAttributes: [.font: secondLineFont])
   136→                drawText(centerText, 
   137→                        font: secondLineFont, 
   138→                        color: .white, 
   139→                        at: CGPoint(x: centerX - centerSize.width / 2, y: secondLineY), 
   140→                        in: context)
   141→            }
   142→            
   143→            if !rightText.isEmpty && rightText != centerText && rightText != leftText {
   144→                let rightSize = rightText.size(withAttributes: [.font: secondLineFont])
   145→                drawText(rightText, 
   146→                        font: secondLineFont, 
   147→                        color: .white, 
   148→                        at: CGPoint(x: effectiveRect.maxX - padding - rightSize.width, y: secondLineY), 
   149→                        in: context)
   150→            }
   151→        }
   152→        
   153→        context.restoreGState()
   154→    }
   155→    
   156→    private func drawText(_ text: String, font: UIFont, color: UIColor, at point: CGPoint, in context: CGContext) {
   157→        // 先绘制黑色描边
   158→        let strokeAttributes: [NSAttributedString.Key: Any] = [
   159→            .font: font,
   160→            .foregroundColor: UIColor.black,
   161→            .strokeColor: UIColor.black,
   162→            .strokeWidth: 3.0  // 正值表示只绘制描边
   163→        ]
   164→        
   165→        let strokeString = NSAttributedString(string: text, attributes: strokeAttributes)
   166→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   167→        strokeString.draw(in: textRect)
   168→        
   169→        // 再绘制白色文字
   170→        let fillAttributes: [NSAttributedString.Key: Any] = [
   171→            .font: font,
   172→            .foregroundColor: color
   173→        ]
   174→        
   175→        let fillString = NSAttributedString(string: text, attributes: fillAttributes)
   176→        fillString.draw(in: textRect)
   177→    }
   178→    
   179→    private func formatShutterSpeed(_ speed: Double) -> String {
   180→        if speed >= 1.0 {
   181→            return String(format: "%.0fs", speed)
   182→        } else {
   183→            let denominator = Int(1.0 / speed)
   184→            return "1/\(denominator)s"
   185→        }
   186→    }
   187→    
   188→    private func getDetailedDeviceModel() -> String {
   189→        var systemInfo = utsname()
   190→        uname(&systemInfo)
   191→        
   192→        let machineMirror = Mirror(reflecting: systemInfo.machine)
   193→        let identifier = machineMirror.children.reduce("") { identifier, element in
   194→            guard let value = element.value as? Int8, value != 0 else { return identifier }
   195→            return identifier + String(UnicodeScalar(UInt8(value)))
   196→        }
   197→        
   198→        // 将设备标识符映射到友好名称
   199→        switch identifier {
   200→        case "iPhone14,2": return "iPhone 13 Pro"
   201→        case "iPhone14,3": return "iPhone 13 Pro Max"
   202→        case "iPhone14,4": return "iPhone 13 mini"
   203→        case "iPhone14,5": return "iPhone 13"
   204→        case "iPhone14,7": return "iPhone 13 mini"
   205→        case "iPhone14,8": return "iPhone 13"
   206→        case "iPhone15,2": return "iPhone 14 Pro"
   207→        case "iPhone15,3": return "iPhone 14 Pro Max"
   208→        case "iPhone15,4": return "iPhone 15"
   209→        case "iPhone15,5": return "iPhone 15 Plus"
   210→        case "iPhone16,1": return "iPhone 15 Pro"
   211→        case "iPhone16,2": return "iPhone 15 Pro Max"
   212→        case "iPhone17,1": return "iPhone 16 Pro"
   213→        case "iPhone17,2": return "iPhone 16 Pro Max"
   214→        case "iPhone17,3": return "iPhone 16"
   215→        case "iPhone17,4": return "iPhone 16 Plus"
   216→        default:
   217→            print("🔍 未知设备标识符: \(identifier)")
   218→            return UIDevice.current.model
   219→        }
   220→    }
   221→}
   222→
   223→
```

_**Agent (claude-sonnet-4-20250514)**_

现在更新 WatermarkService.swift，添加新的功能实现：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    33→        print("  ✅ 水印绘制完成")
    34→        return result
    35→    }
    36→    
    37→    private func drawWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings, aspectRatio: AspectRatio? = nil) {
    38→        print("    🖌️ drawWatermark 开始")
    39→        print("      - 画布尺寸: \(rect.size)")
    40→        print("      - 作者名字: '\(settings.authorName)'")
    41→        print("      - 水印位置: \(settings.position.rawValue)")
    42→        print("      - 水印样式: \(settings.style.rawValue)")
    43→        
    44→        context.saveGState()
    45→        
    46→        // 确定有效绘制区域（考虑比例裁剪）
    47→        let effectiveRect: CGRect
    48→        if let aspectRatio = aspectRatio, aspectRatio != .ratio4_3 {
    49→            effectiveRect = aspectRatio.getCropRect(for: rect.size)
    50→            print("      - 应用比例裁剪: \(aspectRatio.rawValue)")
    51→            print("      - 有效绘制区域: \(effectiveRect)")
    52→        } else {
    53→            effectiveRect = rect
    54→            print("      - 使用完整画布")
    55→        }
    56→        
    57→        // 应用旋转
    58→        if settings.rotation != 0 {
    59→            let centerX = effectiveRect.midX
    60→            let centerY = effectiveRect.midY
    61→            context.translateBy(x: centerX, y: centerY)
    62→            context.rotate(by: CGFloat(settings.rotation) * .pi / 180.0)
    63→            context.translateBy(x: -centerX, y: -centerY)
    64→        }
    65→        
    66→        // 根据不同样式绘制水印
    67→        switch settings.style {
    68→        case .simple:
    69→            drawSimpleWatermark(in: effectiveRect, context: context, settings: settings, captureSettings: captureSettings)
    70→        case .detailed:
    71→            drawDetailedWatermark(in: effectiveRect, context: context, settings: settings, captureSettings: captureSettings)
    72→        case .minimal:
    73→            drawMinimalWatermark(in: effectiveRect, context: context, settings: settings, captureSettings: captureSettings)
    74→        case .professional:
    75→            drawProfessionalWatermark(in: effectiveRect, context: context, settings: settings, captureSettings: captureSettings)
    76→        case .creative:
    77→            drawCreativeWatermark(in: effectiveRect, context: context, settings: settings, captureSettings: captureSettings)
    78→        }
    79→        
    80→        context.restoreGState()
    81→    }
    82→    
    83→    // 简约样式水印
    84→    private func drawSimpleWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings) {
    85→        let baseSize = min(rect.width, rect.height)
    86→        let fontSize = CGFloat(settings.fontSize) * baseSize / 1000.0
    87→        let font = UIFont.systemFont(ofSize: fontSize, weight: .regular)
    88→        
    89→        var watermarkText = ""
    90→        if !settings.authorName.isEmpty {
    91→            watermarkText = settings.authorName
    92→        } else {
    93→            // 组合相机参数
    94→            var components: [String] = []
    95→            if settings.showFocalLength {
    96→                components.append(String(format: "%.0fmm", captureSettings.focalLength))
    97→            }
    98→            if settings.showShutterSpeed {
    99→                components.append(formatShutterSpeed(captureSettings.shutterSpeed))
   100→            }
   101→            if settings.showISO {
   102→                components.append(String(format: "ISO%.0f", captureSettings.iso))
   103→            }
   104→            watermarkText = components.joined(separator: " ")
   105→        }
   106→        
   107→        let position = calculateWatermarkPosition(text: watermarkText, font: font, in: rect, position: settings.position)
   108→        drawStyledText(watermarkText, font: font, at: position, in: context, settings: settings)
   109→    }
   110→    
   111→    // 详细样式水印
   112→    private func drawDetailedWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings) {
   113→        let baseSize = min(rect.width, rect.height)
   114→        let padding = baseSize * 0.02
   115→        let lineSpacing = baseSize * 0.008
   116→        let bottomPadding = baseSize * 0.04
   117→        
   118→        let firstLineFontSize = CGFloat(settings.fontSize) * baseSize / 800.0
   119→        let secondLineFontSize = firstLineFontSize * 0.8
   120→        
   121→        let firstLineFont = UIFont.systemFont(ofSize: firstLineFontSize, weight: .medium)
   122→        let secondLineFont = UIFont.systemFont(ofSize: secondLineFontSize, weight: .regular)
   123→        
   124→        let firstLineY = rect.maxY - bottomPadding - firstLineFont.lineHeight - lineSpacing - secondLineFont.lineHeight
   125→        let secondLineY = rect.maxY - bottomPadding - secondLineFont.lineHeight
   126→        
   127→        if !settings.authorName.isEmpty {
   128→            let firstLineText = "PHOTO BY \(settings.authorName)"
   129→            let textSize = firstLineText.size(withAttributes: [.font: firstLineFont])
   130→            let centerX = rect.minX + (rect.width - textSize.width) / 2
   131→            
   132→            drawStyledText(firstLineText, font: firstLineFont, at: CGPoint(x: centerX, y: firstLineY), in: context, settings: settings)
   133→        }
   134→        
   135→        // 构建第二行信息
   136→        var secondLineComponents: [String] = []
   137→        
   138→        if settings.showDeviceModel {
   139→            secondLineComponents.append(getDetailedDeviceModel())
   140→        }
   141→        if settings.showFocalLength {
   142→            secondLineComponents.append(String(format: "%.0fmm", captureSettings.focalLength))
   143→        }
   144→        if settings.showShutterSpeed {
   145→            secondLineComponents.append(formatShutterSpeed(captureSettings.shutterSpeed))
   146→        }
   147→        if settings.showISO {
   148→            secondLineComponents.append(String(format: "ISO%.0f", captureSettings.iso))
   149→        }
   150→        if settings.showDate {
   151→            let dateFormatter = DateFormatter()
   152→            dateFormatter.dateFormat = "yyyy.MM.dd"
   153→            secondLineComponents.append(dateFormatter.string(from: Date()))
   154→        }
   155→        
   156→        if !secondLineComponents.isEmpty {
   157→            let secondLineText = secondLineComponents.joined(separator: " | ")
   158→            let textSize = secondLineText.size(withAttributes: [.font: secondLineFont])
   159→            let centerX = rect.minX + (rect.width - textSize.width) / 2
   160→            
   161→            drawStyledText(secondLineText, font: secondLineFont, at: CGPoint(x: centerX, y: secondLineY), in: context, settings: settings)
   162→        }
   163→    }
   164→    
   165→    // 极简样式水印
   166→    private func drawMinimalWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings) {
   167→        let baseSize = min(rect.width, rect.height)
   168→        let fontSize = CGFloat(settings.fontSize) * baseSize / 1200.0
   169→        let font = UIFont.systemFont(ofSize: fontSize, weight: .light)
   170→        
   171→        let watermarkText = settings.authorName.isEmpty ? 
   172→            String(format: "%.0fmm", captureSettings.focalLength) : 
   173→            settings.authorName
   174→        
   175→        let position = calculateWatermarkPosition(text: watermarkText, font: font, in: rect, position: settings.position)
   176→        drawStyledText(watermarkText, font: font, at: position, in: context, settings: settings)
   177→    }
   178→    
   179→    // 专业样式水印
   180→    private func drawProfessionalWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings) {
   181→        let baseSize = min(rect.width, rect.height)
   182→        let fontSize = CGFloat(settings.fontSize) * baseSize / 900.0
   183→        let font = UIFont.systemFont(ofSize: fontSize, weight: .semibold)
   184→        
   185→        var components: [String] = []
   186→        
   187→        if !settings.authorName.isEmpty {
   188→            components.append("© \(settings.authorName)")
   189→        }
   190→        if settings.showDeviceModel {
   191→            components.append(getDetailedDeviceModel())
   192→        }
   193→        if settings.showFocalLength && settings.showShutterSpeed && settings.showISO {
   194→            components.append("\(String(format: "%.0fmm", captureSettings.focalLength)) \(formatShutterSpeed(captureSettings.shutterSpeed)) \(String(format: "ISO%.0f", captureSettings.iso))")
   195→        }
   196→        
   197→        let watermarkText = components.joined(separator: " • ")
   198→        let position = calculateWatermarkPosition(text: watermarkText, font: font, in: rect, position: settings.position)
   199→        drawStyledText(watermarkText, font: font, at: position, in: context, settings: settings)
   200→    }
   201→    
   202→    // 创意样式水印
   203→    private func drawCreativeWatermark(in rect: CGRect, context: CGContext, settings: WatermarkSettings, captureSettings: CameraCaptureSettings) {
   204→        let baseSize = min(rect.width, rect.height)
   205→        let fontSize = CGFloat(settings.fontSize) * baseSize / 1000.0
   206→        let font = UIFont.systemFont(ofSize: fontSize, weight: .bold)
   207→        
   208→        // 创意样式：使用特殊符号和布局
   209→        var creativeText = ""
   210→        if !settings.authorName.isEmpty {
   211→            creativeText = "📷 \(settings.authorName)"
   212→        } else {
   213→            creativeText = "🎨 \(String(format: "%.0fmm", captureSettings.focalLength))"
   214→        }
   215→        
   216→        let position = calculateWatermarkPosition(text: creativeText, font: font, in: rect, position: settings.position)
   217→        drawStyledText(creativeText, font: font, at: position, in: context, settings: settings)
   218→    }
   219→    
   220→    // 计算水印位置
   221→    private func calculateWatermarkPosition(text: String, font: UIFont, in rect: CGRect, position: WatermarkPosition) -> CGPoint {
   222→        let textSize = text.size(withAttributes: [.font: font])
   223→        let padding = min(rect.width, rect.height) * 0.03
   224→        
   225→        switch position {
   226→        case .topLeft:
   227→            return CGPoint(x: rect.minX + padding, y: rect.minY + padding)
   228→        case .topCenter:
   229→            return CGPoint(x: rect.midX - textSize.width / 2, y: rect.minY + padding)
   230→        case .topRight:
   231→            return CGPoint(x: rect.maxX - padding - textSize.width, y: rect.minY + padding)
   232→        case .centerLeft:
   233→            return CGPoint(x: rect.minX + padding, y: rect.midY - textSize.height / 2)
   234→        case .center:
   235→            return CGPoint(x: rect.midX - textSize.width / 2, y: rect.midY - textSize.height / 2)
   236→        case .centerRight:
   237→            return CGPoint(x: rect.maxX - padding - textSize.width, y: rect.midY - textSize.height / 2)
   238→        case .bottomLeft:
   239→            return CGPoint(x: rect.minX + padding, y: rect.maxY - padding - textSize.height)
   240→        case .bottomCenter:
   241→            return CGPoint(x: rect.midX - textSize.width / 2, y: rect.maxY - padding - textSize.height)
   242→        case .bottomRight:
   243→            return CGPoint(x: rect.maxX - padding - textSize.width, y: rect.maxY - padding - textSize.height)
   244→        }
   245→    }
   246→    
   247→    // 绘制带样式的文本
   248→    private func drawStyledText(_ text: String, font: UIFont, at point: CGPoint, in context: CGContext, settings: WatermarkSettings) {
   249→        let textRect = CGRect(x: point.x, y: point.y, width: 1000, height: font.lineHeight)
   250→        
   251→        // 绘制背景（如果启用）
   252→        if settings.backgroundEnabled {
   253→            let textSize = text.size(withAttributes: [.font: font])
   254→            let backgroundRect = CGRect(x: point.x - 4, y: point.y - 2, 
   255→                                     width: textSize.width + 8, height: textSize.height + 4)
   256→            
   257→            context.setFillColor(settings.backgroundColor.withAlphaComponent(CGFloat(settings.backgroundOpacity)).cgColor)
   258→            context.fill(backgroundRect)
   259→        }
   260→        
   261→        // 创建文本属性
   262→        var textAttributes: [NSAttributedString.Key: Any] = [
   263→            .font: font,
   264→            .foregroundColor: settings.textColor.withAlphaComponent(CGFloat(settings.opacity))
   265→        ]
   266→        
   267→        // 添加阴影（如果启用）
   268→        if settings.shadow.enabled {
   269→            let shadow = NSShadow()
   270→            shadow.shadowColor = UIColor.black.withAlphaComponent(CGFloat(settings.shadow.opacity))
   271→            shadow.shadowOffset = CGSize(width: CGFloat(settings.shadow.offsetX), 
   272→                                       height: CGFloat(settings.shadow.offsetY))
   273→            shadow.shadowBlurRadius = CGFloat(settings.shadow.blur)
   274→            textAttributes[.shadow] = shadow
   275→        }
   276→        
   277→        let attributedString = NSAttributedString(string: text, attributes: textAttributes)
   278→        attributedString.draw(in: textRect)
   279→    }
   280→    
   281→    private func drawText(_ text: String, font: UIFont, color: UIColor, at point: CGPoint, in context: CGContext) {
   282→        // 先绘制黑色描边
   283→        let strokeAttributes: [NSAttributedString.Key: Any] = [
```

_**Agent (claude-sonnet-4-20250514)**_

现在需要清理一下 WatermarkService.swift 中重复的老方法：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   277→        let attributedString = NSAttributedString(string: text, attributes: textAttributes)
   278→        attributedString.draw(in: textRect)
   279→    }
   280→    
   281→    
   282→    private func formatShutterSpeed(_ speed: Double) -> String {
   283→        if speed >= 1.0 {
   284→            return String(format: "%.0fs", speed)
   285→        } else {
```

_**Agent (claude-sonnet-4-20250514)**_

现在更新 WatermarkSettingsView.swift 来添加新的设置选项：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Watermark/WatermarkSettingsView.swift`

Result:

```
1→import SwiftUI
     2→
     3→struct WatermarkSettingsView: View {
     4→    @State private var settings = WatermarkSettings.load()
     5→    @Environment(\.presentationMode) var presentationMode
     6→    
     7→    var body: some View {
     8→        NavigationView {
     9→            Form {
    10→                Section(header: Text("水印设置")) {
    11→                    Toggle("启用水印", isOn: $settings.isEnabled)
    12→                }
    13→                
    14→                Section(header: Text("第一行文字")) {
    15→                    HStack {
    16→                        Text("PHOTO BY")
    17→                        TextField("输入您的名字", text: $settings.authorName)
    18→                            .textFieldStyle(RoundedBorderTextFieldStyle())
    19→                    }
    20→                }
    21→                
    22→                Section(header: Text("第二行参数显示")) {
    23→                    Toggle("显示设备型号", isOn: $settings.showDeviceModel)
    24→                    Toggle("显示焦段", isOn: $settings.showFocalLength)
    25→                    Toggle("显示快门速度", isOn: $settings.showShutterSpeed)
    26→                    Toggle("显示ISO", isOn: $settings.showISO)
    27→                    Toggle("显示日期", isOn: $settings.showDate)
    28→                }
    29→                
    30→                Section(header: Text("预览效果")) {
    31→                    WatermarkPreview(settings: settings)
    32→                        .frame(height: 80)
    33→                        .background(Color.black)
    34→                        .cornerRadius(8)
    35→                }
    36→            }
    37→            .navigationTitle("水印设置")
    38→            .navigationBarItems(
    39→                leading: Button("取消") {
    40→                    presentationMode.wrappedValue.dismiss()
    41→                },
    42→                trailing: Button("保存") {
    43→                    settings.save()
    44→                    presentationMode.wrappedValue.dismiss()
    45→                }
    46→            )
    47→        }
    48→    }
    49→}
    50→
    51→struct WatermarkPreview: View {
    52→    let settings: WatermarkSettings
    53→    
    54→    var body: some View {
    55→        VStack(alignment: .leading, spacing: 4) {
    56→            Spacer()
    57→            
    58→            if !settings.authorName.isEmpty {
    59→                Text("PHOTO BY \(settings.authorName)")
    60→                    .font(.system(size: 14, weight: .medium))
    61→                    .foregroundColor(.white)
    62→            }
    63→            
    64→            HStack {
    65→                if settings.showDeviceModel {
    66→                    Text("iPhone 15 Pro")
    67→                        .font(.system(size: 12))
    68→                        .foregroundColor(.white)
    69→                }
    70→                
    71→                Spacer()
    72→                
    73→                HStack(spacing: 8) {
    74→                    if settings.showFocalLength {
    75→                        Text("24mm")
    76→                            .font(.system(size: 12))
    77→                            .foregroundColor(.white)
    78→                    }
    79→                    
    80→                    if settings.showShutterSpeed {
    81→                        Text("1/60s")
    82→                            .font(.system(size: 12))
    83→                            .foregroundColor(.white)
    84→                    }
    85→                    
    86→                    if settings.showISO {
    87→                        Text("ISO100")
    88→                            .font(.system(size: 12))
    89→                            .foregroundColor(.white)
    90→                    }
    91→                }
    92→                
    93→                Spacer()
    94→                
    95→                if settings.showDate {
    96→                    Text("2024.12.19")
    97→                        .font(.system(size: 12))
    98→                        .foregroundColor(.white)
    99→                }
   100→            }
   101→        }
   102→        .padding(.horizontal, 16)
   103→        .padding(.bottom, 12)
   104→    }
   105→}
   106→
   107→struct WatermarkSettingsView_Previews: PreviewProvider {
   108→    static var previews: some View {
   109→        WatermarkSettingsView()
   110→    }
   111→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在彻底重构 WatermarkSettingsView.swift 来支持所有新功能：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import SwiftUI
     2→
     3→struct WatermarkSettingsView: View {
     4→    @State private var settings = WatermarkSettings.load()
     5→    @Environment(\.presentationMode) var presentationMode
     6→    
     7→    var body: some View {
     8→        NavigationView {
     9→            Form {
    10→                // 基础设置
    11→                WatermarkBasicSection(settings: $settings)
    12→                
    13→                // 样式设置
    14→                WatermarkStyleSection(settings: $settings)
    15→                
    16→                // 内容设置
    17→                WatermarkContentSection(settings: $settings)
    18→                
    19→                // 高级设置
    20→                WatermarkAdvancedSection(settings: $settings)
    21→                
    22→                // 预览
    23→                WatermarkPreviewSection(settings: settings)
    24→            }
    25→            .navigationTitle("水印设置")
    26→            .navigationBarItems(
    27→                leading: Button("取消") {
    28→                    presentationMode.wrappedValue.dismiss()
    29→                },
    30→                trailing: Button("保存") {
    31→                    settings.save()
    32→                    presentationMode.wrappedValue.dismiss()
    33→                }
    34→            )
    35→        }
    36→    }
    37→}
    38→
    39→// 基础设置部分
    40→struct WatermarkBasicSection: View {
    41→    @Binding var settings: WatermarkSettings
    42→    
    43→    var body: some View {
    44→        Section(header: Text("基础设置")) {
    45→            Toggle("启用水印", isOn: $settings.isEnabled)
    46→            
    47→            HStack {
    48→                Text("作者署名")
    49→                TextField("输入您的名字", text: $settings.authorName)
    50→                    .textFieldStyle(RoundedBorderTextFieldStyle())
    51→            }
    52→        }
    53→    }
    54→}
    55→
    56→// 样式设置部分
    57→struct WatermarkStyleSection: View {
    58→    @Binding var settings: WatermarkSettings
    59→    
    60→    var body: some View {
    61→        Group {
    62→            Section(header: Text("样式设置")) {
    63→                // 水印样式选择
    64→                VStack(alignment: .leading) {
    65→                    Text("水印样式")
    66→                        .font(.body)
    67→                    
    68→                    ScrollView(.horizontal, showsIndicators: false) {
    69→                        HStack(spacing: 12) {
    70→                            ForEach(WatermarkStyle.allCases, id: \.self) { style in
    71→                                WatermarkStyleButton(
    72→                                    style: style,
    73→                                    isSelected: settings.style == style,
    74→                                    action: {
    75→                                        settings.style = style
    76→                                    }
    77→                                )
    78→                            }
    79→                        }
    80→                        .padding(.vertical, 8)
    81→                    }
    82→                }
    83→                .padding(.vertical, 4)
    84→                
    85→                // 位置选择
    86→                VStack(alignment: .leading) {
    87→                    Text("水印位置")
    88→                        .font(.body)
    89→                    
    90→                    LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 3), spacing: 8) {
    91→                        ForEach(WatermarkPosition.allCases, id: \.self) { position in
    92→                            WatermarkPositionButton(
    93→                                position: position,
    94→                                isSelected: settings.position == position,
    95→                                action: {
    96→                                    settings.position = position
    97→                                }
    98→                            )
    99→                        }
   100→                    }
   101→                }
   102→                .padding(.vertical, 4)
   103→            }
   104→        }
   105→    }
   106→}
   107→
   108→// 内容设置部分
   109→struct WatermarkContentSection: View {
   110→    @Binding var settings: WatermarkSettings
   111→    
   112→    var body: some View {
   113→        Section(header: Text("显示内容")) {
   114→            Toggle("显示设备型号", isOn: $settings.showDeviceModel)
   115→            Toggle("显示焦段", isOn: $settings.showFocalLength)
   116→            Toggle("显示快门速度", isOn: $settings.showShutterSpeed)
   117→            Toggle("显示ISO", isOn: $settings.showISO)
   118→            Toggle("显示日期", isOn: $settings.showDate)
   119→        }
   120→    }
   121→}
   122→
   123→// 高级设置部分
   124→struct WatermarkAdvancedSection: View {
   125→    @Binding var settings: WatermarkSettings
   126→    
   127→    var body: some View {
   128→        Group {
   129→            Section(header: Text("外观设置")) {
   130→                // 字体大小
   131→                VStack(alignment: .leading) {
   132→                    HStack {
   133→                        Text("字体大小")
   134→                        Spacer()
   135→                        Text("\(Int(settings.fontSize))")
   136→                            .foregroundColor(.secondary)
   137→                    }
   138→                    
   139→                    Slider(value: $settings.fontSize, in: 10...30, step: 1)
   140→                        .accentColor(.blue)
   141→                }
   142→                .padding(.vertical, 4)
   143→                
   144→                // 透明度
   145→                VStack(alignment: .leading) {
   146→                    HStack {
   147→                        Text("透明度")
   148→                        Spacer()
   149→                        Text("\(Int(settings.opacity * 100))%")
   150→                            .foregroundColor(.secondary)
   151→                    }
   152→                    
   153→                    Slider(value: $settings.opacity, in: 0.1...1.0, step: 0.1)
   154→                        .accentColor(.orange)
   155→                }
   156→                .padding(.vertical, 4)
   157→                
   158→                // 旋转角度
   159→                VStack(alignment: .leading) {
   160→                    HStack {
   161→                        Text("旋转角度")
   162→                        Spacer()
   163→                        Text("\(Int(settings.rotation))°")
   164→                            .foregroundColor(.secondary)
   165→                    }
   166→                    
   167→                    Slider(value: $settings.rotation, in: -45...45, step: 1)
   168→                        .accentColor(.purple)
   169→                }
   170→                .padding(.vertical, 4)
   171→                
   172→                // 文字颜色
   173→                ColorPicker("文字颜色", selection: Binding<Color>(
   174→                    get: { Color(settings.textColor) },
   175→                    set: { newColor in
   176→                        settings.textColor = UIColor(newColor)
   177→                    }
   178→                ))
   179→                .padding(.vertical, 2)
   180→            }
   181→            
   182→            Section(header: Text("背景和阴影")) {
   183→                // 背景设置
   184→                VStack(alignment: .leading) {
   185→                    Toggle("启用文字背景", isOn: $settings.backgroundEnabled)
   186→                        .padding(.vertical, 2)
   187→                    
   188→                    if settings.backgroundEnabled {
   189→                        Group {
   190→                            ColorPicker("背景颜色", selection: Binding<Color>(
   191→                                get: { Color(settings.backgroundColor) },
   192→                                set: { newColor in
   193→                                    settings.backgroundColor = UIColor(newColor)
   194→                                }
   195→                            ))
   196→                            
   197→                            VStack(alignment: .leading) {
   198→                                HStack {
   199→                                    Text("背景透明度")
   200→                                        .font(.caption)
   201→                                    Spacer()
   202→                                    Text("\(Int(settings.backgroundOpacity * 100))%")
   203→                                        .font(.caption)
   204→                                        .foregroundColor(.secondary)
   205→                                }
   206→                                
   207→                                Slider(value: $settings.backgroundOpacity, in: 0.1...1.0, step: 0.1)
   208→                                    .accentColor(.gray)
   209→                            }
   210→                        }
   211→                        .padding(.leading, 16)
   212→                    }
   213→                }
   214→                .padding(.vertical, 4)
   215→                
   216→                // 阴影设置
   217→                VStack(alignment: .leading) {
   218→                    Toggle("启用文字阴影", isOn: $settings.shadow.enabled)
   219→                        .padding(.vertical, 2)
   220→                    
   221→                    if settings.shadow.enabled {
   222→                        Group {
   223→                            VStack(alignment: .leading) {
   224→                                HStack {
   225→                                    Text("阴影透明度")
   226→                                        .font(.caption)
   227→                                    Spacer()
   228→                                    Text("\(Int(settings.shadow.opacity * 100))%")
   229→                                        .font(.caption)
   230→                                        .foregroundColor(.secondary)
   231→                                }
   232→                                
   233→                                Slider(value: $settings.shadow.opacity, in: 0.1...1.0, step: 0.1)
   234→                                    .accentColor(.gray)
   235→                            }
   236→                            
   237→                            VStack(alignment: .leading) {
   238→                                HStack {
   239→                                    Text("阴影模糊度")
   240→                                        .font(.caption)
   241→                                    Spacer()
   242→                                    Text("\(Int(settings.shadow.blur))")
   243→                                        .font(.caption)
   244→                                        .foregroundColor(.secondary)
   245→                                }
   246→                                
   247→                                Slider(value: $settings.shadow.blur, in: 0...10, step: 0.5)
   248→                                    .accentColor(.purple)
   249→                            }
   250→                        }
   251→                        .padding(.leading, 16)
   252→                    }
   253→                }
   254→                .padding(.vertical, 4)
   255→            }
   256→        }
   257→    }
   258→}
   259→
   260→// 预览部分
   261→struct WatermarkPreviewSection: View {
   262→    let settings: WatermarkSettings
   263→    
   264→    var body: some View {
   265→        Section(header: Text("预览效果")) {
   266→            WatermarkPreview(settings: settings)
   267→                .frame(height: 120)
   268→                .background(Color.black)
   269→                .cornerRadius(8)
   270→        }
   271→    }
   272→}
   273→
   274→struct WatermarkPreview: View {
   275→    let settings: WatermarkSettings
   276→
```

_**Agent (claude-sonnet-4-20250514)**_

现在需要在文件末尾添加新的按钮组件：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Watermark/WatermarkSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   270→        }
   271→    }
   272→}
   273→
   274→struct WatermarkPreview: View {
   275→    let settings: WatermarkSettings
   276→    
   277→    var body: some View {
   278→        GeometryReader { geometry in
   279→            ZStack {
   280→                // 示例图片背景
   281→                Color.gray.opacity(0.3)
   282→                
   283→                // 根据样式和位置显示预览水印
   284→                VStack {
   285→                    if positionNeedsTopPlacement() {
   286→                        previewWatermarkView()
   287→                        Spacer()
   288→                    } else if positionNeedsCenterPlacement() {
   289→                        Spacer()
   290→                        previewWatermarkView()
   291→                        Spacer()
   292→                    } else {
   293→                        Spacer()
   294→                        previewWatermarkView()
   295→                    }
   296→                }
   297→                .padding(8)
   298→            }
   299→        }
   300→    }
   301→    
   302→    // 判断是否需要顶部放置
   303→    private func positionNeedsTopPlacement() -> Bool {
   304→        return [.topLeft, .topCenter, .topRight].contains(settings.position)
   305→    }
   306→    
   307→    // 判断是否需要居中放置
   308→    private func positionNeedsCenterPlacement() -> Bool {
   309→        return [.centerLeft, .center, .centerRight].contains(settings.position)
   310→    }
   311→    
   312→    // 预览水印视图
   313→    private func previewWatermarkView() -> some View {
   314→        HStack {
   315→            if [.topLeft, .centerLeft, .bottomLeft].contains(settings.position) {
   316→                watermarkContent()
   317→                Spacer()
   318→            } else if [.topCenter, .center, .bottomCenter].contains(settings.position) {
   319→                Spacer()
   320→                watermarkContent()
   321→                Spacer()
   322→            } else {
   323→                Spacer()
   324→                watermarkContent()
   325→            }
   326→        }
   327→    }
   328→    
   329→    // 水印内容
   330→    private func watermarkContent() -> some View {
   331→        VStack(alignment: .leading, spacing: 2) {
   332→            // 根据样式显示不同内容
   333→            switch settings.style {
   334→            case .simple:
   335→                if !settings.authorName.isEmpty {
   336→                    Text(settings.authorName)
   337→                        .font(.system(size: CGFloat(settings.fontSize) * 0.6))
   338→                        .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   339→                } else {
   340→                    Text("24mm 1/60s ISO100")
   341→                        .font(.system(size: CGFloat(settings.fontSize) * 0.6))
   342→                        .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   343→                }
   344→                
   345→            case .detailed:
   346→                if !settings.authorName.isEmpty {
   347→                    Text("PHOTO BY \(settings.authorName)")
   348→                        .font(.system(size: CGFloat(settings.fontSize) * 0.6, weight: .medium))
   349→                        .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   350→                }
   351→                Text("iPhone 15 Pro | 24mm | 1/60s | ISO100 | 2024.12.19")
   352→                    .font(.system(size: CGFloat(settings.fontSize) * 0.5))
   353→                    .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   354→                
   355→            case .minimal:
   356→                Text(settings.authorName.isEmpty ? "24mm" : settings.authorName)
   357→                    .font(.system(size: CGFloat(settings.fontSize) * 0.5, weight: .light))
   358→                    .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   359→                
   360→            case .professional:
   361→                if !settings.authorName.isEmpty {
   362→                    Text("© \(settings.authorName) • iPhone 15 Pro • 24mm 1/60s ISO100")
   363→                        .font(.system(size: CGFloat(settings.fontSize) * 0.5, weight: .semibold))
   364→                        .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   365→                } else {
   366→                    Text("iPhone 15 Pro • 24mm 1/60s ISO100")
   367→                        .font(.system(size: CGFloat(settings.fontSize) * 0.5, weight: .semibold))
   368→                        .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   369→                }
   370→                
   371→            case .creative:
   372→                Text(settings.authorName.isEmpty ? "🎨 24mm" : "📷 \(settings.authorName)")
   373→                    .font(.system(size: CGFloat(settings.fontSize) * 0.6, weight: .bold))
   374→                    .foregroundColor(Color(settings.textColor).opacity(Double(settings.opacity)))
   375→            }
   376→        }
   377→        .rotationEffect(.degrees(Double(settings.rotation)))
   378→        .padding(settings.backgroundEnabled ? 4 : 0)
   379→        .background(
   380→            settings.backgroundEnabled ? 
   381→            Color(settings.backgroundColor).opacity(Double(settings.backgroundOpacity)) : 
   382→            Color.clear
   383→        )
   384→        .cornerRadius(settings.backgroundEnabled ? 4 : 0)
   385→    }
   386→}
   387→
   388→// 水印样式按钮
   389→struct WatermarkStyleButton: View {
   390→    let style: WatermarkStyle
   391→    let isSelected: Bool
   392→    let action: () -> Void
   393→    
   394→    var body: some View {
   395→        Button(action: action) {
   396→            VStack {
   397→                ZStack {
   398→                    RoundedRectangle(cornerRadius: 8)
   399→                        .fill(Color.gray.opacity(0.2))
   400→                        .frame(width: 80, height: 50)
   401→                    
   402→                    VStack(spacing: 2) {
   403→                        stylePreviewText()
   404→                    }
   405→                }
   406→                .overlay(
   407→                    RoundedRectangle(cornerRadius: 8)
   408→                        .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 2)
   409→                )
   410→                
   411→                Text(style.rawValue)
   412→                    .font(.caption)
   413→                    .foregroundColor(isSelected ? .orange : .primary)
   414→            }
   415→        }
   416→    }
   417→    
   418→    // 样式预览文本
   419→    private func stylePreviewText() -> some View {
   420→        Group {
   421→            switch style {
   422→            case .simple:
   423→                Text("Author")
   424→                    .font(.system(size: 8, weight: .regular))
   425→                    .foregroundColor(.primary)
   426→            case .detailed:
   427→                VStack(spacing: 1) {
   428→                    Text("PHOTO BY Author")
   429→                        .font(.system(size: 7, weight: .medium))
   430→                        .foregroundColor(.primary)
   431→                    Text("24mm 1/60s ISO100")
   432→                        .font(.system(size: 6))
   433→                        .foregroundColor(.secondary)
   434→                }
   435→            case .minimal:
   436→                Text("Author")
   437→                    .font(.system(size: 8, weight: .light))
   438→                    .foregroundColor(.primary)
   439→            case .professional:
   440→                Text("© Author • 24mm")
   441→                    .font(.system(size: 6, weight: .semibold))
   442→                    .foregroundColor(.primary)
   443→            case .creative:
   444→                Text("📷 Author")
   445→                    .font(.system(size: 7, weight: .bold))
   446→                    .foregroundColor(.primary)
   447→            }
   448→        }
   449→    }
   450→}
   451→
   452→// 水印位置按钮
   453→struct WatermarkPositionButton: View {
   454→    let position: WatermarkPosition
   455→    let isSelected: Bool
   456→    let action: () -> Void
   457→    
   458→    var body: some View {
   459→        Button(action: action) {
   460→            ZStack {
   461→                RoundedRectangle(cornerRadius: 6)
   462→                    .fill(Color.gray.opacity(0.2))
   463→                    .frame(height: 40)
   464→                
   465→                // 显示位置示意
   466→                HStack {
   467→                    if [.topLeft, .centerLeft, .bottomLeft].contains(position) {
   468→                        Circle()
   469→                            .fill(isSelected ? Color.orange : Color.gray)
   470→                            .frame(width: 4, height: 4)
   471→                        Spacer()
   472→                    } else if [.topCenter, .center, .bottomCenter].contains(position) {
   473→                        Spacer()
   474→                        Circle()
   475→                            .fill(isSelected ? Color.orange : Color.gray)
   476→                            .frame(width: 4, height: 4)
   477→                        Spacer()
   478→                    } else {
   479→                        Spacer()
   480→                        Circle()
   481→                            .fill(isSelected ? Color.orange : Color.gray)
   482→                            .frame(width: 4, height: 4)
   483→                    }
   484→                }
   485→                .padding(.horizontal, 8)
   486→                
   487→                Text(position.rawValue)
   488→                    .font(.system(size: 9))
   489→                    .foregroundColor(isSelected ? .orange : .primary)
   490→            }
   491→        }
   492→        .overlay(
   493→            RoundedRectangle(cornerRadius: 6)
   494→                .stroke(isSelected ? Color.orange : Color.clear, lineWidth: 1.5)
   495→        )
   496→    }
   497→}
   498→
   499→struct WatermarkSettingsView_Previews: PreviewProvider {
   500→    static var previews: some View {
   501→        WatermarkSettingsView()
```

_**Agent (claude-sonnet-4-20250514)**_

现在完成第4个任务，开始第5个任务 - 创建样式模板系统：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [X] 🌡️ 扩展相框布局类型，添加新的创意样式
- [X] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [X] 🌡️ 优化水印功能，添加更多位置和效果选项
- [⚡] 🌡️ 创建样式模板系统
- [ ] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

现在创建一个样式模板系统。首先创建一个新的文件来管理模板：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```swift
import Foundation

// 样式模板类型
enum FrameTemplateType: String, CaseIterable, Codable {
    case professional = "专业"
    case vintage = "复古"
    case modern = "现代"
    case artistic = "艺术"
    case minimal = "极简"
    case creative = "创意"
    case classic = "经典"
    case seasonal = "季节"
}

// 样式模板
struct FrameTemplate: Codable, Identifiable {
    let id = UUID()
    let name: String
    let type: FrameTemplateType
    let description: String
    let frameSettings: FrameSettings
    let watermarkSettings: WatermarkSettings
    let previewImageName: String?
    
    // 创建时间
    let createdAt: Date = Date()
    
    // 是否为系统预设模板
    let isSystemTemplate: Bool
    
    init(name: String, type: FrameTemplateType, description: String, 
         frameSettings: FrameSettings, watermarkSettings: WatermarkSettings, 
         previewImageName: String? = nil, isSystemTemplate: Bool = true) {
        self.name = name
        self.type = type
        self.description = description
        self.frameSettings = frameSettings
        self.watermarkSettings = watermarkSettings
        self.previewImageName = previewImageName
        self.isSystemTemplate = isSystemTemplate
    }
}

// 模板管理器
class FrameTemplateManager: ObservableObject {
    static let shared = FrameTemplateManager()
    
    @Published var templates: [FrameTemplate] = []
    
    private init() {
        loadTemplates()
        createSystemTemplates()
    }
    
    // 获取系统预设模板
    private func createSystemTemplates() {
        // 只在第一次启动时创建系统模板
        if templates.filter({ $0.isSystemTemplate }).isEmpty {
            templates.append(contentsOf: getSystemTemplates())
            saveTemplates()
        }
    }
    
    // 系统预设模板
    private func getSystemTemplates() -> [FrameTemplate] {
        var systemTemplates: [FrameTemplate] = []
        
        // 专业摄影师模板
        var professionalFrame = FrameSettings()
        professionalFrame.isEnabled = true
        professionalFrame.frameLayout = .polaroid
        professionalFrame.borderColorHex = "#FFFFFF"
        professionalFrame.borderOpacity = 1.0
        professionalFrame.cornerRadius = 0
        professionalFrame.frameTexture = .none
        professionalFrame.borderWidth = 15.0
        professionalFrame.displayContent.showParameters = true
        professionalFrame.displayContent.showDate = true
        
        var professionalWatermark = WatermarkSettings()
        professionalWatermark.isEnabled = true
        professionalWatermark.style = .professional
        professionalWatermark.position = .bottomRight
        professionalWatermark.textColorHex = "#FFFFFF"
        professionalWatermark.fontSize = 16.0
        professionalWatermark.opacity = 0.9
        
        systemTemplates.append(FrameTemplate(
            name: "专业摄影师",
            type: .professional,
            description: "适合专业摄影师使用的经典白色相框配置",
            frameSettings: professionalFrame,
            watermarkSettings: professionalWatermark
        ))
        
        // 复古胶卷模板
        var vintageFrame = FrameSettings()
        vintageFrame.isEnabled = true
        vintageFrame.frameLayout = .filmStrip
        vintageFrame.borderColorHex = "#2C1810"
        vintageFrame.borderOpacity = 0.9
        vintageFrame.cornerRadius = 5
        vintageFrame.frameTexture = .paper
        vintageFrame.borderWidth = 12.0
        
        var vintageWatermark = WatermarkSettings()
        vintageWatermark.isEnabled = true
        vintageWatermark.style = .detailed
        vintageWatermark.position = .bottomLeft
        vintageWatermark.textColorHex = "#F5F5DC"
        vintageWatermark.fontSize = 14.0
        vintageWatermark.opacity = 0.8
        
        systemTemplates.append(FrameTemplate(
            name: "复古胶卷",
            type: .vintage,
            description: "怀旧胶卷风格，带有纸质纹理效果",
            frameSettings: vintageFrame,
            watermarkSettings: vintageWatermark
        ))
        
        // 现代简约模板
        var modernFrame = FrameSettings()
        modernFrame.isEnabled = true
        modernFrame.frameLayout = .modernMinimal
        modernFrame.borderColorHex = "#F8F8FF"
        modernFrame.borderOpacity = 0.95
        modernFrame.cornerRadius = 8
        modernFrame.frameTexture = .none
        modernFrame.borderWidth = 8.0
        
        var modernWatermark = WatermarkSettings()
        modernWatermark.isEnabled = true
        modernWatermark.style = .minimal
        modernWatermark.position = .bottomCenter
        modernWatermark.textColorHex = "#333333"
        modernWatermark.fontSize = 12.0
        modernWatermark.opacity = 0.7
        
        systemTemplates.append(FrameTemplate(
            name: "现代简约",
            type: .modern,
            description: "简洁现代的设计风格，适合日常分享",
            frameSettings: modernFrame,
            watermarkSettings: modernWatermark
        ))
        
        // 艺术画廊模板
        var artisticFrame = FrameSettings()
        artisticFrame.isEnabled = true
        artisticFrame.frameLayout = .artGallery
        artisticFrame.borderColorHex = "#8B4513"
        artisticFrame.borderOpacity = 1.0
        artisticFrame.cornerRadius = 0
        artisticFrame.frameTexture = .wood
        artisticFrame.borderWidth = 20.0
        
        var artisticWatermark = WatermarkSettings()
        artisticWatermark.isEnabled = true
        artisticWatermark.style = .simple
        artisticWatermark.position = .bottomRight
        artisticWatermark.textColorHex = "#2F4F4F"
        artisticWatermark.fontSize = 15.0
        artisticWatermark.opacity = 0.8
        artisticWatermark.backgroundEnabled = true
        artisticWatermark.backgroundColorHex = "#FFFFFF"
        artisticWatermark.backgroundOpacity = 0.8
        
        systemTemplates.append(FrameTemplate(
            name: "艺术画廊",
            type: .artistic,
            description: "艺术展览风格的木质相框效果",
            frameSettings: artisticFrame,
            watermarkSettings: artisticWatermark
        ))
        
        // 创意剪贴簿模板
        var creativeFrame = FrameSettings()
        creativeFrame.isEnabled = true
        creativeFrame.frameLayout = .scrapbook
        creativeFrame.borderColorHex = "#FFF8DC"
        creativeFrame.borderOpacity = 0.9
        creativeFrame.cornerRadius = 12
        creativeFrame.frameTexture = .fabric
        creativeFrame.borderWidth = 18.0
        
        var creativeWatermark = WatermarkSettings()
        creativeWatermark.isEnabled = true
        creativeWatermark.style = .creative
        creativeWatermark.position = .bottomLeft
        creativeWatermark.textColorHex = "#8A2BE2"
        creativeWatermark.fontSize = 16.0
        creativeWatermark.opacity = 0.9
        creativeWatermark.rotation = -5
        
        systemTemplates.append(FrameTemplate(
            name: "创意剪贴簿",
            type: .creative,
            description: "充满创意的手工剪贴簿风格",
            frameSettings: creativeFrame,
            watermarkSettings: creativeWatermark
        ))
        
        // 极简风格模板
        var minimalFrame = FrameSettings()
        minimalFrame.isEnabled = false // 只使用水印，不用相框
        
        var minimalWatermark = WatermarkSettings()
        minimalWatermark.isEnabled = true
        minimalWatermark.style = .minimal
        minimalWatermark.position = .bottomRight
        minimalWatermark.textColorHex = "#FFFFFF"
        minimalWatermark.fontSize = 11.0
        minimalWatermark.opacity = 0.6
        
        systemTemplates.append(FrameTemplate(
            name: "极简主义",
            type: .minimal,
            description: "纯净无框，只保留最简洁的水印",
            frameSettings: minimalFrame,
            watermarkSettings: minimalWatermark
        ))
        
        return systemTemplates
    }
    
    // 按类型获取模板
    func getTemplates(by type: FrameTemplateType) -> [FrameTemplate] {
        return templates.filter { $0.type == type }
    }
    
    // 获取所有用户自定义模板
    func getUserTemplates() -> [FrameTemplate] {
        return templates.filter { !$0.isSystemTemplate }
    }
    
    // 添加自定义模板
    func addCustomTemplate(name: String, type: FrameTemplateType, description: String,
                          frameSettings: FrameSettings, watermarkSettings: WatermarkSettings) {
        let template = FrameTemplate(
            name: name,
            type: type,
            description: description,
            frameSettings: frameSettings,
            watermarkSettings: watermarkSettings,
            isSystemTemplate: false
        )
        
        templates.append(template)
        saveTemplates()
    }
    
    // 删除自定义模板
    func deleteTemplate(_ template: FrameTemplate) {
        // 只能删除用户自定义模板
        if !template.isSystemTemplate {
            templates.removeAll { $0.id == template.id }
            saveTemplates()
        }
    }
    
    // 应用模板
    func applyTemplate(_ template: FrameTemplate) {
        // 保存相框设置
        template.frameSettings.save()
        
        // 保存水印设置
        template.watermarkSettings.save()
        
        print("📋 已应用模板: \(template.name)")
    }
    
    // 保存模板到本地
    private func saveTemplates() {
        do {
            let data = try JSONEncoder().encode(templates)
            UserDefaults.standard.set(data, forKey: "FrameTemplates")
        } catch {
            print("❌ 保存模板失败: \(error)")
        }
    }
    
    // 从本地加载模板
    private func loadTemplates() {
        guard let data = UserDefaults.standard.data(forKey: "FrameTemplates"),
              let loadedTemplates = try? JSONDecoder().decode([FrameTemplate].self, from: data) else {
            templates = []
            return
        }
        
        templates = loadedTemplates
    }
    
    // 导出模板配置
    func exportTemplate(_ template: FrameTemplate) -> Data? {
        do {
            return try JSONEncoder().encode(template)
        } catch {
            print("❌ 导出模板失败: \(error)")
            return nil
        }
    }
    
    // 导入模板配置
    func importTemplate(from data: Data) -> Bool {
        do {
            let template = try JSONDecoder().decode(FrameTemplate.self, from: data)
            
            // 创建新的用户模板（避免ID冲突）
            addCustomTemplate(
                name: template.name + " (导入)",
                type: template.type,
                description: template.description,
                frameSettings: template.frameSettings,
                watermarkSettings: template.watermarkSettings
            )
            
            return true
        } catch {
            print("❌ 导入模板失败: \(error)")
            return false
        }
    }
}
```

Result:

```
File created successfully at: /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameTemplateManager.swift
```

_**Agent (claude-sonnet-4-20250514)**_

现在创建模板选择界面：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```swift
import SwiftUI

struct FrameTemplateView: View {
    @StateObject private var templateManager = FrameTemplateManager.shared
    @Environment(\.presentationMode) var presentationMode
    @State private var selectedCategory: FrameTemplateType = .professional
    @State private var showingCustomTemplateSheet = false
    @State private var showingTemplateDetail = false
    @State private var selectedTemplate: FrameTemplate?
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // 分类选择
                TemplateCategorySelector(selectedCategory: $selectedCategory)
                
                // 模板列表
                ScrollView {
                    LazyVGrid(columns: [
                        GridItem(.flexible(), spacing: 16),
                        GridItem(.flexible(), spacing: 16)
                    ], spacing: 16) {
                        ForEach(filteredTemplates) { template in
                            TemplateCard(
                                template: template,
                                action: {
                                    selectedTemplate = template
                                    showingTemplateDetail = true
                                }
                            )
                        }
                    }
                    .padding()
                }
            }
            .navigationTitle("样式模板")
            .navigationBarItems(
                leading: Button("关闭") {
                    presentationMode.wrappedValue.dismiss()
                },
                trailing: Menu("更多") {
                    Button(action: {
                        showingCustomTemplateSheet = true
                    }) {
                        Label("创建自定义模板", systemImage: "plus")
                    }
                    
                    Button(action: {
                        // TODO: 导入模板功能
                    }) {
                        Label("导入模板", systemImage: "square.and.arrow.down")
                    }
                } label: {
                    Image(systemName: "ellipsis.circle")
                }
            )
            .sheet(isPresented: $showingCustomTemplateSheet) {
                CreateCustomTemplateView()
            }
            .sheet(item: $selectedTemplate) { template in
                TemplateDetailView(template: template)
            }
        }
    }
    
    // 过滤后的模板
    private var filteredTemplates: [FrameTemplate] {
        templateManager.getTemplates(by: selectedCategory)
    }
}

// 分类选择器
struct TemplateCategorySelector: View {
    @Binding var selectedCategory: FrameTemplateType
    
    var body: some View {
        ScrollView(.horizontal, showsIndicators: false) {
            HStack(spacing: 12) {
                ForEach(FrameTemplateType.allCases, id: \.self) { category in
                    CategoryButton(
                        category: category,
                        isSelected: selectedCategory == category,
                        action: {
                            selectedCategory = category
                        }
                    )
                }
            }
            .padding(.horizontal)
        }
        .padding(.vertical, 8)
        .background(Color(UIColor.systemGray6))
    }
}

// 分类按钮
struct CategoryButton: View {
    let category: FrameTemplateType
    let isSelected: Bool
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            Text(category.rawValue)
                .font(.system(size: 14, weight: isSelected ? .semibold : .regular))
                .foregroundColor(isSelected ? .white : .primary)
                .padding(.horizontal, 16)
                .padding(.vertical, 8)
                .background(
                    RoundedRectangle(cornerRadius: 20)
                        .fill(isSelected ? Color.orange : Color.white)
                )
        }
    }
}

// 模板卡片
struct TemplateCard: View {
    let template: FrameTemplate
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            VStack(alignment: .leading, spacing: 8) {
                // 预览区域
                TemplatePreviewCard(template: template)
                    .frame(height: 120)
                    .background(Color.black)
                    .cornerRadius(8)
                
                // 模板信息
                VStack(alignment: .leading, spacing: 4) {
                    HStack {
                        Text(template.name)
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.primary)
                        
                        Spacer()
                        
                        if template.isSystemTemplate {
                            Image(systemName: "checkmark.seal.fill")
                                .font(.caption)
                                .foregroundColor(.blue)
                        } else {
                            Image(systemName: "person.fill")
                                .font(.caption)
                                .foregroundColor(.orange)
                        }
                    }
                    
                    Text(template.description)
                        .font(.caption)
                        .foregroundColor(.secondary)
                        .multilineTextAlignment(.leading)
                        .lineLimit(2)
                }
                .padding(.horizontal, 4)
            }
            .padding(12)
            .background(Color.white)
            .cornerRadius(12)
            .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
        }
        .buttonStyle(PlainButtonStyle())
    }
}

// 模板预览卡片
struct TemplatePreviewCard: View {
    let template: FrameTemplate
    
    var body: some View {
        GeometryReader { geometry in
            ZStack {
                // 示例图片背景
                Color.gray.opacity(0.7)
                
                // 应用模板效果预览
                VStack {
                    if template.frameSettings.isEnabled {
                        // 显示相框效果
                        Rectangle()
                            .fill(Color(template.frameSettings.borderColor).opacity(CGFloat(template.frameSettings.borderOpacity)))
                            .frame(width: geometry.size.width * 0.8, height: geometry.size.height * 0.7)
                            .cornerRadius(CGFloat(template.frameSettings.cornerRadius) * 0.5)
                            .overlay(
                                Rectangle()
                                    .fill(Color.gray.opacity(0.5))
                                    .frame(width: geometry.size.width * 0.6, height: geometry.size.height * 0.5)
                            )
                    } else {
                        // 无相框，只显示图像
                        Rectangle()
                            .fill(Color.gray.opacity(0.5))
                            .frame(width: geometry.size.width * 0.8, height: geometry.size.height * 0.7)
                    }
                    
                    // 显示水印位置和样式
                    if template.watermarkSettings.isEnabled {
                        HStack {
                            if [.bottomLeft, .centerLeft, .topLeft].contains(template.watermarkSettings.position) {
                                watermarkPreview()
                                Spacer()
                            } else if [.bottomCenter, .center, .topCenter].contains(template.watermarkSettings.position) {
                                Spacer()
                                watermarkPreview()
                                Spacer()
                            } else {
                                Spacer()
                                watermarkPreview()
                            }
                        }
                        .padding(.horizontal, 8)
                    }
                }
                .padding(4)
            }
        }
    }
    
    // 水印预览
    private func watermarkPreview() -> some View {
        Text(watermarkText())
            .font(.system(size: 6))
            .foregroundColor(Color(template.watermarkSettings.textColor))
            .opacity(Double(template.watermarkSettings.opacity))
            .rotationEffect(.degrees(Double(template.watermarkSettings.rotation)))
    }
    
    private func watermarkText() -> String {
        switch template.watermarkSettings.style {
        case .simple:
            return template.watermarkSettings.authorName.isEmpty ? "24mm" : template.watermarkSettings.authorName
        case .detailed:
            return "PHOTO BY Author"
        case .minimal:
            return "Author"
        case .professional:
            return "© Author"
        case .creative:
            return "📷 Author"
        }
    }
}

// 模板详情视图
struct TemplateDetailView: View {
    let template: FrameTemplate
    @Environment(\.presentationMode) var presentationMode
    @StateObject private var templateManager = FrameTemplateManager.shared
    @State private var showingDeleteAlert = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(alignment: .leading, spacing: 20) {
                    // 大预览
                    TemplatePreviewCard(template: template)
                        .frame(height: 200)
                        .background(Color.black)
                        .cornerRadius(12)
                    
                    // 模板信息
                    VStack(alignment: .leading, spacing: 12) {
                        HStack {
                            VStack(alignment: .leading) {
                                Text(template.name)
                                    .font(.title2)
                                    .fontWeight(.bold)
                                
                                Text(template.type.rawValue)
                                    .font(.subheadline)
                                    .foregroundColor(.orange)
                            }
                            
                            Spacer()
                            
                            if template.isSystemTemplate {
                                Label("系统模板", systemImage: "checkmark.seal.fill")
                                    .font(.caption)
                                    .foregroundColor(.blue)
                            } else {
                                Label("自定义模板", systemImage: "person.fill")
                                    .font(.caption)
                                    .foregroundColor(.orange)
                            }
                        }
                        
                        Text(template.description)
                            .font(.body)
                            .foregroundColor(.secondary)
                    }
                    
                    // 设置详情
                    VStack(alignment: .leading, spacing: 16) {
                        Text("模板配置")
                            .font(.headline)
                        
                        if template.frameSettings.isEnabled {
                            SettingRow(title: "相框样式", value: template.frameSettings.frameLayout.rawValue)
                            SettingRow(title: "相框纹理", value: template.frameSettings.frameTexture.rawValue)
                            SettingRow(title: "边框透明度", value: "\(Int(template.frameSettings.borderOpacity * 100))%")
                        } else {
                            SettingRow(title: "相框", value: "禁用")
                        }
                        
                        if template.watermarkSettings.isEnabled {
                            SettingRow(title: "水印样式", value: template.watermarkSettings.style.rawValue)
                            SettingRow(title: "水印位置", value: template.watermarkSettings.position.rawValue)
                            SettingRow(title: "字体大小", value: "\(Int(template.watermarkSettings.fontSize))")
                        } else {
                            SettingRow(title: "水印", value: "禁用")
                        }
                    }
                    
                    // 操作按钮
                    VStack(spacing: 12) {
                        Button(action: {
                            templateManager.applyTemplate(template)
                            presentationMode.wrappedValue.dismiss()
                        }) {
                            Text("应用此模板")
                                .font(.headline)
                                .foregroundColor(.white)
                                .frame(maxWidth: .infinity)
                                .padding()
                                .background(Color.orange)
                                .cornerRadius(12)
                        }
                        
                        HStack(spacing: 12) {
                            Button(action: {
                                // TODO: 分享模板
                            }) {
                                Label("分享", systemImage: "square.and.arrow.up")
                                    .frame(maxWidth: .infinity)
                                    .padding()
                                    .background(Color.blue)
                                    .foregroundColor(.white)
                                    .cornerRadius(8)
                            }
                            
                            if !template.isSystemTemplate {
                                Button(action: {
                                    showingDeleteAlert = true
                                }) {
                                    Label("删除", systemImage: "trash")
                                        .frame(maxWidth: .infinity)
                                        .padding()
                                        .background(Color.red)
                                        .foregroundColor(.white)
                                        .cornerRadius(8)
                                }
                            }
                        }
                    }
                }
                .padding()
            }
            .navigationTitle("模板详情")
            .navigationBarItems(trailing: Button("关闭") {
                presentationMode.wrappedValue.dismiss()
            })
            .alert(isPresented: $showingDeleteAlert) {
                Alert(
                    title: Text("删除模板"),
                    message: Text("确定要删除这个自定义模板吗？此操作无法撤销。"),
                    primaryButton: .destructive(Text("删除")) {
                        templateManager.deleteTemplate(template)
                        presentationMode.wrappedValue.dismiss()
                    },
                    secondaryButton: .cancel()
                )
            }
        }
    }
}

// 设置行
struct SettingRow: View {
    let title: String
    let value: String
    
    var body: some View {
        HStack {
            Text(title)
                .foregroundColor(.primary)
            Spacer()
            Text(value)
                .foregroundColor(.secondary)
        }
        .padding(.vertical, 4)
    }
}

// 创建自定义模板视图
struct CreateCustomTemplateView: View {
    @Environment(\.presentationMode) var presentationMode
    @StateObject private var templateManager = FrameTemplateManager.shared
    
    @State private var templateName = ""
    @State private var templateDescription = ""
    @State private var selectedType: FrameTemplateType = .professional
    
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("模板信息")) {
                    TextField("模板名称", text: $templateName)
                    
                    Picker("模板类型", selection: $selectedType) {
                        ForEach(FrameTemplateType.allCases, id: \.self) { type in
                            Text(type.rawValue).tag(type)
                        }
                    }
                    
                    TextField("模板描述", text: $templateDescription, axis: .vertical)
                        .lineLimit(3)
                }
                
                Section(header: Text("说明")) {
                    Text("将使用当前的相框和水印设置创建新模板")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            .navigationTitle("创建模板")
            .navigationBarItems(
                leading: Button("取消") {
                    presentationMode.wrappedValue.dismiss()
                },
                trailing: Button("创建") {
                    createTemplate()
                }
                .disabled(templateName.isEmpty)
            )
        }
    }
    
    private func createTemplate() {
        let currentFrameSettings = FrameSettings.load()
        let currentWatermarkSettings = WatermarkSettings.load()
        
        templateManager.addCustomTemplate(
            name: templateName,
            type: selectedType,
            description: templateDescription.isEmpty ? "用户自定义模板" : templateDescription,
            frameSettings: currentFrameSettings,
            watermarkSettings: currentWatermarkSettings
        )
        
        presentationMode.wrappedValue.dismiss()
    }
}

struct FrameTemplateView_Previews: PreviewProvider {
    static var previews: some View {
        FrameTemplateView()
    }
}
```

Result:

```
File created successfully at: /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameTemplateView.swift
```

_**Agent (claude-sonnet-4-20250514)**_

现在完成第5个任务，开始第6个任务 - 更新设置界面以支持新功能。首先在 FrameSettingsView 中添加模板入口：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [X] 🌡️ 扩展相框布局类型，添加新的创意样式
- [X] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [X] 🌡️ 优化水印功能，添加更多位置和效果选项
- [X] 🌡️ 创建样式模板系统
- [⚡] 🌡️ 更新设置界面以支持新功能
- [ ] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

现在在 FrameSettingsView.swift 中添加模板入口：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→import SwiftUI
     2→
     3→struct FrameSettingsView: View {
     4→    @State private var settings = FrameSettings.load()
     5→    @Environment(\.presentationMode) var presentationMode
     6→    @State private var showingTemplateView = false
     7→    
     8→    // 示例Logo图片名称数组
     9→    private let logoImages = [
    10→        "Apple_logo_black", 
    11→        "Canon_wordmark", 
    12→        "Nikon_Logo", 
    13→        "Sony_logo", 
    14→        "Fujifilm_logo", 
    15→        "Leica_Camera_logo", 
    16→        "Hasselblad_logo", 
    17→        "Olympus_Corporation_logo", 
    18→        "Panasonic_logo_(Blue)", 
    19→        "Polaroid_logo", 
    20→        "Ricoh_logo_2012", 
    21→        "Zeiss_logo", 
    22→        "Eastman_Kodak_Company_logo_(2016)(no_background)", 
    23→        "Arri_logo", 
    24→        "Panavision_logo", 
    25→        "dji-1"
    26→    ]
    27→    
    28→    var body: some View {
    29→        NavigationView {
    30→            Form {
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    26→    ]
    27→    
    28→    var body: some View {
    29→        NavigationView {
    30→            Form {
    31→                // 快速模板选择
    32→                FrameTemplateSection(showingTemplateView: $showingTemplateView)
    33→                
    34→                // 拆分为多个子视图
    35→                FrameEnableSection(settings: $settings)
    36→                FrameLayoutSection(settings: $settings, logoImages: logoImages)
    37→                FrameContentSection(settings: $settings)
    38→                FrameAdvancedSection(settings: $settings)
    39→                FramePreviewSection(settings: settings)
    40→            }
    41→            .navigationTitle("相框设置")
    42→            .navigationBarItems(
    43→                leading: Button("取消") {
    44→                    presentationMode.wrappedValue.dismiss()
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    45→                },
    46→                trailing: Button("保存") {
    47→                    settings.save()
    48→                    presentationMode.wrappedValue.dismiss()
    49→                }
    50→            )
    51→            .sheet(isPresented: $showingTemplateView) {
    52→                FrameTemplateView()
    53→            }
    54→            .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("FrameSettingsChanged"))) { _ in
    55→                // 当模板应用时，重新加载设置
    56→                settings = FrameSettings.load()
    57→            }
    58→        }
    59→    }
    60→}
    61→
    62→// 启用相框部分
    63→struct FrameEnableSection: View {
    64→    @Binding var settings: FrameSettings
```

_**Agent (claude-sonnet-4-20250514)**_

现在在文件末尾添加新的模板选择部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Error:

```
<tool_use_error>String to replace not found in file.
String: }

struct FrameSettingsView_Previews: PreviewProvider {
    static var previews: some View {
        FrameTemplateView()
    }
}</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

让我查看文件的末尾部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/Features/Frame/FrameSettingsView.swift`

Result:

```
770→                        path.move(to: CGPoint(x: CGFloat(i), y: 0))
   771→                        path.addLine(to: CGPoint(x: CGFloat(i), y: 60))
   772→                        path.move(to: CGPoint(x: 0, y: CGFloat(i)))
   773→                        path.addLine(to: CGPoint(x: 60, y: CGFloat(i)))
   774→                    }
   775→                }
   776→                .stroke(Color.gray.opacity(0.2), lineWidth: 0.3)
   777→            case .leather:
   778→                // 皮革纹理 - 随机颗粒
   779→                ForEach(0..<50, id: \.self) { _ in
   780→                    Circle()
   781→                        .fill(Color.brown.opacity(0.2))
   782→                        .frame(width: CGFloat.random(in: 1...3), 
   783→                               height: CGFloat.random(in: 1...3))
   784→                        .position(
   785→                            x: CGFloat.random(in: 0...60),
   786→                            y: CGFloat.random(in: 0...60)
   787→                        )
   788→                }
   789→            }
   790→        }
   791→    }
   792→}
   793→
   794→struct FrameSettingsView_Previews: PreviewProvider {
   795→    static var previews: some View {
   796→        FrameSettingsView()
   797→    }
   798→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在正确添加模板选择部分：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameSettingsView.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   788→                }
   789→            }
   790→        }
   791→    }
   792→}
   793→
   794→// 模板选择部分
   795→struct FrameTemplateSection: View {
   796→    @Binding var showingTemplateView: Bool
   797→    @StateObject private var templateManager = FrameTemplateManager.shared
   798→    
   799→    var body: some View {
   800→        Section(header: Text("快速选择")) {
   801→            Button(action: {
   802→                showingTemplateView = true
   803→            }) {
   804→                HStack {
   805→                    Image(systemName: "rectangle.3.group")
   806→                        .foregroundColor(.orange)
   807→                        .frame(width: 24)
   808→                    
   809→                    VStack(alignment: .leading) {
   810→                        Text("样式模板")
   811→                            .font(.body)
   812→                            .foregroundColor(.primary)
   813→                        Text("从预设模板中快速选择样式")
   814→                            .font(.caption)
   815→                            .foregroundColor(.secondary)
   816→                    }
   817→                    
   818→                    Spacer()
   819→                    
   820→                    Image(systemName: "chevron.right")
   821→                        .foregroundColor(.secondary)
   822→                        .font(.caption)
   823→                }
   824→            }
   825→            .padding(.vertical, 4)
   826→            
   827→            // 显示最近使用的模板
   828→            if !recentTemplates.isEmpty {
   829→                VStack(alignment: .leading) {
   830→                    Text("最近使用")
   831→                        .font(.caption)
   832→                        .foregroundColor(.secondary)
   833→                        .padding(.bottom, 4)
   834→                    
   835→                    ScrollView(.horizontal, showsIndicators: false) {
   836→                        HStack(spacing: 12) {
   837→                            ForEach(recentTemplates) { template in
   838→                                QuickTemplateButton(template: template)
   839→                            }
   840→                        }
   841→                        .padding(.vertical, 4)
   842→                    }
   843→                }
   844→            }
   845→        }
   846→    }
   847→    
   848→    // 获取最近使用的模板（前3个系统模板）
   849→    private var recentTemplates: [FrameTemplate] {
   850→        Array(templateManager.templates.filter { $0.isSystemTemplate }.prefix(3))
   851→    }
   852→}
   853→
   854→// 快速模板按钮
   855→struct QuickTemplateButton: View {
   856→    let template: FrameTemplate
   857→    @StateObject private var templateManager = FrameTemplateManager.shared
   858→    
   859→    var body: some View {
   860→        Button(action: {
   861→            templateManager.applyTemplate(template)
   862→            // 发送通知更新设置界面
   863→            NotificationCenter.default.post(name: NSNotification.Name("FrameSettingsChanged"), object: nil)
   864→        }) {
   865→            VStack(spacing: 4) {
   866→                // 小预览
   867→                ZStack {
   868→                    RoundedRectangle(cornerRadius: 6)
   869→                        .fill(Color.gray.opacity(0.3))
   870→                        .frame(width: 60, height: 40)
   871→                    
   872→                    if template.frameSettings.isEnabled {
   873→                        RoundedRectangle(cornerRadius: 3)
   874→                            .fill(Color(template.frameSettings.borderColor).opacity(0.8))
   875→                            .frame(width: 50, height: 30)
   876→                            .overlay(
   877→                                Rectangle()
   878→                                    .fill(Color.gray.opacity(0.6))
   879→                                    .frame(width: 35, height: 20)
   880→                            )
   881→                    }
   882→                    
   883→                    if template.watermarkSettings.isEnabled {
   884→                        VStack {
   885→                            Spacer()
   886→                            HStack {
   887→                                if [.bottomRight, .centerRight, .topRight].contains(template.watermarkSettings.position) {
   888→                                    Spacer()
   889→                                }
   890→                                
   891→                                Circle()
   892→                                    .fill(Color(template.watermarkSettings.textColor))
   893→                                    .frame(width: 3, height: 3)
   894→                                
   895→                                if [.bottomLeft, .centerLeft, .topLeft].contains(template.watermarkSettings.position) {
   896→                                    Spacer()
   897→                                }
   898→                            }
   899→                            .padding(.horizontal, 8)
   900→                        }
   901→                        .padding(.bottom, 4)
   902→                    }
   903→                }
   904→                
   905→                Text(template.name)
   906→                    .font(.system(size: 10))
   907→                    .foregroundColor(.primary)
   908→                    .multilineTextAlignment(.center)
   909→                    .lineLimit(2)
   910→            }
   911→            .frame(width: 70)
   912→        }
   913→    }
   914→}
   915→
   916→struct FrameSettingsView_Previews: PreviewProvider {
   917→    static var previews: some View {
   918→        FrameSettingsView()
   919→    }
   920→}
```

_**Agent (claude-sonnet-4-20250514)**_

现在需要更新 FrameTemplateManager 中的 save 方法，以便发送通知：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Features/Frame/FrameTemplateManager.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   258→            saveTemplates()
   259→        }
   260→    }
   261→    
   262→    // 应用模板
   263→    func applyTemplate(_ template: FrameTemplate) {
   264→        // 保存相框设置
   265→        template.frameSettings.save()
   266→        
   267→        // 保存水印设置
   268→        template.watermarkSettings.save()
   269→        
   270→        // 发送设置更新通知
   271→        NotificationCenter.default.post(name: NSNotification.Name("FrameSettingsChanged"), object: nil)
   272→        
   273→        print("📋 已应用模板: \(template.name)")
   274→    }
   275→    
   276→    // 保存模板到本地
   277→    private func saveTemplates() {
   278→        do {
```

_**Agent (claude-sonnet-4-20250514)**_

现在完成第6个任务，开始最后一个任务 - 测试新功能并优化用户体验。让我们运行一个简单的编译测试：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析现有相框功能的具体需求和增强点
- [X] 🌡️ 扩展相框布局类型，添加新的创意样式
- [X] 🌡️ 增强相框设置选项（透明度、圆角、纹理等）
- [X] 🌡️ 优化水印功能，添加更多位置和效果选项
- [X] 🌡️ 创建样式模板系统
- [X] 🌡️ 更新设置界面以支持新功能
- [⚡] 🌡️ 测试新功能并优化用户体验


_**Agent (claude-sonnet-4-20250514)**_

让我们运行一个简单的编译检查以确保代码正常工作：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 检查项目构建设置

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -configuration Debug -showBuildSettings | head -5`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -configuration Debug -showBuildSettings

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES
--- xcodebuild: WARNING: Using the first of multiple matching destinations:
{ platform:macOS, arch:arm64, variant:Designed for [iPad,iPhone], id:00008132-001C695E01C3001C, name:My Mac }
{ platform:iOS, id:dvtdevice-DVTiPhonePlaceholder-iphoneos:placeholder, name:Any iOS Device }
{ platform:iOS Simulator, id:dvtdevice-DVTiOSDeviceSimulatorPlaceholder-iphonesimulator:placeholder, name:Any iOS Simulator Device }
{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }
{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }
```

_**User**_

[Request interrupted by user]

