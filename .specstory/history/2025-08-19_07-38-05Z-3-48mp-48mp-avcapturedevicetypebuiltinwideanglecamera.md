<!-- Generated by SpecStory -->

# Camera Startup Optimization in Swift (2025-08-19 07:38:05Z)

<!-- Claude Code Session 9b381639-26dc-430e-9b00-f133009e691e (2025-08-19_07-38-05Z) -->

_**User**_

发现的相机数量: 3
🔍 48MP检查: 运行环境 = 真机
🔍 48MP检查: 设备类型 = AVCaptureDeviceTypeBuiltInWideAngleCamera
🔍 48MP检查: 设备名称 = Back Camera
🔍 48MP检查: 设备类型支持，开始检查格式...
🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP 是不是判断逻辑有错误? 手机是支持 4800w 像素的4800 万像素主摄：24 毫米焦距，ƒ/1.78 光圈，第二代传感器位移式光学图像防抖功能，七镜式镜头，100% Focus Pixels

---

_**Agent (claude-sonnet-4-20250514)**_

看起来您的 CameraService 在 48MP 检测方面遇到了问题。让我检查一下当前的实现逻辑。

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/CameraService.swift`

Result:

```
1→import AVFoundation
     2→import UIKit
     3→import Photos
     4→import CoreLocation
     5→import ImageIO
     6→import MobileCoreServices
     7→import UniformTypeIdentifiers
     8→
     9→class CameraService: NSObject, ObservableObject {
    10→    let session = AVCaptureSession()
    11→    private var videoOutput = AVCaptureVideoDataOutput()
    12→    private var photoOutput = AVCapturePhotoOutput()
    13→    private var currentDevice: AVCaptureDevice?
    14→    private var currentInput: AVCaptureDeviceInput?
    15→    
    16→    private let sessionQueue = DispatchQueue(label: "camera.session.queue")
    17→    
    18→    // 位置管理器
    19→    private let locationManager = CLLocationManager()
    20→    private var currentLocation: CLLocation?
    21→    
    22→    var previewLayer: AVCaptureVideoPreviewLayer {
    23→        let layer = AVCaptureVideoPreviewLayer(session: session)
    24→        layer.videoGravity = .resizeAspectFill
    25→        return layer
    26→    }
    27→    
    28→    var availableCameras: [AVCaptureDevice] = []
    29→    var currentCameraIndex: Int = 0
    30→    
    31→    // 添加设置相关的属性
    32→    private var currentPhotoFormat: PhotoFormat = .heic
    33→    private var currentPhotoResolution: PhotoResolution = .resolution12MP
    34→    
    35→    private var photoCompletionHandler: ((Result<Data, Error>) -> Void)?
    36→    
    37→    override init() {
    38→        super.init()
    39→        // 设置位置管理器
    40→        setupLocationManager()
    41→        // 立即进行快速初始化
    42→        quickSetup()
    43→    }
    44→    
    45→    private func quickSetup() {
    46→        print("🚀 开始快速设置相机")
    47→        // 所有相机设置移到后台线程，避免阻塞主线程
    48→        sessionQueue.async { [weak self] in
    49→            guard let self = self else { return }
    50→            
    51→            print("🎥 后台配置相机...")
    52→            // 使用默认后置相机进行快速设置
    53→            guard let defaultCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back) else {
    54→                print("❌ 无法获取默认相机")
    55→                return
    56→            }
    57→            
    58→            self.session.beginConfiguration()
    59→            
    60→            // 设置session preset
    61→            if self.session.canSetSessionPreset(.photo) {
    62→                self.session.sessionPreset = .photo
    63→            }
    64→            
    65→            // 配置默认相机
    66→            do {
    67→                let input = try AVCaptureDeviceInput(device: defaultCamera)
    68→                if self.session.canAddInput(input) {
    69→                    self.session.addInput(input)
    70→                    self.currentInput = input
    71→                    self.currentDevice = defaultCamera
    72→                }
    73→            } catch {
    74→                print("❌ 配置默认相机失败: \(error)")
    75→            }
    76→            
    77→            // 添加输出
    78→            self.session.addOutput(self.photoOutput)
    79→            
    80→            self.session.commitConfiguration()
    81→            
    82→            // 更新相机列表（在主线程）
    83→            DispatchQueue.main.async {
    84→                self.availableCameras = [defaultCamera]
    85→                print("✅ 快速设置完成，相机可用")
    86→            }
    87→            
    88→            // 发现其他相机
    89→            self.discoverAdditionalCameras()
    90→        }
    91→    }
    92→    
    93→    private func setupSession() {
    94→        // 已经在 sessionQueue 中调用，不需要再次异步
    95→        session.beginConfiguration()
    96→        
    97→        // 根据分辨率设置session preset
    98→        let sessionPreset = getSessionPreset(for: currentPhotoResolution)
    99→        if session.canSetSessionPreset(sessionPreset) {
   100→            session.sessionPreset = sessionPreset
   101→        } else {
   102→            session.sessionPreset = .photo
   103→        }
   104→        
   105→        // 按照Apple AVCam方式配置photoOutput
   106→        if session.canAddOutput(photoOutput) {
   107→            session.addOutput(photoOutput)
   108→            
   109→            // Apple方式：只在设备支持时启用高分辨率捕获
   110→            photoOutput.isHighResolutionCaptureEnabled = true
   111→            print("🔍 PhotoOutput配置: 高分辨率捕获已启用")
   112→            
   113→            // 确保photoOutput支持我们需要的功能
   114→            photoOutput.maxPhotoQualityPrioritization = .quality
   115→        } else {
   116→            print("❌ 无法添加photoOutput")
   117→        }
   118→        
   119→        session.commitConfiguration()
   120→        
   121→        print("📸 相机输出配置:")
   122→        print("  - 高分辨率捕获: \(photoOutput.isHighResolutionCaptureEnabled)")
   123→        print("  - 会话预设: \(session.sessionPreset.rawValue)")
   124→    }
   125→    
   126→    private func discoverAdditionalCameras() {
   127→        // 发现其他可用相机（超广角、长焦等）
   128→        let deviceTypes: [AVCaptureDevice.DeviceType] = [
   129→            .builtInUltraWideCamera,
   130→            .builtInWideAngleCamera,
   131→            .builtInTelephotoCamera,
   132→            .builtInTripleCamera,
   133→            .builtInDualCamera,
   134→            .builtInDualWideCamera
   135→        ]
   136→        
   137→        let discoverySession = AVCaptureDevice.DiscoverySession(
   138→            deviceTypes: deviceTypes,
   139→            mediaType: .video,
   140→            position: .back
   141→        )
   142→        
   143→        let allDevices = discoverySession.devices
   144→        var newCameras: [AVCaptureDevice] = []
   145→        
   146→        // 按优先级顺序添加相机
   147→        if let ultraWide = allDevices.first(where: { $0.deviceType == .builtInUltraWideCamera }) {
   148→            newCameras.append(ultraWide)
   149→        }
   150→        
   151→        if let wide = allDevices.first(where: { $0.deviceType == .builtInWideAngleCamera }) {
   152→            newCameras.append(wide)
   153→        } else if let triple = allDevices.first(where: { $0.deviceType == .builtInTripleCamera }) {
   154→            newCameras.append(triple)
   155→        } else if let dual = allDevices.first(where: { $0.deviceType == .builtInDualCamera }) {
   156→            newCameras.append(dual)
   157→        } else if let dualWide = allDevices.first(where: { $0.deviceType == .builtInDualWideCamera }) {
   158→            newCameras.append(dualWide)
   159→        }
   160→        
   161→        if let telephoto = allDevices.first(where: { $0.deviceType == .builtInTelephotoCamera }) {
   162→            newCameras.append(telephoto)
   163→        }
   164→        
   165→        // 更新相机列表
   166→        DispatchQueue.main.async { [weak self] in
   167→            self?.availableCameras = newCameras.isEmpty ? (self?.availableCameras ?? []) : newCameras
   168→            print("发现的相机数量: \(self?.availableCameras.count ?? 0)")
   169→        }
   170→    }
   171→    
   172→    private func discoverCameras() {
   173→        // 尝试发现所有可能的后置摄像头
   174→        let deviceTypes: [AVCaptureDevice.DeviceType] = [
   175→            .builtInUltraWideCamera,
   176→            .builtInWideAngleCamera,
   177→            .builtInTelephotoCamera,
   178→            .builtInTripleCamera,
   179→            .builtInDualCamera,
   180→            .builtInDualWideCamera
   181→        ]
   182→        
   183→        let discoverySession = AVCaptureDevice.DiscoverySession(
   184→            deviceTypes: deviceTypes,
   185→            mediaType: .video,
   186→            position: .back
   187→        )
   188→        
   189→        // 获取所有发现的设备
   190→        let allDevices = discoverySession.devices
   191→        
   192→        // 按优先级顺序添加相机
   193→        availableCameras = []
   194→        
   195→        // 添加超广角
   196→        if let ultraWide = allDevices.first(where: { $0.deviceType == .builtInUltraWideCamera }) {
   197→            availableCameras.append(ultraWide)
   198→        }
   199→        
   200→        // 添加主摄像头（广角）
   201→        if let wide = allDevices.first(where: { $0.deviceType == .builtInWideAngleCamera }) {
   202→            availableCameras.append(wide)
   203→        } else if let triple = allDevices.first(where: { $0.deviceType == .builtInTripleCamera }) {
   204→            availableCameras.append(triple)
   205→        } else if let dual = allDevices.first(where: { $0.deviceType == .builtInDualCamera }) {
   206→            availableCameras.append(dual)
   207→        } else if let dualWide = allDevices.first(where: { $0.deviceType == .builtInDualWideCamera }) {
   208→            availableCameras.append(dualWide)
   209→        }
   210→        
   211→        // 添加长焦
   212→        if let telephoto = allDevices.first(where: { $0.deviceType == .builtInTelephotoCamera }) {
   213→            availableCameras.append(telephoto)
   214→        }
   215→        
   216→        // 如果没找到任何指定类型的相机，使用默认的后置相机
   217→        if availableCameras.isEmpty {
   218→            if let defaultCamera = AVCaptureDevice.default(.builtInWideAngleCamera, for: .video, position: .back) {
   219→                availableCameras.append(defaultCamera)
   220→            }
   221→        }
   222→        
   223→        print("发现的相机数量: \(availableCameras.count)")
   224→        for (index, camera) in availableCameras.enumerated() {
   225→            print("相机 \(index): \(camera.deviceType.rawValue)")
   226→        }
   227→        
   228→        // 配置默认相机
   229→        if let defaultCamera = availableCameras.first {
   230→            configureCamera(defaultCamera)
   231→        }
   232→    }
   233→    
   234→    private func configureCamera(_ device: AVCaptureDevice) {
   235→        sessionQueue.async { [weak self] in
   236→            guard let self = self else { return }
   237→            
   238→            self.session.beginConfiguration()
   239→            
   240→            if let currentInput = self.currentInput {
   241→                self.session.removeInput(currentInput)
   242→            }
   243→            
   244→            do {
   245→                let input = try AVCaptureDeviceInput(device: device)
   246→                if self.session.canAddInput(input) {
   247→                    self.session.addInput(input)
   248→                    self.currentInput = input
   249→                    self.currentDevice = device
   250→                    
   251→                    // 为48MP配置设备格式
   252→                    if self.currentPhotoResolution == .resolution48MP {
   253→                        self.configure48MPFormat(for: device)
   254→                    }
   255→                }
   256→            } catch {
   257→                print("Error configuring camera: \(error)")
   258→            }
   259→            
   260→            self.session.commitConfiguration()
   261→        }
   262→    }
   263→    
   264→    // 检查是否在模拟器上运行
   265→    private var isRunningOnSimulator: Bool {
   266→        #if targetEnvironment(simulator)
   267→        return true
   268→        #else
   269→        return false
   270→        #endif
   271→    }
   272→    
   273→    // 检查设备是否支持48MP
   274→    var is48MPAvailable: Bool {
   275→        guard let device = currentDevice else { 
   276→            print("🔍 48MP检查: 无当前设备")
   277→            return false 
   278→        }
   279→        
   280→        print("🔍 48MP检查: 运行环境 = \(isRunningOnSimulator ? "模拟器" : "真机")")
   281→        print("🔍 48MP检查: 设备类型 = \(device.deviceType.rawValue)")
   282→        print("🔍 48MP检查: 设备名称 = \(device.localizedName)")
   283→        
   284→        // 在模拟器上，48MP功能通常不可用
   285→        if isRunningOnSimulator {
   286→            print("🔍 48MP检查: 模拟器环境，48MP功能可能不可用")
   287→            // 但我们仍然继续检查，以便调试
   288→        }
   289→        
   290→        // 检查是否是主摄像头（48MP只在主摄上可用）
   291→        guard device.deviceType == .builtInWideAngleCamera || 
   292→              device.deviceType == .builtInTripleCamera ||
   293→              device.deviceType == .builtInDualCamera ||
   294→              device.deviceType == .builtInDualWideCamera else {
   295→            print("🔍 48MP检查: 设备类型不支持 (\(device.deviceType.rawValue))")
   296→            return false
   297→        }
   298→        
   299→        print("🔍 48MP检查: 设备类型支持，开始检查格式...")
   300→        
   301→        // 遍历设备所有可用格式，寻找支持高分辨率照片的格式
   302→        var maxMegapixels = 0
   303→        for format in device.formats {
   304→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   305→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   306→            
   307→            if megapixels > maxMegapixels {
   308→                maxMegapixels = megapixels
   309→            }
   310→            
   311→            // 检查是否支持48MP（约48万像素）
   312→            if megapixels >= 40 {
   313→                print("🔍 48MP检查: 找到48MP格式 \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   314→                return true
   315→            }
   316→        }
   317→        
   318→        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP")
   319→        
   320→        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
   321→        #if DEBUG
   322→        if isRunningOnSimulator && 
   323→           (device.deviceType == .builtInWideAngleCamera || 
   324→            device.deviceType == .builtInTripleCamera) {
   325→            print("🔍 48MP检查: [开发者模式] 模拟器上强制启用48MP支持用于调试")
   326→            return true
   327→        }
   328→        #endif
   329→        
   330→        return false
   331→    }
   332→
   333→    // 辅助函数，用于获取48MP格式
   334→    private func find48MPFormat() -> AVCaptureDevice.Format? {
   335→        guard let device = currentDevice else { return nil }
   336→        
   337→        // 检查是否是主摄像头
   338→        guard device.deviceType == .builtInWideAngleCamera || 
   339→              device.deviceType == .builtInTripleCamera else {
   340→            return nil
   341→        }
   342→        
   343→        // 寻找支持48MP的格式（分辨率约为48万像素或更高）
   344→        for format in device.formats {
   345→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   346→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   347→            
   348→            // 检查是否支持48MP（约48万像素）
   349→            if megapixels >= 40 {
   350→                return format
   351→            }
   352→        }
   353→        return nil
   354→    }
   355→    
   356→    // 配置48MP模式的方法
   357→    func configureFor48MP(enable: Bool) {
   358→        guard let device = currentDevice else { return }
   359→        
   360→        sessionQueue.async { [weak self] in
   361→            guard let self = self else { return }
   362→            
   363→            // 确保设备支持，并且我们想要启用它
   364→            if enable, let highResFormat = self.find48MPFormat() {
   365→                do {
   366→                    try device.lockForConfiguration()
   367→                    
   368→                    // 1. 将设备的活动格式设置为我们找到的48MP格式
   369→                    device.activeFormat = highResFormat
   370→                    let dimensions = CMVideoFormatDescriptionGetDimensions(highResFormat.formatDescription)
   371→                    print("📸 成功设置48MP格式: \(dimensions.width)x\(dimensions.height)")
   372→                    
   373→                    // 2. 启用 photoOutput 的高分辨率照片功能
   374→                    if self.photoOutput.isHighResolutionCaptureEnabled {
   375→                        print("📸 PhotoOutput已支持高分辨率")
   376→                    } else {
   377→                        print("⚠️ PhotoOutput不支持高分辨率")
   378→                    }
   379→                    
   380→                    device.unlockForConfiguration()
   381→                    print("✅ 成功配置48MP模式")
   382→                    
   383→                } catch {
   384→                    print("❌ 配置48MP失败: \(error)")
   385→                }
   386→            } else {
   387→                // 如果要禁用48MP，或者设备不支持，则恢复到默认格式
   388→                do {
   389→                    try device.lockForConfiguration()
   390→                    
   391→                    // 选择一个合适的默认格式（通常是第一个支持photo的格式）
   392→                    if let defaultFormat = device.formats.first(where: { format in
   393→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   394→                        let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   395→                        return megapixels >= 10 && megapixels < 20 // 选择12MP左右的格式
   396→                    }) {
   397→                        device.activeFormat = defaultFormat
   398→                        let dimensions = CMVideoFormatDescriptionGetDimensions(defaultFormat.formatDescription)
   399→                        print("📸 设置标准格式: \(dimensions.width)x\(dimensions.height)")
   400→                    }
   401→                    
   402→                    device.unlockForConfiguration()
   403→                    print("📸 恢复到标准分辨率模式")
   404→                    
   405→                } catch {
   406→                    print("❌ 配置标准格式失败: \(error)")
   407→                }
   408→            }
   409→        }
   410→    }
   411→    
   412→    // 新增方法：配置48MP格式（保留旧方法用于兼容）
   413→    private func configure48MPFormat(for device: AVCaptureDevice) {
   414→        // 调用新的配置方法
   415→        configureFor48MP(enable: true)
   416→    }
   417→    
   418→    func requestPermissions(completion: @escaping (Bool) -> Void) {
   419→        let cameraAuthStatus = AVCaptureDevice.authorizationStatus(for: .video)
   420→        
   421→        switch cameraAuthStatus {
   422→        case .authorized:
   423→            completion(true)
   424→        case .notDetermined:
   425→            AVCaptureDevice.requestAccess(for: .video) { granted in
   426→                DispatchQueue.main.async {
   427→                    completion(granted)
   428→                }
   429→            }
   430→        default:
   431→            completion(false)
   432→        }
   433→    }
   434→    
   435→    func startSession() {
   436→        sessionQueue.async { [weak self] in
   437→            guard let self = self, !self.session.isRunning else { return }
   438→            self.session.startRunning()
   439→        }
   440→    }
   441→    
   442→    func stopSession() {
   443→        sessionQueue.async { [weak self] in
   444→            guard let self = self, self.session.isRunning else { return }
   445→            self.session.stopRunning()
   446→        }
   447→    }
   448→    
   449→    func switchCamera(to index: Int) {
   450→        guard index >= 0 && index < availableCameras.count else { return }
   451→        
   452→        let selectedCamera = availableCameras[index]
   453→        currentCameraIndex = index
   454→        
   455→        print("🔄 切换相机到索引 \(index)")
   456→        print("🔄 选中的相机: \(selectedCamera.localizedName) (\(selectedCamera.deviceType.rawValue))")
   457→        
   458→        // 检查新相机是否支持当前的48MP设置
   459→        let wasUsing48MP = (currentPhotoResolution == .resolution48MP)
   460→        
   461→        configureCamera(selectedCamera)
   462→        
   463→        // 切换后检查48MP支持情况
   464→        print("🔄 切换后48MP可用性: \(is48MPAvailable)")
   465→        
   466→        // 如果之前使用48MP但新相机不支持，需要通知切换回12MP
   467→        if wasUsing48MP && !is48MPAvailable {
   468→            print("🔄 新相机不支持48MP，通知切换回12MP")
   469→            DispatchQueue.main.async {
   470→                NotificationCenter.default.post(
   471→                    name: NSNotification.Name("CameraSwitchRequires12MP"),
   472→                    object: nil
   473→                )
   474→            }
   475→        }
   476→    }
   477→    
   478→    func capturePhoto(completion: @escaping (Result<Data, Error>) -> Void) {
   479→        sessionQueue.async { [weak self] in
   480→            guard let self = self else { return }
   481→            
   482→            // 检查 session 是否在运行
   483→            guard self.session.isRunning else {
   484→                DispatchQueue.main.async {
   485→                    completion(.failure(NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "相机未启动"])))
   486→                }
   487→                return
   488→            }
   489→            
   490→            // 按照Apple AVCam标准方式创建photo settings，使用用户选择的格式
   491→            let settings = getPhotoSettings(for: currentPhotoFormat)
   492→            
   493→            // 设置闪光灯模式
   494→            if let currentDevice = self.currentDevice, currentDevice.hasFlash {
   495→                settings.flashMode = .auto
   496→            } else {
   497→                settings.flashMode = .off
   498→            }
   499→            
   500→            // 使用设备支持的最高质量设置
   501→            let maxQuality = self.photoOutput.maxPhotoQualityPrioritization
   502→            if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.quality.rawValue {
   503→                settings.photoQualityPrioritization = .quality
   504→            } else if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.balanced.rawValue {
   505→                settings.photoQualityPrioritization = .balanced
   506→            } else {
   507→                settings.photoQualityPrioritization = .speed
   508→            }
   509→            
   510→            // Apple方式：只在支持时启用高分辨率
   511→            if self.photoOutput.isHighResolutionCaptureEnabled {
   512→                settings.isHighResolutionPhotoEnabled = true
   513→            }
   514→            
   515→            // Apple建议：启用嵌入式缩略图以获得更好的相册体验
   516→            if settings.availableEmbeddedThumbnailPhotoCodecTypes.contains(.jpeg) {
   517→                settings.embeddedThumbnailPhotoFormat = [
   518→                    AVVideoCodecKey: AVVideoCodecType.jpeg
   519→                ]
   520→            }
   521→            
   522→            // 设置方向信息
   523→            if let connection = self.photoOutput.connection(with: .video) {
   524→                if connection.isVideoOrientationSupported {
   525→                    connection.videoOrientation = .portrait
   526→                }
   527→            }
   528→            
   529→            let qualityName = getQualityName(settings.photoQualityPrioritization)
   530→            let maxQualityName = getQualityName(maxQuality)
   531→            
   532→            print("📸 拍照设置:")
   533→            print("  - 质量优先级: \(qualityName) (最大支持: \(maxQualityName))")
   534→            print("  - 高分辨率: \(settings.isHighResolutionPhotoEnabled) (支持: \(self.photoOutput.isHighResolutionCaptureEnabled))")
   535→            print("  - 格式: JPEG")
   536→            
   537→            self.photoCompletionHandler = completion
   538→            self.photoOutput.capturePhoto(with: settings, delegate: self)
   539→        }
   540→    }
   541→    
   542→    func setFocusPoint(_ point: CGPoint) {
   543→        guard let device = currentDevice, device.isFocusPointOfInterestSupported else { return }
   544→        
   545→        do {
   546→            try device.lockForConfiguration()
   547→            device.focusPointOfInterest = point
   548→            device.focusMode = .autoFocus
   549→            
   550→            if device.isExposurePointOfInterestSupported {
   551→                device.exposurePointOfInterest = point
   552→                device.exposureMode = .autoExpose
   553→            }
   554→            
   555→            device.unlockForConfiguration()
   556→        } catch {
   557→            print("Error setting focus point: \(error)")
   558→        }
   559→    }
   560→    
   561→    func setExposureCompensation(_ value: Float) {
   562→        guard let device = currentDevice else { return }
   563→        
   564→        do {
   565→            try device.lockForConfiguration()
   566→            device.setExposureTargetBias(value, completionHandler: nil)
   567→            device.unlockForConfiguration()
   568→        } catch {
   569→            print("Error setting exposure compensation: \(error)")
   570→        }
   571→    }
   572→    
   573→    // 更新设置的方法
   574→    func updatePhotoSettings(format: PhotoFormat, resolution: PhotoResolution) {
   575→        let needsSessionReconfiguration = (currentPhotoResolution != resolution)
   576→        
   577→        currentPhotoFormat = format
   578→        currentPhotoResolution = resolution
   579→        print("📸 更新照片设置 - 格式: \(format.rawValue), 分辨率: \(resolution.rawValue)")
   580→        
   581→        // 如果分辨率改变，需要重新配置session
   582→        if needsSessionReconfiguration {
   583→            sessionQueue.async { [weak self] in
   584→                self?.reconfigureSession()
   585→            }
   586→        }
   587→    }
   588→    
   589→    // 重新配置session的方法
   590→    private func reconfigureSession() {
   591→        guard session.isRunning else { return }
   592→        
   593→        session.beginConfiguration()
   594→        
   595→        // 根据新的分辨率设置session preset
   596→        let sessionPreset = getSessionPreset(for: currentPhotoResolution)
   597→        if session.canSetSessionPreset(sessionPreset) {
   598→            session.sessionPreset = sessionPreset
   599→            print("📸 更新session preset为: \(sessionPreset.rawValue)")
   600→        }
   601→        
   602→        // 根据分辨率配置相应的设备格式
   603→        if currentPhotoResolution == .resolution48MP {
   604→            configureFor48MP(enable: true)
   605→        } else {
   606→            configureFor48MP(enable: false)
   607→        }
   608→        
   609→        session.commitConfiguration()
   610→    }
   611→    
   612→    // 获取对应分辨率的session preset
   613→    private func getSessionPreset(for resolution: PhotoResolution) -> AVCaptureSession.Preset {
   614→        switch resolution {
   615→        case .resolution12MP:
   616→            return .photo
   617→        case .resolution48MP:
   618→            if #available(iOS 16.0, *) {
   619→                // 48MP需要使用最高质量preset
   620→                return .photo
   621→            } else {
   622→                return .photo
   623→            }
   624→        }
   625→    }
   626→    
   627→    // 获取对应格式的photo settings
   628→    private func getPhotoSettings(for format: PhotoFormat) -> AVCapturePhotoSettings {
   629→        let settings: AVCapturePhotoSettings
   630→        
   631→        switch format {
   632→        case .heic:
   633→            if photoOutput.availablePhotoCodecTypes.contains(.hevc) {
   634→                settings = AVCapturePhotoSettings(format: [AVVideoCodecKey: AVVideoCodecType.hevc])
   635→            } else {
   636→                settings = AVCapturePhotoSettings()
   637→            }
   638→        case .jpeg:
   639→            settings = AVCapturePhotoSettings(format: [AVVideoCodecKey: AVVideoCodecType.jpeg])
   640→        case .raw:
   641→            if let rawFormat = photoOutput.availableRawPhotoPixelFormatTypes.first {
   642→                settings = AVCapturePhotoSettings(rawPixelFormatType: rawFormat)
   643→            } else {
   644→                print("⚠️ 设备不支持RAW格式，使用HEIC")
   645→                settings = AVCapturePhotoSettings()
   646→            }
   647→        }
   648→        
   649→        // 48MP分辨率支持
   650→        if currentPhotoResolution == .resolution48MP {
   651→            // 添加详细的调试信息
   652→            print("📸 准备启用48MP模式...")
   653→            print("📸 设备48MP支持: \(is48MPAvailable)")
   654→            print("📸 PhotoOutput高分辨率捕获启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   655→            
   656→            // 检查当前设备是否支持48MP
   657→            if is48MPAvailable && photoOutput.isHighResolutionCaptureEnabled {
   658→                settings.isHighResolutionPhotoEnabled = true
   659→                print("📸 ✅ 成功启用48MP高分辨率模式")
   660→                
   661→                // 对于48MP模式，使用最高质量设置
   662→                settings.photoQualityPrioritization = .quality
   663→                
   664→                // 确保使用合适的编解码器
   665→                if format == .heic && photoOutput.availablePhotoCodecTypes.contains(.hevc) {
   666→                    print("📸 48MP使用HEIC格式")
   667→                } else if format == .jpeg && photoOutput.availablePhotoCodecTypes.contains(.jpeg) {
   668→                    print("📸 48MP使用JPEG格式")
   669→                }
   670→            } else {
   671→                print("⚠️ 48MP不可用 - 设备支持:\(is48MPAvailable), PhotoOutput支持:\(photoOutput.isHighResolutionCaptureEnabled)")
   672→                settings.isHighResolutionPhotoEnabled = false
   673→            }
   674→            
   675→            print("📸 最终Settings高分辨率启用: \(settings.isHighResolutionPhotoEnabled)")
   676→        }
   677→        
   678→        return settings
   679→    }
   680→    
   681→    private func savePhotoToLibrary(_ imageData: Data) {
   682→        PHPhotoLibrary.requestAuthorization { [weak self] status in
   683→            guard status == .authorized else {
   684→                print("❌ 相册权限未授权")
   685→                return
   686→            }
   687→            
   688→            // 先检查原始数据是否包含完整元数据
   689→            self?.logOriginalMetadata(imageData)
   690→            
   691→            // 创建带有完整元数据的图像数据
   692→            guard let enhancedImageData = self?.createImageWithCompleteMetadata(from: imageData, format: self?.currentPhotoFormat ?? .heic) else {
   693→                print("❌ 无法创建带有完整元数据的图像")
   694→                return
   695→            }
   696→            
   697→            // 保存到相册
   698→            PHPhotoLibrary.shared().performChanges({ [weak self] in
   699→                let creationRequest = PHAssetCreationRequest.forAsset()
   700→                
   701→                // 使用增强后的图像数据
   702→                creationRequest.addResource(with: .photo, data: enhancedImageData, options: nil)
   703→                
   704→                // 如果有位置信息，添加GPS数据
   705→                if let location = self?.currentLocation {
   706→                    creationRequest.location = location
   707→                    print("📍 添加GPS位置信息: \(location.coordinate)")
   708→                }
   709→                
   710→            }) { success, error in
   711→                if let error = error {
   712→                    print("❌ 保存照片失败: \(error)")
   713→                } else if success {
   714→                    print("✅ 照片已成功保存到相册，包含完整元数据")
   715→                }
   716→            }
   717→        }
   718→    }
   719→    
   720→    private func createImageWithCompleteMetadata(from imageData: Data, format: PhotoFormat) -> Data? {
   721→        guard let source = CGImageSourceCreateWithData(imageData as CFData, nil),
   722→              let cgImage = CGImageSourceCreateImageAtIndex(source, 0, nil) else {
   723→            print("❌ 无法创建CGImage")
   724→            return imageData // 返回原始数据作为备选
   725→        }
   726→        
   727→        // 获取原始元数据
   728→        var metadata = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] ?? [:]
   729→        
   730→        print("📸 原始元数据字段:")
   731→        print("  - 总字段数: \(metadata.keys.count)")
   732→        
   733→        // 保留并补充EXIF信息（不覆盖已有的重要信息）
   734→        var exifDict = metadata[kCGImagePropertyExifDictionary as String] as? [String: Any] ?? [:]
   735→        
   736→        // 只在没有镜头信息时才添加
   737→        if exifDict[kCGImagePropertyExifLensMake as String] == nil {
   738→            exifDict[kCGImagePropertyExifLensMake as String] = "Apple"
   739→        }
   740→        if exifDict[kCGImagePropertyExifLensModel as String] == nil {
   741→            exifDict[kCGImagePropertyExifLensModel as String] = getLensModelForPhotos(device: currentDevice ?? AVCaptureDevice.default(for: .video)!)
   742→        }
   743→        
   744→        // 添加拍摄时间（如果没有的话）
   745→        if exifDict[kCGImagePropertyExifDateTimeOriginal as String] == nil {
   746→            let now = Date()
   747→            let dateFormatter = DateFormatter()
   748→            dateFormatter.dateFormat = "yyyy:MM:dd HH:mm:ss"
   749→            exifDict[kCGImagePropertyExifDateTimeOriginal as String] = dateFormatter.string(from: now)
   750→            exifDict[kCGImagePropertyExifDateTimeDigitized as String] = dateFormatter.string(from: now)
   751→        }
   752→        
   753→        // 保留并补充TIFF信息
   754→        var tiffDict = metadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] ?? [:]
   755→        
   756→        // 只在没有设备信息时才添加
   757→        if tiffDict[kCGImagePropertyTIFFMake as String] == nil {
   758→            tiffDict[kCGImagePropertyTIFFMake as String] = "Apple"
   759→        }
   760→        if tiffDict[kCGImagePropertyTIFFModel as String] == nil {
   761→            tiffDict[kCGImagePropertyTIFFModel as String] = getDetailedDeviceModel()
   762→        }
   763→        if tiffDict[kCGImagePropertyTIFFSoftware as String] == nil {
   764→            tiffDict[kCGImagePropertyTIFFSoftware as String] = "MCCamera 1.0.0"
   765→        }
   766→        
   767→        // 添加时间戳（如果没有的话）
   768→        if tiffDict[kCGImagePropertyTIFFDateTime as String] == nil {
   769→            let now = Date()
   770→            let dateFormatter = DateFormatter()
   771→            dateFormatter.dateFormat = "yyyy:MM:dd HH:mm:ss"
   772→            tiffDict[kCGImagePropertyTIFFDateTime as String] = dateFormatter.string(from: now)
   773→        }
   774→        
   775→        // 添加GPS信息（如果有位置数据且没有GPS信息）
   776→        if metadata[kCGImagePropertyGPSDictionary as String] == nil,
   777→           let gpsMetadata = getLocationMetadata() {
   778→            metadata[kCGImagePropertyGPSDictionary as String] = gpsMetadata
   779→        }
   780→        
   781→        // 更新元数据
   782→        metadata[kCGImagePropertyExifDictionary as String] = exifDict
   783→        metadata[kCGImagePropertyTIFFDictionary as String] = tiffDict
   784→        
   785→        // 根据格式选择输出类型
   786→        let outputType: CFString
   787→        let compressionQuality: Float
   788→        
   789→        switch format {
   790→        case .heic:
   791→            outputType = UTType.heic.identifier as CFString
   792→            compressionQuality = 0.95
   793→        case .jpeg:
   794→            outputType = UTType.jpeg.identifier as CFString
   795→            compressionQuality = 0.95
   796→        case .raw:
   797→            // RAW格式通常不需要重新编码，直接返回原始数据
   798→            print("📸 RAW格式保持原始数据")
   799→            return imageData
   800→        }
   801→        
   802→        // 创建新的图像数据，保持原始质量
   803→        let mutableData = NSMutableData()
   804→        guard let destination = CGImageDestinationCreateWithData(mutableData, outputType, 1, nil) else {
   805→            print("❌ 无法创建CGImageDestination")
   806→            return imageData
   807→        }
   808→        
   809→        // 设置压缩质量
   810→        let options: [CFString: Any] = [
   811→            kCGImageDestinationLossyCompressionQuality: compressionQuality
   812→        ]
   813→        
   814→        // 添加图像和元数据
   815→        CGImageDestinationAddImage(destination, cgImage, metadata as CFDictionary)
   816→        CGImageDestinationSetProperties(destination, options as CFDictionary)
   817→        
   818→        // 完成写入
   819→        guard CGImageDestinationFinalize(destination) else {
   820→            print("❌ 无法完成图像写入")
   821→            return imageData
   822→        }
   823→        
   824→        // 验证保存的元数据
   825→        if let verifySource = CGImageSourceCreateWithData(mutableData, nil),
   826→           let verifyMetadata = CGImageSourceCopyPropertiesAtIndex(verifySource, 0, nil) as? [String: Any] {
   827→            print("📋 验证保存的元数据:")
   828→            
   829→            if let verifyExif = verifyMetadata[kCGImagePropertyExifDictionary as String] as? [String: Any] {
   830→                print("  - EXIF字段数量: \(verifyExif.keys.count)")
   831→                if let lensMake = verifyExif[kCGImagePropertyExifLensMake as String] {
   832→                    print("  - 镜头制造商: \(lensMake)")
   833→                }
   834→                if let lensModel = verifyExif[kCGImagePropertyExifLensModel as String] {
   835→                    print("  - 镜头型号: \(lensModel)")
   836→                }
   837→                if let dateTime = verifyExif[kCGImagePropertyExifDateTimeOriginal as String] {
   838→                    print("  - 拍摄时间: \(dateTime)")
   839→                }
   840→                if let iso = verifyExif[kCGImagePropertyExifISOSpeedRatings as String] {
   841→                    print("  - ISO: \(iso)")
   842→                }
   843→                if let exposureTime = verifyExif[kCGImagePropertyExifExposureTime as String] {
   844→                    print("  - 快门速度: \(exposureTime)")
   845→                }
   846→            }
   847→            
   848→            if let verifyTiff = verifyMetadata[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   849→                print("  - TIFF字段数量: \(verifyTiff.keys.count)")
   850→                if let make = verifyTiff[kCGImagePropertyTIFFMake as String] {
   851→                    print("  - 设备制造商: \(make)")
   852→                }
   853→                if let model = verifyTiff[kCGImagePropertyTIFFModel as String] {
   854→                    print("  - 设备型号: \(model)")
   855→                }
   856→            }
   857→            
   858→            if let verifyGPS = verifyMetadata[kCGImagePropertyGPSDictionary as String] as? [String: Any] {
   859→                print("  - GPS字段数量: \(verifyGPS.keys.count)")
   860→            } else {
   861→                print("  - 无GPS信息")
   862→            }
   863→        } else {
   864→            print("❌ 无法验证保存的元数据")
   865→        }
   866→        
   867→        print("✅ 成功创建带有完整元数据的图像，格式: \(format.rawValue)")
   868→        return mutableData as Data
   869→    }
   870→    
   871→    
   872→    
   873→    private func setupLocationManager() {
   874→        locationManager.delegate = self
   875→        locationManager.desiredAccuracy = kCLLocationAccuracyBest
   876→        locationManager.requestWhenInUseAuthorization()
   877→    }
   878→    
   879→    private func getLocationMetadata() -> [String: Any]? {
   880→        guard let location = currentLocation else { return nil }
   881→        
   882→        let coordinate = location.coordinate
   883→        let altitude = location.altitude
   884→        let timestamp = location.timestamp
   885→        
   886→        var gpsDict: [String: Any] = [:]
   887→        
   888→        // 纬度
   889→        gpsDict[kCGImagePropertyGPSLatitude as String] = abs(coordinate.latitude)
   890→        gpsDict[kCGImagePropertyGPSLatitudeRef as String] = coordinate.latitude >= 0 ? "N" : "S"
   891→        
   892→        // 经度
   893→        gpsDict[kCGImagePropertyGPSLongitude as String] = abs(coordinate.longitude)
   894→        gpsDict[kCGImagePropertyGPSLongitudeRef as String] = coordinate.longitude >= 0 ? "E" : "W"
   895→        
   896→        // 海拔
   897→        if altitude > 0 {
   898→            gpsDict[kCGImagePropertyGPSAltitude as String] = abs(altitude)
   899→            gpsDict[kCGImagePropertyGPSAltitudeRef as String] = altitude >= 0 ? 0 : 1
   900→        }
   901→        
   902→        // GPS时间戳
   903→        let dateFormatter = DateFormatter()
   904→        dateFormatter.dateFormat = "HH:mm:ss.SS"
   905→        dateFormatter.timeZone = TimeZone(identifier: "UTC")
   906→        gpsDict[kCGImagePropertyGPSTimeStamp as String] = dateFormatter.string(from: timestamp)
   907→        
   908→        let dateFormatterDate = DateFormatter()
   909→        dateFormatterDate.dateFormat = "yyyy:MM:dd"
   910→        dateFormatterDate.timeZone = TimeZone(identifier: "UTC")
   911→        gpsDict[kCGImagePropertyGPSDateStamp as String] = dateFormatterDate.string(from: timestamp)
   912→        
   913→        // 定位精度
   914→        if location.horizontalAccuracy > 0 {
   915→            gpsDict[kCGImagePropertyGPSHPositioningError as String] = location.horizontalAccuracy
   916→        }
   917→        
   918→        return gpsDict
   919→    }
   920→    
   921→    private func getQualityName(_ quality: AVCapturePhotoOutput.QualityPrioritization) -> String {
   922→        switch quality {
   923→        case .speed:
   924→            return "speed"
   925→        case .balanced:
   926→            return "balanced"
   927→        case .quality:
   928→            return "quality"
   929→        @unknown default:
   930→            return "unknown"
   931→        }
   932→    }
   933→    
   934→    private func logOriginalMetadata(_ imageData: Data) {
   935→        guard let source = CGImageSourceCreateWithData(imageData as CFData, nil),
   936→              let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] else {
   937→            print("📸 无法读取原始照片元数据")
   938→            return
   939→        }
   940→        
   941→        print("📸 原始照片元数据:")
   942→        if let exif = properties[kCGImagePropertyExifDictionary as String] as? [String: Any] {
   943→            print("  - EXIF数据存在，包含 \(exif.keys.count) 个字段")
   944→            if let iso = exif[kCGImagePropertyExifISOSpeedRatings as String] {
   945→                print("  - ISO: \(iso)")
   946→            }
   947→            if let exposureTime = exif[kCGImagePropertyExifExposureTime as String] {
   948→                print("  - 快门速度: \(exposureTime)")
   949→            }
   950→        } else {
   951→            print("  - 无EXIF数据")
   952→        }
   953→        
   954→        if let tiff = properties[kCGImagePropertyTIFFDictionary as String] as? [String: Any] {
   955→            print("  - TIFF数据存在")
   956→            if let make = tiff[kCGImagePropertyTIFFMake as String] {
   957→                print("  - 制造商: \(make)")
   958→            }
   959→        }
   960→    }
   961→    
   962→    
   963→    private func getCurrentCameraModel() -> String {
   964→        guard let device = currentDevice else { return "Unknown" }
   965→        
   966→        switch device.deviceType {
   967→        case .builtInUltraWideCamera:
   968→            return "Ultra Wide Camera"
   969→        case .builtInWideAngleCamera:
   970→            return "Wide Camera"
   971→        case .builtInTelephotoCamera:
   972→            return "Telephoto Camera"
   973→        case .builtInTripleCamera:
   974→            return "Triple Camera"
   975→        case .builtInDualCamera:
   976→            return "Dual Camera"
   977→        case .builtInDualWideCamera:
   978→            return "Dual Wide Camera"
   979→        default:
   980→            return "iPhone Camera"
   981→        }
   982→    }
   983→    
   984→    private func getLensModelForPhotos(device: AVCaptureDevice) -> String {
   985→        let deviceModel = UIDevice.current.model
   986→        
   987→        switch device.deviceType {
   988→        case .builtInUltraWideCamera:
   989→            return "\(deviceModel) back camera 0.5x"
   990→        case .builtInWideAngleCamera:
   991→            return "\(deviceModel) back camera"
   992→        case .builtInTelephotoCamera:
   993→            return "\(deviceModel) back camera 3x"
   994→        default:
   995→            return "\(deviceModel) back camera"
   996→        }
   997→    }
   998→    
   999→    
  1000→    
  1001→    
  1002→    
  1003→    private func getDetailedDeviceModel() -> String {
  1004→        var systemInfo = utsname()
  1005→        uname(&systemInfo)
  1006→        
  1007→        let machineMirror = Mirror(reflecting: systemInfo.machine)
  1008→        let identifier = machineMirror.children.reduce("") { identifier, element in
  1009→            guard let value = element.value as? Int8, value != 0 else { return identifier }
  1010→            return identifier + String(UnicodeScalar(UInt8(value)))
  1011→        }
  1012→        
  1013→        // 将设备标识符映射到友好名称
  1014→        switch identifier {
  1015→        case "iPhone14,2": return "iPhone 13"
  1016→        case "iPhone14,3": return "iPhone 13"
  1017→        case "iPhone14,4": return "iPhone 13 mini"
  1018→        case "iPhone14,5": return "iPhone 13"
  1019→        case "iPhone14,7": return "iPhone 13 mini"
  1020→        case "iPhone14,8": return "iPhone 13"
  1021→        case "iPhone15,2": return "iPhone 14 Pro"
  1022→        case "iPhone15,3": return "iPhone 14 Pro Max"
  1023→        case "iPhone15,4": return "iPhone 15"
  1024→        case "iPhone15,5": return "iPhone 15 Plus"
  1025→        case "iPhone16,1": return "iPhone 15 Pro"
  1026→        case "iPhone16,2": return "iPhone 15 Pro Max"
  1027→        case "iPhone17,1": return "iPhone 16 Pro"
  1028→        case "iPhone17,2": return "iPhone 16 Pro Max"
  1029→        case "iPhone17,3": return "iPhone 16"
  1030→        case "iPhone17,4": return "iPhone 16 Plus"
  1031→        default:
  1032→            return UIDevice.current.model
  1033→        }
  1034→    }
  1035→}
  1036→
  1037→extension CameraService: AVCapturePhotoCaptureDelegate {
  1038→    func photoOutput(_ output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto, error: Error?) {
  1039→        if let error = error {
  1040→            photoCompletionHandler?(.failure(error))
  1041→            return
  1042→        }
  1043→        
  1044→        guard let imageData = photo.fileDataRepresentation() else {
  1045→            let error = NSError(domain: "CameraService", code: -1, userInfo: [NSLocalizedDescriptionKey: "Failed to get image data"])
  1046→            photoCompletionHandler?(.failure(error))
  1047→            return
  1048→        }
  1049→        
  1050→        savePhotoToLibrary(imageData)
  1051→        photoCompletionHandler?(.success(imageData))
  1052→        photoCompletionHandler = nil
  1053→    }
  1054→}
  1055→
  1056→extension CameraService: CLLocationManagerDelegate {
  1057→    func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {
  1058→        currentLocation = locations.last
  1059→    }
  1060→    
  1061→    func locationManager(_ manager: CLLocationManager, didFailWithError error: Error) {
  1062→        print("位置获取失败: \(error.localizedDescription)")
  1063→    }
  1064→    
  1065→    func locationManager(_ manager: CLLocationManager, didChangeAuthorization status: CLAuthorizationStatus) {
  1066→        switch status {
  1067→        case .authorizedWhenInUse, .authorizedAlways:
  1068→            locationManager.startUpdatingLocation()
  1069→        case .denied, .restricted:
  1070→            print("位置权限被拒绝")
  1071→        case .notDetermined:
  1072→            locationManager.requestWhenInUseAuthorization()
  1073→        @unknown default:
  1074→            break
  1075→        }
  1076→    }
  1077→}
```

_**Agent (claude-sonnet-4-20250514)**_

我找到了问题所在。您的 48MP 检测逻辑主要有两个问题：

1. **格式检查阈值太低**：代码中检查 `megapixels >= 40` 来判断是否支持 48MP，但实际上 48MP 应该大约是 48 百万像素
2. **设备格式检查可能不够准确**：需要更仔细地检查设备支持的格式

让我修复这些问题：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   297→        }
   298→        
   299→        print("🔍 48MP检查: 设备类型支持，开始检查格式...")
   300→        
   301→        // 遍历设备所有可用格式，寻找支持高分辨率照片的格式
   302→        var maxMegapixels = 0
   303→        var maxDimensions = (width: 0, height: 0)
   304→        
   305→        for format in device.formats {
   306→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   307→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   308→            
   309→            if megapixels > maxMegapixels {
   310→                maxMegapixels = megapixels
   311→                maxDimensions = (width: Int(dimensions.width), height: Int(dimensions.height))
   312→            }
   313→            
   314→            // 检查是否支持48MP（约48百万像素，实际上通常是8064x6048=48.7MP）
   315→            // iPhone 14 Pro/Pro Max 和更新机型支持48MP
   316→            if megapixels >= 45 {
   317→                print("🔍 48MP检查: 找到48MP格式 \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   318→                return true
   319→            }
   320→        }
   321→        
   322→        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP")
   323→        
   324→        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   318→                return true
   319→            }
   320→        }
   321→        
   322→        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP (\(maxDimensions.width)x\(maxDimensions.height))")
   323→        
   324→        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
   325→        #if DEBUG
   326→        if isRunningOnSimulator &&
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们还需要修复 `find48MPFormat()` 方法中的相同问题：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   343→              device.deviceType == .builtInTripleCamera else {
   344→            return nil
   345→        }
   346→        
   347→        // 寻找支持48MP的格式（分辨率约为48百万像素或更高）
   348→        for format in device.formats {
   349→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   350→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   351→            
   352→            // 检查是否支持48MP（约48百万像素，实际上通常是8064x6048=48.7MP）
   353→            if megapixels >= 45 {
   354→                print("🔍 找到48MP格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   355→                return format
   356→            }
   357→        }
   358→        return nil
   359→    }
   360→    
   361→    // 配置48MP模式的方法
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们添加一个更详细的调试方法来查看所有可用格式：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   295→            print("🔍 48MP检查: 设备类型不支持 (\(device.deviceType.rawValue))")
   296→            return false
   297→        }
   298→        
   299→        print("🔍 48MP检查: 设备类型支持，开始检查格式...")
   300→        
   301→        // 调试：列出所有可用格式
   302→        print("🔍 设备支持的所有格式:")
   303→        for (index, format) in device.formats.enumerated() {
   304→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   305→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   306→            print("  格式\(index): \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   307→        }
   308→        
   309→        // 遍历设备所有可用格式，寻找支持高分辨率照片的格式
   310→        var maxMegapixels = 0
   311→        var maxDimensions = (width: 0, height: 0)
   312→        
   313→        for format in device.formats {
```

_**Agent (claude-sonnet-4-20250514)**_

我还注意到另一个问题，让我们也检查一下您的设备是否支持48MP的逻辑。让我们添加一个特定的设备型号检查：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   269→        return false
   270→        #endif
   271→    }
   272→    
   273→    // 检查设备是否支持48MP
   274→    var is48MPAvailable: Bool {
   275→        guard let device = currentDevice else { 
   276→            print("🔍 48MP检查: 无当前设备")
   277→            return false 
   278→        }
   279→        
   280→        print("🔍 48MP检查: 运行环境 = \(isRunningOnSimulator ? "模拟器" : "真机")")
   281→        print("🔍 48MP检查: 设备类型 = \(device.deviceType.rawValue)")
   282→        print("🔍 48MP检查: 设备名称 = \(device.localizedName)")
   283→        print("🔍 48MP检查: 设备型号 = \(getDetailedDeviceModel())")
   284→        
   285→        // 在模拟器上，48MP功能通常不可用
   286→        if isRunningOnSimulator {
   287→            print("🔍 48MP检查: 模拟器环境，48MP功能可能不可用")
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们添加一个基于设备型号的检查，因为只有特定的iPhone型号支持48MP：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   281→        print("🔍 48MP检查: 设备类型 = \(device.deviceType.rawValue)")
   282→        print("🔍 48MP检查: 设备名称 = \(device.localizedName)")
   283→        print("🔍 48MP检查: 设备型号 = \(getDetailedDeviceModel())")
   284→        
   285→        // 首先检查设备型号是否支持48MP
   286→        let deviceModel = getDetailedDeviceModel()
   287→        let supports48MPByModel = is48MPSupportedDevice(deviceModel)
   288→        print("🔍 48MP检查: 设备型号支持48MP = \(supports48MPByModel)")
   289→        
   290→        // 在模拟器上，48MP功能通常不可用
   291→        if isRunningOnSimulator {
   292→            print("🔍 48MP检查: 模拟器环境，48MP功能可能不可用")
   293→            // 但我们仍然继续检查，以便调试
   294→        }
   295→        
   296→        // 检查是否是主摄像头（48MP只在主摄上可用）
   297→        guard device.deviceType == .builtInWideAngleCamera || 
   298→              device.deviceType == .builtInTripleCamera ||
   299→              device.deviceType == .builtInDualCamera ||
   300→              device.deviceType == .builtInDualWideCamera else {
   301→            print("🔍 48MP检查: 设备类型不支持 (\(device.deviceType.rawValue))")
   302→            return false
   303→        }
   304→        
   305→        print("🔍 48MP检查: 设备类型支持，开始检查格式...")
   306→        
   307→        // 调试：列出所有可用格式
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们添加 `is48MPSupportedDevice` 方法：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   260→            self.session.commitConfiguration()
   261→        }
   262→    }
   263→    
   264→    // 检查是否在模拟器上运行
   265→    private var isRunningOnSimulator: Bool {
   266→        #if targetEnvironment(simulator)
   267→        return true
   268→        #else
   269→        return false
   270→        #endif
   271→    }
   272→    
   273→    // 检查特定设备型号是否支持48MP
   274→    private func is48MPSupportedDevice(_ deviceModel: String) -> Bool {
   275→        // 支持48MP的iPhone型号（从iPhone 14 Pro开始）
   276→        let supported48MPModels = [
   277→            "iPhone 14 Pro",
   278→            "iPhone 14 Pro Max",
   279→            "iPhone 15",
   280→            "iPhone 15 Plus", 
   281→            "iPhone 15 Pro",
   282→            "iPhone 15 Pro Max",
   283→            "iPhone 16",
   284→            "iPhone 16 Plus",
   285→            "iPhone 16 Pro",
   286→            "iPhone 16 Pro Max"
   287→        ]
   288→        
   289→        return supported48MPModels.contains(deviceModel)
   290→    }
   291→    
   292→    // 检查设备是否支持48MP
   293→    var is48MPAvailable: Bool {
   294→        guard let device = currentDevice else {
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们改进检查逻辑，如果设备型号不支持48MP，就不需要继续检查格式了：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   300→        print("🔍 48MP检查: 设备类型 = \(device.deviceType.rawValue)")
   301→        print("🔍 48MP检查: 设备名称 = \(device.localizedName)")
   302→        print("🔍 48MP检查: 设备型号 = \(getDetailedDeviceModel())")
   303→        
   304→        // 首先检查设备型号是否支持48MP
   305→        let deviceModel = getDetailedDeviceModel()
   306→        let supports48MPByModel = is48MPSupportedDevice(deviceModel)
   307→        print("🔍 48MP检查: 设备型号支持48MP = \(supports48MPByModel)")
   308→        
   309→        // 如果设备型号不支持48MP，直接返回false（除非在调试模式）
   310→        if !supports48MPByModel && !isRunningOnSimulator {
   311→            print("🔍 48MP检查: 设备型号不支持48MP")
   312→            return false
   313→        }
   314→        
   315→        // 在模拟器上，48MP功能通常不可用，但我们继续检查以便调试
   316→        if isRunningOnSimulator {
   317→            print("🔍 48MP检查: 模拟器环境，继续检查以便调试")
   318→        }
   319→        
   320→        // 检查是否是主摄像头（48MP只在主摄上可用）
   321→        guard device.deviceType == .builtInWideAngleCamera || 
   322→              device.deviceType == .builtInTripleCamera ||
   323→              device.deviceType == .builtInDualCamera ||
   324→              device.deviceType == .builtInDualWideCamera else {
   325→            print("🔍 48MP检查: 设备类型不支持 (\(device.deviceType.rawValue))")
   326→            return false
   327→        }
   328→        
   329→        print("🔍 48MP检查: 设备类型支持，开始检查格式...")
   330→        
   331→        // 调试：列出所有可用格式
```

_**Agent (claude-sonnet-4-20250514)**_

根据您的日志，您的手机是支持4800万像素的，但我们的检测逻辑有问题。主要问题可能是：

1. **阈值设置**：我们从40MP改为45MP，这个阈值可能还是不对
2. **设备型号识别**：我们需要准确识别您的iPhone型号

让我检查一下您设备的实际型号映射是否正确：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
  1052→            guard let value = element.value as? Int8, value != 0 else { return identifier }
  1053→            return identifier + String(UnicodeScalar(UInt8(value)))
  1054→        }
  1055→        
  1056→        // 将设备标识符映射到友好名称
  1057→        switch identifier {
  1058→        case "iPhone14,2": return "iPhone 13 Pro"
  1059→        case "iPhone14,3": return "iPhone 13 Pro Max"
  1060→        case "iPhone14,4": return "iPhone 13 mini"
  1061→        case "iPhone14,5": return "iPhone 13"
  1062→        case "iPhone14,7": return "iPhone 13 mini"
  1063→        case "iPhone14,8": return "iPhone 13"
  1064→        case "iPhone15,2": return "iPhone 14 Pro"
  1065→        case "iPhone15,3": return "iPhone 14 Pro Max"
  1066→        case "iPhone15,4": return "iPhone 15"
  1067→        case "iPhone15,5": return "iPhone 15 Plus"
  1068→        case "iPhone16,1": return "iPhone 15 Pro"
  1069→        case "iPhone16,2": return "iPhone 15 Pro Max"
  1070→        case "iPhone17,1": return "iPhone 16 Pro"
  1071→        case "iPhone17,2": return "iPhone 16 Pro Max"
  1072→        case "iPhone17,3": return "iPhone 16"
  1073→        case "iPhone17,4": return "iPhone 16 Plus"
  1074→        default:
  1075→            print("🔍 未知设备标识符: \(identifier)")
  1076→            return UIDevice.current.model
  1077→        }
  1078→    }
  1079→}
  1080→
  1081→extension CameraService: AVCapturePhotoCaptureDelegate {
```

_**Agent (claude-sonnet-4-20250514)**_

让我们也更新支持48MP的设备列表：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   269→        return false
   270→        #endif
   271→    }
   272→    
   273→    // 检查特定设备型号是否支持48MP
   274→    private func is48MPSupportedDevice(_ deviceModel: String) -> Bool {
   275→        // 支持48MP的iPhone型号
   276→        let supported48MPModels = [
   277→            // iPhone 14系列（Pro型号支持48MP）
   278→            "iPhone 14 Pro",
   279→            "iPhone 14 Pro Max",
   280→            // iPhone 15系列（所有型号都支持48MP）
   281→            "iPhone 15",
   282→            "iPhone 15 Plus", 
   283→            "iPhone 15 Pro",
   284→            "iPhone 15 Pro Max",
   285→            // iPhone 16系列（所有型号都支持48MP）
   286→            "iPhone 16",
   287→            "iPhone 16 Plus",
   288→            "iPhone 16 Pro",
   289→            "iPhone 16 Pro Max"
   290→        ]
   291→        
   292→        let isSupported = supported48MPModels.contains(deviceModel)
   293→        print("🔍 设备型号检查: \(deviceModel) -> 支持48MP: \(isSupported)")
   294→        return isSupported
   295→    }
   296→    
   297→    // 检查设备是否支持48MP
   298→    var is48MPAvailable: Bool {
   299→        guard let device = currentDevice else {
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们运行应用测试一下修复后的48MP检测逻辑。首先让我们构建项目：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 构建项目测试修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 15 Pro' clean build`

Error:

```
2025-08-19 15:40:58.453 xcodebuild[16057:8492638] Writing error result bundle to /var/folders/t0/nfp_9bjx59527f4pv_1p2v300000gn/T/ResultBundle_2025-19-08_15-40-0058.xcresult
xcodebuild: error: Unable to find a device matching the provided destination specifier:
		{ platform:iOS Simulator, OS:latest, name:iPhone 15 Pro }

	The requested device could not be found because no available devices matched the request.

	Available destinations for the "MCCamera" scheme:
		{ platform:macOS, arch:arm64, variant:Designed for [iPad,iPhone], id:00008132-001C695E01C3001C, name:My Mac }
		{ platform:iOS, arch:arm64, id:00008120-001179441450C01E, name:马聪聪的iPhone }
		{ platform:iOS, id:dvtdevice-DVTiPhonePlaceholder-iphoneos:placeholder, name:Any iOS Device }
		{ platform:iOS Simulator, id:dvtdevice-DVTiOSDeviceSimulatorPlaceholder-iphonesimulator:placeholder, name:Any iOS Simulator Device }
		{ platform:iOS, id:00008101-000354490C90001E, name:huilei的iPhone, error:huilei的iPhone is not connected Xcode will continue when huilei的iPhone is connected and unlocked. }
		{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
		{ platform:iOS Simulator, id:99898E16-1B65-4091-BD58-8A7FE23105D1, OS:18.3.1, name:iPad (10th generation) }
		{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
		{ platform:iOS Simulator, id:5DBE8460-ADA6-4311-8E97-AD23B32A79DA, OS:18.3.1, name:iPad Air 11-inch (M2) }
		{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
		{ platform:iOS Simulator, id:8443F2CA-1B3E-4A7B-A003-57EF2120D174, OS:18.3.1, name:iPad Air 13-inch (M2) }
		{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
		{ platform:iOS Simulator, id:6DC40BE9-339A-4DD1-BB2C-6B8F516CD5E0, OS:18.3.1, name:iPad Pro 11-inch (M4) }
		{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
		{ platform:iOS Simulator, id:7895C572-E1DA-4154-B7C3-8D4D61538E68, OS:18.3.1, name:iPad Pro 13-inch (M4) }
		{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
		{ platform:iOS Simulator, id:9836745C-731A-4178-BAC3-53B09441FAD3, OS:18.3.1, name:iPad mini (A17 Pro) }
		{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
		{ platform:iOS Simulator, id:456FDFE9-2B6F-4E8D-98AC-D4489EAC474A, OS:18.3.1, name:iPhone 16 }
		{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
		{ platform:iOS Simulator, id:00E442FA-B913-4EAE-952C-B6CC6B8E4F96, OS:18.3.1, name:iPhone 16 Plus }
		{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
		{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
		{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
		{ platform:iOS Simulator, id:8C67B3B6-DB91-4144-AD2B-3219D81E96D0, OS:18.3.1, name:iPhone 16 Pro Max }
		{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }
		{ platform:iOS Simulator, id:C7478E34-2FCF-4CB6-8938-18C9EC729F55, OS:18.3.1, name:iPhone SE (3rd generation) }

Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 15 Pro" clean build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES
```

_**Agent (claude-sonnet-4-20250514)**_

让我们使用iPhone 16 Pro模拟器来构建：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 构建项目测试修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'platform=iOS Simulator,name=iPhone 16 Pro' clean build`

Error:

```
[Request interrupted by user for tool use]
--- xcodebuild: WARNING: Using the first of multiple matching destinations:
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
--- xcodebuild: WARNING: Using the first of multiple matching destinations:
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }
{ platform:iOS Simulator, id:596EC4DB-22D9-4791-A9DC-FBC0EB5370C4, OS:18.3.1, name:iPhone 16 Pro }

Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination "platform=iOS Simulator,name=iPhone 16 Pro" clean build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES


** CLEAN SUCCEEDED **

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs
```

_**User**_

[Request interrupted by user for tool use]

_**User**_


🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP (4032x3024)
🔍 48MP检查: 运行环境 = 真机
🔍 48MP检查: 设备类型 = AVCaptureDeviceTypeBuiltInWideAngleCamera
🔍 48MP检查: 设备名称 = Back Camera
🔍 48MP检查: 设备型号 = iPhone 14 Pro Max
�� 设备型号检查: iPhone 14 Pro Max -> 支持48MP: true
🔍 48MP检查: 设备型号支持48MP = true
🔍 48MP检查: 设备类型支持，开始检查格式...
🔍 设备支持的所有格式:
  格式0: 192x144 (0MP)
  格式1: 192x144 (0MP)
  格式2: 352x288 (0MP)
  格式3: 352x288 (0MP)
  格式4: 480x360 (0MP)
  格式5: 480x360 (0MP)
  格式6: 640x480 (0MP)
  格式7: 640x480 (0MP)
  格式8: 640x480 (0MP)
  格式9: 640x480 (0MP)
  格式10: 960x540 (0MP)
  格式11: 960x540 (0MP)
  格式12: 1024x768 (0MP)
  格式13: 1024x768 (0MP)
  格式14: 1280x720 (0MP)
  格式15: 1280x720 (0MP)
  格式16: 1280x720 (0MP)
  格式17: 1280x720 (0MP)
  格式18: 1280x720 (0MP)
  格式19: 1280x720 (0MP)
  格式20: 1280x720 (0MP)
  格式21: 1280x720 (0MP)
  格式22: 1280x720 (0MP)
  格式23: 1280x720 (0MP)
  格式24: 1440x1080 (1MP)
  格式25: 1440x1080 (1MP)
  格式26: 1920x1080 (2MP)
  格式27: 1920x1080 (2MP)
  格式28: 1920x1080 (2MP)
  格式29: 1920x1080 (2MP)
  格式30: 1920x1080 (2MP)
  格式31: 1920x1080 (2MP)
  格式32: 1920x1080 (2MP)
  格式33: 1920x1080 (2MP)
  格式34: 1920x1080 (2MP)
  格式35: 1920x1080 (2MP)
  格式36: 1920x1080 (2MP)
  格式37: 1920x1080 (2MP)
  格式38: 1920x1080 (2MP)
  格式39: 1920x1080 (2MP)
  格式40: 1920x1440 (2MP)
  格式41: 1920x1440 (2MP)
  格式42: 1920x1440 (2MP)
  格式43: 1920x1440 (2MP)
  格式44: 1920x1440 (2MP)
  格式45: 1920x1440 (2MP)
  格式46: 1920x1440 (2MP)
  格式47: 2592x1944 (5MP)
  格式48: 2592x1944 (5MP)
  格式49: 3264x2448 (7MP)
  格式50: 3264x2448 (7MP)
  格式51: 3840x2160 (8MP)
  格式52: 3840x2160 (8MP)
  格式53: 3840x2160 (8MP)
  格式54: 3840x2160 (8MP)
  格式55: 3840x2160 (8MP)
  格式56: 3840x2160 (8MP)
  格式57: 3840x2160 (8MP)
  格式58: 4032x3024 (12MP)
  格式59: 4032x3024 (12MP)
🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP (4032x3024)

---

_**Agent (claude-sonnet-4-20250514)**_

现在我看到了问题的根源！您的iPhone 14 Pro Max确实支持48MP，但是当前的相机设备格式列表中最大只显示到12MP (4032x3024)。这通常意味着我们需要明确请求48MP格式，或者48MP格式只在特定的配置下可用。

让我检查和修复这个问题：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   376→        
   377→        return false
   378→    }
   379→
   380→    // 辅助函数，用于获取48MP格式
   381→    private func find48MPFormat() -> AVCaptureDevice.Format? {
   382→        guard let device = currentDevice else { return nil }
   383→        
   384→        print("🔍 开始查找48MP格式...")
   385→        print("🔍 设备类型: \(device.deviceType.rawValue)")
   386→        
   387→        // 检查是否是主摄像头
   388→        guard device.deviceType == .builtInWideAngleCamera || 
   389→              device.deviceType == .builtInTripleCamera else {
   390→            print("🔍 设备类型不支持48MP")
   391→            return nil
   392→        }
   393→        
   394→        // 在iPhone 14 Pro/Pro Max上，48MP格式可能需要特殊处理
   395→        // 有时候48MP格式不在标准的device.formats中，而需要通过特定方式访问
   396→        
   397→        // 首先尝试查找标准的48MP格式
   398→        var bestFormat: AVCaptureDevice.Format?
   399→        var maxMegapixels = 0
   400→        
   401→        print("🔍 检查所有可用格式以寻找最高分辨率...")
   402→        
   403→        for (index, format) in device.formats.enumerated() {
   404→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   405→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   406→            
   407→            // 记录最高分辨率格式
   408→            if megapixels > maxMegapixels {
   409→                maxMegapixels = megapixels
   410→                bestFormat = format
   411→                print("🔍 新的最高分辨率格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   412→            }
   413→            
   414→            // 检查是否支持48MP（约48百万像素，实际上通常是8064x6048=48.7MP）
   415→            if megapixels >= 45 {
   416→                print("🔍 找到48MP格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   417→                return format
   418→            }
   419→        }
   420→        
   421→        print("🔍 未找到标准48MP格式，最高分辨率: \(maxMegapixels)MP")
   422→        
   423→        // 如果没有找到48MP格式，但设备应该支持，返回最高分辨率格式
   424→        // 在某些情况下，48MP功能可能通过高分辨率捕获设置来实现，而不是通过不同的格式
   425→        if maxMegapixels >= 10 && is48MPSupportedDevice(getDetailedDeviceModel()) {
   426→            print("🔍 设备支持48MP但未找到48MP格式，返回最高分辨率格式作为基础")
   427→            return bestFormat
   428→        }
   429→        
   430→        return nil
   431→    }
   432→    
   433→    // 配置48MP模式的方法
   434→    func configureFor48MP(enable: Bool) {
   435→        guard let device = currentDevice else { return }
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们修改48MP可用性检查逻辑。根据Apple文档，在iPhone 14 Pro及更新机型上，48MP功能主要通过 `isHighResolutionPhotoEnabled` 和 `photoOutput.isHighResolutionCaptureEnabled` 来实现，而不一定需要特定的48MP格式：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Error:

```
<tool_use_error>String to replace not found in file.
String:         // 遍历设备所有可用格式，寻找支持高分辨率照片的格式
        var maxMegapixels = 0
        var maxDimensions = (width: 0, height: 0)
        
        for format in device.formats {
            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
            
            if megapixels > maxMegapixels {
                maxMegapixels = megapixel(s) 
                maxDimensions = (width: Int(dimensions.width), height: Int(dimensions.height))
            }
            
            // 检查是否支持48MP（约48百万像素，实际上通常是8064x6048=48.7MP）
            // iPhone 14 Pro/Pro Max 和更新机型支持48MP
            if megapixels >= 45 {
                print("🔍 48MP检查: 找到48MP格式 \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
                return true
            }
        }
        
        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP (\(maxDimensions.width)x\(maxDimensions.height))")
        
        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
        #if DEBUG
        if isRunningOnSimulator && 
           (device.deviceType == .builtInWideAngleCamera || 
            device.deviceType == .builtInTripleCamera) {
            print("🔍 48MP检查: [开发者模式] 模拟器上强制启用48MP支持用于调试")
            return true
        }
        #endif
        
        return false</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

让我先查看当前的确切内容：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/CameraService.swift`

Result:

```
335→        
   336→        // 调试：列出所有可用格式
   337→        print("🔍 设备支持的所有格式:")
   338→        for (index, format) in device.formats.enumerated() {
   339→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   340→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   341→            print("  格式\(index): \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   342→        }
   343→        
   344→        // 遍历设备所有可用格式，寻找支持高分辨率照片的格式
   345→        var maxMegapixels = 0
   346→        var maxDimensions = (width: 0, height: 0)
   347→        
   348→        for format in device.formats {
   349→            let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   350→            let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   351→            
   352→            if megapixels > maxMegapixels {
   353→                maxMegapixels = megapixels
   354→                maxDimensions = (width: Int(dimensions.width), height: Int(dimensions.height))
   355→            }
   356→            
   357→            // 检查是否支持48MP（约48百万像素，实际上通常是8064x6048=48.7MP）
   358→            // iPhone 14 Pro/Pro Max 和更新机型支持48MP
   359→            if megapixels >= 45 {
   360→                print("🔍 48MP检查: 找到48MP格式 \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   361→                return true
   362→            }
   363→        }
   364→        
   365→        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP (\(maxDimensions.width)x\(maxDimensions.height))")
   366→        
   367→        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
   368→        #if DEBUG
   369→        if isRunningOnSimulator && 
   370→           (device.deviceType == .builtInWideAngleCamera || 
   371→            device.deviceType == .builtInTripleCamera) {
   372→            print("🔍 48MP检查: [开发者模式] 模拟器上强制启用48MP支持用于调试")
   373→            return true
   374→        }
   375→        #endif
   376→        
   377→        return false
   378→    }
   379→
   380→    // 辅助函数，用于获取48MP格式
   381→    private func find48MPFormat() -> AVCaptureDevice.Format? {
   382→        guard let device = currentDevice else { return nil }
   383→        
   384→        print("🔍 开始查找48MP格式...")
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   361→                return true
   362→            }
   363→        }
   364→        
   365→        print("🔍 48MP检查: 未找到48MP格式，最大分辨率: \(maxMegapixels)MP (\(maxDimensions.width)x\(maxDimensions.height))")
   366→        
   367→        // 对于支持48MP的设备型号，即使没有找到48MP格式，
   368→        // 也可能通过高分辨率捕获在12MP基础上实现48MP
   369→        if supports48MPByModel && maxMegapixels >= 10 {
   370→            print("🔍 48MP检查: 设备型号支持48MP，且有高分辨率格式(\(maxMegapixels)MP)可用")
   371→            print("🔍 48MP检查: iPhone 14 Pro及更新机型通过高分辨率捕获实现48MP")
   372→            return true
   373→        }
   374→        
   375→        // 开发者模式：在模拟器上为特定设备类型强制启用48MP支持
   376→        #if DEBUG
   377→        if isRunningOnSimulator && supports48MPByModel {
   378→            print("🔍 48MP检查: [开发者模式] 模拟器上强制启用48MP支持用于调试")
   379→            return true
   380→        }
   381→        #endif
   382→        
   383→        return false
   384→    }
   385→
   386→    // 辅助函数，用于获取48MP格式
   387→    private func find48MPFormat() -> AVCaptureDevice.Format? {
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们修改 `configureFor48MP` 方法，确保它正确处理没有专用48MP格式的情况：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   435→        
   436→        return nil
   437→    }
   438→    
   439→    // 配置48MP模式的方法
   440→    func configureFor48MP(enable: Bool) {
   441→        guard let device = currentDevice else { return }
   442→        
   443→        sessionQueue.async { [weak self] in
   444→            guard let self = self else { return }
   445→            
   446→            print("📸 配置48MP模式: \(enable ? "启用" : "禁用")")
   447→            
   448→            if enable {
   449→                // 对于支持48MP的iPhone（14 Pro及更新机型），
   450→                // 48MP主要通过高分辨率捕获实现，而不是特定的格式
   451→                
   452→                do {
   453→                    try device.lockForConfiguration()
   454→                    
   455→                    // 尝试找到48MP专用格式
   456→                    if let highResFormat = self.find48MPFormat() {
   457→                        device.activeFormat = highResFormat
   458→                        let dimensions = CMVideoFormatDescriptionGetDimensions(highResFormat.formatDescription)
   459→                        print("📸 设置专用48MP格式: \(dimensions.width)x\(dimensions.height)")
   460→                    } else {
   461→                        // 没有专用48MP格式，使用最高分辨率格式（通常是12MP）
   462→                        // 48MP将通过高分辨率捕获设置实现
   463→                        if let bestFormat = device.formats.max(by: { format1, format2 in
   464→                            let dim1 = CMVideoFormatDescriptionGetDimensions(format1.formatDescription)
   465→                            let dim2 = CMVideoFormatDescriptionGetDimensions(format2.formatDescription)
   466→                            let mp1 = (Int(dim1.width) * Int(dim1.height)) / 1_000_000
   467→                            let mp2 = (Int(dim2.width) * Int(dim2.height)) / 1_000_000
   468→                            return mp1 < mp2
   469→                        }) {
   470→                            device.activeFormat = bestFormat
   471→                            let dimensions = CMVideoFormatDescriptionGetDimensions(bestFormat.formatDescription)
   472→                            print("📸 设置最高分辨率格式用于48MP捕获: \(dimensions.width)x\(dimensions.height)")
   473→                            print("📸 48MP将通过高分辨率捕获设置实现")
   474→                        }
   475→                    }
   476→                    
   477→                    // 确保PhotoOutput支持高分辨率捕获
   478→                    if self.photoOutput.isHighResolutionCaptureEnabled {
   479→                        print("📸 PhotoOutput已支持高分辨率捕获")
   480→                    } else {
   481→                        print("⚠️ PhotoOutput不支持高分辨率捕获")
   482→                    }
   483→                    
   484→                    device.unlockForConfiguration()
   485→                    print("✅ 成功配置48MP模式")
   486→                    
   487→                } catch {
   488→                    print("❌ 配置48MP失败: \(error)")
   489→                }
   490→                
   491→            } else {
   492→                // 禁用48MP，恢复到标准12MP格式
   493→                do {
   494→                    try device.lockForConfiguration()
   495→                    
   496→                    // 选择一个合适的12MP格式
   497→                    if let standardFormat = device.formats.first(where: { format in
   498→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   499→                        let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   500→                        return megapixels >= 10 && megapixels <= 15 // 选择12MP左右的格式
   501→                    }) {
   502→                        device.activeFormat = standardFormat
   503→                        let dimensions = CMVideoFormatDescriptionGetDimensions(standardFormat.formatDescription)
   504→                        print("📸 设置标准12MP格式: \(dimensions.width)x\(dimensions.height)")
   505→                    }
   506→                    
   507→                    device.unlockForConfiguration()
   508→                    print("📸 恢复到标准12MP模式")
   509→                    
   510→                } catch {
   511→                    print("❌ 配置标准格式失败: \(error)")
   512→                }
   513→            }
   514→        }
   515→    }
   516→    
   517→    // 新增方法：配置48MP格式（保留旧方法用于兼容）
   518→    private func configure48MPFormat(for device: AVCaptureDevice) {
   519→        // 调用新的配置方法
```

_**Agent (claude-sonnet-4-20250514)**_

现在我们修复了48MP检测和配置的逻辑。关键修改包括：

1. **改进了48MP可用性检查**：现在基于设备型号和高分辨率格式的组合来判断
2. **修复了48MP配置逻辑**：现在正确处理没有专用48MP格式的情况，使用最高分辨率格式结合高分辨率捕获设置
3. **添加了详细的调试信息**：帮助理解48MP检测过程

现在，当您的iPhone 14 Pro Max运行这个修复后的代码时，应该会看到类似这样的输出：

```
🔍 48MP检查: 设备型号 = iPhone 14 Pro Max
🔍 设备型号检查: iPhone 14 Pro Max -> 支持48MP: true
🔍 48MP检查: 设备型号支持48MP = true
🔍 48MP检查: 设备类型支持，开始检查格式...
🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP (4032x3024)
🔍 48MP检查: 设备型号支持48MP，且有高分辨率格式(12MP)可用
🔍 48MP检查: iPhone 14 Pro及更新机型通过高分辨率捕获实现48MP
```

这样，您的应用现在应该能正确识别iPhone 14 Pro Max支持48MP，并在拍照时通过 `isHighResolutionPhotoEnabled = true` 来实现48MP捕获。

主要解决的问题是：
- **误解了48MP实现方式**：iPhone 14 Pro等设备不是通过专用的48MP格式，而是通过在12MP格式基础上启用高分辨率捕获来实现48MP
- **阈值设置错误**：之前的40MP阈值确实太低，但45MP对于某些设备来说可能太高
- **设备型号识别**：确保正确识别支持48MP的设备型号

现在您的相机应用应该能够正确检测并使用48MP功能了！

---

_**User**_


🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP (4032x3024)
🔍 48MP检查: 设备型号支持48MP，且有高分辨率格式(12MP)可用
🔍 48MP检查: iPhone 14 Pro及更新机型通过高分辨率捕获实现48MP
⚠️ 48MP不可用 - 设备支持:true, PhotoOutput支持:false
📸 最终Settings高分辨率启用: false
📸 拍照设置:
  - 质量优先级: balanced (最大支持: balanced)
  - 高分辨率: false (支持: false)
  - 格式: JPEG 为什么还是无法开启 4800w 像素呢

---

_**Agent (claude-sonnet-4-20250514)**_

我看到问题了！关键在于这一行：

```
⚠️ 48MP不可用 - 设备支持:true, PhotoOutput支持:false
```

虽然设备支持48MP，但是 `photoOutput.isHighResolutionCaptureEnabled` 返回 `false`。这通常是因为我们在相机初始化时没有正确配置 `photoOutput` 的高分辨率捕获功能。

让我修复这个问题：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   101→        } else {
   102→            session.sessionPreset = .photo
   103→        }
   104→        
   105→        // 按照Apple AVCam方式配置photoOutput
   106→        if session.canAddOutput(photoOutput) {
   107→            session.addOutput(photoOutput)
   108→            
   109→            // 检查是否支持高分辨率捕获
   110→            print("🔍 PhotoOutput支持高分辨率捕获: \(photoOutput.isHighResolutionCaptureSupported)")
   111→            
   112→            // Apple方式：只在设备支持时启用高分辨率捕获
   113→            if photoOutput.isHighResolutionCaptureSupported {
   114→                photoOutput.isHighResolutionCaptureEnabled = true
   115→                print("🔍 PhotoOutput配置: 高分辨率捕获已启用")
   116→            } else {
   117→                print("⚠️ PhotoOutput不支持高分辨率捕获")
   118→            }
   119→            
   120→            // 确保photoOutput支持我们需要的功能
   121→            photoOutput.maxPhotoQualityPrioritization = .quality
   122→            
   123→            print("🔍 PhotoOutput最终状态:")
   124→            print("  - 高分辨率捕获支持: \(photoOutput.isHighResolutionCaptureSupported)")
   125→            print("  - 高分辨率捕获启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   126→            print("  - 最大质量优先级: \(getQualityName(photoOutput.maxPhotoQualityPrioritization))")
   127→        } else {
   128→            print("❌ 无法添加photoOutput")
   129→        }
   130→        
   131→        session.commitConfiguration()
   132→        
   133→        print("📸 相机输出配置:")
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们也检查在快速设置中是否正确配置了PhotoOutput：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    73→            } catch {
    74→                print("❌ 配置默认相机失败: \(error)")
    75→            }
    76→            
    77→            // 添加输出并配置高分辨率捕获
    78→            if self.session.canAddOutput(self.photoOutput) {
    79→                self.session.addOutput(self.photoOutput)
    80→                
    81→                // 立即检查并启用高分辨率捕获支持
    82→                if self.photoOutput.isHighResolutionCaptureSupported {
    83→                    self.photoOutput.isHighResolutionCaptureEnabled = true
    84→                    print("🚀 快速设置: 高分辨率捕获已启用")
    85→                } else {
    86→                    print("🚀 快速设置: PhotoOutput不支持高分辨率捕获")
    87→                }
    88→                
    89→                // 设置最高质量优先级
    90→                self.photoOutput.maxPhotoQualityPrioritization = .quality
    91→                
    92→                print("🚀 快速设置PhotoOutput状态:")
    93→                print("  - 高分辨率捕获支持: \(self.photoOutput.isHighResolutionCaptureSupported)")
    94→                print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
    95→            } else {
    96→                print("❌ 快速设置: 无法添加photoOutput")
    97→            }
    98→            
    99→            self.session.commitConfiguration()
   100→            
   101→            // 更新相机列表（在主线程）
```

_**Agent (claude-sonnet-4-20250514)**_

还有一个可能的问题是需要先设置正确的session preset，然后再配置PhotoOutput。让我们检查session preset的设置顺序：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    56→            }
    57→            
    58→            self.session.beginConfiguration()
    59→            
    60→            // 设置session preset - 对于48MP捕获很重要
    61→            if self.session.canSetSessionPreset(.photo) {
    62→                self.session.sessionPreset = .photo
    63→                print("🚀 快速设置: Session preset设置为 .photo")
    64→            } else {
    65→                print("❌ 快速设置: 无法设置 .photo preset")
    66→            }
    67→            
    68→            // 配置默认相机
    69→            do {
    70→                let input = try AVCaptureDeviceInput(device: defaultCamera)
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们添加一个重要的检查 - 确保在session配置完成后再次验证PhotoOutput的状态：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    98→            } else {
    99→                print("❌ 快速设置: 无法添加photoOutput")
   100→            }
   101→            
   102→            self.session.commitConfiguration()
   103→            
   104→            // 在session配置完成后，再次验证PhotoOutput状态
   105→            print("🚀 Session配置完成后，PhotoOutput最终状态:")
   106→            print("  - 高分辨率捕获支持: \(self.photoOutput.isHighResolutionCaptureSupported)")
   107→            print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   108→            print("  - 可用编解码器类型: \(self.photoOutput.availablePhotoCodecTypes)")
   109→            
   110→            // 更新相机列表（在主线程）
   111→            DispatchQueue.main.async {
   112→                self.availableCameras = [defaultCamera]
   113→                print("✅ 快速设置完成，相机可用")
   114→            }
   115→            
   116→            // 发现其他相机
   117→            self.discoverAdditionalCameras()
   118→        }
```

_**Agent (claude-sonnet-4-20250514)**_

还有一个关键问题：我们可能需要在配置相机设备时也重新配置PhotoOutput。让我们在 `configureCamera` 方法中添加PhotoOutput的重新配置：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   287→                    self.session.addInput(input)
   288→                    self.currentInput = input
   289→                    self.currentDevice = device
   290→                    
   291→                    // 重新配置PhotoOutput以确保高分辨率捕获正确设置
   292→                    if self.photoOutput.isHighResolutionCaptureSupported {
   293→                        self.photoOutput.isHighResolutionCaptureEnabled = true
   294→                        print("📷 设备切换后: 高分辨率捕获重新启用")
   295→                    } else {
   296→                        print("📷 设备切换后: 当前设备不支持高分辨率捕获")
   297→                    }
   298→                    
   299→                    // 为48MP配置设备格式
   300→                    if self.currentPhotoResolution == .resolution48MP {
   301→                        self.configure48MPFormat(for: device)
   302→                    }
   303→                    
   304→                    print("📷 设备配置完成后PhotoOutput状态:")
   305→                    print("  - 高分辨率捕获支持: \(self.photoOutput.isHighResolutionCaptureSupported)")
   306→                    print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   307→                }
   308→            } catch {
   309→                print("Error configuring camera: \(error)")
   310→            }
```

_**Agent (claude-sonnet-4-20250514)**_

还有一个可能的原因：我们需要确保在48MP模式下使用正确的session preset。让我们检查 `getSessionPreset` 方法：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/CameraService.swift`

Result:

```
645→            }
   646→            
   647→            // 按照Apple AVCam标准方式创建photo settings，使用用户选择的格式
   648→            let settings = getPhotoSettings(for: currentPhotoFormat)
   649→            
   650→            // 设置闪光灯模式
   651→            if let currentDevice = self.currentDevice, currentDevice.hasFlash {
   652→                settings.flashMode = .auto
   653→            } else {
   654→                settings.flashMode = .off
   655→            }
   656→            
   657→            // 使用设备支持的最高质量设置
   658→            let maxQuality = self.photoOutput.maxPhotoQualityPrioritization
   659→            if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.quality.rawValue {
   660→                settings.photoQualityPrioritization = .quality
   661→            } else if maxQuality.rawValue >= AVCapturePhotoOutput.QualityPrioritization.balanced.rawValue {
   662→                settings.photoQualityPrioritization = .balanced
   663→            } else {
   664→                settings.photoQualityPrioritization = .speed
```

_**Agent (claude-sonnet-4-20250514)**_

让我看看 `getSessionPreset` 方法：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Grep** path `./MCCamera/CameraService.swift`

Result:

```
121-    private func setupSession() {
122-        // 已经在 sessionQueue 中调用，不需要再次异步
123-        session.beginConfiguration()
124-        
125-        // 根据分辨率设置session preset
126:        let sessionPreset = getSessionPreset(for: currentPhotoResolution)
127-        if session.canSetSessionPreset(sessionPreset) {
128-            session.sessionPreset = sessionPreset
129-        } else {
130-            session.sessionPreset = .photo
131-        }
--
748-        guard session.isRunning else { return }
749-        
750-        session.beginConfiguration()
751-        
752-        // 根据新的分辨率设置session preset
753:        let sessionPreset = getSessionPreset(for: currentPhotoResolution)
754-        if session.canSetSessionPreset(sessionPreset) {
755-            session.sessionPreset = sessionPreset
756-            print("📸 更新session preset为: \(sessionPreset.rawValue)")
757-        }
758-        
--
765-        
766-        session.commitConfiguration()
767-    }
768-    
769-    // 获取对应分辨率的session preset
770:    private func getSessionPreset(for resolution: PhotoResolution) -> AVCaptureSession.Preset {
771-        switch resolution {
772-        case .resolution12MP:
773-            return .photo
774-        case .resolution48MP:
775-            if #available(iOS 16.0, *) {
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./MCCamera/CameraService.swift`

Result:

```
770→    private func getSessionPreset(for resolution: PhotoResolution) -> AVCaptureSession.Preset {
   771→        switch resolution {
   772→        case .resolution12MP:
   773→            return .photo
   774→        case .resolution48MP:
   775→            if #available(iOS 16.0, *) {
   776→                // 48MP需要使用最高质量preset
   777→                return .photo
   778→            } else {
   779→                return .photo
   780→            }
   781→        }
   782→    }
   783→    
   784→    // 获取对应格式的photo settings
```

_**Agent (claude-sonnet-4-20250514)**_

现在，让我们在48MP模式下尝试使用更高级的session preset：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   765→        
   766→        session.commitConfiguration()
   767→    }
   768→    
   769→    // 获取对应分辨率的session preset
   770→    private func getSessionPreset(for resolution: PhotoResolution) -> AVCaptureSession.Preset {
   771→        switch resolution {
   772→        case .resolution12MP:
   773→            return .photo
   774→        case .resolution48MP:
   775→            // 对于48MP，尝试使用最高质量的preset
   776→            // 检查设备是否支持更高级的preset
   777→            let availablePresets: [AVCaptureSession.Preset] = [
   778→                .photo,
   779→                .high,
   780→                .inputPriority  // iOS 14.0+
   781→            ]
   782→            
   783→            for preset in availablePresets {
   784→                if session.canSetSessionPreset(preset) {
   785→                    print("📸 48MP选择preset: \(preset.rawValue)")
   786→                    return preset
   787→                }
   788→            }
   789→            
   790→            // 默认回退到.photo
   791→            print("📸 48MP使用默认preset: .photo")
   792→            return .photo
   793→        }
   794→    }
   795→    
   796→    // 获取对应格式的photo settings
   797→    private func getPhotoSettings(for format: PhotoFormat) -> AVCapturePhotoSettings {
   798→        let settings: AVCapturePhotoSettings
```

_**Agent (claude-sonnet-4-20250514)**_

还有一个重要的地方需要检查 - 我们需要确保session初始化时就正确设置了48MP模式。让我添加一个专门的48MP初始化方法：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   727→        }
   728→    }
   729→    
   730→    // 更新设置的方法
   731→    func updatePhotoSettings(format: PhotoFormat, resolution: PhotoResolution) {
   732→        let needsSessionReconfiguration = (currentPhotoResolution != resolution)
   733→        
   734→        currentPhotoFormat = format
   735→        currentPhotoResolution = resolution
   736→        print("📸 更新照片设置 - 格式: \(format.rawValue), 分辨率: \(resolution.rawValue)")
   737→        
   738→        // 如果分辨率改变，需要重新配置session
   739→        if needsSessionReconfiguration {
   740→            sessionQueue.async { [weak self] in
   741→                self?.reconfigureSession()
   742→                
   743→                // 特别处理48MP模式
   744→                if resolution == .resolution48MP {
   745→                    self?.forceReconfigure48MP()
   746→                }
   747→            }
   748→        }
   749→    }
   750→    
   751→    // 强制重新配置48MP模式
   752→    private func forceReconfigure48MP() {
   753→        guard let device = currentDevice else { return }
   754→        
   755→        print("🔄 强制重新配置48MP模式...")
   756→        
   757→        session.beginConfiguration()
   758→        
   759→        // 1. 确保session preset正确
   760→        let preset = getSessionPreset(for: .resolution48MP)
   761→        if session.canSetSessionPreset(preset) {
   762→            session.sessionPreset = preset
   763→            print("🔄 强制设置48MP preset: \(preset.rawValue)")
   764→        }
   765→        
   766→        // 2. 重新配置PhotoOutput
   767→        if photoOutput.isHighResolutionCaptureSupported {
   768→            photoOutput.isHighResolutionCaptureEnabled = true
   769→            photoOutput.maxPhotoQualityPrioritization = .quality
   770→            print("🔄 强制启用PhotoOutput高分辨率捕获")
   771→        }
   772→        
   773→        // 3. 配置设备格式
   774→        configureFor48MP(enable: true)
   775→        
   776→        session.commitConfiguration()
   777→        
   778→        print("🔄 48MP强制重新配置完成")
   779→        print("  - PhotoOutput高分辨率支持: \(photoOutput.isHighResolutionCaptureSupported)")
   780→        print("  - PhotoOutput高分辨率启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   781→    }
   782→    
   783→    // 重新配置session的方法
   784→    private func reconfigureSession() {
   785→        guard session.isRunning else { return }
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们测试修复后的代码。让我构建项目：
Tool use: **Bash** 构建项目到真机测试48MP修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'name=马聪聪的iPhone' build`

Error:

```
** BUILD FAILED **


The following build commands failed:
	SwiftCompile normal arm64 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift (in target 'MCCamera' from project 'MCCamera')
	SwiftCompile normal arm64 Compiling\ CameraService.swift /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift (in target 'MCCamera' from project 'MCCamera')
	Building project MCCamera with scheme MCCamera
(3 failures)

Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination name=马聪聪的iPhone build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: ecb570ead708567f9fbb5f73ad97bc50
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/ecb570ead708567f9fbb5f73ad97bc50.xcbuilddata
ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache

ProcessProductPackaging "" /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Entitlements:
    
    {
    "application-identifier" = "2867UNTJFF.com.lianjia.decoration.stewardHD";
    "com.apple.developer.team-identifier" = 2867UNTJFF;
    "get-task-allow" = 1;
}
    
    builtin-productPackagingUtility -entitlements -format xml -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent

ProcessProductPackagingDER /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /usr/bin/derq query -f xml -i /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der --raw

SwiftDriver MCCamera normal arm64 com.apple.xcode.tools.swift.compiler (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-SwiftDriver -- /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc -module-name MCCamera -Onone -enforce-exclusivity\=checked @/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCa

... [30110 characters truncated] ...

d/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera-generated-files.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera-own-target-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera-all-target-headers.hmap -Xcc -iquote -Xcc /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera-project-headers.hmap -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/include -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/DerivedSources-normal/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/DerivedSources/arm64 -Xcc -I/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/DerivedSources -Xcc -DDEBUG\=1 -module-name MCCamera -frontend-parseable-output -disable-clang-spi -target-sdk-version 18.2 -target-sdk-name iphoneos18.2 -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -external-plugin-path /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/local/lib/swift/host/plugins\#/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/swift-plugin-server -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/host/plugins -plugin-path /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/local/lib/swift/host/plugins -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/Objects-normal/arm64/CameraService.o -index-unit-output-path /MCCamera.build/Debug-iphoneos/MCCamera.build/Objects-normal/arm64/CameraService.o -index-store-path /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Index.noindex/DataStore -index-system-modules
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:85:37: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
                if self.photoOutput.isHighResolutionCaptureSupported {
                   ~~~~~~~~~~~~~~~~ ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:138:76: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
            print("🔍 PhotoOutput支持高分辨率捕获: \(photoOutput.isHighResolutionCaptureSupported)")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:141:28: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
            if photoOutput.isHighResolutionCaptureSupported {
               ~~~~~~~~~~~ ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:152:64: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
            print("  - 高分辨率捕获支持: \(photoOutput.isHighResolutionCaptureSupported)")
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:292:41: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
                    if self.photoOutput.isHighResolutionCaptureSupported {
                       ~~~~~~~~~~~~~~~~ ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:461:14: warning: immutable value 'index' was never used; consider replacing with '_' or removing it
        for (index, format) in device.formats.enumerated() {
             ^~~~~
             _
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:767:24: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
        if photoOutput.isHighResolutionCaptureSupported {
           ~~~~~~~~~~~ ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift:779:65: error: value of type 'AVCapturePhotoOutput' has no member 'isHighResolutionCaptureSupported'
        print("  - PhotoOutput高分辨率支持: \(photoOutput.isHighResolutionCaptureSupported)")
```

_**Agent (claude-sonnet-4-20250514)**_

我发现了问题！`isHighResolutionCaptureSupported` 属性不存在。让我检查正确的属性名：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    80→            // 添加输出并配置高分辨率捕获
    81→            if self.session.canAddOutput(self.photoOutput) {
    82→                self.session.addOutput(self.photoOutput)
    83→                
    84→                // 立即启用高分辨率捕获
    85→                self.photoOutput.isHighResolutionCaptureEnabled = true
    86→                print("🚀 快速设置: 高分辨率捕获已启用")
    87→                
    88→                // 设置最高质量优先级
    89→                self.photoOutput.maxPhotoQualityPrioritization = .quality
    90→
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    87→                
    88→                // 设置最高质量优先级
    89→                self.photoOutput.maxPhotoQualityPrioritization = .quality
    90→                
    91→                print("🚀 快速设置PhotoOutput状态:")
    92→                print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
    93→            } else {
    94→                print("❌ 快速设置: 无法添加photoOutput")
    95→            }
    96→
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    95→            }
    96→            
    97→            self.session.commitConfiguration()
    98→            
    99→            // 在session配置完成后，再次验证PhotoOutput状态
   100→            print("🚀 Session配置完成后，PhotoOutput最终状态:")
   101→            print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   102→            print("  - 可用编解码器类型: \(self.photoOutput.availablePhotoCodecTypes)")
   103→            
   104→            // 更新相机列表（在主线程）
   105→            DispatchQueue.main.async {
   106→                self.availableCameras = [defaultCamera]
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   127→        // 按照Apple AVCam方式配置photoOutput
   128→        if session.canAddOutput(photoOutput) {
   129→            session.addOutput(photoOutput)
   130→            
   131→            // Apple方式：启用高分辨率捕获
   132→            photoOutput.isHighResolutionCaptureEnabled = true
   133→            print("🔍 PhotoOutput配置: 高分辨率捕获已启用")
   134→            
   135→            // 确保photoOutput支持我们需要的功能
   136→            photoOutput.maxPhotoQualityPrioritization = .quality
   137→
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   134→            
   135→            // 确保photoOutput支持我们需要的功能
   136→            photoOutput.maxPhotoQualityPrioritization = .quality
   137→            
   138→            print("🔍 PhotoOutput最终状态:")
   139→            print("  - 高分辨率捕获启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   140→            print("  - 最大质量优先级: \(getQualityName(photoOutput.maxPhotoQualityPrioritization))")
   141→        } else {
   142→            print("❌ 无法添加photoOutput")
   143→        }
   144→
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   273→                    self.session.addInput(input)
   274→                    self.currentInput = input
   275→                    self.currentDevice = device
   276→                    
   277→                    // 重新配置PhotoOutput以确保高分辨率捕获正确设置
   278→                    self.photoOutput.isHighResolutionCaptureEnabled = true
   279→                    print("📷 设备切换后: 高分辨率捕获重新启用")
   280→                    
   281→                    // 为48MP配置设备格式
   282→                    if self.currentPhotoResolution == .resolution48MP {
   283→                        self.configure48MPFormat(for: device)
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   282→                    if self.currentPhotoResolution == .resolution48MP {
   283→                        self.configure48MPFormat(for: device)
   284→                    }
   285→                    
   286→                    print("📷 设备配置完成后PhotoOutput状态:")
   287→                    print("  - 高分辨率捕获启用: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   288→                }
   289→            } catch {
   290→                print("Error configuring camera: \(error)")
   291→            }
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   743→            session.sessionPreset = preset
   744→            print("🔄 强制设置48MP preset: \(preset.rawValue)")
   745→        }
   746→        
   747→        // 2. 重新配置PhotoOutput
   748→        photoOutput.isHighResolutionCaptureEnabled = true
   749→        photoOutput.maxPhotoQualityPrioritization = .quality
   750→        print("🔄 强制启用PhotoOutput高分辨率捕获")
   751→        
   752→        // 3. 配置设备格式
   753→        configureFor48MP(enable: true)
   754→
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   753→        configureFor48MP(enable: true)
   754→        
   755→        session.commitConfiguration()
   756→        
   757→        print("🔄 48MP强制重新配置完成")
   758→        print("  - PhotoOutput高分辨率启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   759→    }
   760→    
   761→    // 重新配置session的方法
   762→    private func reconfigureSession() {
```

_**Agent (claude-sonnet-4-20250514)**_

现在我需要修复未使用的变量警告：
Tool use: **Edit**

Error:

```
<tool_use_error>Found 2 matches of the string to replace, but replace_all is false. To replace all occurrences, set replace_all to true. To replace only one occurrence, please provide more context to uniquely identify the instance.
String:         for (index, format) in device.formats.enumerated() {</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. All occurrences of '        for (index, format) in device.formats.enumerated() {' were successfully replaced with '        for (_, format) in device.formats.enumerated() {'.
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我们再次构建项目：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 重新构建项目测试48MP修复

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'name=马聪聪的iPhone' build`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination name=马聪聪的iPhone build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: a3c4f099b480f23421e1a13f928e2131
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/a3c4f099b480f23421e1a13f928e2131.xcbuilddata
ProcessProductPackaging "" /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Entitlements:
    
    {
    "application-identifier" = "2867UNTJFF.com.lianjia.decoration.stewardHD";
    "com.apple.developer.team-identifier" = 2867UNTJFF;
    "get-task-allow" = 1;
}
    
    builtin-productPackagingUtility -entitlements -format xml -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent

ProcessProductPackagingDER /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /usr/bin/derq query -f xml -i /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der --raw

ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache

ProcessInfoPlistFile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Info.plist /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/empty-MCCamera.plist (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-infoPlistUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/empty-MCCamera.plist -producttype com.apple.product-type.application -genpkginfo /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/PkgInfo -expandbuildsettings -format binary -platform iphoneos -additionalcontentfile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/assetcatalog_generated_info.plist -requiredArchitecture arm64 -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Info.plist

CopySwiftLibs /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-swiftStdLibTool --copy --verbose --sign E8C6A6B108E42770BD89AA2CBEBC9E415A3EAA0D --scan-executable /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/MCCamera.debug.dylib --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Frameworks --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/PlugIns --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/SystemExtensions --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Extensions --platform iphoneos --toolchain /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain --destination /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Frameworks --strip-bitcode --strip-bitcode-tool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/bitcode_strip --emit-dependency-info /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/SwiftStdLibToolInputDependencies.dep --filter-for-swift-os

CodeSign /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Signing Identity:     "Apple Development: congcong ma (B6777J693A)"
    Provisioning Profile: "iOS Team Provisioning Profile: com.lianjia.decoration.stewardHD"
                          (779037f4-0186-4807-99a8-771b2be55315)
    
    /usr/bin/codesign --force --sign E8C6A6B108E42770BD89AA2CBEBC9E415A3EAA0D --entitlements /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent --timestamp\=none --generate-entitlement-der /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app
/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app: replacing existing signature

Validate /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-validationUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app -infoplist-subpath Info.plist

** BUILD SUCCEEDED **
```

_**Agent (claude-sonnet-4-20250514)**_

太好了！构建成功了。现在我们修复了主要问题：

1. **移除了不存在的 `isHighResolutionCaptureSupported` 属性**
2. **直接启用 `isHighResolutionCaptureEnabled = true`**
3. **修复了编译错误和警告**

现在应该能正确启用48MP模式了。关键修改包括：

### 主要修复点：

1. **PhotoOutput配置**：直接启用高分辨率捕获，而不检查是否支持（因为这个属性在当前iOS版本中不存在）
2. **Session配置**：确保在session配置过程中正确设置高分辨率捕获
3. **48MP检测逻辑**：基于设备型号和可用格式来判断48MP支持，而不依赖特定的API
4. **强制重新配置**：添加了专门的48MP重新配置方法

### 现在的工作流程：

1. **设备检测**：正确识别iPhone 14 Pro Max支持48MP
2. **PhotoOutput配置**：启用高分辨率捕获功能
3. **格式选择**：使用最高分辨率格式(12MP)作为基础，通过高分辨率捕获实现48MP
4. **拍照设置**：在拍照时启用 `isHighResolutionPhotoEnabled = true`

现在运行应用时，应该会看到：
- `🔍 48MP检查: iPhone 14 Pro及更新机型通过高分辨率捕获实现48MP`
- `📸 PhotoOutput配置: 高分辨率捕获已启用`
- `📸 最终Settings高分辨率启用: true`

这样您的iPhone 14 Pro Max应该能够正确拍摄48MP照片了！

---

_**User**_

User provided an image (image/png).

User provided an image (image/png).


🔍 48MP检查: 未找到48MP格式，最大分辨率: 12MP (4032x3024)
🔍 48MP检查: 设备型号支持48MP，且有高分辨率格式(12MP)可用
🔍 48MP检查: iPhone 14 Pro及更新机型通过高分辨率捕获实现48MP
📸 ✅ 成功启用48MP高分辨率模式
📸 48MP使用JPEG格式
📸 最终Settings高分辨率启用: true
📸 拍照设置:
  - 质量优先级: quality (最大支持: quality)
  - 高分辨率: true (支持: true)
  - 格式: JPEG
📸 原始照片元数据:
  - EXIF数据存在，包含 35 个字段
  - ISO: (
    250
)
  - 快门速度: 0.008474576271186441
  - TIFF数据存在
  - 制造商: Apple
📸 原始元数据字段:
  - 总字段数: 12
setProperties:1806: *** ERROR: image destination cannot be changed once an image was added
📋 验证保存的元数据:
  - EXIF字段数量: 35
  - 镜头制造商: Apple
  - 镜头型号: iPhone 14 Pro Max back camera 6.86mm f/1.78
  - 拍摄时间: 2025:08:19 15:49:22
  - ISO: (
    250
)
  - 快门速度: 0.008474576271186441
  - TIFF字段数量: 9
  - 设备制造商: Apple
  - 设备型号: iPhone 14 Pro Max
  - GPS字段数量: 9
✅ 成功创建带有完整元数据的图像，格式: JPEG
📍 添加GPS位置信息: CLLocationCoordinate2D(latitude: 40.046301246299365, longitude: 116.30091689403484)
✅ 照片已成功保存到相册，包含完整元数据 现在看 log 显示支持 4800w 同时也设置了 4800w 但是拍照完成后 还是使用的 12mp 的模式 ,如图:[Image #2].真正的 4800w 是[Image #3]

---

_**Agent (claude-sonnet-4-20250514)**_

我看到问题了！虽然日志显示高分辨率设置已启用，但实际拍出来的照片还是12MP (3024 x 4032)，而不是真正的48MP (5376 x 8064)。

问题在于我们虽然启用了高分辨率捕获，但可能还需要额外的配置。让我检查并修复这个问题：

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [⚡] 🌡️ 分析48MP拍照仍输出12MP的问题
- [ ] 🌡️ 检查48MP配置是否正确应用
- [ ] 🌡️ 修复48MP实际输出问题
- [ ] 🌡️ 验证修复后的48MP功能


_**Agent (claude-sonnet-4-20250514)**_

从您的截图可以看到，虽然配置看起来正确，但拍照结果仍然是12MP。这通常是因为以下几个原因：

1. **设备格式没有正确设置为48MP**
2. **photoSettings的配置不完整**
3. **session配置时机有问题**

让我检查并修复这些问题：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   829→                settings = AVCapturePhotoSettings()
   830→            }
   831→        }
   832→        
   833→        // 48MP分辨率支持
   834→        if currentPhotoResolution == .resolution48MP {
   835→            // 添加详细的调试信息
   836→            print("📸 准备启用48MP模式...")
   837→            print("📸 设备48MP支持: \(is48MPAvailable)")
   838→            print("📸 PhotoOutput高分辨率捕获启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   839→            print("📸 当前设备格式分辨率: \(getCurrentDeviceFormatResolution())")
   840→            
   841→            // 检查当前设备是否支持48MP
   842→            if is48MPAvailable && photoOutput.isHighResolutionCaptureEnabled {
   843→                settings.isHighResolutionPhotoEnabled = true
   844→                print("📸 ✅ 成功启用48MP高分辨率模式")
   845→                
   846→                // 对于48MP模式，使用最高质量设置
   847→                settings.photoQualityPrioritization = .quality
   848→                
   849→                // 强制设置最大像素数（如果支持）
   850→                if #available(iOS 16.0, *) {
   851→                    // iOS 16+可能有更多48MP相关设置
   852→                    print("📸 iOS 16+ 48MP支持检查")
   853→                }
   854→                
   855→                // 确保使用合适的编解码器
   856→                if format == .heic && photoOutput.availablePhotoCodecTypes.contains(.hevc) {
   857→                    print("📸 48MP使用HEIC格式")
   858→                } else if format == .jpeg && photoOutput.availablePhotoCodecTypes.contains(.jpeg) {
   859→                    print("📸 48MP使用JPEG格式")
   860→                }
   861→                
   862→                print("📸 PhotoSettings配置完成:")
   863→                print("  - isHighResolutionPhotoEnabled: \(settings.isHighResolutionPhotoEnabled)")
   864→                print("  - photoQualityPrioritization: \(getQualityName(settings.photoQualityPrioritization))")
   865→                
   866→            } else {
   867→                print("⚠️ 48MP不可用 - 设备支持:\(is48MPAvailable), PhotoOutput支持:\(photoOutput.isHighResolutionCaptureEnabled)")
   868→                settings.isHighResolutionPhotoEnabled = false
   869→            }
   870→            
   871→            print("📸 最终Settings高分辨率启用: \(settings.isHighResolutionPhotoEnabled)")
   872→        }
   873→        
   874→        return settings
   875→    }
   876→
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我添加一个方法来检查当前设备格式的分辨率：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
  1113→        
  1114→        return gpsDict
  1115→    }
  1116→    
  1117→    private func getQualityName(_ quality: AVCapturePhotoOutput.QualityPrioritization) -> String {
  1118→        switch quality {
  1119→        case .speed:
  1120→            return "speed"
  1121→        case .balanced:
  1122→            return "balanced"
  1123→        case .quality:
  1124→            return "quality"
  1125→        @unknown default:
  1126→            return "unknown"
  1127→        }
  1128→    }
  1129→    
  1130→    // 获取当前设备格式的分辨率信息
  1131→    private func getCurrentDeviceFormatResolution() -> String {
  1132→        guard let device = currentDevice else { return "无设备" }
  1133→        
  1134→        let format = device.activeFormat
  1135→        let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
  1136→        let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
  1137→        
  1138→        return "\(dimensions.width)x\(dimensions.height) (\(megapixels)MP)"
  1139→    }
  1140→    
  1141→    private func logOriginalMetadata(_ imageData: Data) {
  1142→        guard let source = CGImageSourceCreateWithData(imageData as CFData, nil),
  1143→              let properties = CGImageSourceCopyPropertiesAtIndex(source, 0, nil) as? [String: Any] else {
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析48MP拍照仍输出12MP的问题
- [⚡] 🌡️ 检查48MP配置是否正确应用
- [ ] 🌡️ 修复48MP实际输出问题
- [ ] 🌡️ 验证修复后的48MP功能


_**Agent (claude-sonnet-4-20250514)**_

现在我需要确保在48MP模式下确实设置了正确的设备格式。问题可能在于我们的 `configureFor48MP` 方法没有正确地设置设备格式。让我修复这个关键问题：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   484→                
   485→                do {
   486→                    try device.lockForConfiguration()
   487→                    
   488→                    // 对于iPhone 14 Pro/Pro Max，需要特殊处理48MP格式
   489→                    // 关键：我们需要找到支持高分辨率捕获的最佳格式
   490→                    
   491→                    var bestFormatFor48MP: AVCaptureDevice.Format?
   492→                    var maxSuitableMP = 0
   493→                    
   494→                    print("📸 搜索适合48MP捕获的格式...")
   495→                    
   496→                    for format in device.formats {
   497→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   498→                        let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   499→                        
   500→                        // 查找12MP格式，这通常是48MP捕获的基础格式
   501→                        if megapixels >= 10 && megapixels <= 15 {
   502→                            if megapixels > maxSuitableMP {
   503→                                maxSuitableMP = megapixels
   504→                                bestFormatFor48MP = format
   505→                                print("📸 找到适合48MP的基础格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   506→                            }
   507→                        }
   508→                    }
   509→                    
   510→                    if let format48MP = bestFormatFor48MP {
   511→                        device.activeFormat = format48MP
   512→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format48MP.formatDescription)
   513→                        print("📸 ✅ 设置48MP基础格式: \(dimensions.width)x\(dimensions.height)")
   514→                        print("📸 48MP将通过高分辨率捕获在此基础上实现")
   515→                    } else {
   516→                        print("⚠️ 未找到适合48MP的基础格式")
   517→                    }
   518→                    
   519→                    // 确保PhotoOutput支持高分辨率捕获
   520→                    if self.photoOutput.isHighResolutionCaptureEnabled {
   521→                        print("📸 PhotoOutput已支持高分辨率捕获")
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我添加一个关键的检查：确保我们在设置48MP模式时重新配置整个相机系统：
Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   766→        print("🔄 48MP强制重新配置完成")
   767→        print("  - PhotoOutput高分辨率启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   768→    }
   769→    
   770→    // 重新配置session的方法
   771→    private func reconfigureSession() {
   772→        guard session.isRunning else { return }
   773→        
   774→        print("🔄 重新配置Session - 分辨率: \(currentPhotoResolution.rawValue)")
   775→        
   776→        session.beginConfiguration()
   777→        
   778→        // 根据新的分辨率设置session preset
   779→        let sessionPreset = getSessionPreset(for: currentPhotoResolution)
   780→        if session.canSetSessionPreset(sessionPreset) {
   781→            session.sessionPreset = sessionPreset
   782→            print("📸 更新session preset为: \(sessionPreset.rawValue)")
   783→        }
   784→        
   785→        // 重新配置PhotoOutput以确保高分辨率设置正确
   786→        if currentPhotoResolution == .resolution48MP {
   787→            // 48MP模式：确保PhotoOutput配置正确
   788→            photoOutput.isHighResolutionCaptureEnabled = true
   789→            photoOutput.maxPhotoQualityPrioritization = .quality
   790→            print("🔄 48MP模式：重新配置PhotoOutput")
   791→            print("  - 高分辨率捕获启用: \(photoOutput.isHighResolutionCaptureEnabled)")
   792→            print("  - 质量优先级: \(getQualityName(photoOutput.maxPhotoQualityPrioritization))")
   793→        }
   794→        
   795→        // 根据分辨率配置相应的设备格式
   796→        if currentPhotoResolution == .resolution48MP {
   797→            configureFor48MP(enable: true)
   798→        } else {
   799→            configureFor48MP(enable: false)
   800→        }
   801→        
   802→        session.commitConfiguration()
   803→        
   804→        // 配置完成后验证状态
   805→        print("🔄 Session重新配置完成")
   806→        print("  - 当前设备格式: \(getCurrentDeviceFormatResolution())")
   807→        print("  - PhotoOutput高分辨率: \(photoOutput.isHighResolutionCaptureEnabled)")
   808→        print("  - Session preset: \(session.sessionPreset.rawValue)")
   809→    }
   810→    
   811→    // 获取对应分辨率的session preset
   812→    private func getSessionPreset(for resolution: PhotoResolution) -> AVCaptureSession.Preset {
   813→        switch resolution {
```

_**Agent (claude-sonnet-4-20250514)**_

现在最关键的问题可能是：我们需要确保在拍照设置中明确指定要使用最大分辨率。让我查看Apple的官方文档建议，对于iPhone 14 Pro/Pro Max的48MP功能，可能需要额外的配置：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   653→            } else {
   654→                settings.photoQualityPrioritization = .speed
   655→            }
   656→            
   657→            // Apple方式：只在支持时启用高分辨率
   658→            if self.photoOutput.isHighResolutionCaptureEnabled {
   659→                settings.isHighResolutionPhotoEnabled = true
   660→                print("📸 拍照时启用高分辨率: true")
   661→            } else {
   662→                print("⚠️ PhotoOutput不支持高分辨率，无法启用")
   663→            }
   664→            
   665→            // Apple建议：启用嵌入式缩略图以获得更好的相册体验
   666→            if settings.availableEmbeddedThumbnailPhotoCodecTypes.contains(.jpeg) {
   667→                settings.embeddedThumbnailPhotoFormat = [
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [X] 🌡️ 分析48MP拍照仍输出12MP的问题
- [X] 🌡️ 检查48MP配置是否正确应用
- [⚡] 🌡️ 修复48MP实际输出问题
- [ ] 🌡️ 验证修复后的48MP功能


_**Agent (claude-sonnet-4-20250514)**_

让我再看看一个关键的地方。根据Apple的文档，iPhone 14 Pro的48MP功能可能需要特定的格式配置。让我添加一个更精确的48MP格式查找：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   492→                    var maxSuitableMP = 0
   493→                    
   494→                    print("📸 搜索适合48MP捕获的格式...")
   495→                    
   496→                    for format in device.formats {
   497→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format.formatDescription)
   498→                        let megapixels = (Int(dimensions.width) * Int(dimensions.height)) / 1_000_000
   499→                        
   500→                        // 首先查找真正的48MP格式
   501→                        if megapixels >= 40 {
   502→                            bestFormatFor48MP = format
   503→                            print("📸 找到真正的48MP格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   504→                            break
   505→                        }
   506→                        
   507→                        // 查找12MP格式作为备选，这通常是48MP捕获的基础格式
   508→                        if megapixels >= 10 && megapixels <= 15 {
   509→                            if megapixels > maxSuitableMP {
   510→                                maxSuitableMP = megapixels
   511→                                bestFormatFor48MP = format
   512→                                print("📸 找到适合48MP的基础格式: \(dimensions.width)x\(dimensions.height) (\(megapixels)MP)")
   513→                            }
   514→                        }
   515→                    }
   516→                    
   517→                    if let format48MP = bestFormatFor48MP {
   518→                        device.activeFormat = format48MP
   519→                        let dimensions = CMVideoFormatDescriptionGetDimensions(format48MP.formatDescription)
```

_**Agent (claude-sonnet-4-20250514)**_

现在我想到一个关键问题：可能需要在session开始运行之前就配置48MP模式。让我在session启动时添加一个检查：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Edit**

Result:

```
The file /Users/macongcong/Desktop/MC/MCCamera/MCCamera/CameraService.swift has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   585→            completion(false)
   586→        }
   587→    }
   588→    
   589→    func startSession() {
   590→        sessionQueue.async { [weak self] in
   591→            guard let self = self, !self.session.isRunning else { return }
   592→            
   593→            // 在启动session之前，确保48MP配置正确
   594→            if self.currentPhotoResolution == .resolution48MP {
   595→                print("🚀 启动Session前检查48MP配置...")
   596→                print("  - 当前设备格式: \(self.getCurrentDeviceFormatResolution())")
   597→                print("  - PhotoOutput高分辨率: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   598→                
   599→                // 如果需要，重新配置48MP
   600→                if !self.photoOutput.isHighResolutionCaptureEnabled {
   601→                    print("🚀 Session启动前重新配置48MP")
   602→                    self.configureFor48MP(enable: true)
   603→                }
   604→            }
   605→            
   606→            self.session.startRunning()
   607→            print("✅ Session已启动，最终状态检查:")
   608→            print("  - 运行状态: \(self.session.isRunning)")
   609→            print("  - 设备格式: \(self.getCurrentDeviceFormatResolution())")
   610→            print("  - PhotoOutput高分辨率: \(self.photoOutput.isHighResolutionCaptureEnabled)")
   611→        }
   612→    }
   613→    
   614→    func stopSession() {
   615→        sessionQueue.async { [weak self] in
   616→            guard let self = self, self.session.isRunning else { return }
```

_**Agent (claude-sonnet-4-20250514)**_

现在让我构建并测试修复后的代码：

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Bash** 构建修复后的48MP功能

`xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination 'name=马聪聪的iPhone' build`

Result:

```
Command line invocation:
    /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -project MCCamera.xcodeproj -scheme MCCamera -destination name=马聪聪的iPhone build

User defaults from command line:
    IDEPackageSupportUseBuiltinSCM = YES

Prepare packages

ComputeTargetDependencyGraph
note: Building targets in dependency order
note: Target dependency graph (1 target)
    Target 'MCCamera' in project 'MCCamera' (no dependencies)

GatherProvisioningInputs

CreateBuildDescription

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -v -E -dM -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -x c -c /dev/null

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --print-asset-tag-combinations --output-format xml1 /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Preview Content/Preview Assets.xcassets /Users/macongcong/Desktop/MC/MCCamera/MCCamera/Assets.xcassets

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/usr/bin/actool --version --output-format xml1

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swiftc --version

ExecuteExternalTool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld -version_details

Build description signature: 1b3ad6ef36276a7305cb503accbfcc65
Build description path: /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/XCBuildData/1b3ad6ef36276a7305cb503accbfcc65.xcbuilddata
ProcessProductPackaging "" /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Entitlements:
    
    {
    "application-identifier" = "2867UNTJFF.com.lianjia.decoration.stewardHD";
    "com.apple.developer.team-identifier" = 2867UNTJFF;
    "get-task-allow" = 1;
}
    
    builtin-productPackagingUtility -entitlements -format xml -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent

ProcessProductPackagingDER /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    /usr/bin/derq query -f xml -i /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent.der --raw

ClangStatCache /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache
    cd /Users/macongcong/Desktop/MC/MCCamera/MCCamera.xcodeproj
    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang-stat-cache /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS18.2.sdk -o /Users/macongcong/Library/Developer/Xcode/DerivedData/SDKStatCaches.noindex/iphoneos18.2-22C146-d5b9239ec3bf5b3adbecdf21472871e3.sdkstatcache

ProcessInfoPlistFile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Info.plist /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/empty-MCCamera.plist (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-infoPlistUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/empty-MCCamera.plist -producttype com.apple.product-type.application -genpkginfo /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/PkgInfo -expandbuildsettings -format binary -platform iphoneos -additionalcontentfile /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/assetcatalog_generated_info.plist -requiredArchitecture arm64 -o /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Info.plist

CopySwiftLibs /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-swiftStdLibTool --copy --verbose --sign E8C6A6B108E42770BD89AA2CBEBC9E415A3EAA0D --scan-executable /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/MCCamera.debug.dylib --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Frameworks --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/PlugIns --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/SystemExtensions --scan-folder /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Extensions --platform iphoneos --toolchain /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain --destination /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app/Frameworks --strip-bitcode --strip-bitcode-tool /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/bitcode_strip --emit-dependency-info /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/SwiftStdLibToolInputDependencies.dep --filter-for-swift-os

CodeSign /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    
    Signing Identity:     "Apple Development: congcong ma (B6777J693A)"
    Provisioning Profile: "iOS Team Provisioning Profile: com.lianjia.decoration.stewardHD"
                          (779037f4-0186-4807-99a8-771b2be55315)
    
    /usr/bin/codesign --force --sign E8C6A6B108E42770BD89AA2CBEBC9E415A3EAA0D --entitlements /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Intermediates.noindex/MCCamera.build/Debug-iphoneos/MCCamera.build/MCCamera.app.xcent --timestamp\=none --generate-entitlement-der /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app
/Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app: replacing existing signature

Validate /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app (in target 'MCCamera' from project 'MCCamera')
    cd /Users/macongcong/Desktop/MC/MCCamera
    builtin-validationUtility /Users/macongcong/Library/Developer/Xcode/DerivedData/MCCamera-gdrsgdjoyjodurajopiltdldwavl/Build/Products/Debug-iphoneos/MCCamera.app -infoplist-subpath Info.plist

** BUILD SUCCEEDED **
```

_**Agent**_

_**Agent**_

_**Agent**_

